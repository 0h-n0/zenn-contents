---
title: "Bedrock Intelligent Prompt Routingã§ç¤¾å†…RAGã‚³ã‚¹ãƒˆæœ€å¤§60%å‰Šæ¸›"
emoji: "ğŸ”€"
type: "tech"
topics: ["aws", "bedrock", "rag", "python", "llm"]
published: false
---

# Bedrock Intelligent Prompt Routingã§ç¤¾å†…RAGã®APIã‚³ã‚¹ãƒˆã‚’æœ€å¤§60%å‰Šæ¸›ã™ã‚‹å®Ÿè£…ã‚¬ã‚¤ãƒ‰

## ã“ã®è¨˜äº‹ã§ã‚ã‹ã‚‹ã“ã¨

- Amazon Bedrock **Intelligent Prompt Routing**ï¼ˆ2025å¹´4æœˆGAï¼‰ã®ä»•çµ„ã¿ã¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
- boto3ã®`create_prompt_router` APIã‚’ä½¿ã£ãŸ**ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ã‚¿ãƒ¼ã®æ§‹ç¯‰æ‰‹é †**ã¨`responseQualityDifference`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èª¿æ•´æ–¹æ³•
- ç¤¾å†…RAGã‚·ã‚¹ãƒ†ãƒ ã«Prompt Routerã‚’çµ„ã¿è¾¼ã¿ã€**Anthropicãƒ•ã‚¡ãƒŸãƒªãƒ¼ã§æœ€å¤§63.6%ã®ã‚³ã‚¹ãƒˆå‰Šæ¸›**ã‚’å®Ÿç¾ã™ã‚‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- **Cross-Region Inference**ã¨**Model Distillation**ã‚’çµ„ã¿åˆã‚ã›ãŸ**3å±¤ã‚³ã‚¹ãƒˆæœ€é©åŒ–æˆ¦ç•¥**ã®è¨­è¨ˆã¨å®Ÿè£…
- Prompt Routerã®**ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ¯”ç‡ã®å¯è¦–åŒ–**æ‰‹æ³•

## å¯¾è±¡èª­è€…

- **æƒ³å®šèª­è€…**: ä¸­ç´šã€œä¸Šç´šã®AWSãƒ»LLMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºè€…
- **å¿…è¦ãªå‰æçŸ¥è­˜**:
  - AWSï¼ˆBedrockã€IAMã€S3ï¼‰ã®åŸºæœ¬çš„ãªæ“ä½œçµŒé¨“
  - Python 3.12+ / boto3 ã®åŸºç¤
  - RAGï¼ˆRetrieval-Augmented Generationï¼‰ã®åŸºæœ¬æ¦‚å¿µ
  - LLMã®ãƒˆãƒ¼ã‚¯ãƒ³ãƒ»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«é–¢ã™ã‚‹åŸºæœ¬ç†è§£

## çµè«–ãƒ»æˆæœ

Bedrock Intelligent Prompt Routingã‚’ç¤¾å†…RAGã«é©ç”¨ã™ã‚‹ã“ã¨ã§ã€ä»¥ä¸‹ã®æˆæœãŒæœŸå¾…ã§ãã¾ã™ã€‚

- **Anthropicãƒ•ã‚¡ãƒŸãƒªãƒ¼ï¼ˆClaude 3.5 Sonnet + Claude 3.5 Haikuï¼‰ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§å¹³å‡63.6%ã®ã‚³ã‚¹ãƒˆå‰Šæ¸›**ï¼ˆAWSã®å†…éƒ¨RAGãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã«ã‚ˆã‚‹å ±å‘Šå€¤ï¼‰
- 87%ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒHaikuã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã•ã‚Œã€**Sonnetç›¸å½“ã®å›ç­”å“è³ªã‚’ç¶­æŒ**
- Cross-Region Inferenceã¨Model Distillationã®çµ„ã¿åˆã‚ã›ã§ã€**ã•ã‚‰ã«ã‚³ã‚¹ãƒˆ75%å‰Šæ¸›ãƒ»æ¨è«–é€Ÿåº¦500%å‘ä¸Š**ã®å¯èƒ½æ€§
- ãƒ«ãƒ¼ã‚¿ãƒ¼ã®P90ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã¯**ç´„85ms**ã«æŠ‘ãˆã‚‰ã‚Œã€å®Ÿç”¨çš„ãªå¿œç­”é€Ÿåº¦ã‚’ç¢ºä¿

ãŸã ã—ã€ã“ã‚Œã‚‰ã®æ•°å€¤ã¯AWSã®å…¬å¼ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒ»å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹å ±å‘Šå€¤ã§ã‚ã‚Šã€**å®Ÿéš›ã®å‰Šæ¸›ç‡ã¯ã‚¯ã‚¨ãƒªã®è¤‡é›‘ã•ã®åˆ†å¸ƒã‚„ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ä¾å­˜**ã—ã¾ã™ã€‚å˜ç´”ãªFAQç³»ã‚¯ã‚¨ãƒªãŒå¤šã„å ´åˆã¯Haikuã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç‡ãŒé«˜ã¾ã‚Šå‰Šæ¸›å¹…ãŒå¤§ãããªã‚Šã¾ã™ãŒã€å°‚é–€çš„ãƒ»è¤‡é›‘ãªã‚¯ã‚¨ãƒªãŒä¸­å¿ƒã®å ´åˆã¯Sonnetã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒå¢—ãˆã€å‰Šæ¸›å¹…ã¯å°ã•ããªã‚Šã¾ã™ã€‚

## Bedrock Intelligent Prompt Routingã®ä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹

Amazon Bedrock Intelligent Prompt Routingï¼ˆä»¥ä¸‹ã€IPRï¼‰ã¯ã€**åŒä¸€ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ãƒŸãƒªãƒ¼å†…ã®2ã¤ã®ãƒ¢ãƒ‡ãƒ«é–“ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«æœ€é©ãªãƒ¢ãƒ‡ãƒ«ã‚’è‡ªå‹•é¸æŠ**ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ©Ÿèƒ½ã§ã™ã€‚2025å¹´4æœˆã«GAï¼ˆä¸€èˆ¬æä¾›ï¼‰ã¨ãªã‚Šã¾ã—ãŸã€‚

### ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®åˆ¤å®šãƒ•ãƒ­ãƒ¼

IPRã¯ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’åˆ¤å®šã—ã¾ã™ã€‚

1. **ãƒªã‚¯ã‚¨ã‚¹ãƒˆè§£æ**: å…¥åŠ›ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å†…å®¹ãƒ»è¤‡é›‘ã•ã‚’åˆ†æ
2. **å“è³ªäºˆæ¸¬**: å„ãƒ¢ãƒ‡ãƒ«ãŒè¿”ã™å¿œç­”å“è³ªã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«äºˆæ¸¬
3. **ãƒ¢ãƒ‡ãƒ«é¸æŠ**: å“è³ªåŸºæº–ã‚’æº€ãŸã™ä¸­ã§æœ€ã‚‚ã‚³ã‚¹ãƒˆåŠ¹ç‡ã®é«˜ã„ãƒ¢ãƒ‡ãƒ«ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
4. **å¿œç­”è¿”å´**: é¸æŠã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã®å¿œç­”ã«åŠ ãˆã€ã©ã®ãƒ¢ãƒ‡ãƒ«ãŒå‡¦ç†ã—ãŸã‹ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä»˜ä¸

```python
# ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®æ¦‚å¿µãƒ•ãƒ­ãƒ¼ï¼ˆæ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ï¼‰
def route_request(prompt: str, router_config: dict) -> str:
    """
    IPRã®å†…éƒ¨åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ¦‚å¿µçš„ãªæ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ï¼‰
    å®Ÿéš›ã®åˆ¤å®šã¯AWSå´ã§è¡Œã‚ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯APIã‚’å‘¼ã¶ã ã‘
    """
    quality_sonnet = predict_quality(prompt, model="sonnet")
    quality_haiku = predict_quality(prompt, model="haiku")

    quality_diff = quality_sonnet - quality_haiku

    # responseQualityDifference ã®é–¾å€¤ä»¥ä¸‹ãªã‚‰Haikuï¼ˆå®‰ä¾¡ãªãƒ¢ãƒ‡ãƒ«ï¼‰ã‚’é¸æŠ
    if quality_diff <= router_config["responseQualityDifference"]:
        return invoke_model(prompt, model="haiku")  # ã‚³ã‚¹ãƒˆå‰Šæ¸›
    else:
        return invoke_model(prompt, model="sonnet")  # å“è³ªå„ªå…ˆ
```

**ãªãœã“ã®ä»•çµ„ã¿ãŒæœ‰åŠ¹ã‹:**

ç¤¾å†…RAGã®ã‚¯ã‚¨ãƒªã¯è¤‡é›‘ã•ã«ã°ã‚‰ã¤ããŒã‚ã‚Šã¾ã™ã€‚ã€Œç¤¾å†…è¦å®šã®æœ‰çµ¦ä¼‘æš‡æ—¥æ•°ã¯ï¼Ÿã€ã®ã‚ˆã†ãªå˜ç´”ãªæ¤œç´¢ã‚¯ã‚¨ãƒªã¨ã€ã€Œéå»3å¹´ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒªãƒ¼ã‚¸ãƒ§ãƒ³åˆ¥ã®æˆé•·ç‡ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’åˆ†æã—ã¦ã€ã®ã‚ˆã†ãªè¤‡é›‘ãªåˆ†æã‚¯ã‚¨ãƒªã§ã¯ã€å¿…è¦ãªãƒ¢ãƒ‡ãƒ«èƒ½åŠ›ãŒç•°ãªã‚Šã¾ã™ã€‚IPRã¯ã“ã®**ã‚¯ã‚¨ãƒªè¤‡é›‘åº¦ã®åˆ†å¸ƒã‚’æ´»ç”¨**ã—ã¦ã€å˜ç´”ãªã‚¯ã‚¨ãƒªã«ã¯å®‰ä¾¡ãªãƒ¢ãƒ‡ãƒ«ã‚’ã€è¤‡é›‘ãªã‚¯ã‚¨ãƒªã«ã¯é«˜æ€§èƒ½ãƒ¢ãƒ‡ãƒ«ã‚’è‡ªå‹•ã§æŒ¯ã‚Šåˆ†ã‘ã¾ã™ã€‚

### å¯¾å¿œãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã¨åˆ¶ç´„

2026å¹´2æœˆæ™‚ç‚¹ã§å¯¾å¿œã—ã¦ã„ã‚‹ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

| ãƒ•ã‚¡ãƒŸãƒªãƒ¼ | ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å¯¾è±¡ãƒ¢ãƒ‡ãƒ« | ä¸»ãªç”¨é€” |
|-----------|---------------------|---------|
| **Anthropic** | Claude 3.5 Sonnet v2 â†” Claude 3.5 Haiku | æ±ç”¨ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã€ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ |
| **Meta Llama** | Llama 3.3 70B â†” Llama 3.1 8B | ã‚ªãƒ¼ãƒ—ãƒ³ãƒ¢ãƒ‡ãƒ«æ´»ç”¨ |
| **Amazon Nova** | Nova Pro â†” Nova Lite | AWSãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ¢ãƒ‡ãƒ« |

**åˆ¶ç´„äº‹é …:**

> IPRã¯**åŒä¸€ãƒ•ã‚¡ãƒŸãƒªãƒ¼å†…ã®2ãƒ¢ãƒ‡ãƒ«é–“ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ã¿**å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚ãŸã¨ãˆã°ã€ŒClaude Sonnet â†’ Llama 70Bã€ã®ã‚ˆã†ãªã‚¯ãƒ­ã‚¹ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚¯ãƒ­ã‚¹ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã§ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒå¿…è¦ãªå ´åˆã¯ã€LiteLLMã‚„RouteLLMãªã©ã®OSSãƒ„ãƒ¼ãƒ«ã®åˆ©ç”¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚
>
> é–¢é€£è¨˜äº‹: [LLMãƒ«ãƒ¼ã‚¿ãƒ¼å®Ÿè·µã‚¬ã‚¤ãƒ‰ï¼šRouteLLMÃ—LiteLLMã§APIã‚³ã‚¹ãƒˆ60%å‰Šæ¸›ã‚’å®Ÿç¾ã™ã‚‹](https://zenn.dev/0h_n0/articles/3e603a1b91e2e0)

ã¾ãŸã€IPRã¯**è‹±èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«æœ€é©åŒ–**ã•ã‚Œã¦ãŠã‚Šã€æ—¥æœ¬èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ã¯å…¬å¼ã«ã¯ä¿è¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç¤¾å†…RAGãŒæ—¥æœ¬èªä¸­å¿ƒã®å ´åˆã¯ã€`responseQualityDifference`ã‚’ä½ã‚ã«è¨­å®šã—ã¦å“è³ªã‚’å„ªå…ˆã™ã‚‹èª¿æ•´ãŒå¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

## ç¤¾å†…RAGã«Prompt Routerã‚’å®Ÿè£…ã™ã‚‹

ã“ã“ã‹ã‚‰ã¯ã€boto3ã‚’ä½¿ã£ã¦Bedrock Intelligent Prompt Routerã‚’æ§‹ç¯‰ã—ã€ç¤¾å†…RAGã‚·ã‚¹ãƒ†ãƒ ã«çµ„ã¿è¾¼ã‚€æ‰‹é †ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### ã‚«ã‚¹ã‚¿ãƒ Prompt Routerã®ä½œæˆ

ã¾ãšã€Anthropicãƒ•ã‚¡ãƒŸãƒªãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

```python
# router_setup.py
import boto3
from typing import Any


def create_rag_prompt_router(
    region: str = "us-east-1",
    quality_threshold: float = 0.25,
) -> dict[str, Any]:
    """
    ç¤¾å†…RAGå‘ã‘ã®ã‚«ã‚¹ã‚¿ãƒ Prompt Routerã‚’ä½œæˆã™ã‚‹ã€‚

    Args:
        region: AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³
        quality_threshold: ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å“è³ªé–¾å€¤ï¼ˆ0.0ã€œ1.0ï¼‰
            ä½ã„å€¤: Haikuã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç‡ãŒä¸ŠãŒã‚Šã‚³ã‚¹ãƒˆå‰Šæ¸›å¹…ãŒå¤§ãã„
            é«˜ã„å€¤: Sonnetã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç‡ãŒä¸ŠãŒã‚Šå“è³ªãŒå®‰å®š

    Returns:
        ä½œæˆã•ã‚ŒãŸãƒ«ãƒ¼ã‚¿ãƒ¼ã®ARNã‚’å«ã‚€ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    """
    bedrock_client = boto3.client("bedrock", region_name=region)

    response = bedrock_client.create_prompt_router(
        promptRouterName="rag-cost-optimizer",
        description="ç¤¾å†…RAGã‚·ã‚¹ãƒ†ãƒ å‘ã‘Anthropicãƒ¢ãƒ‡ãƒ«ãƒ«ãƒ¼ã‚¿ãƒ¼",
        models=[
            {
                "modelArn": (
                    f"arn:aws:bedrock:{region}::foundation-model/"
                    "anthropic.claude-3-5-sonnet-20241022-v2:0"
                ),
            },
        ],
        fallbackModel={
            "modelArn": (
                f"arn:aws:bedrock:{region}::foundation-model/"
                "anthropic.claude-3-5-haiku-20241022-v1:0"
            ),
        },
        routingCriteria={
            "responseQualityDifference": quality_threshold,
        },
        tags=[
            {"key": "project", "value": "internal-rag"},
            {"key": "environment", "value": "production"},
        ],
    )
    return response


if __name__ == "__main__":
    result = create_rag_prompt_router()
    print(f"Router ARN: {result['promptRouterArn']}")
```

**`responseQualityDifference`ã®è¨­å®šæŒ‡é‡:**

| å€¤ | Haikuãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç‡ï¼ˆç›®å®‰ï¼‰ | ç”¨é€” |
|----|--------------------------|------|
| 0.1 | ç´„50-60% | å“è³ªé‡è¦–ï¼ˆå°‚é–€æ€§ã®é«˜ã„ç¤¾å†…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰ |
| 0.25 | ç´„70-80% | ãƒãƒ©ãƒ³ã‚¹å‹ï¼ˆä¸€èˆ¬çš„ãªç¤¾å†…FAQ + æŠ€è¡“æ–‡æ›¸ï¼‰ |
| 0.5 | ç´„85-90% | ã‚³ã‚¹ãƒˆé‡è¦–ï¼ˆå¤§é‡ã®å˜ç´”å•ã„åˆã‚ã›ï¼‰ |

AWSã®å†…éƒ¨ãƒ†ã‚¹ãƒˆã§ã¯ã€`responseQualityDifference`ã‚’0.25ã«è¨­å®šã—ãŸå ´åˆã€Anthropicãƒ•ã‚¡ãƒŸãƒªãƒ¼ã§**ç´„63.6%ã®ã‚³ã‚¹ãƒˆå‰Šæ¸›**ãŒå ±å‘Šã•ã‚Œã¦ã„ã¾ã™ï¼ˆ87%ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒHaikuã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰ã€‚

### RAGãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¸ã®çµ±åˆ

ä½œæˆã—ãŸãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’ç¤¾å†…RAGãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«çµ±åˆã—ã¾ã™ã€‚ãƒ«ãƒ¼ã‚¿ãƒ¼ã¯Converse APIã®`modelId`ã«ãƒ«ãƒ¼ã‚¿ãƒ¼ARNã‚’æŒ‡å®šã™ã‚‹ã ã‘ã§åˆ©ç”¨ã§ãã¾ã™ã€‚

```python
# rag_with_router.py
import boto3
from typing import Any


class RAGWithPromptRouter:
    """Prompt Routerçµ±åˆæ¸ˆã¿ç¤¾å†…RAGã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã€‚"""

    def __init__(
        self,
        router_arn: str,
        knowledge_base_id: str,
        region: str = "us-east-1",
    ) -> None:
        self.router_arn = router_arn
        self.knowledge_base_id = knowledge_base_id
        self.runtime_client = boto3.client(
            "bedrock-agent-runtime", region_name=region
        )
        self.bedrock_runtime = boto3.client(
            "bedrock-runtime", region_name=region
        )

    def retrieve_context(self, query: str, top_k: int = 5) -> list[dict]:
        """Knowledge Baseã‹ã‚‰é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢ã™ã‚‹ã€‚"""
        response = self.runtime_client.retrieve(
            knowledgeBaseId=self.knowledge_base_id,
            retrievalQuery={"text": query},
            retrievalConfiguration={
                "vectorSearchConfiguration": {
                    "numberOfResults": top_k,
                }
            },
        )
        return [
            {
                "content": result["content"]["text"],
                "source": result.get("location", {}).get("s3Location", {}).get("uri", "N/A"),
                "score": result.get("score", 0.0),
            }
            for result in response.get("retrievalResults", [])
        ]

    def generate_answer(
        self, query: str, context_docs: list[dict]
    ) -> dict[str, Any]:
        """
        Prompt RouterçµŒç”±ã§å›ç­”ã‚’ç”Ÿæˆã™ã‚‹ã€‚

        ãƒ«ãƒ¼ã‚¿ãƒ¼ARNã‚’modelIdã«æŒ‡å®šã™ã‚‹ã ã‘ã§ã€
        ã‚¯ã‚¨ãƒªã®è¤‡é›‘ã•ã«å¿œã˜ãŸãƒ¢ãƒ‡ãƒ«è‡ªå‹•é¸æŠãŒæœ‰åŠ¹ã«ãªã‚‹ã€‚
        """
        # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ§‹é€ åŒ–
        context_text = "\n\n---\n\n".join(
            f"[å‡ºå…¸: {doc['source']}]\n{doc['content']}"
            for doc in context_docs
        )

        system_prompt = (
            "ã‚ãªãŸã¯ç¤¾å†…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«åŸºã¥ã„ã¦è³ªå•ã«å›ç­”ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚"
            "æä¾›ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã«åŸºã¥ã„ã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚"
            "ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«æƒ…å ±ãŒãªã„å ´åˆã¯ã€Œè©²å½“ã™ã‚‹æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€ã¨å›ç­”ã—ã¦ãã ã•ã„ã€‚"
        )

        response = self.bedrock_runtime.converse(
            modelId=self.router_arn,  # ãƒ«ãƒ¼ã‚¿ãƒ¼ARNã‚’æŒ‡å®š
            system=[{"text": system_prompt}],
            messages=[
                {
                    "role": "user",
                    "content": [
                        {
                            "text": (
                                f"## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ\n{context_text}\n\n"
                                f"## è³ªå•\n{query}"
                            )
                        }
                    ],
                }
            ],
            inferenceConfig={
                "maxTokens": 1024,
                "temperature": 0.1,
            },
        )

        output = response["output"]["message"]["content"][0]["text"]
        # ã©ã®ãƒ¢ãƒ‡ãƒ«ãŒé¸æŠã•ã‚ŒãŸã‹ã‚’ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
        model_id = response.get("metrics", {}).get("modelId", "unknown")
        usage = response.get("usage", {})

        return {
            "answer": output,
            "routed_model": model_id,
            "input_tokens": usage.get("inputTokens", 0),
            "output_tokens": usage.get("outputTokens", 0),
        }

    def query(self, question: str) -> dict[str, Any]:
        """æ¤œç´¢â†’å›ç­”ã®ä¸€é€£ã®RAGãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹ã€‚"""
        context_docs = self.retrieve_context(question)
        result = self.generate_answer(question, context_docs)
        result["retrieved_docs_count"] = len(context_docs)
        return result


# ä½¿ç”¨ä¾‹
if __name__ == "__main__":
    rag = RAGWithPromptRouter(
        router_arn="arn:aws:bedrock:us-east-1:123456789012:default-prompt-router/anthropic.claude-3-5",
        knowledge_base_id="YOUR_KB_ID",
    )

    result = rag.query("ç¤¾å†…ã®æœ‰çµ¦ä¼‘æš‡ã®ç”³è«‹æ‰‹é †ã‚’æ•™ãˆã¦ãã ã•ã„")
    print(f"å›ç­”: {result['answer']}")
    print(f"ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«: {result['routed_model']}")
    print(f"å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³: {result['input_tokens']}")
    print(f"å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³: {result['output_tokens']}")
```

**ãƒã‚¤ãƒ³ãƒˆ**: `modelId`ã«ãƒ«ãƒ¼ã‚¿ãƒ¼ARNã‚’æŒ‡å®šã™ã‚‹ã ã‘ã§ã€æ—¢å­˜ã®Converse APIã‚³ãƒ¼ãƒ‰ã‚’ã»ã¼å¤‰æ›´ãªã—ã«ãƒ«ãƒ¼ã‚¿ãƒ¼å¯¾å¿œã§ãã¾ã™ã€‚ã“ã‚ŒãŒIPRã®å¤§ããªåˆ©ç‚¹ã§ã™ã€‚

**æ³¨æ„ç‚¹:**

> ãƒ«ãƒ¼ã‚¿ãƒ¼ARNã®å½¢å¼ã¯ `arn:aws:bedrock:{region}:{account-id}:default-prompt-router/{router-name}` ã§ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ã†å ´åˆã¯ `arn:aws:bedrock:{region}::default-prompt-router/anthropic.claude` ã®ã‚ˆã†ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDãªã—ã®å½¢å¼ã«ãªã‚Šã¾ã™ã€‚ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ã‚¿ãƒ¼ã®å ´åˆã¯ `create_prompt_router` ã®æˆ»ã‚Šå€¤ã«å«ã¾ã‚Œã‚‹ARNã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚

### ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°çµæœã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

é‹ç”¨ã§ã¯ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ¯”ç‡ã¨ã‚³ã‚¹ãƒˆå‰Šæ¸›åŠ¹æœã®å¯è¦–åŒ–ãŒé‡è¦ã§ã™ã€‚Converse APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã¯ã©ã®ãƒ¢ãƒ‡ãƒ«ãŒå‡¦ç†ã—ãŸã‹ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã‚‹ãŸã‚ã€ã“ã‚Œã‚’é›†è¨ˆã—ã¦CloudWatchã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã«é€£æºã—ã¾ã™ã€‚

```python
# monitor_routing.py
from collections import Counter
from dataclasses import dataclass, field


# 2026å¹´2æœˆæ™‚ç‚¹ã®Bedrock On-Demandæ–™é‡‘ï¼ˆus-east-1, $/1Kãƒˆãƒ¼ã‚¯ãƒ³ï¼‰
PRICING = {
    "anthropic.claude-3-5-sonnet-20241022-v2:0": {"input": 0.003, "output": 0.015},
    "anthropic.claude-3-5-haiku-20241022-v1:0": {"input": 0.0008, "output": 0.004},
}


@dataclass
class RoutingMetrics:
    """ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°çµæœã‚’é›†è¨ˆã—ã€ã‚³ã‚¹ãƒˆå‰Šæ¸›ç‡ã‚’ç®—å‡ºã™ã‚‹ã€‚"""

    model_counts: Counter = field(default_factory=Counter)
    token_usage: dict[str, dict[str, int]] = field(default_factory=dict)

    def record(self, model: str, input_tokens: int, output_tokens: int) -> None:
        self.model_counts[model] += 1
        usage = self.token_usage.setdefault(model, {"input": 0, "output": 0})
        usage["input"] += input_tokens
        usage["output"] += output_tokens

    def savings_rate(self) -> float:
        """Sonnetã®ã¿ä½¿ç”¨æ™‚ã¨æ¯”è¼ƒã—ãŸã‚³ã‚¹ãƒˆå‰Šæ¸›ç‡ï¼ˆ%ï¼‰ã‚’è¿”ã™ã€‚"""
        actual = sum(
            (u["input"] / 1000) * PRICING.get(m, PRICING[list(PRICING)[0]])["input"]
            + (u["output"] / 1000) * PRICING.get(m, PRICING[list(PRICING)[0]])["output"]
            for m, u in self.token_usage.items()
        )
        sonnet = PRICING["anthropic.claude-3-5-sonnet-20241022-v2:0"]
        baseline = sum(
            (u["input"] / 1000) * sonnet["input"]
            + (u["output"] / 1000) * sonnet["output"]
            for u in self.token_usage.values()
        )
        return (1 - actual / baseline) * 100 if baseline > 0 else 0
```

CloudWatché€£æºã«ã‚ˆã‚Šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã®å¯è¦–åŒ–ã‚„ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šã‚‚å¯èƒ½ã§ã™ã€‚

## 3å±¤ã‚³ã‚¹ãƒˆæœ€é©åŒ–æˆ¦ç•¥ã‚’è¨­è¨ˆã™ã‚‹

IPRå˜ä½“ã§ã‚‚æœ‰åŠ¹ã§ã™ãŒã€BedrockãŒæä¾›ã™ã‚‹ä»–ã®ã‚³ã‚¹ãƒˆæœ€é©åŒ–æ©Ÿèƒ½ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ã•ã‚‰ã«å¤§ããªå‰Šæ¸›åŠ¹æœãŒæœŸå¾…ã§ãã¾ã™ã€‚ã“ã“ã§ã¯**Intelligent Prompt Routing + Cross-Region Inference + Model Distillation**ã®3å±¤æˆ¦ç•¥ã‚’è¨­è¨ˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å½¹å‰²ã¨æœŸå¾…åŠ¹æœ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Layer 3: Model Distillation                 â”‚
â”‚   è’¸ç•™ãƒ¢ãƒ‡ãƒ«ã§æ¨è«–ã‚³ã‚¹ãƒˆ75%å‰Šæ¸›ãƒ»é€Ÿåº¦500%å‘ä¸Š        â”‚
â”‚   ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ç‰¹åŒ–ã®è»½é‡ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆï¼‰                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Layer 2: Cross-Region Inference             â”‚
â”‚   è¿½åŠ ã‚³ã‚¹ãƒˆãªã—ã§ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆå‘ä¸Š                    â”‚
â”‚   ï¼ˆãƒªãƒ¼ã‚¸ãƒ§ãƒ³é–“ã®è² è·åˆ†æ•£ã§å¾…ã¡æ™‚é–“å‰Šæ¸›ï¼‰            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Layer 1: Intelligent Prompt Routing          â”‚
â”‚   ã‚¯ã‚¨ãƒªè¤‡é›‘åº¦ã«å¿œã˜ãŸãƒ¢ãƒ‡ãƒ«è‡ªå‹•é¸æŠ                 â”‚
â”‚   ï¼ˆæœ€å¤§63.6%ã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | æ©Ÿèƒ½ | æœŸå¾…ã‚³ã‚¹ãƒˆå‰Šæ¸› | å°å…¥é›£æ˜“åº¦ |
|---------|------|--------------|-----------|
| **Layer 1: IPR** | ã‚¯ã‚¨ãƒªâ†’ãƒ¢ãƒ‡ãƒ«è‡ªå‹•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° | æœ€å¤§30-63.6% | ä½ï¼ˆAPIè¨­å®šã®ã¿ï¼‰ |
| **Layer 2: Cross-Region** | ãƒªãƒ¼ã‚¸ãƒ§ãƒ³é–“è² è·åˆ†æ•£ | è¿½åŠ ã‚³ã‚¹ãƒˆãªã—ï¼ˆã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆå‘ä¸Šï¼‰ | ä½ï¼ˆinference profileè¨­å®šï¼‰ |
| **Layer 3: Distillation** | ãƒ‰ãƒ¡ã‚¤ãƒ³ç‰¹åŒ–è’¸ç•™ãƒ¢ãƒ‡ãƒ«ä½œæˆ | æœ€å¤§75% | ä¸­ã€œé«˜ï¼ˆå­¦ç¿’ãƒ‡ãƒ¼ã‚¿æº–å‚™ãŒå¿…è¦ï¼‰ |

### Layer 2: Cross-Region Inferenceã®çµ„ã¿è¾¼ã¿

Cross-Region Inferenceã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æœ€é©ãªãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«è‡ªå‹•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚**è¿½åŠ ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚³ã‚¹ãƒˆã¯ä¸è¦**ã§ã€å…ƒã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®æ–™é‡‘ãŒãã®ã¾ã¾é©ç”¨ã•ã‚Œã¾ã™ã€‚

```python
# cross_region_setup.py
import boto3


def setup_cross_region_inference(region: str = "us-east-1") -> str:
    """
    Cross-Region Inferenceãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

    æ¨è«–ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ARNã‚’modelIdã«æŒ‡å®šã™ã‚‹ã ã‘ã§ã€
    Amazon BedrockãŒæœ€é©ãªãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è‡ªå‹•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹ã€‚
    """
    # USåœ°åŸŸã®cross-region inference profileã‚’ä½¿ç”¨
    # å¯¾å¿œãƒªãƒ¼ã‚¸ãƒ§ãƒ³: us-east-1, us-east-2, us-west-2 é–“ã§è‡ªå‹•è² è·åˆ†æ•£
    cross_region_model_id = (
        "us.anthropic.claude-3-5-sonnet-20241022-v2:0"  # "us."ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§æœ‰åŠ¹åŒ–
    )

    bedrock_runtime = boto3.client("bedrock-runtime", region_name=region)

    # Cross-Region Inferenceã¯ãƒ¢ãƒ‡ãƒ«æŒ‡å®šæ™‚ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§æœ‰åŠ¹åŒ–
    response = bedrock_runtime.converse(
        modelId=cross_region_model_id,
        messages=[
            {
                "role": "user",
                "content": [{"text": "ãƒ†ã‚¹ãƒˆ: Cross-Region Inferenceã®å‹•ä½œç¢ºèª"}],
            }
        ],
        inferenceConfig={"maxTokens": 100},
    )

    return response["output"]["message"]["content"][0]["text"]
```

ç¤¾å†…RAGã§ã¯æ¥­å‹™æ™‚é–“å¸¯ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé›†ä¸­ã—ã€å˜ä¸€ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ãŒç™ºç”Ÿã—ãŒã¡ã§ã™ã€‚Cross-Region Inferenceã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ã§**ãƒ”ãƒ¼ã‚¯æ™‚ã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ã‚’å›é¿**ã§ãã¾ã™ã€‚

> **ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•:** ãƒ‡ãƒ¼ã‚¿ãŒãƒªãƒ¼ã‚¸ãƒ§ãƒ³é–“ã‚’ç§»å‹•ã™ã‚‹ãŸã‚ã€**ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¸ãƒ‡ãƒ³ã‚·ãƒ¼è¦ä»¶ãŒå³æ ¼ãªå ´åˆã¯åˆ©ç”¨ã§ãã¾ã›ã‚“**ã€‚Geographic inference profileã§ã€USå†…ãƒ»EUå†…ãªã©ç‰¹å®šã®åœ°åŸŸå†…ã«é™å®šã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

### Layer 3: Model Distillationã®æ´»ç”¨

Model Distillationã¯ã€é«˜æ€§èƒ½ãªæ•™å¸«ãƒ¢ãƒ‡ãƒ«ï¼ˆä¾‹: Claude Sonnetï¼‰ã®çŸ¥è­˜ã‚’è»½é‡ãªç”Ÿå¾’ãƒ¢ãƒ‡ãƒ«ï¼ˆä¾‹: Claude Haikuï¼‰ã«è’¸ç•™ã—ã€**ãƒ‰ãƒ¡ã‚¤ãƒ³ç‰¹åŒ–ã®é«˜ç²¾åº¦ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆ**ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚

```python
# distillation_setup.py
import boto3


def create_distillation_job(
    training_data_s3_uri: str,
    region: str = "us-east-1",
) -> dict:
    """
    Bedrock Model Distillationã‚¸ãƒ§ãƒ–ã‚’ä½œæˆã™ã‚‹ã€‚
    æ•™å¸«ãƒ¢ãƒ‡ãƒ«ï¼ˆSonnetï¼‰â†’ç”Ÿå¾’ãƒ¢ãƒ‡ãƒ«ï¼ˆHaikuï¼‰ã®è’¸ç•™ã€‚
    å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¯SonnetãŒå‡¦ç†ã—ãŸéå»RAGãƒ­ã‚°ï¼ˆJSONLå½¢å¼ï¼‰ã‚’S3ã«é…ç½®ã€‚
    """
    bedrock_client = boto3.client("bedrock", region_name=region)

    response = bedrock_client.create_model_customization_job(
        jobName="rag-domain-distillation",
        customModelName="rag-distilled-haiku",
        roleArn="arn:aws:iam::123456789012:role/BedrockDistillationRole",
        baseModelIdentifier="anthropic.claude-3-5-haiku-20241022-v1:0",
        trainingDataConfig={"s3Uri": training_data_s3_uri},
        customizationType="DISTILLATION",
        hyperParameters={
            "epochCount": "3",
            "batchSize": "16",
            "learningRate": "0.0001",
        },
    )
    return response
```

å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¯SonnetãŒå‡¦ç†ã—ãŸé«˜å“è³ªãªå›ç­”ãƒ­ã‚°ï¼ˆprompt/completionã®JSONLå½¢å¼ï¼‰ã‚’S3ã«é…ç½®ã—ã¾ã™ã€‚Bedrockã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ã¿æä¾›ã™ã‚Œã°æ•™å¸«ãƒ¢ãƒ‡ãƒ«ã§åˆæˆãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹æ©Ÿèƒ½ã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

AWSã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ã€è’¸ç•™ãƒ¢ãƒ‡ãƒ«ã¯**å…ƒã®ãƒ¢ãƒ‡ãƒ«ã¨æ¯”è¼ƒã—ã¦æœ€å¤§500%é«˜é€Ÿã§ã€ã‚³ã‚¹ãƒˆã¯æœ€å¤§75%å‰Šæ¸›**ã•ã‚Œã‚‹ã¨å ±å‘Šã•ã‚Œã¦ã„ã¾ã™ã€‚RAGã®ã‚ˆã†ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯ç²¾åº¦ä½ä¸‹ã‚‚2%æœªæº€ã«æŠ‘ãˆã‚‰ã‚Œã‚‹ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

**æœ€åˆã‹ã‚‰Distillationã‚’å°å…¥ã™ã¹ãã‹:**

> Model Distillationã¯å¼·åŠ›ã§ã™ãŒã€å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ã¨ã‚¸ãƒ§ãƒ–å®Ÿè¡Œã«ã‚³ã‚¹ãƒˆã¨æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚ã¾ãšã¯Layer 1ï¼ˆIPRï¼‰ã ã‘ã§åŠ¹æœã‚’æ¸¬å®šã—ã€ååˆ†ãªéå»ãƒ­ã‚°ãŒè“„ç©ã•ã‚ŒãŸæ®µéšã§Distillationã«é€²ã‚€ã®ãŒç¾å®Ÿçš„ã§ã™ã€‚ç›®å®‰ã¨ã—ã¦ã€**SonnetãŒå‡¦ç†ã—ãŸé«˜å“è³ªãªå›ç­”ãƒ­ã‚°ãŒ5,000ä»¶ä»¥ä¸Š**ãŸã¾ã£ã¦ã‹ã‚‰æ¤œè¨ã™ã‚‹ã®ãŒã‚ˆã„ã§ã—ã‚‡ã†ã€‚

## ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

ç¤¾å†…RAGã«IPRã‚’å°å…¥ã™ã‚‹éš›ã«é­é‡ã—ã‚„ã™ã„å•é¡Œã¨å¯¾å‡¦æ³•ã‚’æ•´ç†ã—ã¾ã™ã€‚

| å•é¡Œ | åŸå›  | è§£æ±ºæ–¹æ³• |
|------|------|----------|
| ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ¯”ç‡ãŒHaikuã«åã‚Šã™ãã‚‹ | `responseQualityDifference`ãŒå¤§ãã™ãã‚‹ | å€¤ã‚’0.1ã€œ0.15ã«ä¸‹ã’ã¦å“è³ªå„ªå…ˆã«èª¿æ•´ |
| æ—¥æœ¬èªã‚¯ã‚¨ãƒªã®å›ç­”å“è³ªãŒä½ä¸‹ | IPRã®è‹±èªæœ€é©åŒ–ã«ã‚ˆã‚‹å½±éŸ¿ | `responseQualityDifference`ã‚’0.1ã«è¨­å®šã—ã€Sonnetã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç‡ã‚’ä¸Šã’ã‚‹ |
| ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ãŒé »ç™º | å˜ä¸€ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®å®¹é‡åˆ¶é™ | Cross-Region Inferenceã‚’æœ‰åŠ¹åŒ–ï¼ˆ`us.`ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹è¿½åŠ ï¼‰ |
| ã‚³ã‚¹ãƒˆå‰Šæ¸›åŠ¹æœãŒæœŸå¾…ã‚ˆã‚Šå°ã•ã„ | è¤‡é›‘ãªã‚¯ã‚¨ãƒªã®æ¯”ç‡ãŒé«˜ã„ | ã‚¯ã‚¨ãƒªã®å‰å‡¦ç†ï¼ˆè¦ç´„ãƒ»åˆ†å‰²ï¼‰ã‚’è¿½åŠ ã—ã¦Haikuãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç‡ã‚’å‘ä¸Š |
| `ValidationException`ãŒç™ºç”Ÿ | ãƒ¢ãƒ‡ãƒ«ARNã®å½¢å¼ãŒä¸æ­£ | ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã¨ãƒ¢ãƒ‡ãƒ«IDã‚’ç¢ºèªã€`list_foundation_models`ã§æœ‰åŠ¹ãªãƒ¢ãƒ‡ãƒ«ã‚’ç¢ºèª |
| ãƒ«ãƒ¼ã‚¿ãƒ¼ã®ä½œæˆã«å¤±æ•— | åŒåã®ãƒ«ãƒ¼ã‚¿ãƒ¼ãŒæ—¢å­˜ | `list_prompt_routers`ã§ç¢ºèªã—ã€æ—¢å­˜ã®ã‚‚ã®ã‚’`delete_prompt_router`ã§å‰Šé™¤å¾Œã«å†ä½œæˆ |

### Default Router vs Custom Routerã®ä½¿ã„åˆ†ã‘

IPRã«ã¯**Default Routerï¼ˆäº‹å‰è¨­å®šæ¸ˆã¿ï¼‰**ã¨**Custom Routerï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šï¼‰**ã®2ç¨®é¡ãŒã‚ã‚Šã¾ã™ã€‚

```python
# ãƒ«ãƒ¼ã‚¿ãƒ¼ã®é¸æŠä¾‹
import boto3


def list_available_routers(region: str = "us-east-1") -> list[dict]:
    """åˆ©ç”¨å¯èƒ½ãªãƒ«ãƒ¼ã‚¿ãƒ¼ã®ä¸€è¦§ã‚’å–å¾—ã™ã‚‹ã€‚"""
    bedrock_client = boto3.client("bedrock", region_name=region)
    response = bedrock_client.list_prompt_routers()
    return [
        {
            "name": router["promptRouterName"],
            "arn": router["promptRouterArn"],
            "type": router.get("type", "CUSTOM"),
            "models": router.get("models", []),
        }
        for router in response.get("promptRouterSummaries", [])
    ]
```

**ä½¿ã„åˆ†ã‘ã®åˆ¤æ–­åŸºæº–:**

- **Default Router**: æ¤œè¨¼æ®µéšã€è‹±èªä¸­å¿ƒã®ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã€è¿…é€Ÿãªå°å…¥ãŒå¿…è¦ãªå ´åˆ
- **Custom Router**: æœ¬ç•ªé‹ç”¨ã€`responseQualityDifference`ã®ç´°ã‹ã„èª¿æ•´ãŒå¿…è¦ãªå ´åˆã€æ—¥æœ¬èªãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰

## ã¾ã¨ã‚ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

**ã¾ã¨ã‚:**

- **Bedrock Intelligent Prompt Routing**ã¯ã€åŒä¸€ãƒ•ã‚¡ãƒŸãƒªãƒ¼å†…ã®2ãƒ¢ãƒ‡ãƒ«é–“ã§ã‚¯ã‚¨ãƒªè¤‡é›‘åº¦ã«å¿œã˜ãŸè‡ªå‹•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¡Œã„ã€AWSã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã§ã¯Anthropicãƒ•ã‚¡ãƒŸãƒªãƒ¼ã§**å¹³å‡63.6%ã®ã‚³ã‚¹ãƒˆå‰Šæ¸›**ãŒå ±å‘Šã•ã‚Œã¦ã„ã‚‹
- `create_prompt_router` APIã§`responseQualityDifference`ã‚’èª¿æ•´ã™ã‚‹ã“ã¨ã§ã€**å“è³ªã¨ã‚³ã‚¹ãƒˆã®ãƒãƒ©ãƒ³ã‚¹ã‚’æŸ”è»Ÿã«åˆ¶å¾¡**ã§ãã‚‹
- **Cross-Region Inference**ï¼ˆè¿½åŠ ã‚³ã‚¹ãƒˆãªã—ï¼‰ã¨**Model Distillation**ï¼ˆæœ€å¤§75%ã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰ã‚’çµ„ã¿åˆã‚ã›ãŸ3å±¤æˆ¦ç•¥ã§ã€ã•ã‚‰ãªã‚‹æœ€é©åŒ–ãŒå¯èƒ½
- åˆ¶ç´„ã¨ã—ã¦ã€**ã‚¯ãƒ­ã‚¹ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°éå¯¾å¿œ**ã€**è‹±èªæœ€é©åŒ–**ã€**2ãƒ¢ãƒ‡ãƒ«é–“ã®ã¿**ã®åˆ¶é™ãŒã‚ã‚‹
- å°å…¥ã¯Converse APIã®`modelId`ã‚’ãƒ«ãƒ¼ã‚¿ãƒ¼ARNã«å¤‰æ›´ã™ã‚‹ã ã‘ã§ã€**æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ã¯æœ€å°é™**

**æ¬¡ã«ã‚„ã‚‹ã¹ãã“ã¨:**

- Default Routerã§ç¤¾å†…RAGã®ä¸€éƒ¨ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’è©¦é¨“çš„ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã—ã€ã‚³ã‚¹ãƒˆå‰Šæ¸›åŠ¹æœã‚’è¨ˆæ¸¬ã™ã‚‹
- `responseQualityDifference`ã‚’æ®µéšçš„ã«èª¿æ•´ï¼ˆ0.1â†’0.25â†’0.5ï¼‰ã—ã€å“è³ªå½±éŸ¿ã‚’è©•ä¾¡ã™ã‚‹
- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’CloudWatchãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«çµ±åˆã—ã€ãƒ¢ãƒ‡ãƒ«é¸æŠæ¯”ç‡ã‚’ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹

## å‚è€ƒ

- [Amazon Bedrock Intelligent Prompt Routing å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/bedrock/latest/userguide/prompt-routing.html)
- [Amazon Bedrock Intelligent Prompt Routing è£½å“ãƒšãƒ¼ã‚¸](https://aws.amazon.com/bedrock/intelligent-prompt-routing/)
- [CreatePromptRouter API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://docs.aws.amazon.com/bedrock/latest/APIReference/API_CreatePromptRouter.html)
- [Effective cost optimization strategies for Amazon Bedrock](https://aws.amazon.com/blogs/machine-learning/effective-cost-optimization-strategies-for-amazon-bedrock/)
- [Amazon Bedrock Cross-Region Inference](https://docs.aws.amazon.com/bedrock/latest/userguide/cross-region-inference.html)
- [Amazon Bedrock Model Distillation ã‚¬ã‚¤ãƒ‰](https://docs.aws.amazon.com/bedrock/latest/userguide/model-distillation.html)
- [Amazon Bedrock AgentCore](https://aws.amazon.com/bedrock/agentcore/)
- [Amazon Bedrock Cost Optimization](https://aws.amazon.com/bedrock/cost-optimization/)

## é–¢é€£ã™ã‚‹æ·±æ˜ã‚Šè¨˜äº‹

ã“ã®è¨˜äº‹ã§ç´¹ä»‹ã—ãŸæŠ€è¡“ã«ã¤ã„ã¦ã€ã•ã‚‰ã«æ·±æ˜ã‚Šã—ãŸè¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸï¼š

- [è«–æ–‡è§£èª¬: RouteLLM â€” é¸å¥½ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãLLMãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ã‚³ã‚¹ãƒˆ85%å‰Šæ¸›](https://0h-n0.github.io/posts/paper-2406-18665-routellm/) - arXivè«–æ–‡è§£èª¬
- [AWSå…¬å¼ãƒ–ãƒ­ã‚°è§£èª¬: Bedrock IPRã®ã‚³ã‚¹ãƒˆãƒ»ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·æœ€é©åŒ–æˆ¦ç•¥](https://0h-n0.github.io/posts/techblog-aws-bedrock-intelligent-prompt-routing/) - tech_blogè§£èª¬
- [è«–æ–‡è§£èª¬: FrugalGPT â€” ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‹LLMãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ã‚³ã‚¹ãƒˆ98%å‰Šæ¸›](https://0h-n0.github.io/posts/paper-2305-05176-frugalgpt/) - arXivè«–æ–‡è§£èª¬
- [NeurIPS 2024è«–æ–‡è§£èª¬: Minitron â€” LLMãƒ—ãƒ«ãƒ¼ãƒ‹ãƒ³ã‚°+çŸ¥è­˜è’¸ç•™](https://0h-n0.github.io/posts/conf-neurips2024-compact-lm-distillation/) - conferenceè«–æ–‡è§£èª¬
- [NVIDIA Developer Blogè§£èª¬: AI Blueprint for Cost-Efficient LLM Routing](https://0h-n0.github.io/posts/techblog-nvidia-llm-routing-blueprint/) - tech_blogè§£èª¬

:::message
ã“ã‚Œã‚‰ã®è¨˜äº‹ã¯ä¿®å£«å­¦ç”Ÿãƒ¬ãƒ™ãƒ«ã‚’æƒ³å®šã—ãŸæŠ€è¡“çš„è©³ç´°ï¼ˆæ•°å¼ãƒ»å®Ÿè£…ã®æ·±æ˜ã‚Šï¼‰ã‚’å«ã¿ã¾ã™ã€‚
:::

---

:::message
ã“ã®è¨˜äº‹ã¯AIï¼ˆClaude Codeï¼‰ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å†…å®¹ã®æ­£ç¢ºæ€§ã«ã¤ã„ã¦ã¯è¤‡æ•°ã®æƒ…å ±æºã§æ¤œè¨¼ã—ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã®åˆ©ç”¨æ™‚ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚ã”ç¢ºèªãã ã•ã„ã€‚
:::
