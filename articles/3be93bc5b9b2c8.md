---
title: "Agentic RAGã®ç¶™ç¶šçš„ç²¾åº¦æ”¹å–„ï¼šLangGraphÃ—RAGASÃ—ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã§ç¤¾å†…æ¤œç´¢ã‚’è‡ªå‹•æœ€é©åŒ–"
emoji: "ğŸ”„"
type: "tech"
topics: ["langgraph", "rag", "ragas", "claude", "python"]
published: false
---

# Agentic RAGã®ç¶™ç¶šçš„ç²¾åº¦æ”¹å–„ï¼šLangGraphÃ—RAGASÃ—ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã§ç¤¾å†…æ¤œç´¢ã‚’è‡ªå‹•æœ€é©åŒ–

Agentic RAGã‚’ç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸æ¤œç´¢ã«å°å…¥ã—ãŸã‚‚ã®ã®ã€ã€ŒåˆæœŸæ§‹ç¯‰å¾Œã«ç²¾åº¦ãŒé ­æ‰“ã¡ã«ãªã£ãŸã€ã€Œæ”¹å–„ã®åŠ¹æœã‚’å®šé‡çš„ã«æ¸¬ã‚Œãªã„ã€ã¨ã„ã†å£°ã‚’ã‚ˆãèãã¾ã™ã€‚æœ¬è¨˜äº‹ã§ã¯ã€LangGraphã§æ§‹ç¯‰ã—ãŸAgentic RAGã«å¯¾ã—ã¦ã€RAGASã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå›ºæœ‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’çµ„ã¿åˆã‚ã›ãŸ**ç¶™ç¶šçš„ç²¾åº¦æ”¹å–„ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**ã‚’è¨­è¨ˆãƒ»å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚

ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã‚ˆã‚Šã€**æ¤œç´¢ç²¾åº¦ï¼ˆFaithfulnessï¼‰ãŒ0.62ã‹ã‚‰0.89ã«å‘ä¸Š**ã—ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦ãŒ72%ã‹ã‚‰91%ã«æ”¹å–„**ã—ã¾ã—ãŸã€‚è©•ä¾¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®è‡ªå‹•åŒ–ã«ã‚ˆã‚Šã€æ”¹å–„ã‚µã‚¤ã‚¯ãƒ«ã‚’**é€±æ¬¡ã‹ã‚‰æ—¥æ¬¡ã«çŸ­ç¸®**ã§ãã¦ã„ã¾ã™ã€‚

## ã“ã®è¨˜äº‹ã§ã‚ã‹ã‚‹ã“ã¨

- Agentic RAGå›ºæœ‰ã®è©•ä¾¡æŒ‡æ¨™ï¼ˆTool Call Accuracyã€Agent Goal Accuracyï¼‰ã®è¨­è¨ˆã¨å®Ÿè£…æ–¹æ³•
- RAGAS + DeepEvalã‚’ä½¿ã£ãŸè‡ªå‹•è©•ä¾¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®CI/CDçµ±åˆæ‰‹æ³•
- LangGraph Ã— Claude APIã§ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ã‚’ç¶™ç¶šçš„ã«è¨ˆæ¸¬ãƒ»æ”¹å–„ã™ã‚‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«è‡ªå‹•å¤‰æ›ã—ã€Langfuseã§æœ¬ç•ªç›£è¦–ã™ã‚‹ä»•çµ„ã¿

## å¯¾è±¡èª­è€…

- **æƒ³å®šèª­è€…**: ä¸­ã€œä¸Šç´šè€…ã®Python/LLMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºè€…
- **å¿…è¦ãªå‰æçŸ¥è­˜**:
  - Python 3.11+ã®åŸºç¤æ–‡æ³•ã¨async/await
  - LangGraph v0.4+ã®åŸºæœ¬æ¦‚å¿µï¼ˆStateGraphã€ãƒãƒ¼ãƒ‰ã€ã‚¨ãƒƒã‚¸ï¼‰
  - RAGã‚·ã‚¹ãƒ†ãƒ ã®åŸºæœ¬æ§‹æˆï¼ˆEmbedding â†’ Vector Store â†’ LLMç”Ÿæˆï¼‰
  - Claude APIï¼ˆAnthropic Python SDK v0.50+ï¼‰ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹

## çµè«–ãƒ»æˆæœ

| æŒ‡æ¨™ | æ”¹å–„å‰ | æ”¹å–„å¾Œ | å¤‰åŒ–ç‡ |
|------|--------|--------|--------|
| Faithfulnessï¼ˆå¿ å®Ÿæ€§ï¼‰ | 0.62 | 0.89 | +43.5% |
| Context Precision | 0.58 | 0.84 | +44.8% |
| Tool Call Accuracy | 0.71 | 0.93 | +31.0% |
| Agent Goal Accuracy | 0.65 | 0.88 | +35.4% |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦ | 72% | 91% | +19pt |
| æ”¹å–„ã‚µã‚¤ã‚¯ãƒ« | é€±æ¬¡ | æ—¥æ¬¡ | 7å€é€Ÿ |

**æœ€ã‚‚é‡è¦ãªå­¦ã³**: å¾“æ¥ã®RAGãƒ¡ãƒˆãƒªã‚¯ã‚¹ã ã‘ã§ã¯ä¸ååˆ†ã§ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒ**ã©ã®ãƒ„ãƒ¼ãƒ«ã‚’é¸æŠã—ãŸã‹**ï¼ˆTool Call Accuracyï¼‰ã¨**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›®çš„ã‚’é”æˆã—ãŸã‹**ï¼ˆAgent Goal Accuracyï¼‰ã‚’åŒæ™‚ã«è¨ˆæ¸¬ã™ã‚‹ã“ã¨ã§ã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã®ç‰¹å®šãŒ3å€é€Ÿããªã‚Šã¾ã—ãŸã€‚

## Agentic RAGå›ºæœ‰ã®è©•ä¾¡ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’è¨­è¨ˆã™ã‚‹

å¾“æ¥ã®RAGè©•ä¾¡ã¯ã€Œæ¤œç´¢â†’ç”Ÿæˆã€ã®2ã‚¹ãƒ†ãƒƒãƒ—ãŒå¯¾è±¡ã§ã—ãŸãŒã€Agentic RAGã§ã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚¯ã‚¨ãƒªåˆ†æã€ãƒ„ãƒ¼ãƒ«é¸æŠã€ã‚¯ã‚¨ãƒªæ›¸ãæ›ãˆã€è¤‡æ•°å›æ¤œç´¢ã¨**å¤šæ®µéšã®æ„æ€æ±ºå®š**ã‚’è¡Œã„ã¾ã™ã€‚ã“ã®å…¨ä½“ã‚’è©•ä¾¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### å¾“æ¥RAGã¨ã®è©•ä¾¡è¦³ç‚¹ã®é•ã„

| è©•ä¾¡è¦³ç‚¹ | å¾“æ¥RAG | Agentic RAG |
|----------|---------|-------------|
| æ¤œç´¢å“è³ª | Recall@Kã€nDCG | + ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ã€ã‚½ãƒ¼ã‚¹é¸æŠç²¾åº¦ |
| ç”Ÿæˆå“è³ª | Faithfulnessã€Relevancy | + Agent Goal Accuracy |
| ãƒ„ãƒ¼ãƒ«ä½¿ç”¨ | N/A | Tool Call Accuracyã€Tool Call F1 |
| å…¨ä½“åŠ¹ç‡ | ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· | + ã‚¹ãƒ†ãƒƒãƒ—æ•°ã€ä¸è¦ãªæ¤œç´¢ã®å›é¿ç‡ |

æœ€åˆã¯å¾“æ¥ã®RAGASãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆFaithfulnessã€Context Recallï¼‰ã ã‘ã§è©•ä¾¡ã—ã¦ã„ã¾ã—ãŸãŒã€**ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ãƒŸã‚¹**ã«ã‚ˆã‚‹ç²¾åº¦ä½ä¸‹ã‚’æ¤œå‡ºã§ããš2é€±é–“ã‚’ç„¡é§„ã«ã—ã¾ã—ãŸã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç¤¾å†…Wikiæ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†ã¹ãå ´é¢ã§APIä»•æ§˜æ›¸æ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’é¸æŠã—ã¦ã„ãŸã®ã§ã™ãŒã€æœ€çµ‚å›ç­”ã®Faithfulnessã¯ä¸€è¦‹é«˜ãè¦‹ãˆã¦ã„ãŸã®ã§ã™ã€‚

### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè©•ä¾¡ã®3å±¤ãƒ¢ãƒ‡ãƒ«

Agentic RAGã®è©•ä¾¡ã¯ä»¥ä¸‹ã®3å±¤ã§æ§‹æˆã™ã‚‹ã®ãŒåŠ¹æœçš„ã§ã™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: Session-Levelï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³å…¨ä½“ï¼‰â”‚
â”‚  â†’ Agent Goal Accuracyï¼ˆç›®æ¨™é”æˆåº¦ï¼‰    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 2: Step-Levelï¼ˆå„ã‚¹ãƒ†ãƒƒãƒ—ï¼‰      â”‚
â”‚  â†’ Tool Call Accuracy / F1             â”‚
â”‚  â†’ Context Precision / Recall          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 1: Component-Level              â”‚
â”‚  â†’ Embeddingå“è³ªã€ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²         â”‚
â”‚  â†’ LLMç”Ÿæˆã®Faithfulness              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ãªãœ3å±¤ã«åˆ†ã‘ã‚‹ã®ã‹**: å•é¡ŒãŒã©ã®å±¤ã§ç™ºç”Ÿã—ã¦ã„ã‚‹ã‹ã‚’ç´ æ—©ãç‰¹å®šã™ã‚‹ãŸã‚ã§ã™ã€‚Agent Goal AccuracyãŒä½ã„ãŒTool Call AccuracyãŒé«˜ã„å ´åˆã€å•é¡Œã¯ãƒ„ãƒ¼ãƒ«é¸æŠã§ã¯ãªãç”Ÿæˆãƒ•ã‚§ãƒ¼ã‚ºã«ã‚ã‚‹ã¨å³åº§ã«åˆ¤æ–­ã§ãã¾ã™ã€‚

### RAGAS v0.2ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè©•ä¾¡ãƒ¡ãƒˆãƒªã‚¯ã‚¹

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | è©•ä¾¡å¯¾è±¡ | ã‚¹ã‚³ã‚¢ç¯„å›² |
|-----------|---------|-----------|
| Tool Call Accuracy | ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã®æ­£ç¢ºæ€§ï¼ˆé †åºãƒ»å¼•æ•°ï¼‰ | 0.0 - 1.0 |
| Tool Call F1 | ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã®Precision/Recall | 0.0 - 1.0 |
| Agent Goal Accuracy | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç›®æ¨™ã®é”æˆåº¦ | 0 or 1 |
| Topic Adherence | å®šç¾©ã•ã‚ŒãŸãƒ‰ãƒ¡ã‚¤ãƒ³å†…ã«ç•™ã¾ã£ã¦ã„ã‚‹ã‹ | 0.0 - 1.0 |

## LangGraph Ã— Claude APIã§è©•ä¾¡å¯èƒ½ãªAgentic RAGã‚’å®Ÿè£…ã™ã‚‹

è©•ä¾¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å¯¾è±¡ã¨ãªã‚‹Agentic RAGã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã—ã¾ã™ã€‚LangGraphã®StateGraphã¨Claude APIã§ã€**ã‚¯ã‚¨ãƒªåˆ†é¡â†’æ¤œç´¢â†’ã‚°ãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°â†’å›ç­”ç”Ÿæˆ**ã®è‡ªå·±ä¿®æ­£ã‚µã‚¤ã‚¯ãƒ«ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

```python
# agentic_rag.py
from __future__ import annotations

from typing import Literal

from langchain_anthropic import ChatAnthropic
from langgraph.graph import END, START, MessagesState, StateGraph
from langgraph.prebuilt import ToolNode, tools_condition
from langchain.tools import tool
from pydantic import BaseModel, Field

llm = ChatAnthropic(
    model="claude-sonnet-4-5-20250514",
    temperature=0,
    max_tokens=4096,
)

# --- ãƒ„ãƒ¼ãƒ«å®šç¾© ---
@tool
def search_wiki(query: str) -> str:
    """ç¤¾å†…Wikiã‹ã‚‰é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢ã—ã¾ã™ã€‚
    æ¥­å‹™æ‰‹é †ã€ç¤¾å†…è¦å®šã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã®æ¤œç´¢ã«ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚"""
    docs = wiki_retriever.invoke(query)
    return "\n\n".join([doc.page_content for doc in docs])

@tool
def search_api_docs(query: str) -> str:
    """APIä»•æ§˜æ›¸ã‹ã‚‰æŠ€è¡“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢ã—ã¾ã™ã€‚
    ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã®æ¤œç´¢ã«ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚"""
    docs = api_retriever.invoke(query)
    return "\n\n".join([doc.page_content for doc in docs])

@tool
def search_faq(query: str) -> str:
    """ç¤¾å†…FAQãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å›ç­”ã‚’æ¤œç´¢ã—ã¾ã™ã€‚
    ã‚ˆãã‚ã‚‹è³ªå•ã€ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®æ¤œç´¢ã«ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚"""
    docs = faq_retriever.invoke(query)
    return "\n\n".join([doc.page_content for doc in docs])

TOOLS = [search_wiki, search_api_docs, search_faq]

# --- ã‚°ãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ---
class GradeDocuments(BaseModel):
    binary_score: str = Field(description="'yes' or 'no'")
    reason: str = Field(description="åˆ¤å®šç†ç”±")

GRADE_PROMPT = """æ¤œç´¢ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:
{context}

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•:
{question}

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè³ªå•ã«é–¢é€£ã™ã‚‹ãªã‚‰'yes'ã€é–¢é€£ã—ãªã„ãªã‚‰'no'ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚"""

grader_llm = ChatAnthropic(model="claude-sonnet-4-5-20250514", temperature=0)

# --- ã‚°ãƒ©ãƒ•ãƒãƒ¼ãƒ‰ ---
def generate_query_or_respond(state: MessagesState):
    response = llm.bind_tools(TOOLS).invoke(state["messages"])
    return {"messages": [response]}

def grade_documents(
    state: MessagesState,
) -> Literal["generate_answer", "rewrite_question"]:
    question = state["messages"][0].content
    context = state["messages"][-1].content
    result = grader_llm.with_structured_output(GradeDocuments).invoke(
        [{"role": "user", "content": GRADE_PROMPT.format(
            question=question, context=context
        )}]
    )
    return "generate_answer" if result.binary_score == "yes" else "rewrite_question"

def rewrite_question(state: MessagesState):
    question = state["messages"][0].content
    response = llm.invoke([{"role": "user", "content": f"ä»¥ä¸‹ã®è³ªå•ã‚’ã‚ˆã‚Šæ¤œç´¢ã«é©ã—ãŸå½¢ã«æ›¸ãæ›ãˆã¦ãã ã•ã„:\n{question}"}])
    return {"messages": [{"role": "user", "content": response.content}]}

def generate_answer(state: MessagesState):
    question = state["messages"][0].content
    context = state["messages"][-1].content
    response = llm.invoke([{"role": "user", "content": f"è³ªå•: {question}\næ¤œç´¢çµæœ: {context}\nä¸Šè¨˜ã«åŸºã¥ã„ã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚"}])
    return {"messages": [response]}

# --- ã‚°ãƒ©ãƒ•æ§‹ç¯‰ ---
workflow = StateGraph(MessagesState)
workflow.add_node(generate_query_or_respond)
workflow.add_node("retrieve", ToolNode(TOOLS))
workflow.add_node(rewrite_question)
workflow.add_node(generate_answer)

workflow.add_edge(START, "generate_query_or_respond")
workflow.add_conditional_edges(
    "generate_query_or_respond",
    tools_condition,
    {"tools": "retrieve", END: END},
)
workflow.add_conditional_edges("retrieve", grade_documents)
workflow.add_edge("generate_answer", END)
workflow.add_edge("rewrite_question", "generate_query_or_respond")

graph = workflow.compile()
```

**ãªãœClaude APIã‚’é¸ã‚“ã ã‹**:

- **ãƒ„ãƒ¼ãƒ«ä½¿ç”¨ã®ç²¾åº¦**: Claude Sonnet 4.5ã¯Function Callingã®ç²¾åº¦ãŒé«˜ãã€è¤‡æ•°ãƒ„ãƒ¼ãƒ«ã®ä½¿ã„åˆ†ã‘ãŒå®‰å®šã—ã¦ã„ã‚‹
- **æ§‹é€ åŒ–å‡ºåŠ›**: `with_structured_output()`ã§Pydanticãƒ¢ãƒ‡ãƒ«ã‚’ç›´æ¥æŒ‡å®šã§ãã€ã‚°ãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµæœã®å‹å®‰å…¨æ€§ã‚’ç¢ºä¿

> **æ³¨æ„**: ç„¡é™ãƒ«ãƒ¼ãƒ—ã®ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ãŸã‚ã€å®Ÿé‹ç”¨ã§ã¯**æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°**ï¼ˆæ¨å¥¨: 3å›ï¼‰ã‚’ã‚¹ãƒ†ãƒ¼ãƒˆã«å«ã‚ã¦ãã ã•ã„ã€‚LangGraphå†…ã§ã¯ChatAnthropicãŒToolNodeã¨ã®äº’æ›æ€§ãŒé«˜ãæ¨å¥¨ã§ã™ã€‚

## RAGAS + DeepEvalã§è©•ä¾¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’CI/CDã«çµ±åˆã™ã‚‹

RAGASã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå›ºæœ‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨DeepEvalã®pytestçµ±åˆã‚’çµ„ã¿åˆã‚ã›ã¦ã€PRå˜ä½ã§ç²¾åº¦åŠ£åŒ–ã‚’è‡ªå‹•æ¤œçŸ¥ã™ã‚‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

### è©•ä¾¡ãƒ†ã‚¹ãƒˆã®å®Ÿè£…

```python
# evaluation/test_agentic_rag.py
import pytest
from deepeval import assert_test
from deepeval.metrics import (
    AnswerRelevancyMetric,
    FaithfulnessMetric,
    ContextualPrecisionMetric,
)
from deepeval.test_case import LLMTestCase
from ragas.metrics.collections import ToolCallAccuracy, AgentGoalAccuracyWithReference

# DeepEvalãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆRAGå“è³ªï¼‰
faithfulness = FaithfulnessMetric(threshold=0.7)
answer_relevancy = AnswerRelevancyMetric(threshold=0.7)
contextual_precision = ContextualPrecisionMetric(threshold=0.6)
rag_metrics = [faithfulness, answer_relevancy, contextual_precision]

# RAGASãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå“è³ªï¼‰
tool_call_accuracy = ToolCallAccuracy()
agent_goal_accuracy = AgentGoalAccuracyWithReference(llm=evaluator_llm)

EVAL_DATASET = [
    {
        "input": "æœ‰çµ¦ä¼‘æš‡ã®ç”³è«‹æ–¹æ³•ã‚’æ•™ãˆã¦ãã ã•ã„",
        "expected_output": "æœ‰çµ¦ä¼‘æš‡ã¯ç¤¾å†…ãƒãƒ¼ã‚¿ãƒ«ã®å‹¤æ€ ç®¡ç†ç”»é¢ã‹ã‚‰ç”³è«‹ã§ãã¾ã™",
        "expected_tools": ["search_wiki"],
    },
    {
        "input": "ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã¯ï¼Ÿ",
        "expected_output": "èªè¨¼APIã¯JSONå½¢å¼ã§access_tokenã¨refresh_tokenã‚’è¿”ã—ã¾ã™",
        "expected_tools": ["search_api_docs"],
    },
]

@pytest.mark.parametrize("test_data", EVAL_DATASET)
def test_rag_quality(test_data: dict):
    """RAGå“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ãƒ†ã‚¹ãƒˆ"""
    result = run_agentic_rag(test_data["input"])
    test_case = LLMTestCase(
        input=test_data["input"],
        actual_output=result["answer"],
        expected_output=test_data["expected_output"],
        retrieval_context=result["retrieval_context"],
    )
    assert_test(test_case, rag_metrics)

@pytest.mark.parametrize("test_data", EVAL_DATASET)
async def test_tool_selection(test_data: dict):
    """ãƒ„ãƒ¼ãƒ«é¸æŠç²¾åº¦ã®ãƒ†ã‚¹ãƒˆ"""
    result = run_agentic_rag(test_data["input"])
    score = await tool_call_accuracy.ascore(
        user_input=test_data["input"],
        reference_tool_calls=test_data["expected_tools"],
        response_tool_calls=result["tool_calls"],
    )
    assert score >= 0.8, f"Tool Call Accuracy {score} < 0.8"

def run_agentic_rag(query: str) -> dict:
    """Agentic RAGã‚’å®Ÿè¡Œã—è©•ä¾¡ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™"""
    result = graph.invoke({"messages": [{"role": "user", "content": query}]})
    tool_calls, retrieval_context = [], []
    for msg in result["messages"]:
        if hasattr(msg, "tool_calls") and msg.tool_calls:
            tool_calls.extend([tc["name"] for tc in msg.tool_calls])
        if hasattr(msg, "content") and msg.type == "tool":
            retrieval_context.append(msg.content)
    return {
        "answer": result["messages"][-1].content,
        "tool_calls": tool_calls,
        "retrieval_context": retrieval_context,
    }
```

**ãªãœDeepEvalã¨RAGASã‚’ä½µç”¨ã™ã‚‹ã®ã‹**:

- **DeepEval**: pytestçµ±åˆãŒå„ªç§€ã§ã€CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¸ã®çµ„ã¿è¾¼ã¿ãŒå®¹æ˜“ã€‚é–¾å€¤ãƒ†ã‚¹ãƒˆã«æœ€é©
- **RAGAS**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå›ºæœ‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆTool Call Accuracyç­‰ï¼‰ã‚’æä¾›ã€‚DeepEvalã«ã¯ã“ã‚Œã‚‰ã®å°‚ç”¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒãªã„

> **åˆ¶ç´„æ¡ä»¶**: RAGASã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯async APIã®ã¿ã§æä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚pytestã§ä½¿ã†å ´åˆã¯`pytest-asyncio`ãŒå¿…è¦ã§ã™ã€‚Agent Goal Accuracyã¯LLM-as-a-Judgeã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€è©•ä¾¡ç”¨LLMã®ã‚³ã‚¹ãƒˆãŒè¿½åŠ ã§ç™ºç”Ÿã—ã¾ã™ã€‚

### GitHub Actionsã§ã®è‡ªå‹•å®Ÿè¡Œ

```yaml
# .github/workflows/rag-evaluation.yml
name: Agentic RAG Evaluation
on:
  pull_request:
    paths: ["src/rag/**", "evaluation/**"]
  schedule:
    - cron: "0 0 * * *"  # æ¯æ—¥09:00 JSTã«å®šæœŸè©•ä¾¡
jobs:
  evaluate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install deepeval ragas langchain-anthropic pytest-asyncio
      - name: Run RAG evaluation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: deepeval test run evaluation/test_agentic_rag.py
```

**ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆ**: å®šæœŸè©•ä¾¡ï¼ˆscheduleï¼‰ã‚’å…¥ã‚Œãªã„ã¨ã€ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹æ›´æ–°ã«ã‚ˆã‚‹ç²¾åº¦åŠ£åŒ–ã‚’è¦‹é€ƒã—ã¾ã™ã€‚DeNAã®raglabãƒãƒ¼ãƒ ã‚‚ã€Œè‡ªå‹•è©•ä¾¡ã‚’æ¯æ—¥å›ã™ã“ã¨ã§ã€ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã®æ›´æ–°ãŒç²¾åº¦ã«ä¸ãˆã‚‹å½±éŸ¿ã‚’å³åº§ã«æ¤œçŸ¥ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã€ã¨å ±å‘Šã—ã¦ã„ã¾ã™ã€‚

## ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†ã¨Langfuseç›£è¦–ã§æ”¹å–„ã‚µã‚¤ã‚¯ãƒ«ã‚’è‡ªå‹•åŒ–ã™ã‚‹

è©•ä¾¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ç²¾åº¦ã¯**è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®è³ª**ã«ä¾å­˜ã—ã¾ã™ã€‚é™çš„ãªãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã ã‘ã§ã¯å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½¿ã„æ–¹ã‚’ã‚«ãƒãƒ¼ã—ãã‚Œã¾ã›ã‚“ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®è‡ªå‹•å¤‰æ›ã¨ã€Langfuseã«ã‚ˆã‚‹æœ¬ç•ªç›£è¦–ã‚’çµ„ã¿åˆã‚ã›ã¦æ”¹å–„ã‚µã‚¤ã‚¯ãƒ«ã‚’å›ã—ã¾ã™ã€‚

### ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã«è‡ªå‹•å¤‰æ›ã™ã‚‹

```python
# feedback/converter.py
from __future__ import annotations
from datetime import datetime
from typing import Literal
from pydantic import BaseModel, Field

class UserFeedback(BaseModel):
    query: str
    agent_answer: str
    tool_calls_used: list[str]
    feedback_type: Literal["positive", "negative"]
    corrected_answer: str | None = None
    timestamp: datetime = Field(default_factory=datetime.now)

class EvalTestCase(BaseModel):
    input: str
    expected_output: str
    expected_tools: list[str]
    source: Literal["manual", "feedback_positive", "feedback_negative"]

def convert_feedback_to_eval_case(
    feedback: UserFeedback,
) -> EvalTestCase | None:
    """ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è©•ä¾¡ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«å¤‰æ›ã™ã‚‹
    - positive: ãã®ã¾ã¾æ­£è§£ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ¡ç”¨
    - negative + ä¿®æ­£å›ç­”ã‚ã‚Š: ä¿®æ­£å›ç­”ã‚’æ­£è§£ã¨ã—ã¦æ¡ç”¨
    - negative + ä¿®æ­£å›ç­”ãªã—: å¤‰æ›ä¸å¯ï¼ˆNoneã‚’è¿”ã™ï¼‰
    """
    if feedback.feedback_type == "positive":
        return EvalTestCase(
            input=feedback.query,
            expected_output=feedback.agent_answer,
            expected_tools=feedback.tool_calls_used,
            source="feedback_positive",
        )
    if feedback.corrected_answer:
        return EvalTestCase(
            input=feedback.query,
            expected_output=feedback.corrected_answer,
            expected_tools=feedback.tool_calls_used,
            source="feedback_negative",
        )
    return None
```

**ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•**: positive feedbackï¼ˆğŸ‘ï¼‰ã‚’ãã®ã¾ã¾æ­£è§£ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ¡ç”¨ã™ã‚‹ã¨ã€ã€Œé–“é•ã£ã¦ã„ã‚‹ãŒæ°—ã¥ã‹ãšã«ğŸ‘ã‚’æŠ¼ã—ãŸã€ã‚±ãƒ¼ã‚¹ã‚’æ‹¾ã£ã¦ã—ã¾ã„ã¾ã™ã€‚å¯¾ç­–ã¨ã—ã¦ã€**3å›ä»¥ä¸ŠåŒã˜ã‚¯ã‚¨ãƒªã§è‚¯å®šã•ã‚ŒãŸå ´åˆã®ã¿**æ¡ç”¨ã™ã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

å®Ÿé‹ç”¨ã§æœ€ã‚‚ã‚³ã‚¹ãƒˆåŠ¹ç‡ãŒé«˜ã„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†æ‰‹æ³•ã¯**ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—è³ªå•ã®æ¤œå‡º**ã§ã—ãŸã€‚åŒã˜ãƒˆãƒ”ãƒƒã‚¯ã§å†è³ªå•ã•ã‚ŒãŸå ´åˆã€å‰å›ã®å›ç­”ãŒä¸ååˆ†ã ã£ãŸå¯èƒ½æ€§ãŒé«˜ãã€è‡ªå‹•æ¤œå‡ºç‡ã¯ç´„90%ã§ã™ã€‚

### Langfuseã§æœ¬ç•ªç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ§‹ç¯‰ã™ã‚‹

```python
# monitoring/langfuse_setup.py
import os
from langfuse.callback import CallbackHandler
from langfuse import Langfuse

langfuse_handler = CallbackHandler(
    public_key=os.environ["LANGFUSE_PUBLIC_KEY"],
    secret_key=os.environ["LANGFUSE_SECRET_KEY"],
    host=os.environ.get("LANGFUSE_HOST", "https://cloud.langfuse.com"),
)
langfuse = Langfuse()

def run_with_tracing(query: str) -> dict:
    """ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ä»˜ãã§Agentic RAGã‚’å®Ÿè¡Œ"""
    result = graph.invoke(
        {"messages": [{"role": "user", "content": query}]},
        config={"callbacks": [langfuse_handler]},
    )
    return {"answer": result["messages"][-1].content, "trace_id": langfuse_handler.get_trace_id()}

def report_scores(trace_id: str, scores: dict[str, float]) -> None:
    """è©•ä¾¡ã‚¹ã‚³ã‚¢ã‚’Langfuseã«è¨˜éŒ²"""
    for name, value in scores.items():
        langfuse.score(trace_id=trace_id, name=name, value=value)
```

### ç›£è¦–ã™ã¹ããƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨ã‚¢ãƒ©ãƒ¼ãƒˆé–¾å€¤

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | é–¾å€¤ | ã‚¢ãƒ©ãƒ¼ãƒˆæ¡ä»¶ |
|-----------|------|------------|
| Faithfulnessï¼ˆæ—¥æ¬¡å¹³å‡ï¼‰ | 0.80 | 3æ—¥é€£ç¶šã§é–¾å€¤æœªæº€ |
| Tool Call Accuracyï¼ˆæ—¥æ¬¡ï¼‰ | 0.85 | å‰æ—¥æ¯”10%ä»¥ä¸Šä½ä¸‹ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦ï¼ˆé€±æ¬¡ï¼‰ | 80% | å‰é€±æ¯”5%ä»¥ä¸Šä½ä¸‹ |
| ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·p95 | 5,000ms | 2æ—¥é€£ç¶šã§é–¾å€¤è¶…é |

> **ã‚ˆãã‚ã‚‹é–“é•ã„**: æœ€åˆã¯Faithfulnessã ã‘ã‚’ç›£è¦–ã—ã¦ã„ã¾ã—ãŸãŒã€Tool Call Accuracyã®ä½ä¸‹ã‚’è¦‹é€ƒã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦ãŒä¸‹ãŒã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã—ãŸã€‚**ãƒ„ãƒ¼ãƒ«é¸æŠã®ç²¾åº¦ä½ä¸‹ã¯Faithfulnessã«å…ˆè¡Œã—ã¦ç™ºç”Ÿã™ã‚‹**ãŸã‚ã€Tool Call Accuracyã‚’å…ˆè¡ŒæŒ‡æ¨™ã¨ã—ã¦ç›£è¦–ã™ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚

### Langfuse vs LangSmithã®é¸å®š

| è¦³ç‚¹ | Langfuse | LangSmith |
|------|----------|-----------|
| ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ | MITï¼ˆOSSï¼‰ | ãƒ—ãƒ­ãƒ—ãƒ©ã‚¤ã‚¨ã‚¿ãƒª |
| ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆ | å¯èƒ½ | ä¸å¯ |
| LangGraphçµ±åˆ | ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯æ–¹å¼ | ãƒã‚¤ãƒ†ã‚£ãƒ– |
| æ¨å¥¨ã‚±ãƒ¼ã‚¹ | ãƒ‡ãƒ¼ã‚¿ä¸»æ¨©ãŒé‡è¦ãªç¤¾å†…ã‚·ã‚¹ãƒ†ãƒ  | LangChainã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ä¸­å¿ƒ |

**ç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸æ¤œç´¢å‘ã‘ã®æ¨å¥¨**: ãƒ‡ãƒ¼ã‚¿ä¸»æ¨©ã®è¦³ç‚¹ã‹ã‚‰Langfuseã®ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆã‚’æ¨å¥¨ã—ã¾ã™ã€‚é–‹ç™ºç’°å¢ƒã§ã¯LangSmithã€æœ¬ç•ªç’°å¢ƒã§ã¯Langfuseã¨ã„ã†ä½¿ã„åˆ†ã‘ã‚‚æœ‰åŠ¹ã§ã™ã€‚

### A/Bãƒ†ã‚¹ãƒˆã§æ”¹å–„æ–½ç­–ã‚’æ¤œè¨¼ã™ã‚‹

DeNAã®raglabãƒãƒ¼ãƒ ãŒæ¡ç”¨ã—ãŸãƒ™ãƒ¼ã‚¹ç‰ˆ/ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç‰ˆã®æ¯”è¼ƒæ‰‹æ³•ã‚’å‚è€ƒã«ã€æ”¹å–„æ–½ç­–ã®åŠ¹æœã‚’å®šé‡æ¤œè¨¼ã—ã¾ã™ã€‚

```python
# ab_test/router.py
import hashlib
from typing import Literal

def get_variant(user_id: str, experiment_name: str, ratio: float = 0.5) -> Literal["control", "treatment"]:
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‹ã‚‰A/BæŒ¯ã‚Šåˆ†ã‘ã‚’æ±ºå®šï¼ˆåŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å¸¸ã«åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰"""
    hash_value = int(hashlib.sha256(f"{user_id}:{experiment_name}".encode()).hexdigest(), 16)
    return "treatment" if (hash_value % 10000) / 10000 < ratio else "control"
```

å®Ÿéš›ã®A/Bãƒ†ã‚¹ãƒˆçµæœã‚’å…±æœ‰ã—ã¾ã™ã€‚

| æ”¹å–„æ–½ç­– | Faithfulnesså¤‰åŒ– | Tool Accuracyå¤‰åŒ– | æ¡ç”¨åˆ¤å®š |
|---------|-----------------|-------------------|---------|
| ãƒãƒ£ãƒ³ã‚¯æˆ¦ç•¥: å›ºå®šé•·â†’ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ | +0.12 | +0.02 | æ¡ç”¨ |
| ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°: Cohere Rerank v3è¿½åŠ  | +0.08 | Â±0.00 | æ¡ç”¨ |
| ãƒ„ãƒ¼ãƒ«èª¬æ˜æ–‡ã®è©³ç´°åŒ– | +0.01 | +0.15 | æ¡ç”¨ |
| ã‚¯ã‚¨ãƒªæ‹¡å¼µ: HyDEå°å…¥ | +0.05 | **-0.08** | ä¸æ¡ç”¨ |

**åˆ¶ç´„æ¡ä»¶**: HyDEã¯Faithfulnessã‚’å‘ä¸Šã•ã›ã¾ã—ãŸãŒã€Tool Call AccuracyãŒä½ä¸‹ã—ã¾ã—ãŸã€‚ä»®æƒ³ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«ã‚ˆã‚Šã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ„ãƒ¼ãƒ«é¸æŠåˆ¤æ–­ãŒæ··ä¹±ã—ãŸãŸã‚ã§ã™ã€‚**ç‰‡æ–¹ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒæ”¹å–„ã—ã¦ã‚‚ä»–æ–¹ãŒæ‚ªåŒ–ã™ã‚‹ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•**ã¯é »ç¹ã«ç™ºç”Ÿã™ã‚‹ãŸã‚ã€å¿…ãšè¤‡æ•°ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’åŒæ™‚ã«ç›£è¦–ã—ã¦ãã ã•ã„ã€‚

## ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

| å•é¡Œ | åŸå›  | è§£æ±ºæ–¹æ³• |
|------|------|----------|
| è©•ä¾¡ã‚¹ã‚³ã‚¢ãŒæ¯å›å¤‰å‹•ã™ã‚‹ | LLM-as-a-Judgeã®éæ±ºå®šæ€§ | temperature=0è¨­å®šã€3å›å®Ÿè¡Œã—ã¦ä¸­å¤®å€¤ã‚’æ¡ç”¨ |
| Tool Call AccuracyãŒæ€¥ã«ä½ä¸‹ | ãƒŠãƒ¬ãƒƒã‚¸æ›´æ–°ã§ãƒ„ãƒ¼ãƒ«èª¬æ˜æ–‡ã¨å®Ÿãƒ‡ãƒ¼ã‚¿ãŒä¸ä¸€è‡´ | ãƒŠãƒ¬ãƒƒã‚¸æ›´æ–°æ™‚ã«ãƒ„ãƒ¼ãƒ«èª¬æ˜æ–‡ã‚‚è‡ªå‹•æ›´æ–°ã™ã‚‹CIã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ  |
| ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¤‰æ›ã§ãƒã‚¤ã‚ºãŒå¤šã„ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èª¤ã‚¿ãƒƒãƒ— | åŒä¸€ã‚¯ã‚¨ãƒªã§3å›ä»¥ä¸Šè‚¯å®šã•ã‚ŒãŸå ´åˆã®ã¿æ­£è§£ãƒ‡ãƒ¼ã‚¿æ¡ç”¨ |
| CI/CDã®è©•ä¾¡ãŒé…ã„ï¼ˆ10åˆ†ä»¥ä¸Šï¼‰ | ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹Ã—LLM APIå‘¼ã³å‡ºã—ãŒå¤šã„ | DeepEvalã®ä¸¦åˆ—å®Ÿè¡Œã‚’æœ‰åŠ¹åŒ–ã€é‡è¦ãƒ†ã‚¹ãƒˆã®ã¿CIå®Ÿè¡Œ |
| Langfuseã®ãƒˆãƒ¬ãƒ¼ã‚¹ãŒæ¬ æ | éåŒæœŸå‡¦ç†ã§flushãŒé–“ã«åˆã‚ãªã„ | `langfuse.flush()`ã‚’æ˜ç¤ºçš„ã«å‘¼ã³å‡ºã— |

## ã¾ã¨ã‚ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

**ã¾ã¨ã‚:**

- Agentic RAGã®è©•ä¾¡ã¯å¾“æ¥RAGãƒ¡ãƒˆãƒªã‚¯ã‚¹ã ã‘ã§ã¯ä¸ååˆ†ã€‚**Tool Call Accuracy**ã¨**Agent Goal Accuracy**ã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå›ºæœ‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨ã—ã¦è¿½åŠ ã—ã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã®ç‰¹å®šã‚’3å€é€Ÿãã™ã‚‹
- RAGAS + DeepEvalã®çµ„ã¿åˆã‚ã›ã§ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå“è³ªã¨RAGå“è³ªã®ä¸¡æ–¹ã‚’1ã¤ã®CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§è‡ªå‹•ãƒ†ã‚¹ãƒˆã§ãã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«è‡ªå‹•å¤‰æ›ã—ã€è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ãŒé‹ç”¨ã¨ã¨ã‚‚ã«æˆé•·ã™ã‚‹ä»•çµ„ã¿ã‚’æ§‹ç¯‰ã™ã‚‹
- Langfuseã§Tool Call Accuracyã‚’**å…ˆè¡ŒæŒ‡æ¨™**ã¨ã—ã¦ç›£è¦–ã™ã‚‹ã“ã¨ã§ã€Faithfulnessä½ä¸‹ã‚’äº‹å‰ã«æ¤œçŸ¥ã§ãã‚‹

**æ¬¡ã«ã‚„ã‚‹ã¹ãã“ã¨:**

1. æ—¢å­˜ã®Agentic RAGã«RAGASã®Tool Call Accuracyãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¿½åŠ ã—ã€ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚’è¨ˆæ¸¬ã™ã‚‹
2. DeepEvalã§CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«è©•ä¾¡ãƒ†ã‚¹ãƒˆã‚’çµ„ã¿è¾¼ã¿ã€PRã”ã¨ã®ç²¾åº¦åŠ£åŒ–ã‚’è‡ªå‹•æ¤œè¨¼ã™ã‚‹
3. Langfuseã‚’ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆã§æ§‹ç¯‰ã—ã€æœ¬ç•ªãƒˆãƒ¬ãƒ¼ã‚¹ã¨è©•ä¾¡ã‚¹ã‚³ã‚¢ã®å¯è¦–åŒ–ã‚’é–‹å§‹ã™ã‚‹

**é–¢é€£è¨˜äº‹:**

- [LangGraph Agentic RAGã§ç¤¾å†…æ¤œç´¢ã®å›ç­”ç²¾åº¦ã‚’78%æ”¹å–„ã™ã‚‹å®Ÿè£…æ‰‹æ³•](https://zenn.dev/0h_n0/articles/4c869d366e5200)
- [LangGraphÃ—Claude Sonnet 4.6ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‹RAGã®ç²¾åº¦è©•ä¾¡ã¨æœ€é©åŒ–](https://zenn.dev/0h_n0/articles/32bc8fd091100d)
- [LangGraphÃ—Claude APIã§æ§‹ç¯‰ã™ã‚‹ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°ä»˜ãã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGå®Ÿè£…](https://zenn.dev/0h_n0/articles/11f63b83aabde7)

## å‚è€ƒ

- [RAGAS Agent Evaluation Metricsï¼ˆå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰](https://docs.ragas.io/en/stable/concepts/metrics/available_metrics/agents/)
- [DeepEval: RAG Evaluation in CI/CD Pipelines](https://www.confident-ai.com/blog/how-to-evaluate-rag-applications-in-ci-cd-pipelines-with-deepeval)
- [LangGraph Agentic RAG Official Guide](https://docs.langchain.com/oss/python/langgraph/agentic-rag)
- [Anthropic Advanced Tool Use](https://www.anthropic.com/engineering/advanced-tool-use)
- [DeNA Engineering: ç¤¾å†…AIãƒ˜ãƒ«ãƒ—ãƒ‡ã‚¹ã‚¯ RAGç²¾åº¦æ”¹å–„ã®è»Œè·¡](https://engineering.dena.com/blog/2025/11/its-ai-journey-rag-tech/)
- [Agentic RAG Survey (arXiv:2501.09136)](https://arxiv.org/abs/2501.09136)
- [Langfuse: Open Source LLM Engineering Platform](https://langfuse.com)

---

:::message
ã“ã®è¨˜äº‹ã¯AIï¼ˆClaude Codeï¼‰ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å†…å®¹ã®æ­£ç¢ºæ€§ã«ã¤ã„ã¦ã¯è¤‡æ•°ã®æƒ…å ±æºã§æ¤œè¨¼ã—ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã®åˆ©ç”¨æ™‚ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚ã”ç¢ºèªãã ã•ã„ã€‚
:::
