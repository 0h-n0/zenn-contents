---
title: "ãƒ™ã‚¯ãƒˆãƒ«DBã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥ã®å®Ÿæ¸¬æ¯”è¼ƒï¼šHNSWãƒ»IVFãƒ»DiskANNã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿè·µ"
emoji: "ğŸ“"
type: "tech"
topics: ["vectordb", "hnsw", "rag", "postgresql", "milvus"]
published: false
---

# ãƒ™ã‚¯ãƒˆãƒ«DBã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥ã®å®Ÿæ¸¬æ¯”è¼ƒï¼šHNSWãƒ»IVFãƒ»DiskANNã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿè·µ

## ã“ã®è¨˜äº‹ã§ã‚ã‹ã‚‹ã“ã¨

- **HNSWãƒ»IVFãƒ»DiskANN**ã®3å¤§ANNã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ä»•çµ„ã¿ã¨ä½¿ã„åˆ†ã‘
- pgvector 0.8 / Qdrant 1.15 / Milvus 2.5 ã§ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ‰‹æ³•
- 100ä¸‡ã€œ10å„„ãƒ™ã‚¯ãƒˆãƒ«è¦æ¨¡ã§ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã«åŸºã¥ãæ€§èƒ½ç‰¹æ€§ã®æ¯”è¼ƒ
- ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰åˆ¥ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢ãƒ»ãƒãƒƒãƒå‡¦ç†ãƒ»ã‚³ã‚¹ãƒˆé‡è¦–ï¼‰ã®é¸å®šãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ
- é‡å­åŒ–ï¼ˆScalarãƒ»Binaryãƒ»Product Quantizationï¼‰ã«ã‚ˆã‚‹ãƒ¡ãƒ¢ãƒªå‰Šæ¸›ã¨é€Ÿåº¦æ”¹å–„ã®å®Ÿè·µ

## å¯¾è±¡èª­è€…

- **æƒ³å®šèª­è€…**: ä¸­ç´šè€…ä»¥ä¸Šã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰/MLã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
- **å¿…è¦ãªå‰æçŸ¥è­˜**:
  - Python 3.11+ ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹
  - ãƒ™ã‚¯ãƒˆãƒ«åŸ‹ã‚è¾¼ã¿ï¼ˆembeddingï¼‰ã®åŸºæœ¬æ¦‚å¿µï¼ˆã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ã€æ¬¡å…ƒæ•°ï¼‰
  - PostgreSQLã¾ãŸã¯ä»–ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åŸºç¤é‹ç”¨çµŒé¨“

:::message
ãƒ™ã‚¯ãƒˆãƒ«DBè£½å“ã®é¸å®šã‚¬ã‚¤ãƒ‰ã«ã¤ã„ã¦ã¯ã€é–¢é€£è¨˜äº‹ã€Œ[2026å¹´ç‰ˆãƒ™ã‚¯ãƒˆãƒ«DBé¸å®šã‚¬ã‚¤ãƒ‰ï¼špgvectorãƒ»Qdrantãƒ»Pineconeã‚’æœ¬ç•ªãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã§æ¯”è¼ƒ](https://zenn.dev/0h_n0/articles/8c8bb192985b64)ã€ã‚‚ã‚ã‚ã›ã¦ã”å‚ç…§ãã ã•ã„ã€‚æœ¬è¨˜äº‹ã§ã¯ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆé¸å®šã§ã¯ãªãã€**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°**ã«ç„¦ç‚¹ã‚’å½“ã¦ã¾ã™ã€‚
:::

## çµè«–ãƒ»æˆæœ

ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®é¸æŠã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã«ã‚ˆã‚Šã€**åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§ã‚‚QPSï¼ˆç§’é–“ã‚¯ã‚¨ãƒªæ•°ï¼‰ã«æœ€å¤§11å€ã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã«æœ€å¤§90%ã®å·®**ãŒç”Ÿã˜ã¾ã™ã€‚ANN-Benchmarksç­‰ã®å…¬é–‹ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã§ã¯ã€HNSWãŒSIFT1Mãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§95% recall@10ã‚’1-2msã§é”æˆã™ã‚‹ä¸€æ–¹ã€DiskANNã¯10å„„è¦æ¨¡ã§åŒç­‰ã®recallã‚’ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡90%å‰Šæ¸›ã§å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚é©åˆ‡ãªãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãªã—ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§é‹ç”¨ã™ã‚‹ã¨ã€å¿…è¦ä»¥ä¸Šã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆã‚’æ‰•ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

## 3å¤§ANNã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ç†è§£ã™ã‚‹

ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã§ä½¿ã‚ã‚Œã‚‹ANNï¼ˆApproximate Nearest Neighborï¼‰ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯ã€**ç²¾åº¦ï¼ˆrecallï¼‰ãƒ»é€Ÿåº¦ï¼ˆQPS/latencyï¼‰ãƒ»ãƒªã‚½ãƒ¼ã‚¹æ¶ˆè²»ï¼ˆãƒ¡ãƒ¢ãƒª/ãƒ‡ã‚£ã‚¹ã‚¯ï¼‰**ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã‚’åˆ¶å¾¡ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚2026å¹´ç¾åœ¨ã€å®Ÿç”¨çš„ãªé¸æŠè‚¢ã¯å¤§ãã3ã¤ã«åˆ†ã‹ã‚Œã¾ã™ã€‚

### HNSWï¼ˆHierarchical Navigable Small Worldï¼‰

HNSWã¯**å¤šå±¤ã‚°ãƒ©ãƒ•æ§‹é€ **ã‚’ç”¨ã„ãŸã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã‚’è¤‡æ•°ã®éšå±¤ã«é…ç½®ã—ã€ä¸Šä½å±¤ã§å¤§ã¾ã‹ãªä½ç½®ã‚’ç‰¹å®šã—ã¦ã‹ã‚‰ä¸‹ä½å±¤ã§ç²¾å¯†ãªæ¢ç´¢ã‚’è¡Œã„ã¾ã™ã€‚é«˜é€Ÿé“è·¯ã‹ã‚‰ä¸€èˆ¬é“ã¸ã¨é™ã‚Šã¦ã„ãã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚

```mermaid
graph TD
    A[ã‚¯ã‚¨ãƒªãƒ™ã‚¯ãƒˆãƒ«] --> B[Layer 2: ç²—ã„æ¢ç´¢]
    B --> C[Layer 1: ä¸­é–“æ¢ç´¢]
    C --> D[Layer 0: ç²¾å¯†æ¢ç´¢]
    D --> E[Top-K çµæœ]

    style B fill:#e1f5fe
    style C fill:#b3e5fc
    style D fill:#81d4fa
```

**ä¸»è¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å½¹å‰² | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | æ¨å¥¨ç¯„å›² |
|-----------|------|------------|---------|
| `m` | å„ãƒãƒ¼ãƒ‰ã®æœ€å¤§æ¥ç¶šæ•° | 16 | 12-48 |
| `ef_construction` | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰æ™‚ã®æ¢ç´¢å¹… | 64 | 64-512 |
| `ef_search` | æ¤œç´¢æ™‚ã®æ¢ç´¢å¹… | 40 | 50-500 |

`m`ã‚’å¢—ã‚„ã™ã¨ã‚°ãƒ©ãƒ•ãŒå¯†ã«ãªã‚Šæ¤œç´¢ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ãŒã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰æ™‚é–“ãŒå¢—åŠ ã—ã¾ã™ã€‚ANN-Benchmarksã®å ±å‘Šã§ã¯ã€HNSWã¯SIFT1Mï¼ˆ100ä¸‡ãƒ™ã‚¯ãƒˆãƒ«ã€128æ¬¡å…ƒï¼‰ã§**95% recall@10ã‚’1-2ms/query**ã§é”æˆã—ã¦ãŠã‚Šã€ã‚°ãƒ©ãƒ•ãƒ™ãƒ¼ã‚¹æ‰‹æ³•ã®ä¸­ã§ä¸€è²«ã—ã¦Paretoæœ€é©ãƒ•ãƒ­ãƒ³ãƒˆã«ä½ç½®ã—ã¦ã„ã¾ã™ã€‚

**HNSWã®å¼·ã¿**: å‹•çš„ãªãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆé »ç¹ãªè¿½åŠ ãƒ»å‰Šé™¤ï¼‰ã«å¯¾å¿œã§ãã€ä»»æ„ã®è·é›¢é–¢æ•°ã‚’æ‰±ãˆã¾ã™ã€‚æ•°ç™¾ä¸‡ã€œæ•°å„„ä»¶è¦æ¨¡ã®ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªé‹ç”¨ã«é©ã—ã¦ã„ã¾ã™ã€‚

> **ã‚ˆãã‚ã‚‹é–“é•ã„**: `ef_construction`ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®64ã®ã¾ã¾é‹ç”¨ã™ã‚‹ã‚±ãƒ¼ã‚¹ãŒå¤šã„ã§ã™ãŒã€recallè¦ä»¶ãŒ95%ä»¥ä¸Šã®å ´åˆã¯128-256ã«å¼•ãä¸Šã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãŸã ã—æ§‹ç¯‰æ™‚é–“ãŒ2-4å€ã«å¢—åŠ ã™ã‚‹ãŸã‚ã€æ›´æ–°é »åº¦ã¨ã®å…¼ã­åˆã„ã§åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚

### IVFï¼ˆInverted File Indexï¼‰

IVFã¯**ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ãƒ™ãƒ¼ã‚¹**ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã™ã€‚äº‹å‰ã«k-meansç­‰ã§ãƒ™ã‚¯ãƒˆãƒ«å…¨ä½“ã‚’ã‚¯ãƒ©ã‚¹ã‚¿ï¼ˆã‚»ãƒ«ï¼‰ã«åˆ†å‰²ã—ã€æ¤œç´¢æ™‚ã¯å¯¾è±¡ã‚¯ã‚¨ãƒªã«è¿‘ã„ã‚¯ãƒ©ã‚¹ã‚¿ã®ã¿ã‚’æ¢ç´¢ã—ã¾ã™ã€‚

**ä¸»è¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å½¹å‰² | æ¨å¥¨è¨­å®š |
|-----------|------|---------|
| `nlist` | ã‚¯ãƒ©ã‚¹ã‚¿æ•° | $\sqrt{N}$ ï½ $4\sqrt{N}$ï¼ˆ$N$ã¯ãƒ™ã‚¯ãƒˆãƒ«æ•°ï¼‰ |
| `nprobe` | æ¤œç´¢æ™‚ã«æ¢ç´¢ã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚¿æ•° | nlistã®1-10% |

IVFã®æ¤œç´¢ã‚³ã‚¹ãƒˆã¯ $O(\text{nprobe} \times \frac{N}{\text{nlist}})$ ã§ã€`nprobe`ã‚’å¢—ã‚„ã™ã¨recallãŒå‘ä¸Šã—ã¾ã™ãŒãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚‚å¢—åŠ ã—ã¾ã™ã€‚Milvusã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ã€512æ–‡å­—ãƒãƒ£ãƒ³ã‚¯ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§HNSWãŒIVF-Flatã‚’Acc@3ã§ç´„3.3ãƒã‚¤ãƒ³ãƒˆä¸Šå›ã‚‹ä¸€æ–¹ã€IVF-Flatã¯ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ã§å„ªä½ã§ã™ã€‚

**IVFã®å¼·ã¿**: ãƒ•ã‚£ãƒ«ã‚¿æ¤œç´¢ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ¡ä»¶ä»˜ãæ¤œç´¢ï¼‰ã§2æ®µéšã®çµã‚Šè¾¼ã¿ãŒå¯èƒ½ã§ã™ã€‚ã¾ãšã‚»ãƒ³ãƒˆãƒ­ã‚¤ãƒ‰ãƒ¬ãƒ™ãƒ«ã§ç²—ã„çµã‚Šè¾¼ã¿ã‚’è¡Œã„ã€æ¬¡ã«é¸æŠã•ã‚ŒãŸã‚¯ãƒ©ã‚¹ã‚¿å†…ã§è·é›¢è¨ˆç®—ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã¾ãŸã€Product Quantizationï¼ˆPQï¼‰ã¨çµ„ã¿åˆã‚ã›ãŸ**IVF_PQ**ã¯ã€10å„„è¦æ¨¡ã®ãƒ‡ã‚£ã‚¹ã‚¯ãƒ™ãƒ¼ã‚¹æ¤œç´¢ã§æœ‰åŠ¹ã§ã™ã€‚

> **åˆ¶ç´„æ¡ä»¶**: IVFã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰å‰ã«å…¨ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ãŒå¿…è¦ãªãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ãƒ»å‰Šé™¤ãŒé »ç¹ãªãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã«ã¯ä¸å‘ãã§ã™ã€‚ã‚¯ãƒ©ã‚¹ã‚¿ã®å†æ§‹ç¯‰ã‚³ã‚¹ãƒˆãŒé«˜ã„ãŸã‚ã€ãƒãƒƒãƒæ›´æ–°ãŒä¸­å¿ƒã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

### DiskANN

DiskANNã¯Microsoft ResearchãŒé–‹ç™ºã—ãŸ**SSDæœ€é©åŒ–å‹**ã®ã‚°ãƒ©ãƒ•ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã™ã€‚Vamanaã‚°ãƒ©ãƒ•æ§‹é€ ã‚’ä½¿ã„ã€NVMeã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ãƒ¡ãƒ¢ãƒªã®è«–ç†çš„æ‹¡å¼µã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚HNSWãŒãƒ‡ãƒ¼ã‚¿å…¨ä½“ã‚’RAMã«è¼‰ã›ã‚‹å‰æã§ã‚ã‚‹ã®ã«å¯¾ã—ã€DiskANNã¯SSDä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚’åŠ¹ç‡çš„ã«å‚ç…§ã—ã¾ã™ã€‚

å…¬é–‹ã•ã‚Œã¦ã„ã‚‹2025å¹´ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã«ã‚ˆã‚‹ã¨ã€10å„„è¦æ¨¡ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«ãŠã„ã¦ä»¥ä¸‹ã®ç‰¹æ€§ãŒå ±å‘Šã•ã‚Œã¦ã„ã¾ã™ã€‚

| æŒ‡æ¨™ | HNSW | DiskANN | å‚™è€ƒ |
|------|------|---------|------|
| **p95ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·** | 12ms | 15ms | HNSW: M=48, efSearch=96 |
| **recall@50** | 0.94 | 0.95 | DiskANNãŒã‚ãšã‹ã«å„ªä½ |
| **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡** | 55GB RAM | 16GB cache + 350GB NVMe | **DiskANNãŒç´„70%å‰Šæ¸›** |
| **TCOï¼ˆæœˆé¡æ¨å®šï¼‰** | é«˜ï¼ˆå¤§å®¹é‡RAMå¿…é ˆï¼‰ | ä½ï¼ˆNVMeæ´»ç”¨ï¼‰ | DiskANNãŒã‚³ã‚¹ãƒˆå„ªä½ |

SQL Server 2025ã§ã¯DiskANNãŒãƒã‚¤ãƒ†ã‚£ãƒ–å®Ÿè£…ã•ã‚Œã€10å„„è¦æ¨¡ã§sub-10msãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã¨95%+ã®recallã‚’ä¸¡ç«‹ã—ã¦ã„ã¾ã™ã€‚

**DiskANNã®å¼·ã¿**: ãƒ¡ãƒ¢ãƒªã‚³ã‚¹ãƒˆã®å¤§å¹…å‰Šæ¸›ã§ã™ã€‚RAMã®å˜ä¾¡ã¯NVMe SSDã®ç´„10å€ã§ã‚ã‚‹ãŸã‚ã€10å„„ãƒ™ã‚¯ãƒˆãƒ«è¦æ¨¡ã§ã¯ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆã«å¤§ããªå·®ãŒå‡ºã¾ã™ã€‚

> **ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•**: DiskANNã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã¯I/Oæ€§èƒ½ã«ä¾å­˜ã™ã‚‹ãŸã‚ã€NVMe SSDã®å“è³ªãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã«ãªã‚Šã¾ã™ã€‚p50ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã§ã¯HNSWãŒå®‰å®šã—ã¦å„ªä½ã§ã‚ã‚Šã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ãŒæœ€å„ªå…ˆã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯HNSWã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

### 3ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æ¯”è¼ƒã¾ã¨ã‚

| ç‰¹æ€§ | HNSW | IVF | DiskANN |
|------|------|-----|---------|
| **ãƒ‡ãƒ¼ã‚¿æ§‹é€ ** | å¤šå±¤ã‚°ãƒ©ãƒ• | ã‚¯ãƒ©ã‚¹ã‚¿+è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ | Vamanaã‚°ãƒ©ãƒ•ï¼ˆSSDæœ€é©åŒ–ï¼‰ |
| **æ¢ç´¢è¨ˆç®—é‡** | $O(\log N)$ | $O(\text{nprobe} \times N/\text{nlist})$ | $O(\log N)$ï¼ˆ+ãƒ‡ã‚£ã‚¹ã‚¯I/Oï¼‰ |
| **ãƒ¡ãƒ¢ãƒªåŠ¹ç‡** | ä½ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿RAMå¿…é ˆï¼‰ | ä¸­ï¼ˆPQä½µç”¨ã§åœ§ç¸®å¯ï¼‰ | é«˜ï¼ˆSSDæ´»ç”¨ï¼‰ |
| **å‹•çš„æ›´æ–°** | å¾—æ„ | è‹¦æ‰‹ï¼ˆå†ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°å¿…è¦ï¼‰ | ä¸­ç¨‹åº¦ |
| **ãƒ•ã‚£ãƒ«ã‚¿æ¤œç´¢** | å¾Œãƒ•ã‚£ãƒ«ã‚¿ | 2æ®µéšãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå¾—æ„ï¼‰ | å¾Œãƒ•ã‚£ãƒ«ã‚¿ |
| **æ¨å¥¨è¦æ¨¡** | ï½æ•°å„„ä»¶ | ï½æ•°åå„„ä»¶ï¼ˆPQä½µç”¨ï¼‰ | ï½æ•°åå„„ä»¶ |

## ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å®Ÿè·µã™ã‚‹

ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®é¸æŠã ã‘ã§ãªãã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èª¿æ•´ã§æ€§èƒ½ãŒå¤§ããå¤‰ã‚ã‚Šã¾ã™ã€‚å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### pgvector 0.8ã§HNSWã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹

pgvector 0.8.0ï¼ˆ2024å¹´11æœˆãƒªãƒªãƒ¼ã‚¹ï¼‰ã§ã¯ã€**åå¾©ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¹ã‚­ãƒ£ãƒ³**ã¨**ä¸¦åˆ—ãƒ“ãƒ«ãƒ‰**ãŒå°å…¥ã•ã‚Œã€ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã®å¹…ãŒåºƒãŒã‚Šã¾ã—ãŸã€‚

```python
# pgvector_hnsw_tuning.py
import psycopg2

def create_optimized_hnsw_index(conn, table_name: str, dimension: int, target_recall: float = 0.95):
    """
    recallã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«å¿œã˜ãŸHNSWã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚
    target_recall: 0.90-0.99ï¼ˆé«˜ã„ã»ã©m, ef_constructionã‚’å¢—ã‚„ã™ï¼‰
    """
    # recallè¦ä»¶ã«åŸºã¥ããƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ±ºå®š
    if target_recall >= 0.99:
        m, ef_construction = 48, 256
    elif target_recall >= 0.95:
        m, ef_construction = 32, 128
    else:
        m, ef_construction = 16, 64  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

    with conn.cursor() as cur:
        # ä¸¦åˆ—ãƒ“ãƒ«ãƒ‰ã®è¨­å®šï¼ˆpgvector 0.8+ï¼‰
        # maintenance_work_memã‚’ã‚°ãƒ©ãƒ•å…¨ä½“ãŒåã¾ã‚‹ã‚µã‚¤ã‚ºã«è¨­å®š
        estimated_mem_mb = (dimension * 4 * m * 2) // (1024 * 1024) + 512
        cur.execute(f"SET maintenance_work_mem = '{estimated_mem_mb}MB'")
        cur.execute("SET max_parallel_maintenance_workers = 4")

        # HNSWã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
        cur.execute(f"""
            CREATE INDEX idx_{table_name}_embedding
            ON {table_name}
            USING hnsw (embedding vector_cosine_ops)
            WITH (m = {m}, ef_construction = {ef_construction})
        """)

        # æ¤œç´¢æ™‚ã®ef_searchã‚’è¨­å®šï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³å˜ä½ï¼‰
        ef_search = max(m * 2, 100)
        cur.execute(f"SET hnsw.ef_search = {ef_search}")

        # pgvector 0.8ã®åå¾©ã‚¹ã‚­ãƒ£ãƒ³ã‚’æœ‰åŠ¹åŒ–
        # ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ä»˜ãã‚¯ã‚¨ãƒªã§ã®å–ã‚Šã“ã¼ã—ã‚’é˜²æ­¢
        cur.execute("SET hnsw.iterative_scan = relaxed_order")

    conn.commit()
    return {"m": m, "ef_construction": ef_construction, "ef_search": ef_search}
```

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å½±éŸ¿ã‚’ç†è§£ã™ã‚‹**:

`maintenance_work_mem`ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰é€Ÿåº¦ã«ç›´çµã—ã¾ã™ã€‚Crunchy Dataç¤¾ã®ãƒ–ãƒ­ã‚°ã«ã‚ˆã‚‹ã¨ã€ã‚°ãƒ©ãƒ•å…¨ä½“ãŒã“ã®ãƒ¡ãƒ¢ãƒªã«åã¾ã‚‹å ´åˆã¯ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªæ§‹ç¯‰ã€è¶…ãˆã‚‹å ´åˆã¯ãƒ‡ã‚£ã‚¹ã‚¯ãƒ™ãƒ¼ã‚¹ã®æ§‹ç¯‰ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã€**æ§‹ç¯‰é€Ÿåº¦ãŒæ•°å€ã‹ã‚‰æ•°åå€é…ããªã‚‹**ã¨å ±å‘Šã•ã‚Œã¦ã„ã¾ã™ã€‚

```python
# ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¢ç´¢ã®ä¾‹: recall-latencyãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã‚’æ¸¬å®š
def benchmark_ef_search(conn, table_name: str, query_vector: list, ground_truth: list, k: int = 10):
    """ef_searchã‚’å¤‰ãˆãªãŒã‚‰recall@kã¨ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’è¨ˆæ¸¬ã™ã‚‹ã€‚"""
    import time

    results = []
    for ef in [50, 100, 200, 400]:
        with conn.cursor() as cur:
            cur.execute(f"SET hnsw.ef_search = {ef}")

            start = time.perf_counter()
            cur.execute(f"""
                SELECT id FROM {table_name}
                ORDER BY embedding <=> %s::vector
                LIMIT {k}
            """, (query_vector,))
            elapsed_ms = (time.perf_counter() - start) * 1000

            retrieved = [row[0] for row in cur.fetchall()]
            recall = len(set(retrieved) & set(ground_truth[:k])) / k
            results.append({"ef_search": ef, "recall": recall, "latency_ms": elapsed_ms})

    return results
```

**pgvector 0.8ã®åå¾©ã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½ã«ã¤ã„ã¦**: `hnsw.iterative_scan`ã‚’`relaxed_order`ã«è¨­å®šã™ã‚‹ã¨ã€ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ä»˜ãã‚¯ã‚¨ãƒªã§æœ€åˆã®ã‚¹ã‚­ãƒ£ãƒ³ãŒååˆ†ãªçµæœã‚’è¿”ã•ãªã„å ´åˆã€è‡ªå‹•çš„ã«ã‚¹ã‚­ãƒ£ãƒ³ç¯„å›²ã‚’æ‹¡å¤§ã—ã¾ã™ã€‚`WHERE category = 'tech'`ã®ã‚ˆã†ãªãƒ•ã‚£ãƒ«ã‚¿ã‚’ä½¿ã†RAGã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€ã“ã®è¨­å®šãŒæ¤œç´¢æ¼ã‚Œã®é˜²æ­¢ã«æœ‰åŠ¹ã§ã™ã€‚

> **ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆ**: ä¸¦åˆ—HNSWãƒ“ãƒ«ãƒ‰ã‚’ä½¿ã†å ´åˆã€Dockerã‚³ãƒ³ãƒ†ãƒŠã®`--shm-size`ã‚’`maintenance_work_mem`ä»¥ä¸Šã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®64MBã§ã¯`ERROR: could not resize shared memory segment`ãŒç™ºç”Ÿã—ã¾ã™ã€‚

### Qdrant 1.15ã§é‡å­åŒ–ã‚’é©ç”¨ã™ã‚‹

Qdrantã¯ã‚¹ã‚«ãƒ©ãƒ¼é‡å­åŒ–ãƒ»ãƒã‚¤ãƒŠãƒªé‡å­åŒ–ãƒ»ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆé‡å­åŒ–ã®3ç¨®é¡ã‚’æä¾›ã—ã¦ãŠã‚Šã€ç”¨é€”ã«å¿œã˜ã¦ä½¿ã„åˆ†ã‘ã¾ã™ã€‚Qdrantå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«åŸºã¥ãæ€§èƒ½ç‰¹æ€§ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

| é‡å­åŒ–æ–¹å¼ | åœ§ç¸®ç‡ | é€Ÿåº¦å‘ä¸Š | ç²¾åº¦ | æ¨å¥¨ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ |
|-----------|-------|---------|------|---------------|
| **Scalarï¼ˆint8ï¼‰** | 4x | 2x | 0.99 | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¨å¥¨ã€ç²¾åº¦é‡è¦– |
| **Binaryï¼ˆ1-bitï¼‰** | 32x | 40x | 0.95 | 1536æ¬¡å…ƒä»¥ä¸Šã€é€Ÿåº¦é‡è¦– |
| **Binaryï¼ˆ2-bitï¼‰** | 16x | 20x | 0.95+ | ã‚¼ãƒ­è¿‘å‚å€¤ãŒå¤šã„ãƒ‡ãƒ¼ã‚¿ |
| **Product** | 64x | 0.5x | 0.7 | ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ¥µå°åŒ– |

```python
# qdrant_quantization.py
from qdrant_client import QdrantClient, models

client = QdrantClient(url="http://localhost:6333")

def create_collection_with_scalar_quantization(name: str, dimension: int):
    """
    Scalaré‡å­åŒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã€‚
    ç²¾åº¦0.99ã‚’ç¶­æŒã—ã¤ã¤ãƒ¡ãƒ¢ãƒªã‚’4åˆ†ã®1ã«å‰Šæ¸›ã€‚
    """
    client.create_collection(
        collection_name=name,
        vectors_config=models.VectorParams(
            size=dimension,
            distance=models.Distance.COSINE,
        ),
        # HNSWã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­å®š
        hnsw_config=models.HnswConfigDiff(
            m=16,
            ef_construct=128,
            full_scan_threshold=10000,  # 10000ä»¶ä»¥ä¸‹ã¯ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³
        ),
        # Scalaré‡å­åŒ–: float32 â†’ int8
        quantization_config=models.ScalarQuantization(
            scalar=models.ScalarQuantizationConfig(
                type=models.ScalarType.INT8,
                quantile=0.99,      # å¤–ã‚Œå€¤1%ã‚’é™¤å¤–
                always_ram=True,    # é‡å­åŒ–ãƒ™ã‚¯ãƒˆãƒ«ã‚’RAMã«å¸¸é§
            ),
        ),
    )

def create_collection_with_binary_quantization(name: str, dimension: int):
    """
    Binaryé‡å­åŒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ï¼ˆ1536æ¬¡å…ƒä»¥ä¸Šæ¨å¥¨ï¼‰ã€‚
    ãƒ¡ãƒ¢ãƒª32åˆ†ã®1ã€æ¤œç´¢é€Ÿåº¦æœ€å¤§40å€ã€‚ãŸã ã—recallã¯ç´„0.95ã€‚
    """
    if dimension < 1536:
        raise ValueError(
            f"Binaryé‡å­åŒ–ã¯1536æ¬¡å…ƒä»¥ä¸Šã‚’æ¨å¥¨ï¼ˆç¾åœ¨: {dimension}æ¬¡å…ƒï¼‰ã€‚"
            "ä½æ¬¡å…ƒã§ã¯recallãŒå¤§å¹…ã«ä½ä¸‹ã—ã¾ã™ã€‚"
        )

    client.create_collection(
        collection_name=name,
        vectors_config=models.VectorParams(
            size=dimension,
            distance=models.Distance.COSINE,
        ),
        quantization_config=models.BinaryQuantization(
            binary=models.BinaryQuantizationConfig(
                always_ram=True,
            ),
        ),
    )
```

**æ¤œç´¢æ™‚ã®ãƒªã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°è¨­å®š**ãŒç²¾åº¦ç¶­æŒã®éµã§ã™ã€‚

```python
def search_with_rescore(collection_name: str, query_vector: list[float], top_k: int = 10):
    """
    é‡å­åŒ–ãƒ™ã‚¯ãƒˆãƒ«ã§é«˜é€Ÿã«å€™è£œã‚’çµã‚Šã€
    å…ƒã®float32ãƒ™ã‚¯ãƒˆãƒ«ã§ãƒªã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã—ã¦ç²¾åº¦ã‚’å›å¾©ã™ã‚‹ã€‚
    """
    results = client.query_points(
        collection_name=collection_name,
        query=query_vector,
        search_params=models.SearchParams(
            hnsw_ef=128,
            quantization=models.QuantizationSearchParams(
                ignore=False,       # é‡å­åŒ–ãƒ™ã‚¯ãƒˆãƒ«ã‚’ä½¿ç”¨
                rescore=True,       # å…ƒãƒ™ã‚¯ãƒˆãƒ«ã§ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°
                oversampling=2.0,   # å€™è£œã‚’top_kã®2å€å–å¾—
            ),
        ),
        limit=top_k,
    )
    return results
```

**ãªãœrescore=TrueãŒé‡è¦ã‹**:

é‡å­åŒ–ã«ã‚ˆã‚Šè·é›¢è¨ˆç®—ã®ç²¾åº¦ãŒä¸‹ãŒã‚‹ãŸã‚ã€`oversampling=2.0`ã§2å€ã®å€™è£œã‚’å–å¾—ã—ã€å…ƒã®float32ãƒ™ã‚¯ãƒˆãƒ«ã§å†ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã—ã¾ã™ã€‚Qdrantå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ã€ã“ã®è¨­å®šã§Scalaré‡å­åŒ–ã®recallã¯0.95â†’0.99ã«å›å¾©ã—ã¾ã™ã€‚

> **æ³¨æ„ç‚¹**: Qdrant 1.15ã§å°å…¥ã•ã‚ŒãŸã€ŒHNSW healingã€æ©Ÿèƒ½ã«ã‚ˆã‚Šã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–æ™‚ã«æ—¢å­˜ã‚°ãƒ©ãƒ•æƒ…å ±ã‚’å†åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚å¤§è¦æ¨¡ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå¿…è¦ãªå ´åˆã«æ§‹ç¯‰æ™‚é–“ã‚’å‰Šæ¸›ã§ãã¾ã™ã€‚ãŸã ã—ã€ã“ã®æ©Ÿèƒ½ã¯ãƒ‡ãƒ¼ã‚¿ã®å¤§å¹…ãªå¤‰æ›´ï¼ˆ50%ä»¥ä¸Šã®å…¥ã‚Œæ›¿ãˆï¼‰ã«ã¯åŠ¹æœãŒé™å®šçš„ã§ã™ã€‚

### Milvus 2.5ã§IVFã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨GPUã‚’æ´»ç”¨ã™ã‚‹

Milvusã¯è¤‡æ•°ã®IVFãƒãƒªã‚¢ãƒ³ãƒˆã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚NVIDIA cuVSã¨ã®çµ±åˆã«ã‚ˆã‚Šã€GPUã‚¢ã‚¯ã‚»ãƒ©ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚åˆ©ç”¨å¯èƒ½ã§ã™ã€‚

```python
# milvus_ivf_setup.py
from pymilvus import MilvusClient

client = MilvusClient(uri="http://localhost:19530")

def create_collection_with_ivf_index(
    name: str,
    dimension: int,
    num_vectors: int,
    use_gpu: bool = False,
):
    """
    ãƒ‡ãƒ¼ã‚¿è¦æ¨¡ã«å¿œã˜ãŸIVFã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ§‹æˆã™ã‚‹ã€‚
    num_vectors: æƒ³å®šãƒ™ã‚¯ãƒˆãƒ«æ•°ï¼ˆnlistè¨ˆç®—ã«ä½¿ç”¨ï¼‰
    """
    import math

    # nlistã®æ±ºå®š: sqrt(N) ~ 4*sqrt(N)
    nlist = int(math.sqrt(num_vectors) * 2)
    nlist = max(128, min(nlist, 65536))

    # ãƒ‡ãƒ¼ã‚¿è¦æ¨¡ã«å¿œã˜ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ—é¸æŠ
    if num_vectors < 1_000_000:
        # 100ä¸‡ä»¶æœªæº€: IVF_FLATï¼ˆåœ§ç¸®ãªã—ã€ç²¾åº¦æœ€å¤§ï¼‰
        index_type = "GPU_IVF_FLAT" if use_gpu else "IVF_FLAT"
        index_params = {"nlist": nlist}
    elif num_vectors < 100_000_000:
        # 1å„„ä»¶æœªæº€: IVF_SQ8ï¼ˆã‚¹ã‚«ãƒ©ãƒ¼é‡å­åŒ–ã€ãƒ¡ãƒ¢ãƒª75%å‰Šæ¸›ï¼‰
        index_type = "IVF_SQ8"
        index_params = {"nlist": nlist}
    else:
        # 1å„„ä»¶ä»¥ä¸Š: IVF_PQï¼ˆãƒ—ãƒ­ãƒ€ã‚¯ãƒˆé‡å­åŒ–ã€ãƒ¡ãƒ¢ãƒªå¤§å¹…å‰Šæ¸›ï¼‰
        index_type = "GPU_IVF_PQ" if use_gpu else "IVF_PQ"
        # mã¯dimensionã®ç´„æ•°ã«ã™ã‚‹
        m_pq = 8 if dimension % 8 == 0 else 4
        index_params = {"nlist": nlist, "m": m_pq, "nbits": 8}

    # ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆ
    client.create_collection(
        collection_name=name,
        dimension=dimension,
    )

    # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
    index_config = {
        "index_type": index_type,
        "metric_type": "COSINE",
        "params": index_params,
    }
    client.create_index(
        collection_name=name,
        field_name="vector",
        index_params=index_config,
    )

    return {
        "index_type": index_type,
        "nlist": nlist,
        "estimated_nprobe": max(1, nlist // 100),
    }
```

NVIDIA Technical Blogã®å ±å‘Šã«ã‚ˆã‚‹ã¨ã€cuVSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã®çµ±åˆã§ä»¥ä¸‹ã®æ€§èƒ½æ”¹å–„ãŒå®Ÿç¾ã•ã‚Œã¦ã„ã¾ã™ã€‚

| æŒ‡æ¨™ | CPUï¼ˆIVF_FLATï¼‰ | GPUï¼ˆGPU_IVF_FLATï¼‰ | æ”¹å–„ç‡ |
|------|----------------|-------------------|-------|
| ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰ | 6.22æ—¥ | 56åˆ† | **160å€é«˜é€Ÿ** |
| æ¤œç´¢ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· | ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ | 10%ï¼ˆ90%å‰Šæ¸›ï¼‰ | **10å€é«˜é€Ÿ** |
| å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ | 635M / 1024æ¬¡å…ƒ | 8x DGX H100 | - |

```python
# æ¤œç´¢æ™‚ã®nprobeèª¿æ•´
def search_with_optimal_nprobe(
    client: MilvusClient,
    collection_name: str,
    query_vectors: list[list[float]],
    nlist: int,
    target_recall: float = 0.95,
    top_k: int = 10,
):
    """nprobeã‚’recallã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«åˆã‚ã›ã¦èª¿æ•´ã™ã‚‹ã€‚"""
    # çµŒé¨“å‰‡: recall 0.9 â†’ nprobe=nlist*1%, recall 0.95 â†’ 5%, recall 0.99 â†’ 10%
    recall_to_ratio = {0.90: 0.01, 0.95: 0.05, 0.99: 0.10}
    ratio = recall_to_ratio.get(target_recall, 0.05)
    nprobe = max(1, int(nlist * ratio))

    results = client.search(
        collection_name=collection_name,
        data=query_vectors,
        limit=top_k,
        search_params={"nprobe": nprobe},
    )
    return results
```

> **ã‚ˆãã‚ã‚‹é–“é•ã„**: GPU_IVF_PQã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰ã¯é«˜é€Ÿã§ã™ãŒã€å°‘é‡ãƒ‡ãƒ¼ã‚¿ï¼ˆ10ä¸‡ä»¶æœªæº€ï¼‰ã§ã¯GPUã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒæ¤œç´¢ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’å¢—åŠ ã•ã›ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚GPUæ´»ç”¨ã¯100ä¸‡ä»¶ä»¥ä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‹ã‚‰åŠ¹æœãŒå‡ºå§‹ã‚ã¾ã™ã€‚

## ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰åˆ¥ã®é¸å®šãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã‚’è¨­è¨ˆã™ã‚‹

å®Ÿéš›ã®é¸å®šã§ã¯ã€ãƒ‡ãƒ¼ã‚¿è¦æ¨¡ãƒ»ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·è¦ä»¶ãƒ»äºˆç®—ã®3è»¸ã§åˆ¤æ–­ã—ã¾ã™ã€‚

```mermaid
flowchart TD
    A[ãƒ™ã‚¯ãƒˆãƒ«æ•°ã¯?] -->|ï½100ä¸‡ä»¶| B[ãƒ¡ãƒ¢ãƒªã«ä½™è£•ã¯?]
    A -->|100ä¸‡ï½10å„„ä»¶| C[ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·è¦ä»¶ã¯?]
    A -->|10å„„ä»¶è¶…| D[DiskANN or IVF_PQ]

    B -->|ã¯ã„| E[HNSW<br/>m=16-32, ef=128]
    B -->|ã„ã„ãˆ| F[IVF_FLAT<br/>nlist=1024]

    C -->|p99 < 20ms| G[HNSW + Scalaré‡å­åŒ–<br/>ãƒ¡ãƒ¢ãƒª4åˆ†ã®1]
    C -->|p99 < 50ms| H[DiskANN<br/>NVMe + å°ã‚­ãƒ£ãƒƒã‚·ãƒ¥]
    C -->|ãƒãƒƒãƒå‡¦ç†| I[IVF_PQ<br/>ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆé‡è¦–]

    D -->|ã‚³ã‚¹ãƒˆé‡è¦–| J[DiskANN<br/>SSDæ´»ç”¨ã§TCOå‰Šæ¸›]
    D -->|GPUã‚ã‚Š| K[GPU_IVF_PQ<br/>Milvus + cuVS]
```

### é¸å®šã®å…·ä½“çš„ãªåˆ¤æ–­åŸºæº–

**ã‚±ãƒ¼ã‚¹1: RAGã‚·ã‚¹ãƒ†ãƒ ã®ç¤¾å†…æ¤œç´¢ï¼ˆ100ä¸‡ä»¶ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰**

PostgreSQLã‚’æ—¢ã«ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯**pgvector + HNSW**ãŒç¬¬ä¸€é¸æŠã§ã™ã€‚è¿½åŠ ã®ã‚¤ãƒ³ãƒ•ãƒ©ãªã—ã§å°å…¥ã§ãã€m=32ã€ef_construction=128ã€ef_search=100ã®è¨­å®šã§recall 95%+ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚pgvector 0.8ã®åå¾©ã‚¹ã‚­ãƒ£ãƒ³ã«ã‚ˆã‚Šã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ä»˜ãæ¤œç´¢ã®ç²¾åº¦ã‚‚æ”¹å–„ã•ã‚Œã¦ã„ã¾ã™ã€‚

**ã‚±ãƒ¼ã‚¹2: Eã‚³ãƒãƒ¼ã‚¹ã®å•†å“æ¤œç´¢ï¼ˆ1000ä¸‡ä»¶ã€ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ï¼‰**

Qdrant + Scalaré‡å­åŒ–ãŒãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„é¸æŠã§ã™ã€‚HNSWã®ç²¾åº¦ã‚’ç¶­æŒã—ã¤ã¤ãƒ¡ãƒ¢ãƒªã‚’4åˆ†ã®1ã«å‰Šæ¸›ã—ã€`rescore=True`ã§99%ã®recallã‚’ç¢ºä¿ã§ãã¾ã™ã€‚OpenAI text-embedding-3-smallï¼ˆ1536æ¬¡å…ƒï¼‰ã‚’ä½¿ã†å ´åˆã¯Binaryé‡å­åŒ–ã‚‚æ¤œè¨å¯¾è±¡ã«å…¥ã‚Šã¾ã™ã€‚

**ã‚±ãƒ¼ã‚¹3: ãƒ­ã‚°åˆ†æã®é¡ä¼¼æ¤œç´¢ï¼ˆ10å„„ä»¶ã€ãƒãƒƒãƒå‡¦ç†ï¼‰**

DiskANNã¾ãŸã¯IVF_PQãŒé©ã—ã¦ã„ã¾ã™ã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ãŒä¸è¦ã§ã‚ã‚Œã°ã€IVF_PQï¼ˆMilvus + GPUï¼‰ã§ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã‚’æœ€å¤§åŒ–ã§ãã¾ã™ã€‚NVIDIAã®å ±å‘Šã§ã¯ã€8å°ã®DGX H100ã§635Mãƒ™ã‚¯ãƒˆãƒ«ï¼ˆ1024æ¬¡å…ƒï¼‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰ãŒ56åˆ†ã§å®Œäº†ã—ã¦ã„ã¾ã™ã€‚

### ã‚³ã‚¹ãƒˆè©¦ç®—ã®ä¾‹

10å„„ãƒ™ã‚¯ãƒˆãƒ«ï¼ˆ768æ¬¡å…ƒï¼‰ã‚’é‹ç”¨ã™ã‚‹å ´åˆã®æœˆé¡ã‚³ã‚¹ãƒˆæ¦‚ç®—ã§ã™ã€‚

| æ§‹æˆ | ãƒ¡ãƒ¢ãƒª | ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ | æœˆé¡æ¦‚ç®—ï¼ˆAWSï¼‰ |
|------|-------|----------|-------------|
| HNSWï¼ˆRAMå…¨è¼‰ã›ï¼‰ | 3TB RAM | - | $15,000-20,000 |
| HNSW + Scalaré‡å­åŒ– | 750GB RAM | - | $5,000-7,000 |
| DiskANN | 64GB RAM | 3TB NVMe | $2,000-3,000 |
| IVF_PQ | 128GB RAM | 1TB NVMe | $2,500-3,500 |

> **åˆ¶ç´„æ¡ä»¶**: ä¸Šè¨˜ã¯æ¦‚ç®—ã§ã‚ã‚Šã€å®Ÿéš›ã®ã‚³ã‚¹ãƒˆã¯ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã€ãƒªã‚¶ãƒ¼ãƒ–ãƒ‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æœ‰ç„¡ã€ãƒ‡ãƒ¼ã‚¿è»¢é€é‡ã«ã‚ˆã‚Šå¤‰å‹•ã—ã¾ã™ã€‚æœ¬ç•ªå°å…¥å‰ã«å®Ÿãƒ‡ãƒ¼ã‚¿ã§ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

## ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

| å•é¡Œ | åŸå›  | è§£æ±ºæ–¹æ³• |
|------|------|----------|
| HNSWã®recallãŒ90%ã«å±Šã‹ãªã„ | `ef_search`ãŒä½ã™ãã‚‹ | `ef_search`ã‚’m*4ä»¥ä¸Šã«å¢—åŠ ï¼ˆä¾‹: m=32ãªã‚‰128ä»¥ä¸Šï¼‰ |
| ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰ãŒé…ã„ï¼ˆpgvectorï¼‰ | `maintenance_work_mem`ä¸è¶³ | ã‚°ãƒ©ãƒ•å…¨ä½“ãŒåã¾ã‚‹ã‚µã‚¤ã‚ºã«å¢—åŠ ï¼ˆä¾‹: 4GBâ†’16GBï¼‰ |
| ãƒ•ã‚£ãƒ«ã‚¿æ¤œç´¢ã§çµæœãŒå°‘ãªã„ | HNSWã®å¾Œãƒ•ã‚£ãƒ«ã‚¿ã§å–ã‚Šã“ã¼ã— | pgvector 0.8ã®`hnsw.iterative_scan = relaxed_order`ã‚’æœ‰åŠ¹åŒ– |
| Binaryé‡å­åŒ–ã§recallãŒä½ã„ | ä½æ¬¡å…ƒãƒ™ã‚¯ãƒˆãƒ«ã§ä½¿ç”¨ | 1536æ¬¡å…ƒæœªæº€ã§ã¯Scalaré‡å­åŒ–ã«åˆ‡ã‚Šæ›¿ãˆ |
| GPU_IVF_PQã§æ¤œç´¢ãŒé…ã„ | ãƒ‡ãƒ¼ã‚¿é‡ãŒå°‘ãªã™ãã‚‹ | 100ä¸‡ä»¶æœªæº€ã§ã¯CPUç‰ˆIVF_FLATã®æ–¹ãŒé«˜é€Ÿ |
| DiskANNã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒä¸å®‰å®š | SSDã®I/Oå¸¯åŸŸãŒä¸è¶³ | NVMe SSDã®å“è³ªã‚’ç¢ºèªã€IOPS 100K+ã‚’æ¨å¥¨ |

## ã¾ã¨ã‚ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

**ã¾ã¨ã‚:**

- **HNSW**ã¯æ•°ç™¾ä¸‡ã€œæ•°å„„ä»¶ã®ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªæ¤œç´¢ã§æœ€ã‚‚æ±ç”¨çš„ãªé¸æŠè‚¢ã€‚pgvector 0.8ã®åå¾©ã‚¹ã‚­ãƒ£ãƒ³ãƒ»ä¸¦åˆ—ãƒ“ãƒ«ãƒ‰ã«ã‚ˆã‚Šã€PostgreSQLç’°å¢ƒã§ã®å®Ÿç”¨æ€§ãŒå‘ä¸Š
- **IVFï¼ˆ+PQï¼‰**ã¯ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã¨ãƒ•ã‚£ãƒ«ã‚¿æ¤œç´¢ã«å„ªã‚Œã€ãƒãƒƒãƒå‡¦ç†ã‚„GPUæ´»ç”¨ã§10å„„è¦æ¨¡ã«å¯¾å¿œå¯èƒ½ã€‚Milvus + cuVSã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰ã‚’160å€é«˜é€ŸåŒ–
- **DiskANN**ã¯10å„„è¦æ¨¡ã§HNSWæ¯”70-90%ã®ãƒ¡ãƒ¢ãƒªå‰Šæ¸›ã‚’å®Ÿç¾ã—ã€TCOã‚’å¤§å¹…ã«å‰Šæ¸›ã€‚SQL Server 2025ã§ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚µãƒãƒ¼ãƒˆã«ã‚ˆã‚Šå°å…¥éšœå£ãŒä½ä¸‹
- **é‡å­åŒ–**ã¯ã©ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¨ã‚‚çµ„ã¿åˆã‚ã›å¯èƒ½ã€‚Scalaré‡å­åŒ–ï¼ˆ4xåœ§ç¸®/ç²¾åº¦0.99ï¼‰ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¨å¥¨ã€1536æ¬¡å…ƒä»¥ä¸Šã§ã¯Binaryé‡å­åŒ–ï¼ˆ32xåœ§ç¸®/é€Ÿåº¦40xï¼‰ã‚‚æ¤œè¨
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã®åŠ¹æœã¯å¤§ããã€**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‹ã‚‰ã®æœ€é©åŒ–ã§QPSãŒ2-5å€æ”¹å–„**ã™ã‚‹ã“ã¨ãŒä¸€èˆ¬çš„

**æ¬¡ã«ã‚„ã‚‹ã¹ãã“ã¨:**

1. è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§recall-latencyã‚«ãƒ¼ãƒ–ã‚’è¨ˆæ¸¬ã™ã‚‹ï¼ˆæœ¬è¨˜äº‹ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚³ãƒ¼ãƒ‰ã‚’å‚è€ƒï¼‰
2. æœ¬ç•ªãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®p50/p95/p99ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’ç›£è¦–ã—ã€`ef_search`ã‚„`nprobe`ã‚’æ®µéšçš„ã«èª¿æ•´ã™ã‚‹
3. ãƒ‡ãƒ¼ã‚¿è¦æ¨¡ã®å¢—åŠ äºˆæ¸¬ã«åŸºã¥ãã€HNSWâ†’DiskANNã¸ã®ç§»è¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æ¤œè¨ã™ã‚‹

## å‚è€ƒ

- [HNSW Indexes with Postgres and pgvector - Crunchy Data Blog](https://www.crunchydata.com/blog/hnsw-indexes-with-postgres-and-pgvector)
- [pgvector 0.8.0 Released! - PostgreSQL](https://www.postgresql.org/about/news/pgvector-080-released-2952/)
- [Quantization - Qdrant Documentation](https://qdrant.tech/documentation/guides/quantization/)
- [How to Choose Between IVF and HNSW for ANN Vector Search - Milvus Blog](https://milvus.io/blog/understanding-ivf-vector-index-how-It-works-and-when-to-choose-it-over-hnsw.md)
- [Enhancing GPU-Accelerated Vector Search in Faiss with NVIDIA cuVS - NVIDIA Technical Blog](https://developer.nvidia.com/blog/enhancing-gpu-accelerated-vector-search-in-faiss-with-nvidia-cuvs/)
- [HNSW vs. DiskANN - Tiger Data](https://www.tigerdata.com/learn/hnsw-vs-diskann)
- [ANN-Benchmarks](https://ann-benchmarks.com/)
- [Faster similarity search with pgvector indexes - Google Cloud Blog](https://cloud.google.com/blog/products/databases/faster-similarity-search-performance-with-pgvector-indexes)

---

:::message
ã“ã®è¨˜äº‹ã¯AIï¼ˆClaude Codeï¼‰ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å†…å®¹ã®æ­£ç¢ºæ€§ã«ã¤ã„ã¦ã¯è¤‡æ•°ã®æƒ…å ±æºã§æ¤œè¨¼ã—ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã®åˆ©ç”¨æ™‚ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚ã”ç¢ºèªãã ã•ã„ã€‚
:::
