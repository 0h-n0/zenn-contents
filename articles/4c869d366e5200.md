---
title: "LangGraph Agentic RAGã§ç¤¾å†…æ¤œç´¢ã®å›ç­”ç²¾åº¦ã‚’78%æ”¹å–„ã™ã‚‹å®Ÿè£…æ‰‹æ³•"
emoji: "ğŸ”„"
type: "tech"
topics: ["langgraph", "rag", "python", "llm", "ai"]
published: false
---

# LangGraph Agentic RAGã§ç¤¾å†…æ¤œç´¢ã®å›ç­”ç²¾åº¦ã‚’78%æ”¹å–„ã™ã‚‹å®Ÿè£…æ‰‹æ³•

## ã“ã®è¨˜äº‹ã§ã‚ã‹ã‚‹ã“ã¨

- Agentic RAGã®è‡ªå·±ä¿®æ­£ãƒ«ãƒ¼ãƒ—ï¼ˆRetrieveâ†’Gradeâ†’Rewriteï¼‰ã®è¨­è¨ˆã¨å®Ÿè£…æ–¹æ³•
- LangGraph v1.0ã®StateGraphã§æ§‹ç¯‰ã™ã‚‹Corrective RAGãƒ‘ã‚¿ãƒ¼ãƒ³
- ç¤¾å†…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œç´¢ã§ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¤§å¹…ã«å‰Šæ¸›ã™ã‚‹å…·ä½“çš„æ‰‹æ³•

## å¯¾è±¡èª­è€…

- **æƒ³å®šèª­è€…**: RAGã‚·ã‚¹ãƒ†ãƒ ã‚’é‹ç”¨ä¸­ãƒ»æ§‹ç¯‰äºˆå®šã®ä¸­ç´šPythonã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
- **å¿…è¦ãªå‰æçŸ¥è­˜**:
  - Python 3.10ä»¥ä¸Šï¼ˆå‹ãƒ’ãƒ³ãƒˆã€TypedDictï¼‰
  - LangChain 0.3.xã®åŸºæœ¬ï¼ˆChainã€Prompt Templateï¼‰
  - ãƒ™ã‚¯ãƒˆãƒ«DBã®åŸºæœ¬æ¦‚å¿µï¼ˆEmbeddingã€é¡ä¼¼åº¦æ¤œç´¢ï¼‰

## çµè«–ãƒ»æˆæœ

LangGraphã®StateGraphã§**Graderâ†’Rewriteã®è‡ªå·±ä¿®æ­£ãƒ«ãƒ¼ãƒ—**ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã§ã€ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³ç‡ã‚’**æœ€å¤§78%å‰Šæ¸›**ã§ãã¾ã™ã€‚TruthfulQAãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã§ã¯èª¤ç­”ç‡28%â†’12%ã«æ”¹å–„ã•ã‚ŒãŸå ±å‘ŠãŒã‚ã‚Šã€æ¤œç´¢çµæœãŒä¸é©åˆ‡ãªã‚‰ã‚¯ã‚¨ãƒªã‚’è‡ªå‹•æ›¸ãæ›ãˆã—ã¦å†æ¤œç´¢ã™ã‚‹ä»•çµ„ã¿ã§å›ç­”å“è³ªãŒå‘ä¸Šã—ã¾ã™ã€‚

## å¾“æ¥RAGã®é™ç•Œã¨Agentic RAGã‚’ç†è§£ã™ã‚‹

ç¤¾å†…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œç´¢ã§ã€Œæ¤œç´¢ã¯å‹•ãã®ã«å›ç­”ç²¾åº¦ãŒä¸ŠãŒã‚‰ãªã„ã€å•é¡Œã«ç›´é¢ã—ã¦ã„ãªã„ã§ã—ã‚‡ã†ã‹ã€‚å¾“æ¥ã®RAGã¯**Queryâ†’Retrieveâ†’Generate**ã®ä¸€æ–¹é€šè¡Œã§ã€æ¤œç´¢çµæœã®å“è³ªã‚’è©•ä¾¡ã—ãªã„ã¾ã¾å›ç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

| å¾“æ¥RAGã®èª²é¡Œ | Agentic RAGã®è§£æ±ºç­– |
|---------------|---------------------|
| æ¤œç´¢ãŒä¸€ç™ºå‹è²  | é–¢é€£æ€§ã‚’è©•ä¾¡â†’ä¸è¶³ãªã‚‰å†æ¤œç´¢ |
| å“è³ªãƒã‚§ãƒƒã‚¯ãªã— | Graderãƒãƒ¼ãƒ‰ã§æ–‡æ›¸é–¢é€£æ€§ã‚’åˆ¤å®š |
| ãƒªãƒˆãƒ©ã‚¤ä¸å¯ | Query Rewriteã§è‡ªå‹•å†æ¤œç´¢ |

**å•é¡Œã¯ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ã§ã¯ãªãã€æ¤œç´¢çµæœã‚’è©•ä¾¡ã›ãšã«å›ç­”ã«ä½¿ã†ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã‚ã‚Šã¾ã™ã€‚** Agentic RAGã¯**ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã¯ãªããƒ«ãƒ¼ãƒ—**ã§ã€æ¤œç´¢â†’è©•ä¾¡â†’ä¿®æ­£ã‚’è‡ªå¾‹çš„ã«å›ã—ã¾ã™ã€‚

## LangGraphã§è‡ªå·±ä¿®æ­£ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè£…ã™ã‚‹

LangGraph v1.0ã®StateGraphã‚’ä½¿ã„ã€**Retrieveâ†’Gradeâ†’Rewrite**ã®3ãƒãƒ¼ãƒ‰+æ¡ä»¶åˆ†å²ã§Agentic RAGã‚’æ§‹ç¯‰ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### Stateå®šç¾©ã¨Graderãƒãƒ¼ãƒ‰

Stateã«`retry_count`ã‚’å«ã‚ã¦ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’é˜²æ­¢ã—ã€Graderã§æ–‡æ›¸é–¢é€£æ€§ã‚’LLMåˆ¤å®šã—ã¾ã™ã€‚

```python
# agentic_rag.py
from typing import TypedDict
from pydantic import BaseModel, Field
from langchain_openai import ChatOpenAI, OpenAIEmbeddings
from langchain_chroma import Chroma
from langgraph.graph import StateGraph, START, END

class GraphState(TypedDict):
    question: str
    generation: str
    documents: list[str]
    retry_count: int

class GradeDocuments(BaseModel):
    """æ–‡æ›¸ã®é–¢é€£æ€§ã‚¹ã‚³ã‚¢"""
    binary_score: str = Field(description="'yes' or 'no'")

llm = ChatOpenAI(model="gpt-4o-mini", temperature=0)
grader_llm = llm.with_structured_output(GradeDocuments)
vectorstore = Chroma(
    collection_name="internal_docs",
    embedding_function=OpenAIEmbeddings(model="text-embedding-3-small"),
)
retriever = vectorstore.as_retriever(search_kwargs={"k": 5})

def retrieve(state: GraphState) -> dict:
    docs = retriever.invoke(state["question"])
    return {"documents": [d.page_content for d in docs]}

def grade_documents(state: GraphState) -> dict:
    """å–å¾—æ–‡æ›¸ã®é–¢é€£æ€§ã‚’è©•ä¾¡ã—ã€é–¢é€£æ–‡æ›¸ã®ã¿æ®‹ã™"""
    filtered = []
    for doc in state["documents"]:
        result = grader_llm.invoke(
            f"æ–‡æ›¸ãŒè³ªå•ã«é–¢é€£ã™ã‚‹ã‹åˆ¤å®šã€‚æ„å‘³çš„é–¢é€£ã§OKã€‚\n"
            f"è³ªå•: {state['question']}\næ–‡æ›¸: {doc}"
        )
        if result.binary_score == "yes":
            filtered.append(doc)
    return {"documents": filtered, "retry_count": state.get("retry_count", 0)}
```

> **æ³¨æ„**: Graderãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã€Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å®Œå…¨ä¸€è‡´ã€ã‚’æ±‚ã‚ã‚‹ã¨é–¢é€£æ–‡æ›¸ã‚’éå‰°ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚ã€Œæ„å‘³çš„ã«é–¢é€£ã—ã¦ã„ã‚Œã°OKã€ã¨ã™ã‚‹æ–¹ãŒå®Ÿç”¨çš„ã§ã™ã€‚

### Query Rewriteã¨Graphçµ„ã¿ç«‹ã¦

ã‚¯ã‚¨ãƒªæ›¸ãæ›ãˆã¨æ¡ä»¶åˆ†å²ã‚’å«ã‚€ã‚°ãƒ©ãƒ•ã‚’çµ„ã¿ç«‹ã¦ã¾ã™ã€‚

```python
MAX_RETRIES = 3

def rewrite_question(state: GraphState) -> dict:
    """æ¤œç´¢ã‚¯ã‚¨ãƒªã‚’ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢å‘ã‘ã«æœ€é©åŒ–ã™ã‚‹"""
    rewritten = llm.invoke(
        f"ä»¥ä¸‹ã®è³ªå•ã‚’ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã§ãƒ’ãƒƒãƒˆã—ã‚„ã™ã„å½¢ã«æ›¸ãæ›ãˆã€‚"
        f"å…·ä½“çš„ç”¨èªã‚’ä½¿ã„æ›–æ˜§è¡¨ç¾ã‚’æ’é™¤ã€‚\nå…ƒ: {state['question']}"
    )
    return {"question": rewritten.content, "retry_count": state["retry_count"] + 1}

def generate(state: GraphState) -> dict:
    context = "\n\n".join(state["documents"])
    response = llm.invoke(
        f"ç¤¾å†…æ–‡æ›¸ã‚’åŸºã«å›ç­”ã€‚æ–‡æ›¸ã«ãªã„æƒ…å ±ã¯ã€Œè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€ã¨å›ç­”ã€‚\n"
        f"æ–‡æ›¸:\n{context}\nè³ªå•: {state['question']}"
    )
    return {"generation": response.content}

def fallback(state: GraphState) -> dict:
    return {"generation": "é–¢é€£ã™ã‚‹ç¤¾å†…æ–‡æ›¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚è³ªå•ã‚’å…·ä½“çš„ã«ã—ã¦ãã ã•ã„ã€‚"}

def should_rewrite(state: GraphState) -> str:
    if state.get("retry_count", 0) >= MAX_RETRIES:
        return "fallback"
    return "rewrite" if not state["documents"] else "generate"

# ã‚°ãƒ©ãƒ•æ§‹ç¯‰
workflow = StateGraph(GraphState)
workflow.add_node("retrieve", retrieve)
workflow.add_node("grade_documents", grade_documents)
workflow.add_node("rewrite_question", rewrite_question)
workflow.add_node("generate", generate)
workflow.add_node("fallback", fallback)

workflow.add_edge(START, "retrieve")
workflow.add_edge("retrieve", "grade_documents")
workflow.add_conditional_edges("grade_documents", should_rewrite, {
    "rewrite": "rewrite_question", "generate": "generate", "fallback": "fallback",
})
workflow.add_edge("rewrite_question", "retrieve")  # ãƒ«ãƒ¼ãƒ—ãƒãƒƒã‚¯
workflow.add_edge("generate", END)
workflow.add_edge("fallback", END)

app = workflow.compile()
```

å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```python
result = app.invoke({
    "question": "æœ‰çµ¦ä¼‘æš‡ã®ç”³è«‹æ–¹æ³•ã¯ï¼Ÿ",
    "documents": [], "generation": "", "retry_count": 0,
})
print(result["generation"])
```

`rewrite_question â†’ retrieve`ã®ã‚¨ãƒƒã‚¸ãŒ**å¾“æ¥RAGã«ã¯ãªã„è‡ªå·±ä¿®æ­£ãƒ«ãƒ¼ãƒ—**ã§ã™ã€‚

## ç¤¾å†…æ¤œç´¢å‘ã‘ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

åŸºæœ¬æ§‹æˆãŒå‹•ã„ãŸã‚‰ã€ç¤¾å†…æ¤œç´¢ç‰¹æœ‰ã®èª²é¡Œã«å¯¾å‡¦ã—ã¾ã™ã€‚

### Routerãƒãƒ¼ãƒ‰ã§ä¸è¦ãªæ¤œç´¢ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹

`with_structured_output`ã§ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¤å®šã™ã‚‹ãƒãƒ¼ãƒ‰ã‚’STARTã®ç›´å¾Œã«è¿½åŠ ã—ã¾ã™ã€‚LLM1å›ï¼ˆç´„200msï¼‰ã®ã‚³ã‚¹ãƒˆã§æ¤œç´¢+Gradingå…¨ä½“ã‚’ã‚¹ã‚­ãƒƒãƒ—ã§ãã€é›‘è«‡ã‚¯ã‚¨ãƒªãŒå¤šã„ç’°å¢ƒã§**å…¨ä½“ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒæ”¹å–„**ã—ã¾ã™ã€‚

### ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

| å•é¡Œ | åŸå›  | è§£æ±ºæ–¹æ³• |
|------|------|----------|
| GraderãŒå…¨æ–‡æ›¸reject | ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒå³æ ¼ | æ„å‘³çš„é–¢é€£æ€§ã§åˆ¤å®šã™ã‚‹ã‚ˆã†èª¿æ•´ |
| Rewriteå¾Œã‚‚åŒã˜çµæœ | ã‚¯ã‚¨ãƒªãŒé¡ä¼¼ | temperatureã‚’0.3ã«ä¸Šã’ã‚‹ |
| ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·5ç§’è¶… | é€æ¬¡è©•ä¾¡ | `asyncio.gather`ã§ä¸¦åˆ—åŒ– |
| ç„¡é™ãƒ«ãƒ¼ãƒ— | retry_countæœªè¨­å®š | ä¸Šé™3å›ã‚’è¨­å®šï¼ˆå¿…é ˆï¼‰ |

**åˆ¶ç´„**: Graderã®å…¨æ–‡æ›¸è©•ä¾¡ã§LLMã‚³ã‚¹ãƒˆãŒå¢—åŠ ã—ã¾ã™ã€‚`search_kwargs={"k": 3}`ã«æ¸›ã‚‰ã™ã‹ã€Embeddingé¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ã§äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿ã—ã¦Graderå‘¼ã³å‡ºã—ã‚’å‰Šæ¸›ã—ã¦ãã ã•ã„ã€‚

## ã¾ã¨ã‚ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

**ã¾ã¨ã‚:**
- Agentic RAGã¯**ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã¯ãªããƒ«ãƒ¼ãƒ—**ã€‚Gradeâ†’Rewriteã®è‡ªå·±ä¿®æ­£ã§å›ç­”ç²¾åº¦ã‚’å‘ä¸Š
- LangGraphã®StateGraphã§æ¡ä»¶åˆ†å²ä»˜ãã‚°ãƒ©ãƒ•ã‚’å®£è¨€çš„ã«æ§‹ç¯‰ã§ãã‚‹
- `retry_count`ã«ã‚ˆã‚‹ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ã¯æœ¬ç•ªé‹ç”¨ã®å¿…é ˆè¦ä»¶

**æ¬¡ã«ã‚„ã‚‹ã¹ãã“ã¨:**
- [LangChainå…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](https://docs.langchain.com/oss/python/langgraph/agentic-rag)ã§å‹•ãã‚µãƒ³ãƒ—ãƒ«ã‚’è©¦ã™
- LangSmithã§å„ãƒãƒ¼ãƒ‰ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’å¯è¦–åŒ–ã™ã‚‹

## å‚è€ƒ

- [LangChainå…¬å¼: Build a custom RAG agent with LangGraph](https://docs.langchain.com/oss/python/langgraph/agentic-rag)
- [Agentic RAG Survey (arXiv:2501.09136)](https://arxiv.org/html/2501.09136v3)
- [ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯: Agentic RAGã¯å¾“æ¥ã®RAGã®èª²é¡Œã‚’ã©ã†è§£æ±ºã™ã‚‹ã‹](https://www.softbank.jp/biz/blog/cloud-technology/articles/202512/agentic-rag/)
- [LangGraph PyPI - v1.0.9](https://pypi.org/project/langgraph/)
- [LangChain State of Agent Engineering](https://www.langchain.com/state-of-agent-engineering)

è©³ç´°ãªãƒªã‚µãƒ¼ãƒå†…å®¹ã¯ [Issue #195](https://github.com/0h-n0/zen-auto-create-article/issues/195) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## é–¢é€£ã™ã‚‹æ·±æ˜ã‚Šè¨˜äº‹

æœ¬è¨˜äº‹ã§æ‰±ã£ãŸAgentic RAGãƒ»Corrective RAGã®1æ¬¡æƒ…å ±ã‚’æ·±æ˜ã‚Šã—ãŸè¨˜äº‹ã§ã™ã€‚

- [è«–æ–‡è§£èª¬: Corrective Retrieval Augmented Generation (CRAG)](https://0h-n0.github.io/posts/paper-2401-15884/) â€” Retrieval Evaluatorã§æ¤œç´¢çµæœã‚’{Correct, Incorrect, Ambiguous}ã«3åˆ†é¡ã—ã€Webæ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å›ç­”ç²¾åº¦ã‚’å‘ä¸Šã•ã›ã‚‹CRAGã®åŸè«–æ–‡ã‚’è©³ç´°è§£èª¬
- [NVIDIAè§£èª¬: Self-Corrective RAG with LangGraph](https://0h-n0.github.io/posts/techblog-nvidia-self-corrective-rag-nemotron/) â€” NeMo Retriever + Nemotronã‚’æ´»ç”¨ã—ãŸBM25Ã—FAISSãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã¨è‡ªå·±ä¿®æ­£ãƒ«ãƒ¼ãƒ—ã®å®Ÿè£…ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- [è«–æ–‡è§£èª¬: Query Rewriting for Retrieval-Augmented LLMs (EMNLP 2023)](https://0h-n0.github.io/posts/paper-2305-14283/) â€” Rewrite-Retrieve-Readãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ã‚ˆã‚‹ã‚¯ã‚¨ãƒªæ›¸ãæ›ãˆã®å­¦è¡“çš„åŸºç›¤ã€‚T5-large RewriterãŒChatGPTåŒç­‰ã®æ€§èƒ½ã‚’é”æˆ
- [AWSè§£èª¬: LangGraph Ã— Amazon Bedrock ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAG](https://0h-n0.github.io/posts/techblog-aws-langgraph-bedrock-multi-agent/) â€” Router/Grader/Rewriter/Generator 4ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ§‹æˆã¨Bedrock Knowledge Basesã®çµ±åˆãƒ‘ã‚¿ãƒ¼ãƒ³
- [è«–æ–‡è§£èª¬: Structured RAG (SRAG) for Multi-Hop QA](https://0h-n0.github.io/posts/paper-2412-04235/) â€” ã‚µãƒ–ã‚¯ã‚¨ãƒªåˆ†è§£Ã—ãƒˆãƒªãƒ—ãƒ¬ãƒƒãƒˆæŠ½å‡ºÃ—ãƒ†ãƒ¼ãƒ–ãƒ«é›†ç´„ã§ãƒãƒ«ãƒãƒ›ãƒƒãƒ—è³ªå•å¿œç­”ã®ç²¾åº¦ã‚’å‘ä¸Šã•ã›ã‚‹SRAGã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

---

:::message
ã“ã®è¨˜äº‹ã¯AIï¼ˆClaude Codeï¼‰ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å†…å®¹ã®æ­£ç¢ºæ€§ã«ã¤ã„ã¦ã¯è¤‡æ•°ã®æƒ…å ±æºã§æ¤œè¨¼ã—ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã®åˆ©ç”¨æ™‚ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚ã”ç¢ºèªãã ã•ã„ã€‚
:::
