---
title: "Claude Sonnet 4.6ã®1Mã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å¤§è¦æ¨¡ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹"
emoji: "ğŸ“‹"
type: "tech"
topics: ["claudesonnet", "codereview", "llm", "python", "agent"]
published: false
---

# Claude Sonnet 4.6ã®1Mã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å¤§è¦æ¨¡ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹

## ã“ã®è¨˜äº‹ã§ã‚ã‹ã‚‹ã“ã¨

- Claude Sonnet 4.6ã®1Mãƒˆãƒ¼ã‚¯ãƒ³ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆãƒ™ãƒ¼ã‚¿ï¼‰ã‚’APIã‹ã‚‰æœ‰åŠ¹åŒ–ã—ã€ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã‚’ä¸€æ‹¬æŠ•å…¥ã™ã‚‹æ–¹æ³•
- ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ä¸è¦ã®ãƒªãƒã‚¸ãƒˆãƒªæ¨ªæ–­ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¨­è¨ˆã¨å®Ÿè£…
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨Batch APIã‚’çµ„ã¿åˆã‚ã›ã¦ã€é•·æ–‡ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ã‚³ã‚¹ãƒˆã‚’æœ€å¤§90%å‰Šæ¸›ã™ã‚‹ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯
- 200Kãƒˆãƒ¼ã‚¯ãƒ³ä»¥ä¸‹ã¨1Mãƒˆãƒ¼ã‚¯ãƒ³ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼å“è³ªãŒã©ã†å¤‰åŒ–ã™ã‚‹ã‹ã€LongCodeBenchã®çŸ¥è¦‹ã‚’äº¤ãˆãŸè©•ä¾¡æ‰‹æ³•
- å¤§è¦æ¨¡ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§ã®ãƒ­ãƒ³ã‚°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ´»ç”¨ã«ãŠã‘ã‚‹å®Ÿæ¸¬ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨åˆ¶ç´„äº‹é …

## å¯¾è±¡èª­è€…

- **æƒ³å®šèª­è€…**: ä¸­ç´šã€œä¸Šç´šã®Pythoné–‹ç™ºè€…ã§ã€æ•°ä¸‡è¡Œè¦æ¨¡ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼è‡ªå‹•åŒ–ã‚’æ¤œè¨ã—ã¦ã„ã‚‹æ–¹
- **å¿…è¦ãªå‰æçŸ¥è­˜**:
  - Python 3.12+ã®åŸºæœ¬æ“ä½œï¼ˆasyncioã€å‹ãƒ’ãƒ³ãƒˆï¼‰
  - Anthropic Python SDKï¼ˆ`anthropic` v0.50+ï¼‰ã®åŸºæœ¬çš„ãªAPIå‘¼ã³å‡ºã—
  - Git/GitHubã®Pull Requestãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
  - ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®åŸºæœ¬çš„ãªè¦³ç‚¹ï¼ˆè¨­è¨ˆã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼‰

## çµè«–ãƒ»æˆæœ

Claude Sonnet 4.6ã®1Mãƒˆãƒ¼ã‚¯ãƒ³ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ´»ç”¨ã—ãŸãƒªãƒã‚¸ãƒˆãƒªæ¨ªæ–­ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã‚ˆã‚Šã€**ãƒ•ã‚¡ã‚¤ãƒ«å˜ä½ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯æ¤œå‡ºãŒå›°é›£ã ã£ãŸã‚¯ãƒ­ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ä¾å­˜ã®å•é¡Œ**ï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ä¸æ•´åˆã€importãƒã‚§ãƒ¼ãƒ³ã®å¾ªç’°ä¾å­˜ãªã©ï¼‰ã‚’ä¸€æ‹¬ã§æ¤œå‡ºã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚LongCodeBenchã®è©•ä¾¡ï¼ˆarXiv:2505.07897ï¼‰ã«ã‚ˆã‚‹ã¨ã€GPT-4.1ã¯1Mãƒˆãƒ¼ã‚¯ãƒ³ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã‚‚ã‚³ãƒ¼ãƒ‰ç†è§£ã‚¿ã‚¹ã‚¯ã§**80%ã®ç²¾åº¦ã‚’ç¶­æŒ**ã—ã¦ãŠã‚Šã€å•é¡Œæ¤œå‡ºç”¨é€”ã§ã®å®Ÿç”¨æ€§ãŒç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ´»ç”¨ã«ã‚ˆã‚Šã€åŒä¸€ãƒªãƒã‚¸ãƒˆãƒªã¸ã®ç¹°ã‚Šè¿”ã—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯å…¥åŠ›ã‚³ã‚¹ãƒˆã‚’**æœ€å¤§90%å‰Šæ¸›**ï¼ˆAnthropicå…¬å¼æ–™é‡‘è¡¨ã«åŸºã¥ãè©¦ç®—ï¼‰ã§ãã€1å›ã‚ãŸã‚Šã®å®ŸåŠ¹ã‚³ã‚¹ãƒˆã¯ç´„$0.50ã€œ$1.50ã«æŠ‘ãˆã‚‰ã‚Œã¾ã™ã€‚

ãŸã ã—ã€LongCodeBenchï¼ˆarXiv:2505.07897ï¼‰ã®ç ”ç©¶ã§ã¯ã€1Mãƒˆãƒ¼ã‚¯ãƒ³è¦æ¨¡ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ãŠã„ã¦LLMã®ã‚³ãƒ¼ãƒ‰ä¿®å¾©ç²¾åº¦ãŒå¤§å¹…ã«ä½ä¸‹ã™ã‚‹å‚¾å‘ãŒå ±å‘Šã•ã‚Œã¦ãŠã‚Šã€**ç”¨é€”ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå•é¡Œæ¤œå‡ºãƒ»æŒ‡æ‘˜ï¼‰ã«çµã‚Šã€è‡ªå‹•ä¿®æ­£ã¯é™å®šçš„ã«ä½¿ã†**ã®ãŒç¾æ™‚ç‚¹ã§ã®ç¾å®Ÿçš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã™ã€‚

## 1Mãƒˆãƒ¼ã‚¯ãƒ³ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æœ‰åŠ¹åŒ–ã™ã‚‹

Claude Sonnet 4.6ï¼ˆ2026å¹´2æœˆ17æ—¥ãƒªãƒªãƒ¼ã‚¹ï¼‰ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§200Kãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’æŒã¡ã¾ã™ã€‚1Mãƒˆãƒ¼ã‚¯ãƒ³ã¸ã®æ‹¡å¼µã¯ãƒ™ãƒ¼ã‚¿æ©Ÿèƒ½ã¨ã—ã¦æä¾›ã•ã‚Œã¦ãŠã‚Šã€APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒ™ãƒ¼ã‚¿ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§æœ‰åŠ¹åŒ–ã§ãã¾ã™ã€‚

### APIã§ã®æœ‰åŠ¹åŒ–æ‰‹é †

```python
# reviewer_client.py
from anthropic import Anthropic

client = Anthropic()

def create_review_request(repo_content: str, review_prompt: str) -> str:
    """1Mã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹"""
    response = client.beta.messages.create(
        model="claude-sonnet-4-6-20260217",
        max_tokens=8192,
        thinking={"type": "adaptive"},  # Adaptive Thinkingæ¨å¥¨
        messages=[
            {
                "role": "user",
                "content": f"{review_prompt}\n\n{repo_content}",
            }
        ],
        betas=["context-1m-2025-08-07"],
    )
    # ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã®ã¿æŠ½å‡º
    return "\n".join(
        block.text for block in response.content if block.type == "text"
    )
```

**ãªãœã“ã®å®Ÿè£…ã‚’é¸ã‚“ã ã‹:**
- `betas=["context-1m-2025-08-07"]`ãŒ1Mã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæœ‰åŠ¹åŒ–ã®å”¯ä¸€ã®æ–¹æ³•ã§ã™ï¼ˆå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚ˆã‚Šï¼‰
- `thinking={"type": "adaptive"}`ã¯Claude 4.6ã§æ¨å¥¨ã•ã‚Œã‚‹æ€è€ƒãƒ¢ãƒ¼ãƒ‰ã§ã€å¾“æ¥ã®`budget_tokens`æŒ‡å®šã¯éæ¨å¥¨ã¨ãªã‚Šã¾ã—ãŸ
- Adaptive Thinkingã«ã‚ˆã‚Šã€ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã®è¤‡é›‘ã•ã«å¿œã˜ã¦ãƒ¢ãƒ‡ãƒ«ãŒè‡ªå‹•çš„ã«æ¨è«–ã®æ·±ã•ã‚’èª¿æ•´ã—ã¾ã™

**æ³¨æ„ç‚¹:**
> 1Mãƒˆãƒ¼ã‚¯ãƒ³ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®åˆ©ç”¨ã«ã¯**Usage Tier 4**ï¼ˆç´¯ç©èª²é‡‘$400ä»¥ä¸Šï¼‰ãŒå¿…è¦ã§ã™ã€‚Tier 4æœªæº€ã®çµ„ç¹”ã§ã¯ã“ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚ã¾ãŸã€200Kãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¶…ãˆã‚‹å…¥åŠ›ã¯è‡ªå‹•çš„ã«ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ–™é‡‘ï¼ˆå…¥åŠ›2å€ãƒ»å‡ºåŠ›1.5å€ï¼‰ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚

### åˆ©ç”¨è¦ä»¶ã¨æ–™é‡‘ä½“ç³»

| é …ç›® | å€¤ |
|------|-----|
| å¯¾å¿œãƒ¢ãƒ‡ãƒ« | Claude Opus 4.6, Sonnet 4.6, Sonnet 4.5, Sonnet 4 |
| æœ‰åŠ¹åŒ–ãƒ˜ãƒƒãƒ€ãƒ¼ | `anthropic-beta: context-1m-2025-08-07` |
| å¿…è¦Tier | Usage Tier 4ï¼ˆç´¯ç©$400+ï¼‰ |
| 200Kä»¥ä¸‹ã®å…¥åŠ›æ–™é‡‘ | $3/Mãƒˆãƒ¼ã‚¯ãƒ³ |
| 200Kè¶…ã®å…¥åŠ›æ–™é‡‘ | $6/Mãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ2å€ï¼‰ |
| 200Kä»¥ä¸‹ã®å‡ºåŠ›æ–™é‡‘ | $15/Mãƒˆãƒ¼ã‚¯ãƒ³ |
| 200Kè¶…ã®å‡ºåŠ›æ–™é‡‘ | $22.50/Mãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ1.5å€ï¼‰ |

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ã€200Kãƒˆãƒ¼ã‚¯ãƒ³ã®é–¾å€¤ã¯**å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿**ã§åˆ¤å®šã•ã‚Œã¾ã™ã€‚å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã¯æ–™é‡‘ãƒ†ã‚£ã‚¢åˆ¤å®šã«å½±éŸ¿ã—ã¾ã›ã‚“ãŒã€å…¥åŠ›ãŒ200Kã‚’è¶…ãˆãŸå ´åˆã¯å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚‚å‰²å¢—æ–™é‡‘ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚

## ãƒªãƒã‚¸ãƒˆãƒªæ¨ªæ–­ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¨­è¨ˆã™ã‚‹

å¾“æ¥ã®LLMã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«å˜ä½ã‚„PR diffå˜ä½ã§å‡¦ç†ã™ã‚‹ã®ãŒä¸€èˆ¬çš„ã§ã—ãŸã€‚1Mãƒˆãƒ¼ã‚¯ãƒ³ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ã‚ˆã‚Šã€**ãƒªãƒã‚¸ãƒˆãƒªã®æ§‹é€ å…¨ä½“ã‚’ä¸€åº¦ã«æŠŠæ¡ã—ãŸä¸Šã§ãƒ¬ãƒ“ãƒ¥ãƒ¼**ã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã‚’ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«æŠ•å…¥ã™ã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€3ã¤ã®ãƒ•ã‚§ãƒ¼ã‚ºã§æ§‹æˆã—ã¾ã™ã€‚

```
Phase 1: ãƒªãƒã‚¸ãƒˆãƒªåé›† â†’ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ„ãƒªãƒ¼æ§‹ç¯‰ + ã‚³ãƒ³ãƒ†ãƒ³ãƒ„çµåˆ
Phase 2: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹æˆ â†’ ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ + ãƒªãƒã‚¸ãƒˆãƒªå…¨æ–‡ + ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡ç¤º
Phase 3: ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ   â†’ Adaptive Thinking + æ§‹é€ åŒ–å‡ºåŠ›
```

### ãƒªãƒã‚¸ãƒˆãƒªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åé›†

```python
# repo_collector.py
import os
from pathlib import Path
from dataclasses import dataclass

@dataclass
class RepoFile:
    """ãƒªãƒã‚¸ãƒˆãƒªå†…ã®å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¾ã™ã‚‹"""
    path: str
    content: str
    token_estimate: int

# 1ãƒˆãƒ¼ã‚¯ãƒ³ â‰ˆ 4æ–‡å­—ï¼ˆè‹±èªï¼‰ã€æ—¥æœ¬èªã¯ç´„1.5æ–‡å­—/ãƒˆãƒ¼ã‚¯ãƒ³
CHARS_PER_TOKEN = 4

# ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã®æ‹¡å¼µå­
TARGET_EXTENSIONS = {
    ".py", ".ts", ".tsx", ".js", ".jsx",
    ".go", ".rs", ".java", ".kt",
    ".yaml", ".yml", ".toml", ".json",
}

# é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³
EXCLUDE_DIRS = {
    "node_modules", ".git", "__pycache__", ".venv",
    "dist", "build", ".next", "vendor",
}

def collect_repo_files(
    repo_path: str,
    max_tokens: int = 800_000,
) -> list[RepoFile]:
    """ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åé›†ã™ã‚‹

    Args:
        repo_path: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹
        max_tokens: ãƒˆãƒ¼ã‚¯ãƒ³ä¸Šé™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ800Kã€ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåˆ†ã‚’ç¢ºä¿ï¼‰

    Returns:
        ãƒˆãƒ¼ã‚¯ãƒ³ä¸Šé™å†…ã«åã¾ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ
    """
    files: list[RepoFile] = []
    total_tokens = 0

    for root, dirs, filenames in os.walk(repo_path):
        # é™¤å¤–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¹ã‚­ãƒƒãƒ—
        dirs[:] = [d for d in dirs if d not in EXCLUDE_DIRS]

        for filename in sorted(filenames):
            ext = Path(filename).suffix
            if ext not in TARGET_EXTENSIONS:
                continue

            filepath = os.path.join(root, filename)
            try:
                content = Path(filepath).read_text(encoding="utf-8")
            except (UnicodeDecodeError, PermissionError):
                continue

            rel_path = os.path.relpath(filepath, repo_path)
            token_estimate = len(content) // CHARS_PER_TOKEN

            # ãƒˆãƒ¼ã‚¯ãƒ³ä¸Šé™ãƒã‚§ãƒƒã‚¯
            if total_tokens + token_estimate > max_tokens:
                break

            files.append(RepoFile(
                path=rel_path,
                content=content,
                token_estimate=token_estimate,
            ))
            total_tokens += token_estimate

    return files


def format_repo_context(files: list[RepoFile]) -> str:
    """ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’LLMæŠ•å…¥ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›ã™ã‚‹"""
    parts = [f"# Repository Structure ({len(files)} files)\n"]

    # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ„ãƒªãƒ¼ã‚’å…ˆé ­ã«é…ç½®
    parts.append("## File Tree\n```")
    for f in files:
        parts.append(f"  {f.path} ({f.token_estimate:,} tokens)")
    parts.append("```\n")

    # å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹
    parts.append("## File Contents\n")
    for f in files:
        parts.append(f"### {f.path}\n```\n{f.content}\n```\n")

    return "\n".join(parts)
```

**æœ€åˆã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ã—ã¦ãã‚Œãã‚Œå€‹åˆ¥ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹æ–¹å¼ã‚’æ¤œè¨ã—ã¾ã—ãŸãŒã€å®Ÿéš›ã«ã¯ã‚¯ãƒ­ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ä¾å­˜ã®å•é¡Œã‚’è¦‹è½ã¨ã™åŸå› ã«ãªã‚Šã¾ã—ãŸã€‚** ãŸã¨ãˆã°ã€`models.py`ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’å¤‰æ›´ã—ãŸéš›ã«`serializers.py`ã¨`views.py`ãŒè¿½å¾“ã—ã¦ã„ãªã„ã‚±ãƒ¼ã‚¹ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«å˜ä½ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯æ¤œå‡ºãŒå›°é›£ã§ã™ã€‚1Mã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å…¨ä½“ã‚’æŠ•å…¥ã™ã‚‹ã“ã¨ã§ã€ã“ã†ã—ãŸä¸æ•´åˆã‚’ä¸€æ‹¬æ¤œå‡ºã§ãã¾ã™ã€‚

### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¨­è¨ˆ

```python
# review_prompt.py

SYSTEM_PROMPT = """ã‚ãªãŸã¯ã‚·ãƒ‹ã‚¢ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦ã€
ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚

## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹

ä»¥ä¸‹ã®è¦³ç‚¹ã§å•é¡Œã‚’æ¤œå‡ºã—ã€é‡è¦åº¦é †ã«å ±å‘Šã—ã¦ãã ã•ã„:

1. **ã‚¯ãƒ­ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§**: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ä¸æ•´åˆã€
   å‹ã®ä¸ä¸€è‡´ã€æœªä½¿ç”¨ã®import/export
2. **è¨­è¨ˆä¸Šã®å•é¡Œ**: å¾ªç’°ä¾å­˜ã€God Objectã€ä¸é©åˆ‡ãªè²¬å‹™åˆ†é›¢
3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€XSSã€ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸç§˜å¯†æƒ…å ±
4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: N+1ã‚¯ã‚¨ãƒªã€ä¸è¦ãªå†è¨ˆç®—ã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯
5. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: æ¡ã‚Šã¤ã¶ã•ã‚ŒãŸä¾‹å¤–ã€ä¸é©åˆ‡ãªãƒªãƒˆãƒ©ã‚¤

## å‡ºåŠ›å½¢å¼

å„å•é¡Œã‚’ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„:
```json
{
  "issues": [
    {
      "severity": "critical|high|medium|low",
      "category": "cross-file|design|security|performance|error-handling",
      "files": ["é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹"],
      "line_hint": "è©²å½“ç®‡æ‰€ã®æ¦‚è¦",
      "description": "å•é¡Œã®èª¬æ˜",
      "suggestion": "æ”¹å–„ææ¡ˆ"
    }
  ],
  "summary": {
    "total_issues": 0,
    "critical": 0,
    "high": 0,
    "medium": 0,
    "low": 0
  }
}
```"""

REVIEW_USER_PROMPT = """ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚
ç‰¹ã«ã‚¯ãƒ­ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ä¾å­˜ã®æ•´åˆæ€§ã«æ³¨ç›®ã—ã¦ãã ã•ã„ã€‚

{repo_context}
"""
```

**ãªãœJSONå½¢å¼ã§ã®å‡ºåŠ›ã‚’æŒ‡å®šã™ã‚‹ã‹:**
- å¾Œç¶šã®å‡¦ç†ï¼ˆGitHub PRã‚³ãƒ¡ãƒ³ãƒˆã¸ã®è‡ªå‹•æŠ•ç¨¿ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰é›†è¨ˆï¼‰ã§æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ãªãŸã‚
- Adaptive Thinkingã¨ã®çµ„ã¿åˆã‚ã›ã«ã‚ˆã‚Šã€Claude 4.6ã¯JSONå‡ºåŠ›ã§ã‚‚ååˆ†ãªæ¨è«–ç²¾åº¦ã‚’ç¶­æŒã—ã¾ã™

> ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ã€Œå•é¡Œæ¤œå‡ºã€ã«ç‰¹åŒ–ã—ã¦ã„ã¾ã™ã€‚è‡ªå‹•ä¿®æ­£ï¼ˆãƒ‘ãƒƒãƒç”Ÿæˆï¼‰ã¯1Mã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã¯ç²¾åº¦ãŒä½ä¸‹ã™ã‚‹å‚¾å‘ãŒã‚ã‚‹ãŸã‚ï¼ˆLongCodeBench LongSWE-Benchã§ã¯ã»ã¨ã‚“ã©ã®ãƒ¢ãƒ‡ãƒ«ãŒ1Mã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§æˆåŠŸç‡3%æœªæº€ï¼‰ã€ä¿®æ­£ææ¡ˆã¯è‡ªç„¶è¨€èªã®`suggestion`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ç•™ã‚ã¦ã„ã¾ã™ã€‚

### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæœ¬ä½“ã®å®Ÿè£…

```python
# review_agent.py
import json
import time
from anthropic import Anthropic
from repo_collector import collect_repo_files, format_repo_context
from review_prompt import SYSTEM_PROMPT, REVIEW_USER_PROMPT

client = Anthropic()


def run_review(
    repo_path: str,
    effort: str = "high",
    max_context_tokens: int = 800_000,
) -> dict:
    """ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹

    Args:
        repo_path: ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‘ã‚¹
        effort: Adaptive Thinkingã®effortãƒ¬ãƒ™ãƒ«ï¼ˆlow/medium/high/maxï¼‰
        max_context_tokens: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¸Šé™ãƒˆãƒ¼ã‚¯ãƒ³æ•°

    Returns:
        ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã®dict
    """
    # Phase 1: ãƒªãƒã‚¸ãƒˆãƒªåé›†
    files = collect_repo_files(repo_path, max_tokens=max_context_tokens)
    repo_context = format_repo_context(files)
    total_tokens = sum(f.token_estimate for f in files)

    print(f"åé›†ãƒ•ã‚¡ã‚¤ãƒ«æ•°: {len(files)}")
    print(f"æ¨å®šãƒˆãƒ¼ã‚¯ãƒ³æ•°: {total_tokens:,}")

    # Phase 2: ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
    start_time = time.time()

    response = client.beta.messages.create(
        model="claude-sonnet-4-6-20260217",
        max_tokens=8192,
        system=SYSTEM_PROMPT,
        thinking={"type": "adaptive", "effort": effort},
        messages=[
            {
                "role": "user",
                "content": REVIEW_USER_PROMPT.format(
                    repo_context=repo_context
                ),
            }
        ],
        betas=["context-1m-2025-08-07"],
    )

    elapsed = time.time() - start_time

    # Phase 3: çµæœè§£æ
    text_content = "\n".join(
        block.text for block in response.content if block.type == "text"
    )

    # JSONéƒ¨åˆ†ã‚’æŠ½å‡º
    try:
        json_start = text_content.index("{")
        json_end = text_content.rindex("}") + 1
        review_result = json.loads(text_content[json_start:json_end])
    except (ValueError, json.JSONDecodeError):
        review_result = {"raw_response": text_content, "parse_error": True}

    # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä»˜ä¸
    review_result["metadata"] = {
        "files_reviewed": len(files),
        "estimated_input_tokens": total_tokens,
        "actual_input_tokens": response.usage.input_tokens,
        "output_tokens": response.usage.output_tokens,
        "elapsed_seconds": round(elapsed, 1),
        "effort": effort,
        "model": "claude-sonnet-4-6-20260217",
    }

    return review_result


if __name__ == "__main__":
    import sys

    if len(sys.argv) < 2:
        print("Usage: python review_agent.py <repo_path>")
        sys.exit(1)

    result = run_review(sys.argv[1])
    print(json.dumps(result, indent=2, ensure_ascii=False))
```

## ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ã‚³ã‚¹ãƒˆã‚’å‰Šæ¸›ã™ã‚‹

1Mãƒˆãƒ¼ã‚¯ãƒ³ã®å…¥åŠ›ã¯ã€200Kè¶…ã®å ´åˆ$6/Mãƒˆãƒ¼ã‚¯ãƒ³ã§èª²é‡‘ã•ã‚Œã¾ã™ã€‚500Kãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’æ¯å›ãƒ•ãƒ«ã§æŠ•å…¥ã™ã‚‹ã¨ã€1å›ã‚ãŸã‚Šå…¥åŠ›ã ã‘ã§ç´„$3.00ã®ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚Šã¾ã™ã€‚

ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ´»ç”¨ã™ã‚Œã°ã€åŒä¸€ãƒªãƒã‚¸ãƒˆãƒªã¸ã®ç¹°ã‚Šè¿”ã—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã“ã®ã‚³ã‚¹ãƒˆã‚’å¤§å¹…ã«å‰Šæ¸›ã§ãã¾ã™ã€‚

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾å¿œã®å®Ÿè£…

```python
# cached_review.py
from anthropic import Anthropic

client = Anthropic()


def run_cached_review(
    repo_context: str,
    review_instruction: str,
) -> dict:
    """ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ´»ç”¨ã—ãŸãƒ¬ãƒ“ãƒ¥ãƒ¼

    ãƒªãƒã‚¸ãƒˆãƒªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã€
    ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡ç¤ºã®ã¿ã‚’å¤‰ãˆã¦è¤‡æ•°å›å‘¼ã³å‡ºã™ã€‚
    """
    response = client.beta.messages.create(
        model="claude-sonnet-4-6-20260217",
        max_tokens=8192,
        thinking={"type": "adaptive", "effort": "high"},
        system=[
            {
                "type": "text",
                "text": "ã‚ãªãŸã¯ã‚·ãƒ‹ã‚¢ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚",
            },
            {
                # ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ–ãƒ­ãƒƒã‚¯ã¨ã—ã¦è¨­å®š
                "type": "text",
                "text": repo_context,
                "cache_control": {"type": "ephemeral"},
            },
        ],
        messages=[
            {
                "role": "user",
                "content": review_instruction,
            }
        ],
        betas=["context-1m-2025-08-07"],
    )

    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨çŠ¶æ³ã®ç¢ºèª
    usage = response.usage
    print(f"ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›¸ãè¾¼ã¿: {getattr(usage, 'cache_creation_input_tokens', 0):,} tokens")
    print(f"ã‚­ãƒ£ãƒƒã‚·ãƒ¥èª­ã¿å–ã‚Š: {getattr(usage, 'cache_read_input_tokens', 0):,} tokens")
    print(f"é€šå¸¸å…¥åŠ›: {usage.input_tokens:,} tokens")

    return response
```

### ã‚³ã‚¹ãƒˆæ¯”è¼ƒ

500Kãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒªãƒã‚¸ãƒˆãƒªã«å¯¾ã—ã¦5å›ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œã—ãŸå ´åˆã®ã‚³ã‚¹ãƒˆè©¦ç®—ã§ã™ï¼ˆAnthropicå…¬å¼æ–™é‡‘è¡¨ã«åŸºã¥ãï¼‰ã€‚

| æ–¹å¼ | 1å›ç›® | 2-5å›ç›®ï¼ˆå„ï¼‰ | åˆè¨ˆï¼ˆ5å›ï¼‰ |
|------|-------|-------------|------------|
| ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã— | $3.00 | $3.00 | $15.00 |
| ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ã‚Šï¼ˆåˆå›æ›¸ãè¾¼ã¿ï¼‰ | $3.75ï¼ˆæ›¸ãè¾¼ã¿25%å¢—ï¼‰ | $0.30ï¼ˆèª­ã¿å–ã‚Š90%æ¸›ï¼‰ | $4.95 |
| ã‚­ãƒ£ãƒƒã‚·ãƒ¥ + Batch API | $1.88 | $0.15 | $2.48 |

**ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿ã§ç´„67%ã€Batch APIä½µç”¨ã§ç´„83%ã®ã‚³ã‚¹ãƒˆå‰Šæ¸›ãŒå¯èƒ½ã§ã™ã€‚** ãŸã ã—ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®TTLã¯5åˆ†é–“ã§ã‚ã‚‹ãŸã‚ã€é€£ç¶šã—ã¦è¤‡æ•°ã®è¦³ç‚¹ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹ãƒãƒƒãƒå‡¦ç†ã«é©ã—ã¦ã„ã¾ã™ã€‚5åˆ†ã‚’è¶…ãˆã‚‹é–“éš”ã§ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¤±åŠ¹ã—ã€å†æ›¸ãè¾¼ã¿ãŒå¿…è¦ã§ã™ã€‚

> ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ€å°ãƒ–ãƒ­ãƒƒã‚¯ã‚µã‚¤ã‚ºã¯1,024ãƒˆãƒ¼ã‚¯ãƒ³ã§ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…ã®ãƒªãƒã‚¸ãƒˆãƒªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯é€šå¸¸ã“ã®é–¾å€¤ã‚’å¤§ããä¸Šå›ã‚‹ãŸã‚ã€å®Ÿç”¨ä¸Šã®åˆ¶ç´„ã«ã¯ãªã‚Šã¾ã›ã‚“ã€‚

## ãƒ­ãƒ³ã‚°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æ€§èƒ½ç‰¹æ€§ã‚’ç†è§£ã™ã‚‹

1Mãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¯ä¸‡èƒ½ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚LongCodeBenchï¼ˆarXiv:2505.07897ï¼‰ã®ç ”ç©¶çµæœã¨å®Ÿè£…çµŒé¨“ã«åŸºã¥ãã€ç¾æ™‚ç‚¹ã§ã®æ€§èƒ½ç‰¹æ€§ã¨åˆ¶ç´„ã‚’æ•´ç†ã—ã¾ã™ã€‚

### ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé•·ã¨ç²¾åº¦ã®é–¢ä¿‚

LongCodeBenchã®è©•ä¾¡ã«ã‚ˆã‚‹ã¨ã€LLMã®ã‚³ãƒ¼ãƒ‰é–¢é€£ã‚¿ã‚¹ã‚¯ç²¾åº¦ã¯ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé•·ãŒå¢—åŠ ã™ã‚‹ã«ã¤ã‚Œéå˜èª¿ã«å¤‰å‹•ã™ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚

| ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé•· | LongCodeQAï¼ˆç†è§£ï¼‰ | LongSWE-Benchï¼ˆä¿®å¾©ï¼‰ |
|--------------|-------------------|---------------------|
| 32K | 70-80% | 15-29% |
| 128K | 65-75% | 10-20% |
| 256K | 55-70% | 3-10% |
| 1M | 40-80%ï¼ˆãƒ¢ãƒ‡ãƒ«å·®å¤§ï¼‰ | 0-7% |

å‡ºå…¸: LongCodeBenchï¼ˆarXiv:2505.07897ï¼‰ã®å ±å‘Šå€¤ã‚’åŸºã«ä½œæˆã€‚GPT-4.1ã€Gemini 2.5 Proã€Claude 3.5 Sonnetãªã©è¤‡æ•°ãƒ¢ãƒ‡ãƒ«ã®ã‚¹ã‚³ã‚¢ç¯„å›²ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

**ã“ã®çµæœã‹ã‚‰å¾—ã‚‰ã‚Œã‚‹é‡è¦ãªæ•™è¨“ã¯2ã¤ã‚ã‚Šã¾ã™:**

1. **ã‚³ãƒ¼ãƒ‰ç†è§£ï¼ˆQAï¼‰ã¯æ¯”è¼ƒçš„ãƒ­ãƒã‚¹ãƒˆ**: GPT-4.1ã¯1Mã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã‚‚80%ã®ç²¾åº¦ã‚’ç¶­æŒã—ã¦ãŠã‚Šã€ã‚³ãƒ¼ãƒ‰ã®ç†è§£ãƒ»å•é¡Œæ¤œå‡ºã‚¿ã‚¹ã‚¯ã¯é•·æ–‡ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã‚‚å®Ÿç”¨çš„ã§ã™
2. **ã‚³ãƒ¼ãƒ‰ä¿®å¾©ã¯ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé•·ã«å¼±ã„**: LongSWE-Benchã§ã¯ã€1Mã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§æ„å‘³ã®ã‚ã‚‹ä¿®å¾©ç²¾åº¦ã‚’ç¤ºã—ãŸã®ã¯Gemini 2.5 Proï¼ˆ7%ï¼‰ã®ã¿ã§ã—ãŸ

### prefillæ™‚é–“ã¸ã®å½±éŸ¿

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ã€1Mãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã¯prefillæ™‚é–“ï¼ˆæœ€åˆã®ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆã¾ã§ã®æ™‚é–“ï¼‰ãŒ**2åˆ†ä»¥ä¸Š**ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹CIãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã®åˆ©ç”¨ã«ã¯èª²é¡Œã¨ãªã‚Šã¾ã™ã€‚

**ç¾å®Ÿçš„ãªå¯¾å‡¦æ³•:**

```python
# effort_router.py

def select_effort_and_context(
    file_count: int,
    estimated_tokens: int,
) -> dict:
    """ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã¨ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã«åŸºã¥ã„ã¦effortã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæˆ¦ç•¥ã‚’é¸æŠã™ã‚‹"""
    if estimated_tokens <= 200_000:
        # 200Kä»¥ä¸‹: æ¨™æº–æ–™é‡‘ã€é«˜é€Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹
        return {
            "effort": "high",
            "use_1m_context": False,
            "expected_latency": "10-30ç§’",
        }
    elif estimated_tokens <= 500_000:
        # 200K-500K: ãƒ­ãƒ³ã‚°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€ä¸­ç¨‹åº¦ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·
        return {
            "effort": "medium",
            "use_1m_context": True,
            "expected_latency": "30-90ç§’",
        }
    else:
        # 500K+: ãƒ­ãƒ³ã‚°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€é«˜ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·
        return {
            "effort": "medium",
            "use_1m_context": True,
            "expected_latency": "90-180ç§’",
        }
```

**ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•**: effortã‚’`medium`ã«ä¸‹ã’ã‚‹ã¨ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã¨ã‚³ã‚¹ãƒˆãŒæ”¹å–„ã—ã¾ã™ãŒã€æ¨è«–ã®æ·±ã•ãŒæµ…ããªã‚Šã¾ã™ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã©æ·±ã„åˆ†æãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹ã§ã¯`high`ã‚’ç¶­æŒã—ã€ã‚¹ã‚¿ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯ãªã©è»½é‡ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯`medium`ãŒé©åˆ‡ã§ã™ã€‚

## GitHub Actionsã§ã®è‡ªå‹•åŒ–ã‚’å®Ÿè£…ã™ã‚‹

å®Ÿé‹ç”¨ã§ã¯ã€PRãŒã‚ªãƒ¼ãƒ—ãƒ³ã•ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è‡ªå‹•å®Ÿè¡Œã™ã‚‹ã®ãŒåŠ¹æœçš„ã§ã™ã€‚

### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®šç¾©

```yaml
# .github/workflows/llm-review.yml
name: LLM Code Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´å–å¾—ï¼ˆdiffè¨ˆç®—ç”¨ï¼‰

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install anthropic

      - name: Run repository review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python review_agent.py . > review_result.json

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const result = JSON.parse(fs.readFileSync('review_result.json', 'utf8'));
            const issues = result.issues || [];
            const meta = result.metadata || {};

            let body = `## ğŸ” LLM Code Review Results\n\n`;
            body += `**Files reviewed:** ${meta.files_reviewed || 'N/A'}\n`;
            body += `**Input tokens:** ${(meta.actual_input_tokens || 0).toLocaleString()}\n`;
            body += `**Review time:** ${meta.elapsed_seconds || 'N/A'}s\n\n`;

            if (issues.length === 0) {
              body += 'âœ… No issues found.\n';
            } else {
              body += `### Found ${issues.length} issue(s)\n\n`;
              for (const issue of issues) {
                const emoji = {critical:'ğŸ”´',high:'ğŸŸ ',medium:'ğŸŸ¡',low:'ğŸ”µ'}[issue.severity] || 'âšª';
                body += `${emoji} **[${issue.severity.toUpperCase()}]** ${issue.category}\n`;
                body += `- Files: ${(issue.files || []).join(', ')}\n`;
                body += `- ${issue.description}\n`;
                body += `- ğŸ’¡ ${issue.suggestion}\n\n`;
              }
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
```

**æ³¨æ„ç‚¹:**
> GitHub Actionsã®å®Ÿè¡Œæ™‚é–“ã¯15åˆ†ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚500Kãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¶…ãˆã‚‹å¤§è¦æ¨¡ãƒªãƒã‚¸ãƒˆãƒªã§ã¯prefillæ™‚é–“ã ã‘ã§2åˆ†ä»¥ä¸Šã‹ã‹ã‚‹ãŸã‚ã€CIç’°å¢ƒã§ã¯ãƒˆãƒ¼ã‚¯ãƒ³ä¸Šé™ã‚’400Kç¨‹åº¦ã«åˆ¶é™ã™ã‚‹ã®ãŒå®‰å…¨ã§ã™ã€‚Actionsã®ã‚³ã‚¹ãƒˆï¼ˆå®Ÿè¡Œæ™‚é–“èª²é‡‘ï¼‰ã¨APIæ–™é‡‘ã®ä¸¡æ–¹ã‚’è€ƒæ…®ã—ã¦ãã ã•ã„ã€‚

## ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

| å•é¡Œ | åŸå›  | è§£æ±ºæ–¹æ³• |
|------|------|----------|
| `400 Bad Request: context too long` | å…¥åŠ›ãŒ1Mãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¶…é | `max_tokens`ã‚’æ¸›ã‚‰ã™ã‹ã€é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’å‰Šæ¸› |
| `403: tier requirement not met` | Usage Tier 4æœªæº€ | Anthropicãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ç´¯ç©$400ä»¥ä¸Šã®èª²é‡‘å®Ÿç¸¾ã‚’ç¢ºèª |
| prefillæ™‚é–“ãŒ3åˆ†ä»¥ä¸Š | å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³æ•°ãŒ800Kè¶… | effortã‚’`medium`ã«ä¸‹ã’ã‚‹ã‹ã€å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®æ‹¡å¼µå­ã‚’çµã‚‹ |
| ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãŒJSONä¸æ­£ | å‡ºåŠ›ãŒ`max_tokens`ã§åˆ‡æ–­ | `max_tokens`ã‚’16384ã«å¢—ã‚„ã™ã€ã¾ãŸã¯å‡ºåŠ›å½¢å¼ã‚’ç°¡ç•¥åŒ– |
| ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ã‹ãªã„ | å‰å›ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰5åˆ†è¶…çµŒé | ãƒãƒƒãƒå®Ÿè¡Œã§é€£ç¶šã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ |
| `429 Too Many Requests` | ãƒ­ãƒ³ã‚°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå°‚ç”¨ãƒ¬ãƒ¼ãƒˆåˆ¶é™ | ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“éš”ã‚’ç©ºã‘ã‚‹ã€Batch APIã«åˆ‡ã‚Šæ›¿ãˆã‚‹ |

## ã¾ã¨ã‚ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

**ã¾ã¨ã‚:**
- Claude Sonnet 4.6ã®1Mãƒˆãƒ¼ã‚¯ãƒ³ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ã‚ˆã‚Šã€**ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ãªã—**ã§ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸ
- `betas=["context-1m-2025-08-07"]`ãƒ˜ãƒƒãƒ€ãƒ¼ã§æœ‰åŠ¹åŒ–ã€Tier 4ãŒå¿…è¦ã€200Kè¶…ã¯2å€èª²é‡‘
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨Batch APIã®ä½µç”¨ã§ã€ç¹°ã‚Šè¿”ã—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã‚³ã‚¹ãƒˆã‚’**æœ€å¤§83%å‰Šæ¸›**ã§ãã¾ã™
- ãƒ­ãƒ³ã‚°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¯**ã‚³ãƒ¼ãƒ‰ç†è§£ãƒ»å•é¡Œæ¤œå‡º**ã«é©ã—ã¦ãŠã‚Šã€**ã‚³ãƒ¼ãƒ‰ä¿®å¾©**ã«ã¯ç²¾åº¦ä¸Šã®åˆ¶ç´„ãŒã‚ã‚Šã¾ã™ï¼ˆLongCodeBenchå ±å‘Šï¼‰
- prefillæ™‚é–“ï¼ˆ2åˆ†ä»¥ä¸Šï¼‰ã‚’è€ƒæ…®ã—ã€effortãƒ¬ãƒ™ãƒ«ã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¸Šé™ã®é©åˆ‡ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒé‡è¦ã§ã™

**æ¬¡ã«ã‚„ã‚‹ã¹ãã“ã¨:**
- [Anthropicå…¬å¼: Context windows](https://platform.claude.com/docs/en/build-with-claude/context-windows)ã§1Mã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æœ€æ–°ä»•æ§˜ã‚’ç¢ºèª
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://platform.claude.com/docs/en/build-with-claude/prompt-caching)ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã‚’è¨­è¨ˆ
- å°è¦æ¨¡ãªãƒªãƒã‚¸ãƒˆãƒªï¼ˆ200Kä»¥ä¸‹ï¼‰ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è©¦è¡Œã—ã€å‡ºåŠ›å“è³ªã‚’æ¤œè¨¼

**é–¢é€£è¨˜äº‹:**
- [Claude Sonnet 4.6ã®Extended Thinkingã§ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹](https://zenn.dev/0h_n0/articles/5698ef2dfcbc61): Extended Thinkingã«ç‰¹åŒ–ã—ãŸã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè£…

## å‚è€ƒ

- [What's new in Claude 4.6 - å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://platform.claude.com/docs/en/about-claude/models/whats-new-claude-4-6)
- [Context windows - Claude API Docs](https://platform.claude.com/docs/en/build-with-claude/context-windows)
- [Prompt caching - Claude API Docs](https://platform.claude.com/docs/en/build-with-claude/prompt-caching)
- [Pricing - Claude API Docs](https://platform.claude.com/docs/en/about-claude/pricing)
- [LongCodeBench: Evaluating Coding LLMs at 1M Context Windows (arXiv:2505.07897)](https://arxiv.org/abs/2505.07897)
- [Anthropic launches Claude Sonnet 4.6 - CryptoBriefing](https://cryptobriefing.com/claude-sonnet-4-6-enhanced-features/)
- [Claude Sonnet 4.6 Complete Guide - NxCode](https://www.nxcode.io/resources/news/claude-sonnet-4-6-complete-guide-benchmarks-pricing-2026)

---

:::message
ã“ã®è¨˜äº‹ã¯AIï¼ˆClaude Codeï¼‰ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å†…å®¹ã®æ­£ç¢ºæ€§ã«ã¤ã„ã¦ã¯è¤‡æ•°ã®æƒ…å ±æºã§æ¤œè¨¼ã—ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã®åˆ©ç”¨æ™‚ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚ã”ç¢ºèªãã ã•ã„ã€‚
:::
