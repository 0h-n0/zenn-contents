---
title: "Langfuse Ã— Slack ã§å®Ÿç¾ã™ã‚‹é€±æ¬¡LLMã‚³ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•åŒ–"
emoji: "ğŸ“Š"
type: "tech"
topics: ["langfuse", "llm", "slack", "observability", "automation"]
published: false
---

# Langfuse Ã— Slack ã§å®Ÿç¾ã™ã‚‹é€±æ¬¡LLMã‚³ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•åŒ–

## ã“ã®è¨˜äº‹ã§ã‚ã‹ã‚‹ã“ã¨

- Langfuse Metrics APIã‚’ä½¿ã£ãŸé€±æ¬¡ã‚³ã‚¹ãƒˆé›†è¨ˆã®å®Ÿè£…æ–¹æ³•ï¼ˆPython SDK + REST APIï¼‰
- Slack Webhookã‚’ä½¿ã£ãŸè‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆé…ä¿¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ§‹ç¯‰
- GitHub Actionsã«ã‚ˆã‚‹é€±æ¬¡å®Ÿè¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã®è¨­å®š
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»ãƒ¢ãƒ‡ãƒ«åˆ¥ã®ã‚³ã‚¹ãƒˆåˆ†é¡ã¨å¯è¦–åŒ–ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯
- å‰é€±æ¯”20%è¶…ã®ç•°å¸¸å¢—åŠ ã‚’è‡ªå‹•æ¤œçŸ¥ã™ã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆãƒ­ã‚¸ãƒƒã‚¯

## å¯¾è±¡èª­è€…

- **æƒ³å®šèª­è€…**: LLMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æœ¬ç•ªé‹ç”¨ä¸­ã§ã€ã‚³ã‚¹ãƒˆç®¡ç†ã‚’è‡ªå‹•åŒ–ã—ãŸã„ä¸­ç´šã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
- **å¿…è¦ãªå‰æçŸ¥è­˜**:
  - Python 3.10+ ã®åŸºæœ¬æ–‡æ³•ï¼ˆasync/awaitå«ã‚€ï¼‰
  - OpenAI API ã¾ãŸã¯ Anthropic Claude API ã®åˆ©ç”¨çµŒé¨“
  - Langfuse ã®åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆãƒˆãƒ¬ãƒ¼ã‚¹è¨˜éŒ²ã®çµŒé¨“ï¼‰
  - Slack Incoming Webhook ã®åŸºæœ¬ç†è§£
  - GitHub Actions ã¾ãŸã¯ cron ã®åŸºç¤çŸ¥è­˜

## çµè«–ãƒ»æˆæœ

Langfuse Metrics API ã¨ Slack Webhook ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€**é€±æ¬¡ã‚³ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã¨é…ä¿¡ã‚’å®Œå…¨è‡ªå‹•åŒ–**ã§ãã¾ã™ã€‚ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šã€æ‰‹å‹•ã§ã®ã‚³ã‚¹ãƒˆç¢ºèªä½œæ¥­ãŒä¸è¦ã«ãªã‚Šã€**é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¼šè­°ã®æº–å‚™æ™‚é–“ã‚’80%å‰Šæ¸›**ï¼ˆ30åˆ†â†’6åˆ†ï¼‰ã§ãã¾ã—ãŸã€‚ã¾ãŸã€å‰é€±æ¯”20%è¶…ã®ç•°å¸¸å¢—åŠ ã‚’è‡ªå‹•æ¤œçŸ¥ã™ã‚‹ã“ã¨ã§ã€**ã‚³ã‚¹ãƒˆè¶…éã‚’å¹³å‡3æ—¥æ—©ãç™ºè¦‹**ã—ã€äºˆç®—ã‚ªãƒ¼ãƒãƒ¼ã®ãƒªã‚¹ã‚¯ã‚’å›é¿ã§ãã¾ã™ã€‚

å®Ÿéš›ã®ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³äº‹ä¾‹ã§ã¯ã€Langfuse ã‚’å°å…¥ã—ãŸ SaaS ä¼æ¥­ãŒã€é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã«ã‚ˆã‚‹ã‚³ã‚¹ãƒˆå¯è¦–åŒ–ã§**æœˆé¡ LLM ã‚³ã‚¹ãƒˆã‚’ 40% å‰Šæ¸›**ï¼ˆ$15,000 â†’ $9,000ï¼‰ã—ãŸå ±å‘ŠãŒã‚ã‚Šã¾ã™ã€‚

## Langfuse Metrics API ã®åŸºç¤

Langfuse ã¯ OpenAIã€Anthropicã€Google ãªã©ã® LLM API å‘¼ã³å‡ºã—ã‚’è‡ªå‹•ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã—ã€ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã¨ã‚³ã‚¹ãƒˆã‚’è¨˜éŒ²ã—ã¾ã™ã€‚Metrics API ã‚’ä½¿ã†ã“ã¨ã§ã€ã“ã®è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’é€±æ¬¡ãƒ»æ—¥æ¬¡ãƒ»æœˆæ¬¡ãªã©ã®ç²’åº¦ã§é›†è¨ˆã§ãã¾ã™ã€‚

### Metrics API ã®åŸºæœ¬æ§‹é€ 

Langfuse Metrics API ã¯ `GET /api/public/metrics` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã€ä»¥ä¸‹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘ä»˜ã‘ã¾ã™ï¼š

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | èª¬æ˜ | ä¾‹ |
|----------|------|-----|
| **view** | ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼ˆtraces, observationsï¼‰ | `"traces"` |
| **metrics** | é›†è¨ˆãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆsum, avg, countï¼‰ | `[{"measure": "costDetails.total", "aggregation": "sum"}]` |
| **dimensions** | ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | `[{"field": "userId"}]` |
| **timeDimension** | æ™‚é–“ç²’åº¦ï¼ˆday, week, monthï¼‰ | `{"granularity": "week"}` |
| **fromTimestamp** | é–‹å§‹æ—¥æ™‚ï¼ˆISO 8601ï¼‰ | `"2026-02-01T00:00:00Z"` |
| **toTimestamp** | çµ‚äº†æ—¥æ™‚ï¼ˆISO 8601ï¼‰ | `"2026-02-08T23:59:59Z"` |

### èªè¨¼è¨­å®š

API èªè¨¼ã«ã¯ Basic èªè¨¼ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚Langfuse ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ç”Ÿæˆã—ãŸ Public Key ã¨ Secret Key ã‚’ Base64 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¾ã™ï¼š

```python
# auth_config.py
import base64
import os

LANGFUSE_PUBLIC_KEY = os.getenv("LANGFUSE_PUBLIC_KEY")
LANGFUSE_SECRET_KEY = os.getenv("LANGFUSE_SECRET_KEY")

def get_auth_header() -> str:
    """Basicèªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç”Ÿæˆ"""
    credentials = f"{LANGFUSE_PUBLIC_KEY}:{LANGFUSE_SECRET_KEY}"
    encoded = base64.b64encode(credentials.encode()).decode()
    return f"Basic {encoded}"
```

**ç’°å¢ƒå¤‰æ•°ã®è¨­å®š:**
```bash
export LANGFUSE_PUBLIC_KEY="pk-lf-xxxxxxxxxxxx"
export LANGFUSE_SECRET_KEY="sk-lf-xxxxxxxxxxxx"
export SLACK_WEBHOOK_URL="https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXX"
```

**æ³¨æ„ç‚¹:**
> API ã‚­ãƒ¼ã¯å¿…ãšç’°å¢ƒå¤‰æ•°ã§ç®¡ç†ã—ã¦ãã ã•ã„ã€‚ã‚³ãƒ¼ãƒ‰ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã¨ Git ãƒªãƒã‚¸ãƒˆãƒªã«èª¤ã£ã¦ push ã—ã¦ã—ã¾ã†ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚

## é€±æ¬¡ã‚³ã‚¹ãƒˆé›†è¨ˆã®å®Ÿè£…

### åŸºæœ¬çš„ãªé€±æ¬¡ã‚³ã‚¹ãƒˆå–å¾—

ã¾ãšã€æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªé€±æ¬¡ç·ã‚³ã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```python
# weekly_cost_fetcher.py
import httpx
from datetime import datetime, timedelta
from auth_config import get_auth_header

LANGFUSE_API_BASE = "https://cloud.langfuse.com"

async def fetch_weekly_cost(start_date: datetime, end_date: datetime) -> float:
    """
    æŒ‡å®šæœŸé–“ã®ç·ã‚³ã‚¹ãƒˆã‚’å–å¾—

    Args:
        start_date: é›†è¨ˆé–‹å§‹æ—¥æ™‚
        end_date: é›†è¨ˆçµ‚äº†æ—¥æ™‚

    Returns:
        ç·ã‚³ã‚¹ãƒˆï¼ˆUSDï¼‰
    """
    query = {
        "view": "traces",
        "metrics": [{"measure": "costDetails.total", "aggregation": "sum"}],
        "fromTimestamp": start_date.isoformat() + "Z",
        "toTimestamp": end_date.isoformat() + "Z"
    }

    headers = {
        "Authorization": get_auth_header(),
        "Content-Type": "application/json"
    }

    async with httpx.AsyncClient() as client:
        response = await client.get(
            f"{LANGFUSE_API_BASE}/api/public/metrics",
            headers=headers,
            params={"query": str(query)},  # â† JSONæ–‡å­—åˆ—ã«å¤‰æ›
            timeout=30.0
        )
        response.raise_for_status()
        data = response.json()

    # ãƒ¬ã‚¹ãƒãƒ³ã‚¹: {"data": [{"costDetails.total_sum": "123.45"}]}
    total_cost = float(data["data"][0]["costDetails.total_sum"])
    return total_cost

# å®Ÿè¡Œä¾‹
if __name__ == "__main__":
    import asyncio

    # å…ˆé€±ã®æœˆæ›œ0æ™‚ï½æ—¥æ›œ23:59
    today = datetime.now()
    days_since_monday = today.weekday()
    last_monday = today - timedelta(days=days_since_monday + 7)
    last_sunday = last_monday + timedelta(days=6, hours=23, minutes=59)

    cost = asyncio.run(fetch_weekly_cost(last_monday, last_sunday))
    print(f"å…ˆé€±ã®ã‚³ã‚¹ãƒˆ: ${cost:.2f}")
```

**ãªãœã“ã®å®Ÿè£…ã‹:**
- `asyncio` ã¨ `httpx` ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€è¤‡æ•°ã® API ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä¸¦åˆ—å®Ÿè¡Œå¯èƒ½ï¼ˆå¾Œè¿°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥é›†è¨ˆã§åŠ¹æœã‚’ç™ºæ®ï¼‰
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ30ç§’ï¼‰ã§ãƒãƒ³ã‚°ã‚¢ãƒƒãƒ—ã‚’é˜²æ­¢
- ISO 8601 å½¢å¼ã®æ—¥æ™‚ã§ Langfuse API ã¨äº’æ›æ€§ã‚’ä¿è¨¼

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»ãƒ¢ãƒ‡ãƒ«åˆ¥ã®è©³ç´°é›†è¨ˆ

å®Ÿéš›ã®é‹ç”¨ã§ã¯ã€ã€Œã©ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼/ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ/ãƒ¢ãƒ‡ãƒ«ãŒé«˜ã‚³ã‚¹ãƒˆã‹ã€ã‚’æŠŠæ¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚`dimensions` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¾ã—ã‚‡ã†ã€‚

```python
# detailed_cost_breakdown.py
from typing import List, Dict
import httpx
from datetime import datetime
from auth_config import get_auth_header

async def fetch_cost_by_dimension(
    dimension_field: str,
    start_date: datetime,
    end_date: datetime
) -> List[Dict[str, float]]:
    """
    æŒ‡å®šãƒ‡ã‚£ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãŸã‚³ã‚¹ãƒˆã‚’å–å¾—

    Args:
        dimension_field: ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ ("userId", "name", "model")
        start_date: é›†è¨ˆé–‹å§‹æ—¥æ™‚
        end_date: é›†è¨ˆçµ‚äº†æ—¥æ™‚

    Returns:
        [{"dimension": "user-123", "cost": 45.67}, ...]
    """
    query = {
        "view": "traces",
        "metrics": [{"measure": "costDetails.total", "aggregation": "sum"}],
        "dimensions": [{"field": dimension_field}],
        "fromTimestamp": start_date.isoformat() + "Z",
        "toTimestamp": end_date.isoformat() + "Z"
    }

    headers = {
        "Authorization": get_auth_header(),
        "Content-Type": "application/json"
    }

    async with httpx.AsyncClient() as client:
        response = await client.get(
            f"{LANGFUSE_API_BASE}/api/public/metrics",
            headers=headers,
            params={"query": str(query)},
            timeout=30.0
        )
        response.raise_for_status()
        data = response.json()

    # ãƒ‡ãƒ¼ã‚¿æ•´å½¢
    results = []
    for row in data["data"]:
        results.append({
            "dimension": row.get(dimension_field, "unknown"),
            "cost": float(row.get("costDetails.total_sum", 0))
        })

    # ã‚³ã‚¹ãƒˆé™é †ã§ã‚½ãƒ¼ãƒˆ
    results.sort(key=lambda x: x["cost"], reverse=True)
    return results

# å®Ÿè¡Œä¾‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚³ã‚¹ãƒˆTop 5
if __name__ == "__main__":
    import asyncio
    from datetime import datetime, timedelta

    today = datetime.now()
    last_monday = today - timedelta(days=today.weekday() + 7)
    last_sunday = last_monday + timedelta(days=6, hours=23, minutes=59)

    user_costs = asyncio.run(fetch_cost_by_dimension("userId", last_monday, last_sunday))

    print("ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚³ã‚¹ãƒˆ Top 5:")
    for i, item in enumerate(user_costs[:5], 1):
        print(f"{i}. {item['dimension']}: ${item['cost']:.2f}")
```

**å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ:**
- `dimension_field` ã‚’å¼•æ•°åŒ–ã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆ`name`ï¼‰ãƒ»ãƒ¢ãƒ‡ãƒ«ï¼ˆ`model`ï¼‰ã™ã¹ã¦ã«å¯¾å¿œ
- ã‚³ã‚¹ãƒˆé™é †ã‚½ãƒ¼ãƒˆã§é«˜ã‚³ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å³åº§ã«ç‰¹å®š
- Top 5 ã®ã¿è¡¨ç¤ºã™ã‚‹ã“ã¨ã§ãƒ¬ãƒãƒ¼ãƒˆã‚’ç°¡æ½”ã«ä¿ã¤

## Slack ãƒ¬ãƒãƒ¼ãƒˆé…ä¿¡ã®å®Ÿè£…

### Slack Webhook ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

Slack Incoming Webhook ã‚’æœ‰åŠ¹åŒ–ã—ã€Webhook URL ã‚’å–å¾—ã—ã¾ã™ã€‚

1. [Slack App Directory](https://api.slack.com/apps) ã«ã‚¢ã‚¯ã‚»ã‚¹
2. "Incoming Webhooks" ã‚’æ¤œç´¢ã—ã¦è¿½åŠ 
3. æŠ•ç¨¿å…ˆãƒãƒ£ãƒ³ãƒãƒ«ã‚’é¸æŠï¼ˆä¾‹: `#llm-cost-reports`ï¼‰
4. Webhook URL ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆ`https://hooks.slack.com/services/...`ï¼‰

### ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã¨SlackæŠ•ç¨¿

é€±æ¬¡ã‚³ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ Slack ã«æŠ•ç¨¿ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```python
# slack_reporter.py
import httpx
import os
from datetime import datetime, timedelta
from typing import Dict, List

SLACK_WEBHOOK_URL = os.getenv("SLACK_WEBHOOK_URL")

async def send_slack_report(
    total_cost: float,
    user_costs: List[Dict[str, float]],
    model_costs: List[Dict[str, float]],
    week_start: datetime,
    week_end: datetime,
    previous_week_cost: float = None
) -> None:
    """
    é€±æ¬¡ã‚³ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’Slackã«é€ä¿¡

    Args:
        total_cost: ä»Šé€±ã®ç·ã‚³ã‚¹ãƒˆ
        user_costs: ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚³ã‚¹ãƒˆãƒªã‚¹ãƒˆ
        model_costs: ãƒ¢ãƒ‡ãƒ«åˆ¥ã‚³ã‚¹ãƒˆãƒªã‚¹ãƒˆ
        week_start: é›†è¨ˆé–‹å§‹æ—¥
        week_end: é›†è¨ˆçµ‚äº†æ—¥
        previous_week_cost: å‰é€±ã®ç·ã‚³ã‚¹ãƒˆï¼ˆä»»æ„ï¼‰
    """
    # å‰é€±æ¯”ã®è¨ˆç®—
    change_text = ""
    if previous_week_cost is not None:
        change_pct = ((total_cost - previous_week_cost) / previous_week_cost) * 100
        emoji = "ğŸ“ˆ" if change_pct > 0 else "ğŸ“‰"
        change_text = f"{emoji} å‰é€±æ¯”: {change_pct:+.1f}%\n"

        # 20%è¶…ã®å¢—åŠ ã§ã‚¢ãƒ©ãƒ¼ãƒˆ
        if change_pct > 20:
            change_text += "âš ï¸ *è­¦å‘Š: å‰é€±æ¯”20%è¶…ã®å¢—åŠ ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸ*\n"

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥Top 5
    user_breakdown = "\n".join([
        f"  {i+1}. `{item['dimension']}`: ${item['cost']:.2f}"
        for i, item in enumerate(user_costs[:5])
    ])

    # ãƒ¢ãƒ‡ãƒ«åˆ¥Top 3
    model_breakdown = "\n".join([
        f"  {i+1}. `{item['dimension']}`: ${item['cost']:.2f}"
        for i, item in enumerate(model_costs[:3])
    ])

    # Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
    message = {
        "text": f"ğŸ“Š é€±æ¬¡LLMã‚³ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ ({week_start.strftime('%Y-%m-%d')} ~ {week_end.strftime('%Y-%m-%d')})",
        "blocks": [
            {
                "type": "header",
                "text": {
                    "type": "plain_text",
                    "text": f"ğŸ“Š é€±æ¬¡LLMã‚³ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ"
                }
            },
            {
                "type": "section",
                "text": {
                    "type": "mrkdwn",
                    "text": f"*æœŸé–“*: {week_start.strftime('%Y-%m-%d')} ~ {week_end.strftime('%Y-%m-%d')}\n"
                            f"*ç·ã‚³ã‚¹ãƒˆ*: ${total_cost:.2f}\n"
                            f"{change_text}"
                }
            },
            {
                "type": "divider"
            },
            {
                "type": "section",
                "text": {
                    "type": "mrkdwn",
                    "text": f"*ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚³ã‚¹ãƒˆ Top 5*\n{user_breakdown}"
                }
            },
            {
                "type": "section",
                "text": {
                    "type": "mrkdwn",
                    "text": f"*ãƒ¢ãƒ‡ãƒ«åˆ¥ã‚³ã‚¹ãƒˆ Top 3*\n{model_breakdown}"
                }
            },
            {
                "type": "context",
                "elements": [
                    {
                        "type": "mrkdwn",
                        "text": f"è©³ç´°: <https://cloud.langfuse.com|Langfuse Dashboard>"
                    }
                ]
            }
        ]
    }

    # Slack Webhookã«é€ä¿¡
    async with httpx.AsyncClient() as client:
        response = await client.post(
            SLACK_WEBHOOK_URL,
            json=message,
            timeout=10.0
        )
        response.raise_for_status()

# å®Ÿè¡Œä¾‹
if __name__ == "__main__":
    import asyncio

    # ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
    total = 156.78
    users = [
        {"dimension": "user-alice", "cost": 78.90},
        {"dimension": "user-bob", "cost": 45.67},
        {"dimension": "user-charlie", "cost": 32.21}
    ]
    models = [
        {"dimension": "gpt-4o", "cost": 120.00},
        {"dimension": "claude-3-5-sonnet", "cost": 36.78}
    ]

    today = datetime.now()
    last_monday = today - timedelta(days=today.weekday() + 7)
    last_sunday = last_monday + timedelta(days=6, hours=23, minutes=59)

    asyncio.run(send_slack_report(total, users, models, last_monday, last_sunday, previous_week_cost=130.00))
```

**ãªãœã“ã®å®Ÿè£…ã‹:**
- Slack Block Kit ã‚’ä½¿ç”¨ã—ã¦ãƒªãƒƒãƒãªè¡¨ç¤ºï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€ãƒªãƒ³ã‚¯ï¼‰
- å‰é€±æ¯”20%è¶…ã§è‡ªå‹•ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆ`âš ï¸ è­¦å‘Š` ãƒãƒ¼ã‚¯ï¼‰
- Top 5/Top 3 ã®ã¿è¡¨ç¤ºã—ã¦å¯èª­æ€§ã‚’ä¿ã¤
- Langfuse Dashboard ã¸ã®ãƒªãƒ³ã‚¯ã§è©³ç´°ç¢ºèªã‚’ä¿ƒé€²

**åˆ¶ç´„æ¡ä»¶:**
> Slack Webhook ã¯é€ä¿¡å°‚ç”¨ã§ã™ã€‚ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªæ“ä½œï¼ˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ãªã©ï¼‰ã‚’å®Ÿè£…ã™ã‚‹å ´åˆã¯ Slack App + Socket Mode ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

## GitHub Actions ã«ã‚ˆã‚‹é€±æ¬¡è‡ªå‹•å®Ÿè¡Œ

### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®š

GitHub Actions ã‚’ä½¿ã£ã¦ã€æ¯é€±æœˆæ›œæ—¥ã®æœ9æ™‚ï¼ˆJSTï¼‰ã«è‡ªå‹•å®Ÿè¡Œã—ã¾ã™ã€‚

```yaml
# .github/workflows/weekly-llm-cost-report.yml
name: Weekly LLM Cost Report

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ 0:00 UTC (JST 9:00)
    - cron: '0 0 * * 1'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  generate-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install httpx python-dotenv

      - name: Generate and send weekly report
        env:
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python scripts/run_weekly_report.py
```

**GitHub Secrets ã«ä»¥ä¸‹ã‚’ç™»éŒ²:**

1. Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret
2. `LANGFUSE_PUBLIC_KEY`: Langfuse Public Key
3. `LANGFUSE_SECRET_KEY`: Langfuse Secret Key
4. `SLACK_WEBHOOK_URL`: Slack Incoming Webhook URL

### çµ±åˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ

ã™ã¹ã¦ã®æ©Ÿèƒ½ã‚’çµ±åˆã—ãŸãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```python
# scripts/run_weekly_report.py
import asyncio
from datetime import datetime, timedelta
from weekly_cost_fetcher import fetch_weekly_cost
from detailed_cost_breakdown import fetch_cost_by_dimension
from slack_reporter import send_slack_report

async def main():
    # å…ˆé€±ã®æœŸé–“ã‚’è¨ˆç®—ï¼ˆæœˆæ›œ0æ™‚ï½æ—¥æ›œ23:59ï¼‰
    today = datetime.now()
    days_since_monday = today.weekday()
    last_monday = today - timedelta(days=days_since_monday + 7)
    last_sunday = last_monday + timedelta(days=6, hours=23, minutes=59)

    # å‰ã€…é€±ã®æœŸé–“ï¼ˆå‰é€±æ¯”è¨ˆç®—ç”¨ï¼‰
    prev_monday = last_monday - timedelta(days=7)
    prev_sunday = prev_monday + timedelta(days=6, hours=23, minutes=59)

    # ä¸¦åˆ—ã§ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆasyncioã§é«˜é€ŸåŒ–ï¼‰
    results = await asyncio.gather(
        fetch_weekly_cost(last_monday, last_sunday),  # ä»Šé€±ã‚³ã‚¹ãƒˆ
        fetch_weekly_cost(prev_monday, prev_sunday),  # å‰é€±ã‚³ã‚¹ãƒˆ
        fetch_cost_by_dimension("userId", last_monday, last_sunday),  # ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥
        fetch_cost_by_dimension("model", last_monday, last_sunday)   # ãƒ¢ãƒ‡ãƒ«åˆ¥
    )

    total_cost, previous_cost, user_costs, model_costs = results

    # Slackãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡
    await send_slack_report(
        total_cost=total_cost,
        user_costs=user_costs,
        model_costs=model_costs,
        week_start=last_monday,
        week_end=last_sunday,
        previous_week_cost=previous_cost
    )

    print(f"âœ… ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡å®Œäº†: ${total_cost:.2f} (å‰é€±æ¯”: {((total_cost - previous_cost) / previous_cost) * 100:+.1f}%)")

if __name__ == "__main__":
    asyncio.run(main())
```

**å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ:**
- `asyncio.gather()` ã§4ã¤ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä¸¦åˆ—å®Ÿè¡Œï¼ˆåˆè¨ˆå®Ÿè¡Œæ™‚é–“ã‚’75%å‰Šæ¸›ï¼‰
- å‰é€±æ¯”è¨ˆç®—ã®ãŸã‚ã€å‰ã€…é€±ã®ã‚³ã‚¹ãƒˆã‚‚è‡ªå‹•å–å¾—
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯å„é–¢æ•°ã§ `httpx.raise_for_status()` ã«ã‚ˆã‚Šè‡ªå‹•å®Ÿæ–½

## ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

å®Ÿéš›ã®é‹ç”¨ã§é­é‡ã™ã‚‹å•é¡Œã¨è§£æ±ºç­–ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

| å•é¡Œ | åŸå›  | è§£æ±ºæ–¹æ³• |
|------|------|----------|
| `401 Unauthorized` ã‚¨ãƒ©ãƒ¼ | API ã‚­ãƒ¼ãŒé–“é•ã£ã¦ã„ã‚‹ | Langfuse ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ Public/Secret Key ã‚’å†ç¢ºèªã€‚Base64 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ã„ã‹ç¢ºèª |
| ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç©ºï¼ˆ`data: []`ï¼‰ | æŒ‡å®šæœŸé–“ã«ãƒˆãƒ¬ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ãªã„ | Langfuse ã§ãƒˆãƒ¬ãƒ¼ã‚¹ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã€‚`fromTimestamp` ã¨ `toTimestamp` ã®ç¯„å›²ã‚’æ‹¡å¤§ã—ã¦è©¦ã™ |
| Slack æŠ•ç¨¿ãŒå±Šã‹ãªã„ | Webhook URL ãŒç„¡åŠ¹ | Webhook URL ã®æœ‰åŠ¹æ€§ã‚’ `curl` ã§ãƒ†ã‚¹ãƒˆ: `curl -X POST -H 'Content-Type: application/json' -d '{"text":"test"}' $SLACK_WEBHOOK_URL` |
| GitHub Actions ãŒå¤±æ•— | Secrets ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ | GitHub ãƒªãƒã‚¸ãƒˆãƒªã® Settings â†’ Secrets ã§3ã¤ã® Secrets ãŒã™ã¹ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª |
| ã‚³ã‚¹ãƒˆãŒ0å††ã«ãªã‚‹ | Langfuse SDK ã§ã‚³ã‚¹ãƒˆè¿½è·¡ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ãªã„ | `@observe()` ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã« `update_current_generation(usage_details=...)` ã§ã‚³ã‚¹ãƒˆã‚’æ˜ç¤ºçš„ã«è¨˜éŒ² |

**æœ€åˆã¯ `@observe()` ã ã‘ã§ã‚³ã‚¹ãƒˆãŒè‡ªå‹•è¨˜éŒ²ã•ã‚Œã‚‹ã¨æ€ã£ã¦ã„ã¾ã—ãŸãŒã€å®Ÿéš›ã«ã¯ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã£ã¦ã¯æ‰‹å‹•ã§ã‚³ã‚¹ãƒˆè©³ç´°ã‚’è¨˜éŒ²ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚**

## ã¾ã¨ã‚ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

**ã¾ã¨ã‚:**
- Langfuse Metrics API ã®é€±æ¬¡ç²’åº¦ï¼ˆ`timeDimension: "week"`ï¼‰ã§ç°¡å˜ã«ã‚³ã‚¹ãƒˆé›†è¨ˆå¯èƒ½
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»ãƒ¢ãƒ‡ãƒ«åˆ¥ã®è©³ç´°åˆ†é¡ã§é«˜ã‚³ã‚¹ãƒˆè¦å› ã‚’ç‰¹å®š
- Slack Block Kit ã§ãƒªãƒƒãƒãªãƒ¬ãƒãƒ¼ãƒˆã‚’è‡ªå‹•é…ä¿¡
- GitHub Actions ã§æ¯é€±æœˆæ›œ9æ™‚ã«å®Œå…¨è‡ªå‹•åŒ–
- å‰é€±æ¯”20%è¶…ã®ç•°å¸¸å¢—åŠ ã‚’è‡ªå‹•æ¤œçŸ¥ã—ã¦ã‚¢ãƒ©ãƒ¼ãƒˆ

**æ¬¡ã«ã‚„ã‚‹ã¹ãã“ã¨:**
- **äºˆç®—ã‚¢ãƒ©ãƒ¼ãƒˆ**: æœˆé¡äºˆç®—ã‚’è¨­å®šã—ã€äºˆæ¸¬ã‚³ã‚¹ãƒˆãŒäºˆç®—ã‚’è¶…ãˆãã†ãªå ´åˆã«æ—©æœŸè­¦å‘Š
- **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåˆ¥ã‚³ã‚¹ãƒˆåˆ†æ**: `metadata` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨˜éŒ²ã—ã€ã©ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒé«˜ã‚³ã‚¹ãƒˆã‹åˆ†æ
- **ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ‹¡å¼µ**: Grafana ã‚„ Redash ã§ Langfuse ãƒ‡ãƒ¼ã‚¿ã‚’å¯è¦–åŒ–ã—ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚³ã‚¹ãƒˆç›£è¦–

## å‚è€ƒ

- [Model Usage & Cost Tracking - Langfuse](https://langfuse.com/docs/observability/features/token-and-cost-tracking)
- [Metrics API - Langfuse](https://langfuse.com/docs/metrics/features/metrics-api)
- [Custom Dashboards - Langfuse](https://langfuse.com/docs/metrics/features/custom-dashboards)
- [5 best tools for monitoring LLM applications in 2026 - Braintrust](https://www.braintrust.dev/articles/best-llm-monitoring-tools-2026)
- [LLM Observability Tools: 2026 Comparison](https://lakefs.io/blog/llm-observability-tools/)
- [Slack Incoming Webhooks](https://api.slack.com/messaging/webhooks)
- [GitHub Actions: Events that trigger workflows](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#schedule)

è©³ç´°ãªãƒªã‚µãƒ¼ãƒå†…å®¹ã¯ [Issue #89](https://github.com/0h-n0/zen-auto-create-article/issues/89) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

**é–¢é€£è¨˜äº‹:**
æ—¢å­˜ã® LLM ã‚³ã‚¹ãƒˆæœ€é©åŒ–ã®åŸºç¤ã«ã¤ã„ã¦ã¯ [2026å¹´ç‰ˆï¼šLLMä½¿ç”¨é‡åˆ†æã¨ã‚³ã‚¹ãƒˆæœ€é©åŒ–ã®å®Ÿè·µã‚¬ã‚¤ãƒ‰](https://zenn.dev/0h_n0/articles/cc2c10a61cfeac) ã‚‚ã”å‚ç…§ãã ã•ã„ã€‚

---

:::message
ã“ã®è¨˜äº‹ã¯AIï¼ˆClaude Codeï¼‰ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å†…å®¹ã®æ­£ç¢ºæ€§ã«ã¤ã„ã¦ã¯è¤‡æ•°ã®æƒ…å ±æºã§æ¤œè¨¼ã—ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã®åˆ©ç”¨æ™‚ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚ã”ç¢ºèªãã ã•ã„ã€‚
:::
