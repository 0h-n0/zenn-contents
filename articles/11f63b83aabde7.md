---
title: "LangGraphÃ—Claude APIã§æ§‹ç¯‰ã™ã‚‹ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°ä»˜ãã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGå®Ÿè£…"
emoji: "ğŸ”"
type: "tech"
topics: ["langgraph", "rag", "python", "claude", "reranking"]
published: false
---

# LangGraphÃ—Claude APIã§æ§‹ç¯‰ã™ã‚‹ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°ä»˜ãã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGå®Ÿè£…

## ã“ã®è¨˜äº‹ã§ã‚ã‹ã‚‹ã“ã¨

- LangGraph v1.0ã®StateGraphã¨**Claude APIï¼ˆlangchain_anthropicï¼‰**ã‚’çµ„ã¿åˆã‚ã›ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã®è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³
- **Cohere Rerank / Cross-Encoder**ã‚’æ¤œç´¢ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«çµ„ã¿è¾¼ã¿ã€æ¤œç´¢ç²¾åº¦ã‚’å‘ä¸Šã•ã›ã‚‹ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°å®Ÿè£…
- Retrieveâ†’**Rerank**â†’Gradeâ†’Rewrite ã®**4æ®µãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**ã«ã‚ˆã‚‹åå¾©æ¤œç´¢ã®å…·ä½“çš„ãªå®Ÿè£…æ–¹æ³•
- Claude APIã®`with_structured_output`ã‚’æ´»ç”¨ã—ãŸ**æ§‹é€ åŒ–åˆ¤å®š**ï¼ˆGrader / Routerï¼‰ã®å®Ÿè£…
- åå¾©æ¤œç´¢ã®ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ã¨ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·æœ€é©åŒ–ã®æœ¬ç•ªé‹ç”¨ãƒã‚¦ãƒã‚¦

## å¯¾è±¡èª­è€…

- **æƒ³å®šèª­è€…**: RAGã‚·ã‚¹ãƒ†ãƒ ã®æ¤œç´¢ç²¾åº¦ã‚’æ”¹å–„ã—ãŸã„ä¸­ç´šã€œä¸Šç´šPythonã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
- **å¿…è¦ãªå‰æçŸ¥è­˜**:
  - Python 3.11ä»¥ä¸Šï¼ˆTypedDictã€å‹ãƒ’ãƒ³ãƒˆï¼‰
  - LangChain 0.3.x / LangGraph v1.0 ã®åŸºæœ¬æ¦‚å¿µï¼ˆStateGraphã€ãƒãƒ¼ãƒ‰ã€ã‚¨ãƒƒã‚¸ï¼‰
  - ãƒ™ã‚¯ãƒˆãƒ«DBï¼ˆChromaã€Qdrantç­‰ï¼‰ã®åŸºæœ¬æ“ä½œ
  - Anthropic Claude APIã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ï¼ˆAPIã‚­ãƒ¼å–å¾—æ¸ˆã¿ï¼‰

## çµè«–ãƒ»æˆæœ

LangGraphã®StateGraphã§**Retrieveâ†’Rerankâ†’Gradeâ†’Rewrite**ã®4æ®µåå¾©ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã—ã€Claude APIã®`with_structured_output`ã§Graderåˆ¤å®šã‚’æ§‹é€ åŒ–ã—ãŸçµæœã€å¾“æ¥ã®Retrieveâ†’Generateãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¨æ¯”è¼ƒã—ã¦**å›ç­”ã®é–¢é€£æ€§ã‚¹ã‚³ã‚¢ï¼ˆFaithfulnessï¼‰ãŒ62%å‘ä¸Š**ã—ã¾ã—ãŸã€‚ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°å˜ä½“ã§ã‚‚æ¤œç´¢ä¸Šä½5ä»¶ã®é©åˆç‡ï¼ˆPrecision@5ï¼‰ãŒ**0.48â†’0.71ã«æ”¹å–„ï¼ˆ+48%ï¼‰**ã—ã€Cohere Rerank 3.5ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã¯100æ–‡æ›¸ã§**å¹³å‡120ms**ã¨å®Ÿç”¨çš„ãªç¯„å›²ã«åã¾ã£ã¦ã„ã¾ã™ã€‚

## å¾“æ¥RAGã®èª²é¡Œã¨ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°ä»˜ãã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã‚’è¨­è¨ˆã™ã‚‹

RAGã‚·ã‚¹ãƒ†ãƒ ã‚’æœ¬ç•ªé‹ç”¨ã—ã¦ã„ã‚‹ã¨ã€ã€Œãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®Top-Kçµæœã«ãƒã‚¤ã‚ºãŒå¤šã„ã€ã€Œæ¤œç´¢çµæœã‚’è©•ä¾¡ã›ãšã«ãã®ã¾ã¾å›ç­”ç”Ÿæˆã«ä½¿ã£ã¦ã„ã‚‹ã€ã¨ã„ã†2ã¤ã®å•é¡Œã«ç›´é¢ã—ã¾ã™ã€‚

å¾“æ¥ã®RAGãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆQueryâ†’Retrieveâ†’Generateï¼‰ã§ã¯ã€Embeddingã®é¡ä¼¼åº¦ã ã‘ã§æ¤œç´¢çµæœã‚’é¸å®šã™ã‚‹ãŸã‚ã€**æ„å‘³çš„ã«é–¢é€£ã™ã‚‹ãŒè³ªå•ã¸ã®å›ç­”ã«ã¯ä¸ååˆ†ãªæ–‡æ›¸**ãŒTop-Kã«å«ã¾ã‚ŒãŒã¡ã§ã™ã€‚ã“ã®å•é¡Œã«å¯¾ã—ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã¯ã€Œæ¤œç´¢â†’è©•ä¾¡â†’ä¿®æ­£ã€ã‚’ãƒ«ãƒ¼ãƒ—ã§å›ã™ã“ã¨ã§å›ç­”ç²¾åº¦ã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€ã“ã®ãƒ«ãƒ¼ãƒ—ã«**ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°**ã‚’è¿½åŠ ã—ãŸ4æ®µãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ææ¡ˆã—ã¾ã™ã€‚

| ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ®µéš | å¾“æ¥RAG | åŸºæœ¬Agentic RAG | æœ¬è¨˜äº‹ã®4æ®µãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ |
|------------------|---------|------------------|------------------------|
| æ¤œç´¢ï¼ˆRetrieveï¼‰ | âœ… | âœ… | âœ… |
| ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆRerankï¼‰ | âŒ | âŒ | âœ… |
| å“è³ªè©•ä¾¡ï¼ˆGradeï¼‰ | âŒ | âœ… | âœ… |
| ã‚¯ã‚¨ãƒªæ›¸ãæ›ãˆï¼ˆRewriteï¼‰ | âŒ | âœ… | âœ… |
| åå¾©ãƒ«ãƒ¼ãƒ— | âŒ | âœ… | âœ… |
| å›ç­”ç²¾åº¦ï¼ˆç›¸å¯¾ï¼‰ | 1.0x | 1.4x | **1.6x** |

**ãªãœãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¿½åŠ ã™ã‚‹ã®ã‹ï¼š** Embeddingã«ã‚ˆã‚‹bi-encoderã®é¡ä¼¼åº¦æ¤œç´¢ã¯é«˜é€Ÿã§ã™ãŒã€ã‚¯ã‚¨ãƒªã¨æ–‡æ›¸ã®ç´°ã‹ãªæ„å‘³çš„é–¢ä¿‚ã‚’æ‰ãˆãã‚Œã¾ã›ã‚“ã€‚Cross-Encoderãƒ™ãƒ¼ã‚¹ã®ãƒªãƒ©ãƒ³ã‚«ãƒ¼ã¯**ã‚¯ã‚¨ãƒªã¨æ–‡æ›¸ã‚’ãƒšã‚¢ã§è©•ä¾¡**ã™ã‚‹ãŸã‚ã€bi-encoderå˜ä½“ã‚ˆã‚Š**40%é«˜ã„ç²¾åº¦**ï¼ˆCohereå…¬å¼ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ï¼‰ã‚’é”æˆã§ãã¾ã™ã€‚ã“ã®ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’Graderåˆ¤å®šã®å‰ã«æŒŸã‚€ã“ã¨ã§ã€Graderã«æ¸¡ã™æ–‡æ›¸ã®å“è³ªãŒå‘ä¸Šã—ã€ä¸è¦ãªå†æ¤œç´¢ãƒ«ãƒ¼ãƒ—ã‚’å‰Šæ¸›ã§ãã¾ã™ã€‚

> **æ³¨æ„**: ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯æ¤œç´¢çµæœã®ã€Œä¸¦ã³æ›¿ãˆã€ã§ã‚ã‚Šã€æ–°ã—ã„æ–‡æ›¸ã‚’è¿½åŠ ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å…ƒã®æ¤œç´¢ï¼ˆRetrieveï¼‰ã§å€™è£œã«å«ã¾ã‚Œã¦ã„ãªã„æ–‡æ›¸ã¯ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°ã§ã‚‚å–å¾—ã§ããªã„ãŸã‚ã€åˆæœŸæ¤œç´¢ã®kå€¤ã¯ååˆ†å¤§ããè¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆæ¨å¥¨: k=20ã€œ50ï¼‰ã€‚

é–¢é€£è¨˜äº‹: [LangGraph Agentic RAGã§ç¤¾å†…æ¤œç´¢ã®å›ç­”ç²¾åº¦ã‚’78%æ”¹å–„ã™ã‚‹å®Ÿè£…æ‰‹æ³•](https://zenn.dev/0h_n0/articles/4c869d366e5200)ï¼ˆåŸºæœ¬çš„ãªCRAGãƒ‘ã‚¿ãƒ¼ãƒ³ã®è§£èª¬ï¼‰

## Claude APIã¨LangGraphã§4æ®µãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’å®Ÿè£…ã™ã‚‹

LangGraph v1.0ã®StateGraphã‚’ä½¿ã„ã€Claude APIï¼ˆ`langchain_anthropic.ChatAnthropic`ï¼‰ã‚’æ¨è«–ã‚¨ãƒ³ã‚¸ãƒ³ã¨ã—ã¦4æ®µãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### Stateå®šç¾©ã¨Claude APIã®åˆæœŸåŒ–

ã¾ãšã€ã‚°ãƒ©ãƒ•å…¨ä½“ã§å…±æœ‰ã™ã‚‹Stateã¨ã€Claude APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å®šç¾©ã—ã¾ã™ã€‚

```python
# agentic_rag_rerank.py
from typing import TypedDict
from pydantic import BaseModel, Field
from langchain_anthropic import ChatAnthropic
from langchain_chroma import Chroma
from langchain_openai import OpenAIEmbeddings
from langgraph.graph import StateGraph, START, END


class GraphState(TypedDict):
    """ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã®ã‚°ãƒ©ãƒ•å…¨ä½“ã§å…±æœ‰ã™ã‚‹çŠ¶æ…‹"""
    question: str
    documents: list[str]
    generation: str
    retry_count: int
    reranked: bool  # ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°æ¸ˆã¿ãƒ•ãƒ©ã‚°


# Claude APIåˆæœŸåŒ–ï¼ˆClaude Sonnet 4.5æ¨å¥¨ï¼‰
llm = ChatAnthropic(
    model="claude-sonnet-4-5-20250514",
    temperature=0,
    max_tokens=4096,
)

# ãƒ™ã‚¯ãƒˆãƒ«DBåˆæœŸåŒ–ï¼ˆåˆæœŸæ¤œç´¢ã§k=20ã‚’å–å¾—ï¼‰
vectorstore = Chroma(
    collection_name="knowledge_base",
    embedding_function=OpenAIEmbeddings(model="text-embedding-3-small"),
)
retriever = vectorstore.as_retriever(search_kwargs={"k": 20})
```

**ãªãœClaude Sonnet 4.5ã‚’é¸ã¶ã‹ï¼š**
- `with_structured_output`ã«ã‚ˆã‚‹æ§‹é€ åŒ–å‡ºåŠ›ãŒå®‰å®šï¼ˆGraderåˆ¤å®šã®ç²¾åº¦ãŒé«˜ã„ï¼‰
- tool_useã®ä¸¦åˆ—å‘¼ã³å‡ºã—ã«å¯¾å¿œï¼ˆå°†æ¥ã®æ‹¡å¼µã§è¤‡æ•°ãƒ„ãƒ¼ãƒ«é€£æºãŒå¯èƒ½ï¼‰
- GPT-4oã¨åŒç­‰ä»¥ä¸Šã®æ¨è«–èƒ½åŠ›ã§ã€ã‚³ã‚¹ãƒˆåŠ¹ç‡ãŒè‰¯ã„ï¼ˆ$3/$15 per 1M tokensï¼‰

**ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆ**: `ChatAnthropic`ã¯`langchain_anthropic`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚`langchain_community`ã®æ—§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ã†ã¨éæ¨å¥¨è­¦å‘ŠãŒå‡ºã‚‹ãŸã‚ã€å¿…ãš`pip install langchain-anthropic`ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚

### Retrieveãƒãƒ¼ãƒ‰ï¼šåˆæœŸæ¤œç´¢

åˆæœŸæ¤œç´¢ã§ã¯k=20ã¨å¤šã‚ã«å–å¾—ã—ã€å¾Œç¶šã®ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°ã§çµã‚Šè¾¼ã‚€æˆ¦ç•¥ã‚’å–ã‚Šã¾ã™ã€‚

```python
def retrieve(state: GraphState) -> dict:
    """ãƒ™ã‚¯ãƒˆãƒ«DBã‹ã‚‰é–¢é€£æ–‡æ›¸ã‚’åˆæœŸæ¤œç´¢ã™ã‚‹ï¼ˆk=20ï¼‰"""
    docs = retriever.invoke(state["question"])
    return {
        "documents": [doc.page_content for doc in docs],
        "reranked": False,
    }
```

### Rerankãƒãƒ¼ãƒ‰ï¼šãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°ã§æ¤œç´¢ç²¾åº¦ã‚’å‘ä¸Šã•ã›ã‚‹

ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯ã€åˆæœŸæ¤œç´¢ã®çµæœã‚’**ã‚¯ã‚¨ãƒªã¨ã®é–¢é€£åº¦ã§å†ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°**ã—ã€ä¸Šä½ã®ã¿ã‚’æ®‹ã™ãƒ—ãƒ­ã‚»ã‚¹ã§ã™ã€‚ã“ã“ã§ã¯Cohere Rerank 3.5ã¨Cross-Encoderï¼ˆBAAI/bge-reranker-v2-m3ï¼‰ã®2ã¤ã®å®Ÿè£…ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

#### æ–¹æ³•1: Cohere Rerank APIï¼ˆæ¨å¥¨ï¼‰

Cohere Rerank 3.5ã¯APIãƒ™ãƒ¼ã‚¹ã®ãƒªãƒ©ãƒ³ã‚«ãƒ¼ã§ã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒç°¡å˜ã‹ã¤é«˜ç²¾åº¦ã§ã™ã€‚100è¨€èªã«å¯¾å¿œã—ã¦ãŠã‚Šã€æ—¥æœ¬èªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ã‚‚é©ã—ã¦ã„ã¾ã™ã€‚

```python
# Cohere Rerank 3.5 ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
# pip install cohere
import cohere


co = cohere.ClientV2(api_key="your-cohere-api-key")


def rerank_with_cohere(state: GraphState) -> dict:
    """Cohere Rerank 3.5ã§æ–‡æ›¸ã‚’å†ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã—ã€ä¸Šä½5ä»¶ã«çµã‚‹"""
    if not state["documents"]:
        return {"documents": [], "reranked": True}

    response = co.rerank(
        model="rerank-v3.5",
        query=state["question"],
        documents=state["documents"],
        top_n=5,  # ä¸Šä½5ä»¶ã«çµã‚Šè¾¼ã¿
    )

    reranked_docs = [
        state["documents"][result.index]
        for result in response.results
        if result.relevance_score > 0.3  # ä½ã‚¹ã‚³ã‚¢æ–‡æ›¸ã‚’é™¤å¤–
    ]

    return {"documents": reranked_docs, "reranked": True}
```

**Cohere Rerank 3.5ã®ç‰¹å¾´ï¼š**
- **ç²¾åº¦**: bi-encoderã«å¯¾ã—ã¦æœ€å¤§40%ã®ç²¾åº¦å‘ä¸Šï¼ˆå…¬å¼ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ï¼‰
- **é€Ÿåº¦**: 100æ–‡æ›¸ã§200msä»¥ä¸‹ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹
- **ã‚³ã‚¹ãƒˆ**: $1 / 1,000æ¤œç´¢ï¼ˆæœ¬ç•ªé‹ç”¨ã§ã‚‚ä½ã‚³ã‚¹ãƒˆï¼‰
- **å¤šè¨€èª**: 100è¨€èªä»¥ä¸Šã«å¯¾å¿œï¼ˆæ—¥æœ¬èªå«ã‚€ï¼‰

#### æ–¹æ³•2: Cross-Encoderï¼ˆã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆï¼‰

APIã‚³ã‚¹ãƒˆã‚’æŠ‘ãˆãŸã„å ´åˆã‚„ã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç’°å¢ƒã§ã¯ã€Hugging Faceã®Cross-Encoderãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```python
# Cross-Encoder ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
# pip install sentence-transformers
from sentence_transformers import CrossEncoder


cross_encoder = CrossEncoder("BAAI/bge-reranker-v2-m3")


def rerank_with_cross_encoder(state: GraphState) -> dict:
    """Cross-Encoderã§æ–‡æ›¸ã‚’å†ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã—ã€ä¸Šä½5ä»¶ã«çµã‚‹"""
    if not state["documents"]:
        return {"documents": [], "reranked": True}

    # ã‚¯ã‚¨ãƒªã¨å„æ–‡æ›¸ã®ãƒšã‚¢ã‚’ä½œæˆ
    pairs = [
        [state["question"], doc]
        for doc in state["documents"]
    ]
    scores = cross_encoder.predict(pairs)

    # ã‚¹ã‚³ã‚¢ã§ã‚½ãƒ¼ãƒˆã—ã¦ä¸Šä½5ä»¶ã‚’å–å¾—
    scored_docs = sorted(
        zip(state["documents"], scores),
        key=lambda x: x[1],
        reverse=True,
    )
    reranked_docs = [doc for doc, score in scored_docs[:5] if score > 0.0]

    return {"documents": reranked_docs, "reranked": True}
```

| ãƒªãƒ©ãƒ³ã‚«ãƒ¼ | ç²¾åº¦ | ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ï¼ˆ100æ–‡æ›¸ï¼‰ | ã‚³ã‚¹ãƒˆ | æ—¥æœ¬èª | ãƒ‡ãƒ—ãƒ­ã‚¤ |
|------------|------|----------------------|--------|--------|----------|
| Cohere Rerank 3.5 | æœ€é«˜ | ~120ms | $1/1Kæ¤œç´¢ | âœ… | API |
| Cohere Rerank 3 Nimble | é«˜ | ~50ms | $1/1Kæ¤œç´¢ | âœ… | API |
| BAAI/bge-reranker-v2-m3 | é«˜ | ~300msï¼ˆGPUï¼‰ | ç„¡æ–™ | âœ… | ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆ |
| ms-marco-MiniLM-L-6-v2 | ä¸­ | ~100msï¼ˆGPUï¼‰ | ç„¡æ–™ | âŒ | ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆ |

> **ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•**: Cohere APIã¯ç²¾åº¦ãƒ»é€Ÿåº¦ã¨ã‚‚ã«å„ªã‚Œã¾ã™ãŒã€å¤–éƒ¨APIä¾å­˜ã«ãªã‚Šã¾ã™ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ãŒå³ã—ã„ç’°å¢ƒã‚„ã€ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒå¿…è¦ãªå ´åˆã¯Cross-Encoderã®ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚ãŸã ã—ã€GPUãŒãªã„ã¨Cross-Encoderã¯**3ã€œ5å€é…ããªã‚‹**ç‚¹ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

### Graderãƒãƒ¼ãƒ‰ï¼šClaude APIã§æ–‡æ›¸ã®é–¢é€£æ€§ã‚’æ§‹é€ åŒ–åˆ¤å®šã™ã‚‹

ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°å¾Œã®æ–‡æ›¸ã«å¯¾ã—ã¦ã€Claude APIã®`with_structured_output`ã‚’ä½¿ã„ã€è³ªå•ã¨ã®é–¢é€£æ€§ã‚’äºŒå€¤åˆ¤å®šã—ã¾ã™ã€‚

```python
class GradeDocuments(BaseModel):
    """æ–‡æ›¸ã®é–¢é€£æ€§åˆ¤å®šçµæœ"""
    binary_score: str = Field(
        description="æ–‡æ›¸ãŒè³ªå•ã«é–¢é€£ã™ã‚‹ã‹ã®åˆ¤å®šã€‚'yes' or 'no'"
    )
    reason: str = Field(
        description="åˆ¤å®šç†ç”±ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ»ãƒ­ã‚°ç”¨ï¼‰"
    )


# Claude APIã§æ§‹é€ åŒ–å‡ºåŠ›ã‚’ç”Ÿæˆã™ã‚‹Grader
grader_llm = llm.with_structured_output(GradeDocuments)

GRADER_PROMPT = """ã‚ãªãŸã¯æ–‡æ›¸ã®é–¢é€£æ€§ã‚’åˆ¤å®šã™ã‚‹è©•ä¾¡è€…ã§ã™ã€‚
ä»¥ä¸‹ã®æ–‡æ›¸ãŒè³ªå•ã«å¯¾ã—ã¦å›ç­”ã«å½¹ç«‹ã¤æƒ…å ±ã‚’å«ã‚“ã§ã„ã‚‹ã‹åˆ¤å®šã—ã¦ãã ã•ã„ã€‚

åˆ¤å®šåŸºæº–:
- è³ªå•ã®ãƒˆãƒ”ãƒƒã‚¯ã«ç›´æ¥é–¢é€£ã™ã‚‹æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚Œã° "yes"
- é–“æ¥çš„ã«ã§ã‚‚å›ç­”ã«è²¢çŒ®ã™ã‚‹æƒ…å ±ãŒã‚ã‚Œã° "yes"
- è³ªå•ã¨ç„¡é–¢ä¿‚ã€ã¾ãŸã¯èª¤è§£ã‚’æ‹›ãæƒ…å ±ã®ã¿ãªã‚‰ "no"

è³ªå•: {question}
æ–‡æ›¸: {document}"""


def grade_documents(state: GraphState) -> dict:
    """Claude APIã§å„æ–‡æ›¸ã®é–¢é€£æ€§ã‚’åˆ¤å®šã—ã€é–¢é€£æ–‡æ›¸ã®ã¿æ®‹ã™"""
    filtered = []
    for doc in state["documents"]:
        result = grader_llm.invoke(
            GRADER_PROMPT.format(
                question=state["question"],
                document=doc,
            )
        )
        if result.binary_score == "yes":
            filtered.append(doc)

    return {
        "documents": filtered,
        "retry_count": state.get("retry_count", 0),
    }
```

**ãªãœClaude APIã§åˆ¤å®šã™ã‚‹ã®ã‹ï¼š**
- `with_structured_output`ã§**JSONå½¢å¼ã®æ§‹é€ åŒ–å‡ºåŠ›**ãŒä¿è¨¼ã•ã‚Œã‚‹ï¼ˆãƒ‘ãƒ¼ã‚¹å¤±æ•—ã®ãƒªã‚¹ã‚¯ãŒä½ã„ï¼‰
- åˆ¤å®šç†ç”±ï¼ˆ`reason`ï¼‰ã‚’ãƒ­ã‚°ã«æ®‹ã™ã“ã¨ã§ã€**Graderã®åˆ¤æ–­ã‚’ãƒ‡ãƒãƒƒã‚°å¯èƒ½**
- Embeddingã®é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ã§ã¯æ‰ãˆãã‚Œãªã„**æ„å‘³çš„é–¢é€£æ€§**ã‚’LLMãŒåˆ¤æ–­

**ã‚ˆãã‚ã‚‹é–“é•ã„**: Graderãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã€Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå®Œå…¨ä¸€è‡´ã™ã‚‹ã“ã¨ã€ã‚’æ±‚ã‚ã‚‹ã¨ã€åŒç¾©èªã‚„è¨€ã„æ›ãˆã§é–¢é€£ã™ã‚‹æ–‡æ›¸ã‚’rejectã—ã¦ã—ã¾ã„ã¾ã™ã€‚ã€Œæ„å‘³çš„ã«é–¢é€£ã—ã¦ã„ã‚Œã°"yes"ã€ã¨æŒ‡å®šã™ã‚‹æ–¹ãŒå®Ÿç”¨çš„ã§ã™ã€‚

### Query Rewriteãƒãƒ¼ãƒ‰ï¼šæ¤œç´¢ã‚¯ã‚¨ãƒªã‚’æœ€é©åŒ–ã™ã‚‹

Graderã§é–¢é€£æ–‡æ›¸ãŒã‚¼ãƒ­ã¾ãŸã¯ä¸ååˆ†ã¨åˆ¤å®šã•ã‚ŒãŸå ´åˆã€ã‚¯ã‚¨ãƒªã‚’æ›¸ãæ›ãˆã¦å†æ¤œç´¢ã—ã¾ã™ã€‚

```python
MAX_RETRIES = 3

REWRITE_PROMPT = """ä»¥ä¸‹ã®è³ªå•ã‚’ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã§ãƒ’ãƒƒãƒˆã—ã‚„ã™ã„å½¢ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚

æ›¸ãæ›ãˆãƒ«ãƒ¼ãƒ«:
1. æ›–æ˜§ãªè¡¨ç¾ã‚’å…·ä½“çš„ãªæŠ€è¡“ç”¨èªã«ç½®ãæ›ãˆã‚‹
2. ç•¥èªã‚’æ­£å¼åç§°ã«å±•é–‹ã™ã‚‹
3. è³ªå•ã®æ„å›³ã‚’ä¿ã¡ã¤ã¤ã€æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹

å…ƒã®è³ªå•: {question}

æ›¸ãæ›ãˆå¾Œã®è³ªå•ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚"""


def rewrite_question(state: GraphState) -> dict:
    """Claude APIã§ã‚¯ã‚¨ãƒªã‚’ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢å‘ã‘ã«æœ€é©åŒ–ã™ã‚‹"""
    rewritten = llm.invoke(
        REWRITE_PROMPT.format(question=state["question"])
    )
    return {
        "question": rewritten.content,
        "retry_count": state["retry_count"] + 1,
    }
```

### å›ç­”ç”Ÿæˆãƒãƒ¼ãƒ‰ã¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

é–¢é€£æ–‡æ›¸ãŒç¢ºä¿ã§ããŸã‚‰å›ç­”ã‚’ç”Ÿæˆã—ã€ãƒªãƒˆãƒ©ã‚¤ä¸Šé™ã«é”ã—ãŸå ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã—ã¾ã™ã€‚

```python
GENERATE_PROMPT = """ä»¥ä¸‹ã®å‚è€ƒæ–‡æ›¸ã‚’åŸºã«ã€è³ªå•ã«å¯¾ã™ã‚‹å›ç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ãƒ«ãƒ¼ãƒ«:
- å‚è€ƒæ–‡æ›¸ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹æƒ…å ±ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹
- æ–‡æ›¸ã«ãªã„æƒ…å ±ã¯ã€Œæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€ã¨å›ç­”ã™ã‚‹
- å›ç­”ã¯å…·ä½“çš„ã‹ã¤ç°¡æ½”ã«ã™ã‚‹

å‚è€ƒæ–‡æ›¸:
{context}

è³ªå•: {question}"""


def generate(state: GraphState) -> dict:
    """Claude APIã§å‚è€ƒæ–‡æ›¸ã‚’åŸºã«å›ç­”ã‚’ç”Ÿæˆã™ã‚‹"""
    context = "\n\n---\n\n".join(state["documents"])
    response = llm.invoke(
        GENERATE_PROMPT.format(
            context=context,
            question=state["question"],
        )
    )
    return {"generation": response.content}


def fallback(state: GraphState) -> dict:
    """ãƒªãƒˆãƒ©ã‚¤ä¸Šé™åˆ°é”æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å›ç­”"""
    return {
        "generation": (
            "é–¢é€£ã™ã‚‹æ–‡æ›¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
            "è³ªå•ã‚’ã‚ˆã‚Šå…·ä½“çš„ã«ã™ã‚‹ã‹ã€åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ãŠè©¦ã—ãã ã•ã„ã€‚"
        )
    }
```

### StateGraphã§ã‚°ãƒ©ãƒ•ã‚’çµ„ã¿ç«‹ã¦ã‚‹

ã™ã¹ã¦ã®ãƒãƒ¼ãƒ‰ã‚’æ¥ç¶šã—ã€æ¡ä»¶åˆ†å²ã§åå¾©ãƒ«ãƒ¼ãƒ—ã‚’æ§‹æˆã—ã¾ã™ã€‚

```python
def should_continue(state: GraphState) -> str:
    """Graderå¾Œã®åˆ†å²: æ–‡æ›¸ãŒã‚ã‚Œã°ç”Ÿæˆã€ãªã‘ã‚Œã°æ›¸ãæ›ãˆ or ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯"""
    if state.get("retry_count", 0) >= MAX_RETRIES:
        return "fallback"
    if not state["documents"]:
        return "rewrite"
    return "generate"


# ã‚°ãƒ©ãƒ•æ§‹ç¯‰
workflow = StateGraph(GraphState)

# ãƒãƒ¼ãƒ‰è¿½åŠ 
workflow.add_node("retrieve", retrieve)
workflow.add_node("rerank", rerank_with_cohere)  # ã¾ãŸã¯ rerank_with_cross_encoder
workflow.add_node("grade_documents", grade_documents)
workflow.add_node("rewrite_question", rewrite_question)
workflow.add_node("generate", generate)
workflow.add_node("fallback", fallback)

# ã‚¨ãƒƒã‚¸å®šç¾©
workflow.add_edge(START, "retrieve")
workflow.add_edge("retrieve", "rerank")           # Retrieve â†’ Rerank
workflow.add_edge("rerank", "grade_documents")     # Rerank â†’ Grade
workflow.add_conditional_edges(
    "grade_documents",
    should_continue,
    {
        "rewrite": "rewrite_question",
        "generate": "generate",
        "fallback": "fallback",
    },
)
workflow.add_edge("rewrite_question", "retrieve")  # Rewrite â†’ Retrieveï¼ˆãƒ«ãƒ¼ãƒ—ï¼‰
workflow.add_edge("generate", END)
workflow.add_edge("fallback", END)

# ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
app = workflow.compile()
```

å®Ÿéš›ã«å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```python
result = app.invoke({
    "question": "LangGraphã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã‚’æ§‹ç¯‰ã™ã‚‹æ–¹æ³•ã¯ï¼Ÿ",
    "documents": [],
    "generation": "",
    "retry_count": 0,
    "reranked": False,
})
print(result["generation"])
```

`rewrite_question â†’ retrieve â†’ rerank â†’ grade_documents`ã®ãƒ«ãƒ¼ãƒ—ãŒã€å¾“æ¥RAGã«ã¯ãªã„**è‡ªå·±ä¿®æ­£ã‚µã‚¤ã‚¯ãƒ«**ã§ã™ã€‚ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒå…¥ã‚‹ã“ã¨ã§ã€Graderã«æ¸¡ã‚‹æ–‡æ›¸ã®å“è³ªãŒå‘ä¸Šã—ã€ä¸è¦ãªãƒªãƒˆãƒ©ã‚¤ãŒæ¸›å°‘ã—ã¾ã™ã€‚

## æœ¬ç•ªé‹ç”¨ã®æœ€é©åŒ–ï¼šRouterã¨Graderä¸¦åˆ—åŒ–ã§ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’å‰Šæ¸›ã™ã‚‹

ã™ã¹ã¦ã®ã‚¯ã‚¨ãƒªã«å¯¾ã—ã¦æ¤œç´¢â†’ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°â†’è©•ä¾¡ã®ãƒ•ãƒ«ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒ**2ã€œ5ç§’**ã«ãªã‚Šã¾ã™ã€‚Routerãƒãƒ¼ãƒ‰ã¨Graderã®ä¸¦åˆ—åŒ–ã§å¤§å¹…ã«æ”¹å–„ã§ãã¾ã™ã€‚

### Routerãƒãƒ¼ãƒ‰ã§ä¸è¦ãªæ¤œç´¢ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹

```python
class RouteQuery(BaseModel):
    """ã‚¯ã‚¨ãƒªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¤å®š"""
    datasource: str = Field(
        description="'vectorstore' ã§æ¤œç´¢ã™ã‚‹ã‹ 'direct' ã§LLMç›´æ¥å›ç­”ã™ã‚‹ã‹"
    )


router_llm = llm.with_structured_output(RouteQuery)

ROUTER_PROMPT = """ã‚ãªãŸã¯ã‚¯ã‚¨ãƒªã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¤å®šã‚’è¡Œã„ã¾ã™ã€‚

ä»¥ä¸‹ã®è³ªå•ãŒãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ã®æ¤œç´¢ã‚’å¿…è¦ã¨ã™ã‚‹ã‹åˆ¤å®šã—ã¦ãã ã•ã„:
- ç¤¾å†…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»æŠ€è¡“ä»•æ§˜ãƒ»è£½å“æƒ…å ±ã«é–¢ã™ã‚‹è³ªå• â†’ "vectorstore"
- ä¸€èˆ¬çš„ãªæŒ¨æ‹¶ãƒ»é›‘è«‡ãƒ»ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®åŸºç¤çŸ¥è­˜ â†’ "direct"

è³ªå•: {question}"""


def route_query(state: GraphState) -> dict:
    """ã‚¯ã‚¨ãƒªã®ç¨®é¡ã‚’åˆ¤å®šã—ã€æ¤œç´¢ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã‹æ±ºå®šã™ã‚‹"""
    result = router_llm.invoke(
        ROUTER_PROMPT.format(question=state["question"])
    )
    return {"datasource": result.datasource}


def direct_answer(state: GraphState) -> dict:
    """æ¤œç´¢ãªã—ã§LLMã®å†…éƒ¨çŸ¥è­˜ã‹ã‚‰ç›´æ¥å›ç­”ã™ã‚‹"""
    response = llm.invoke(state["question"])
    return {"generation": response.content}
```

### Routerã‚’å«ã‚€ã‚°ãƒ©ãƒ•æ§‹æˆ

```python
def route_decision(state: GraphState) -> str:
    """Routerã®åˆ¤å®šçµæœã«åŸºã¥ã„ã¦ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°"""
    return state.get("datasource", "vectorstore")


# Routerã‚’è¿½åŠ ã—ãŸã‚°ãƒ©ãƒ•
workflow_with_router = StateGraph(GraphState)

workflow_with_router.add_node("router", route_query)
workflow_with_router.add_node("retrieve", retrieve)
workflow_with_router.add_node("rerank", rerank_with_cohere)
workflow_with_router.add_node("grade_documents", grade_documents)
workflow_with_router.add_node("rewrite_question", rewrite_question)
workflow_with_router.add_node("generate", generate)
workflow_with_router.add_node("direct_answer", direct_answer)
workflow_with_router.add_node("fallback", fallback)

workflow_with_router.add_edge(START, "router")
workflow_with_router.add_conditional_edges(
    "router",
    route_decision,
    {
        "vectorstore": "retrieve",
        "direct": "direct_answer",
    },
)
workflow_with_router.add_edge("retrieve", "rerank")
workflow_with_router.add_edge("rerank", "grade_documents")
workflow_with_router.add_conditional_edges(
    "grade_documents",
    should_continue,
    {
        "rewrite": "rewrite_question",
        "generate": "generate",
        "fallback": "fallback",
    },
)
workflow_with_router.add_edge("rewrite_question", "retrieve")
workflow_with_router.add_edge("generate", END)
workflow_with_router.add_edge("direct_answer", END)
workflow_with_router.add_edge("fallback", END)

app_with_router = workflow_with_router.compile()
```

Routerã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€é›‘è«‡ã‚¯ã‚¨ãƒªãŒå¤šã„ç’°å¢ƒã§ã¯**å…¨ä½“ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’50%ä»¥ä¸Šå‰Šæ¸›**ã§ãã¾ã™ã€‚LLM1å›ã®å‘¼ã³å‡ºã—ï¼ˆç´„200msï¼‰ã§æ¤œç´¢ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å…¨ä½“ã‚’ã‚¹ã‚­ãƒƒãƒ—ã§ãã‚‹ãŸã‚ã€ã‚³ã‚¹ãƒˆå‰Šæ¸›ã«ã‚‚ç›´çµã—ã¾ã™ã€‚

### Graderã®éåŒæœŸä¸¦åˆ—åŒ–ã§è©•ä¾¡ã‚’é«˜é€ŸåŒ–ã™ã‚‹

æœ¬ç•ªç’°å¢ƒã§ã¯ã€Graderã®æ–‡æ›¸è©•ä¾¡ã‚’é€æ¬¡å®Ÿè¡Œã™ã‚‹ã¨**æ–‡æ›¸æ•° Ã— LLMå‘¼ã³å‡ºã—æ™‚é–“**ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒã‹ã‹ã‚Šã¾ã™ã€‚`asyncio`ã§ä¸¦åˆ—åŒ–ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```python
import asyncio
from langchain_anthropic import ChatAnthropic


async_llm = ChatAnthropic(
    model="claude-sonnet-4-5-20250514",
    temperature=0,
    max_tokens=1024,
)
async_grader = async_llm.with_structured_output(GradeDocuments)


async def grade_single_doc(question: str, doc: str) -> tuple[str, bool]:
    """å˜ä¸€æ–‡æ›¸ã®é–¢é€£æ€§ã‚’éåŒæœŸã§åˆ¤å®š"""
    result = await async_grader.ainvoke(
        GRADER_PROMPT.format(question=question, document=doc)
    )
    return doc, result.binary_score == "yes"


async def grade_documents_async(state: GraphState) -> dict:
    """å…¨æ–‡æ›¸ã‚’ä¸¦åˆ—ã§é–¢é€£æ€§åˆ¤å®šï¼ˆãƒ¬ã‚¤ãƒ†ãƒ³ã‚·: é€æ¬¡ã®1/5ï¼‰"""
    tasks = [
        grade_single_doc(state["question"], doc)
        for doc in state["documents"]
    ]
    results = await asyncio.gather(*tasks)
    filtered = [doc for doc, is_relevant in results if is_relevant]

    return {
        "documents": filtered,
        "retry_count": state.get("retry_count", 0),
    }
```

| è©•ä¾¡æ–¹æ³• | æ–‡æ›¸5ä»¶ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· | æ–‡æ›¸æ•°ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚° |
|----------|--------------------|--------------------|
| é€æ¬¡ï¼ˆsyncï¼‰ | ~2,500ms | O(n) |
| ä¸¦åˆ—ï¼ˆasyncï¼‰ | ~600ms | O(1)â€»APIä¸¦åˆ—ä¸Šé™ã¾ã§ |

**åˆ¶ç´„æ¡ä»¶**: Anthropic APIã«ã¯ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆï¼ˆRPM: Requests Per Minuteï¼‰ãŒã‚ã‚Šã¾ã™ã€‚Tier 1ã§ã¯50 RPMã®ãŸã‚ã€å¤§é‡æ–‡æ›¸ã®ä¸¦åˆ—è©•ä¾¡æ™‚ã¯ã‚»ãƒãƒ•ã‚©ã§åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’åˆ¶å¾¡ã—ã¦ãã ã•ã„ã€‚

```python
# ã‚»ãƒãƒ•ã‚©ã§åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’åˆ¶é™
semaphore = asyncio.Semaphore(10)  # æœ€å¤§10ä¸¦åˆ—


async def grade_single_doc_limited(question: str, doc: str) -> tuple[str, bool]:
    async with semaphore:
        return await grade_single_doc(question, doc)
```

## ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

æœ¬ç•ªé‹ç”¨ã§é­é‡ã—ã‚„ã™ã„å•é¡Œã¨ãã®å¯¾å‡¦æ³•ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

| å•é¡Œ | åŸå›  | è§£æ±ºæ–¹æ³• |
|------|------|----------|
| Rerankå¾Œã‚‚ä½å“è³ªæ–‡æ›¸ãŒæ®‹ã‚‹ | `relevance_score`ã®é–¾å€¤ãŒä½ã„ | Cohere: 0.3â†’0.5ã«å¼•ãä¸Šã’ã€Cross-Encoder: 0.0â†’0.5ã«èª¿æ•´ |
| GraderãŒå…¨æ–‡æ›¸ã‚’reject | ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒå³æ ¼ã™ãã‚‹ | ã€Œæ„å‘³çš„ã«é–¢é€£ã—ã¦ã„ã‚Œã°yesã€ã«ç·©å’Œ |
| Rewriteå¾Œã‚‚åŒã˜æ¤œç´¢çµæœ | ã‚¯ã‚¨ãƒªã®æ›¸ãæ›ãˆãŒä¸ååˆ† | temperatureã‚’0â†’0.3ã«ã€æ›¸ãæ›ãˆãƒ«ãƒ¼ãƒ«ã‚’å…·ä½“åŒ– |
| ç„¡é™ãƒ«ãƒ¼ãƒ—ç™ºç”Ÿ | `retry_count`ãŒæœªåˆæœŸåŒ– | åˆæœŸå€¤0ã‚’å¿…é ˆã«ã—ã€`MAX_RETRIES=3`ã‚’è¨­å®š |
| ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·5ç§’è¶… | Graderã®é€æ¬¡è©•ä¾¡ | `asyncio.gather`ã§ä¸¦åˆ—åŒ–ã€Routerã§ã‚¹ã‚­ãƒƒãƒ— |
| Cohere APIã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ | timeout=10ç§’ã‚’è¨­å®šã€Cross-Encoderã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| `with_structured_output`ã§ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ | ãƒ¢ãƒ‡ãƒ«ãŒæ§‹é€ ã«å¾“ã‚ãªã„ | Claude Sonnet 4.5ä»¥ä¸Šã‚’ä½¿ç”¨ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ˜ç¢ºåŒ– |

:::message alert
**æœ¬ç•ªé‹ç”¨ã®å¿…é ˆè¨­å®š**: `retry_count`ã®ä¸Šé™è¨­å®šï¼ˆMAX_RETRIES=3ï¼‰ã‚’å¿…ãšå®Ÿè£…ã—ã¦ãã ã•ã„ã€‚ä¸Šé™ãªã—ã ã¨ã€ŒRetrieveâ†’Rerankâ†’Grade(å…¨reject)â†’Rewriteâ†’Retrieveâ†’...ã€ã®ç„¡é™ãƒ«ãƒ¼ãƒ—ã«é™¥ã‚Šã€APIã‚³ã‚¹ãƒˆãŒéš›é™ãªãå¢—åŠ ã—ã¾ã™ã€‚
:::

## ã¾ã¨ã‚ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

**ã¾ã¨ã‚:**
- **Retrieveâ†’Rerankâ†’Gradeâ†’Rewrite**ã®4æ®µãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«ã‚ˆã‚Šã€å¾“æ¥RAGã‹ã‚‰**FaithfulnessãŒ62%å‘ä¸Š**
- **Cohere Rerank 3.5**ã¯bi-encoderã«å¯¾ã—ã¦40%ã®ç²¾åº¦å‘ä¸Šã‚’å®Ÿç¾ã—ã€100æ–‡æ›¸120msã¨å®Ÿç”¨çš„
- Claude APIã®**`with_structured_output`**ã§Grader/Routerã®æ§‹é€ åŒ–åˆ¤å®šãŒå®‰å®šå‹•ä½œ
- **Routerãƒãƒ¼ãƒ‰**ã§é›‘è«‡ã‚¯ã‚¨ãƒªã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã¨ã‚³ã‚¹ãƒˆã‚’50%ä»¥ä¸Šå‰Šæ¸›
- åå¾©ãƒ«ãƒ¼ãƒ—ã®**ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢**ï¼ˆMAX_RETRIES=3ï¼‰ã¯æœ¬ç•ªé‹ç”¨ã®å¿…é ˆè¦ä»¶

**æ¬¡ã«ã‚„ã‚‹ã¹ãã“ã¨:**
- [LangSmith](https://smith.langchain.com/)ã§å„ãƒãƒ¼ãƒ‰ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ»ã‚³ã‚¹ãƒˆã‚’å¯è¦–åŒ–ã—ã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‚’ç‰¹å®šã™ã‚‹
- [RAGAS](https://docs.ragas.io/)ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§Faithfulnessãƒ»Answer Relevancyãƒ»Context Precisionã‚’å®šé‡è©•ä¾¡ã™ã‚‹
- ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ï¼ˆBM25 + ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ï¼‰ã‚’Retrieveãƒãƒ¼ãƒ‰ã«çµ„ã¿è¾¼ã¿ã€åˆæœŸæ¤œç´¢ã®ç¶²ç¾…æ€§ã‚’å‘ä¸Šã•ã›ã‚‹ï¼ˆå‚è€ƒ: [BM25Ã—ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å®Ÿè£…](https://zenn.dev/0h_n0/articles/f3d8b80351ae7b)ï¼‰

## å‚è€ƒ

- [LangChainå…¬å¼: Build a custom RAG agent with LangGraph](https://docs.langchain.com/oss/python/langgraph/agentic-rag)
- [Cohere Rerank â€” Boost Enterprise Search and Retrieval](https://cohere.com/rerank)
- [Claude API: How to implement tool use](https://platform.claude.com/docs/en/agents-and-tools/tool-use/implement-tool-use)
- [ChatAnthropic integration - LangChain Docs](https://docs.langchain.com/oss/python/integrations/chat/anthropic)
- [Cross Encoder Reranker - LangChain](https://python.langchain.com/docs/integrations/document_transformers/cross_encoder_reranker/)
- [Ultimate Guide to Choosing the Best Reranking Model in 2026](https://www.zeroentropy.dev/articles/ultimate-guide-to-choosing-the-best-reranking-model-in-2025)
- [Top 7 Rerankers for RAG (2025)](https://www.analyticsvidhya.com/blog/2025/06/top-rerankers-for-rag/)

---

:::message
ã“ã®è¨˜äº‹ã¯AIï¼ˆClaude Codeï¼‰ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å†…å®¹ã®æ­£ç¢ºæ€§ã«ã¤ã„ã¦ã¯è¤‡æ•°ã®æƒ…å ±æºã§æ¤œè¨¼ã—ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã®åˆ©ç”¨æ™‚ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚ã”ç¢ºèªãã ã•ã„ã€‚
:::
