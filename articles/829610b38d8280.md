---
title: "ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã®è©•ä¾¡é§†å‹•ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ï¼šNDCGè¨ˆæ¸¬ã¨Î±æœ€é©åŒ–ã®å®Ÿè·µ"
emoji: "ğŸ“Š"
type: "tech"
topics: ["rag", "search", "python", "elasticsearch", "opensearch"]
published: false
---

# ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã®è©•ä¾¡é§†å‹•ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ï¼šNDCGè¨ˆæ¸¬ã¨Î±æœ€é©åŒ–ã®å®Ÿè·µ

## ã“ã®è¨˜äº‹ã§ã‚ã‹ã‚‹ã“ã¨

- ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ï¼ˆBM25Ã—ãƒ™ã‚¯ãƒˆãƒ«ï¼‰ã®**æ¤œç´¢å“è³ªã‚’å®šé‡è©•ä¾¡ã™ã‚‹æ–¹æ³•**ï¼ˆNDCG@10ã€MRRã€Recall@kï¼‰
- RRFãƒ»ç·šå½¢çµåˆãƒ»Weighted RRFã®**fusionæ‰‹æ³•ã‚’è‡ªå‹•æ¯”è¼ƒãƒ»æœ€é©åŒ–**ã™ã‚‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ§‹ç¯‰æ‰‹é †
- OpenSearch/Elasticsearchã®**æ­£è¦åŒ–æ‰‹æ³•ï¼ˆl2ã€min_maxï¼‰ã¨çµ„ã¿åˆã‚ã›æˆ¦ç•¥**ã®é¸ã³æ–¹
- BGE-M3ã®Learned Sparse RetrievalãŒ**å¾“æ¥BM25ã‚’ä¸Šå›ã‚‹ç†ç”±**ã¨å°å…¥æ–¹æ³•
- ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ãŒ**é€†åŠ¹æœã«ãªã‚‹ã‚±ãƒ¼ã‚¹ã®å®šé‡çš„ãªåˆ¤å®šåŸºæº–**

## å¯¾è±¡èª­è€…

- **æƒ³å®šèª­è€…**: ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã®åŸºæœ¬å®Ÿè£…ã‚’çµ‚ãˆã€ç²¾åº¦ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã«å–ã‚Šçµ„ã‚€ä¸­ç´šã€œä¸Šç´šã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
- **å¿…è¦ãªå‰æçŸ¥è­˜**:
  - BM25ã¨ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®åŸºæœ¬çš„ãªä»•çµ„ã¿ï¼ˆ[åŸºç¤ã¯ã“ã¡ã‚‰ã®è¨˜äº‹ã‚’å‚ç…§](https://zenn.dev/0h_n0/articles/f3d8b80351ae7b)ï¼‰
  - Python 3.10ä»¥ä¸Šã®åŸºæœ¬æ“ä½œ
  - RRFï¼ˆReciprocal Rank Fusionï¼‰ã®æ¦‚å¿µ

## çµè«–ãƒ»æˆæœ

WANDSãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§ã®å®Ÿæ¸¬ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã«ã‚ˆã‚‹ã¨ã€å˜ç´”ãªRRFã®NDCG@10ã¯0.707ã«ã¨ã©ã¾ã‚‹ã®ã«å¯¾ã—ã€**æ®µéšçš„å€™è£œé¸åˆ¥ï¼ˆmulti-tierï¼‰ï¼‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ–ãƒ¼ã‚¹ãƒˆã‚’çµ„ã¿åˆã‚ã›ãŸæˆ¦ç•¥ã§ã¯NDCG@10ãŒ0.750ã«åˆ°é”**ã—ã¦ã„ã¾ã™ï¼ˆ[Doug Turnbullæ°ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯](https://softwaredoug.com/blog/2025/03/13/elasticsearch-hybrid-search-strategies)ã«ã‚ˆã‚‹ï¼‰ã€‚RRFã ã‘ã«é ¼ã‚‰ãšã€**è©•ä¾¡æŒ‡æ¨™ã‚’è¨ˆæ¸¬ã—ãªãŒã‚‰fusionæ‰‹æ³•ã‚’æœ€é©åŒ–ã™ã‚‹**ã“ã¨ã§ã€æ¤œç´¢ç²¾åº¦ã‚’ã•ã‚‰ã«7ã€œ10%å‘ä¸Šã•ã›ã‚‹ä½™åœ°ãŒã‚ã‚Šã¾ã™ã€‚

## RRFã ã‘ã§ã¯ä¸ååˆ†ãªç†ç”±ã‚’ç†è§£ã™ã‚‹

RRFã¯é †ä½ã ã‘ã§ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã™ã‚‹ãŸã‚ã€ã‚¹ã‚±ãƒ¼ãƒ«å·®ã‚’å¸åã§ãã‚‹å®‰å®šã—ãŸfusionæ‰‹æ³•ã§ã™ã€‚ã—ã‹ã—ã€**å®Ÿéš›ã®ã‚¹ã‚³ã‚¢å·®ã‚’å®Œå…¨ã«ç„¡è¦–ã™ã‚‹**ã¨ã„ã†ç‰¹æ€§ã¯ã€å ´é¢ã«ã‚ˆã£ã¦ã¯ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã«ãªã‚Šã¾ã™ã€‚

### RRFãŒè¦‹è½ã¨ã™ã‚¹ã‚³ã‚¢å·®ã®å•é¡Œ

æ¬¡ã®ä¾‹ã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚BM25ã§æ–‡æ›¸Aã®ã‚¹ã‚³ã‚¢ãŒ25.3ï¼ˆ1ä½ï¼‰ã€æ–‡æ›¸BãŒ24.8ï¼ˆ2ä½ï¼‰ã ã£ãŸã¨ã—ã¾ã™ã€‚ä¸€æ–¹ã€kNNæ¤œç´¢ã§ã¯æ–‡æ›¸CãŒ0.98ï¼ˆ1ä½ï¼‰ã€æ–‡æ›¸AãŒ0.42ï¼ˆ2ä½ï¼‰ã§ã—ãŸã€‚

RRFã¯é †ä½ã ã‘ã‚’è¦‹ã‚‹ãŸã‚ã€BM25ã§ã®åƒ…å·®ï¼ˆA=25.3 vs B=24.8ï¼‰ã‚‚kNNã§ã®å¤§å·®ï¼ˆC=0.98 vs A=0.42ï¼‰ã‚‚åŒã˜ã€Œ1ä½ vs 2ä½ã€ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚Elasticsearchã®æ¤œè¨¼ã§ã¯ã€ã“ã®ç‰¹æ€§ã«ã‚ˆã‚Š**æœ¬æ¥ä¸Šä½ã§ã‚ã‚‹ã¹ãæ–‡æ›¸ãŒãƒ©ãƒ³ã‚¯è½ã¡ã™ã‚‹ã‚±ãƒ¼ã‚¹ãŒç¢ºèªã•ã‚Œã¦ã„ã¾ã™**ï¼ˆ[Elastic Labs: Linear Retriever](https://www.elastic.co/search-labs/blog/linear-retriever-hybrid-search)ï¼‰ã€‚

### ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã§è¦‹ã‚‹fusionæ‰‹æ³•ã®æ¯”è¼ƒ

[Doug Turnbullæ°ã®WANDSãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯](https://softwaredoug.com/blog/2025/03/13/elasticsearch-hybrid-search-strategies)ã§ã¯ã€Elasticsearchã®7ã¤ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢æˆ¦ç•¥ã‚’æ¯”è¼ƒã—ã¦ã„ã¾ã™ã€‚

| æˆ¦ç•¥ | Mean NDCG | Median NDCG |
|------|-----------|-------------|
| BM25 Cross-fieldsï¼ˆãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼‰ | 0.698 | 0.780 |
| Pure kNN | 0.695 | 0.772 |
| **RRF** | **0.707** | 0.766 |
| Hybrid with filter | 0.709 | 0.780 |
| Hybrid with vector fallback | 0.708 | 0.780 |
| Multi-tierï¼ˆå…¨ã‚¯ã‚¨ãƒªèªä¸€è‡´ãƒ•ã‚£ãƒ«ã‚¿ï¼‰ | 0.719 | 0.805 |
| **Multi-tier + name boost** | **0.750** | **0.842** |

RRFã¯ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‹ã‚‰ã‚ãšã‹+1.3%ã®æ”¹å–„ã«ã¨ã©ã¾ã‚‹ã®ã«å¯¾ã—ã€**æ®µéšçš„å€™è£œé¸åˆ¥ï¼‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ–ãƒ¼ã‚¹ãƒˆ**ã§ã¯+7.4%ã®æ”¹å–„ã‚’é”æˆã—ã¦ã„ã¾ã™ã€‚

**æ³¨æ„ç‚¹:**
> ã“ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã¯ECã‚µã‚¤ãƒˆï¼ˆå®¶å…·ï¼‰ã®å•†å“æ¤œç´¢ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§ã™ã€‚ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚„ã‚¯ã‚¨ãƒªç‰¹æ€§ã«ã‚ˆã£ã¦fusionæ‰‹æ³•ã®æœ‰åŠ¹æ€§ã¯å¤‰ã‚ã‚‹ãŸã‚ã€**è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã§ã®è¨ˆæ¸¬ãŒå¿…é ˆ**ã§ã™ã€‚

## NDCGè¨ˆæ¸¬ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹

æ¤œç´¢å“è³ªã®æ”¹å–„ã«ã¯ã€ã¾ãš**å®šé‡çš„ãªè¨ˆæ¸¬åŸºç›¤**ãŒå¿…è¦ã§ã™ã€‚ranxãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ã€fusionæ‰‹æ³•ã®è‡ªå‹•æ¯”è¼ƒãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### ranxã§æ¤œç´¢è©•ä¾¡ã‚’è‡ªå‹•åŒ–ã™ã‚‹

[ranx](https://github.com/AmenRa/ranx)ã¯25ç¨®é¡ã®fusionã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¨è‡ªå‹•æœ€é©åŒ–æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ã€æƒ…å ±æ¤œç´¢è©•ä¾¡ã®å®šç•ªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚ECIR 2022ã€CIKM 2022ã€SIGIR 2023ã§æ¡æŠã•ã‚ŒãŸå®Ÿç¸¾ãŒã‚ã‚Šã¾ã™ã€‚

```python
# eval_hybrid_search.py
"""ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã®fusionæ‰‹æ³•ã‚’è‡ªå‹•è©•ä¾¡ã™ã‚‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³"""
from ranx import Qrels, Run, compare, fuse, optimize_fusion


def load_qrels(path: str) -> Qrels:
    """äººæ‰‹è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ï¼ˆqrelsï¼‰ã‚’èª­ã¿è¾¼ã‚€ã€‚

    TSVå½¢å¼: query_id, 0, doc_id, relevance (0-3)
    """
    return Qrels.from_file(path, kind="trec")


def load_run(path: str) -> Run:
    """æ¤œç´¢çµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã€‚

    TSVå½¢å¼: query_id, Q0, doc_id, rank, score, run_name
    """
    return Run.from_file(path, kind="trec")


def evaluate_fusion_methods(
    qrels: Qrels,
    bm25_run: Run,
    vector_run: Run,
    metrics: list[str] | None = None,
) -> None:
    """è¤‡æ•°ã®fusionæ‰‹æ³•ã‚’è©•ä¾¡ãƒ»æ¯”è¼ƒã™ã‚‹ã€‚"""
    if metrics is None:
        metrics = ["ndcg@10", "mrr@10", "recall@100"]

    # RRF fusion
    rrf_run = fuse(
        runs=[bm25_run, vector_run],
        norm="min-max",
        method="rrf",
    )
    rrf_run.name = "RRF"

    # CombSUM fusion
    combsum_run = fuse(
        runs=[bm25_run, vector_run],
        norm="min-max",
        method="sum",
    )
    combsum_run.name = "CombSUM"

    # Weighted Sum fusion
    wsum_run = fuse(
        runs=[bm25_run, vector_run],
        norm="min-max",
        method="wsum",
        params={"weights": [0.4, 0.6]},
    )
    wsum_run.name = "WeightedSum(0.4,0.6)"

    # æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
    report = compare(
        qrels=qrels,
        runs=[bm25_run, vector_run, rrf_run, combsum_run, wsum_run],
        metrics=metrics,
        stat_test="student",
    )
    print(report)
```

### fusionæ‰‹æ³•ã®è‡ªå‹•æœ€é©åŒ–

ranxã® `optimize_fusion` ã‚’ä½¿ã†ã¨ã€**ã‚°ãƒªãƒƒãƒ‰ã‚µãƒ¼ãƒã§æœ€é©ãªé‡ã¿ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**ã‚’è‡ªå‹•æ¢ç´¢ã§ãã¾ã™ã€‚

```python
# optimize_fusion_weights.py
"""fusionæ‰‹æ³•ã®æœ€é©ãªé‡ã¿ã‚’ã‚°ãƒªãƒƒãƒ‰ã‚µãƒ¼ãƒã§æ¢ç´¢ã™ã‚‹"""
from ranx import Qrels, Run, fuse, optimize_fusion


def find_optimal_weights(
    train_qrels: Qrels,
    train_bm25: Run,
    train_vector: Run,
    test_bm25: Run,
    test_vector: Run,
) -> Run:
    """è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã§æœ€é©ãªfusionãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¢ç´¢ã—ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã«é©ç”¨ã™ã‚‹ã€‚

    Returns:
        æœ€é©åŒ–ã•ã‚ŒãŸfusionçµæœã®Run
    """
    # è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã§ã‚°ãƒªãƒƒãƒ‰ã‚µãƒ¼ãƒ
    best_params = optimize_fusion(
        qrels=train_qrels,
        runs=[train_bm25, train_vector],
        norm="min-max",
        method="wsum",       # weighted sum
        metric="ndcg@10",    # æœ€é©åŒ–å¯¾è±¡ã®æŒ‡æ¨™
    )
    print(f"æœ€é©ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: {best_params}")
    # ä¾‹: {"weights": [0.35, 0.65]}

    # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã«é©ç”¨
    optimized_run = fuse(
        runs=[test_bm25, test_vector],
        norm="min-max",
        method="wsum",
        params=best_params,
    )
    return optimized_run
```

**ãªãœranxã‚’é¸ã¶ã®ã‹:**
- 25ç¨®é¡ã®fusionæ‰‹æ³•ï¼ˆRRFã€CombSUMã€BordaFuseã€ProbFuseãªã©ï¼‰ã‚’**çµ±ä¸€APIã§æ¯”è¼ƒå¯èƒ½**
- çµ±è¨ˆçš„æœ‰æ„æ€§æ¤œå®šï¼ˆStudent's t-testã€Fisher's randomization testï¼‰ãŒçµ„ã¿è¾¼ã¿
- TREC Evalã¨ã®äº’æ›æ€§æ¤œè¨¼æ¸ˆã¿

**åˆ¶ç´„æ¡ä»¶:**
> ranxã®æœ€é©åŒ–ã«ã¯ãƒ©ãƒ™ãƒ«ä»˜ãè©•ä¾¡ãƒ‡ãƒ¼ã‚¿ï¼ˆqrelsï¼‰ãŒå¿…è¦ã§ã™ã€‚äººæ‰‹ã§50ã€œ100ã‚¯ã‚¨ãƒªåˆ†ã®relevance judgmentï¼ˆ0-3ã®4æ®µéšï¼‰ã‚’ä½œæˆã™ã‚‹ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚Šã¾ã™ã€‚[è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ä½œæˆã®ã‚³ã‚¹ãƒˆã¯1ã‚¯ã‚¨ãƒªã‚ãŸã‚Š10-15åˆ†ãŒç›®å®‰](https://superlinked.com/vectorhub/articles/optimizing-rag-with-hybrid-search-reranking)ã§ã™ã€‚

## OpenSearch/Elasticsearchã®æ­£è¦åŒ–æˆ¦ç•¥ã‚’é¸æŠã™ã‚‹

ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã®ç²¾åº¦ã¯ã€**ã‚¹ã‚³ã‚¢æ­£è¦åŒ–æ‰‹æ³•**ã¨**çµ„ã¿åˆã‚ã›æ–¹å¼**ã®é¸æŠã«å¤§ããä¾å­˜ã—ã¾ã™ã€‚

### OpenSearchã®æ­£è¦åŒ–ãƒ—ãƒ­ã‚»ãƒƒã‚µ

OpenSearchã®hybrid queryã§ã¯ã€`normalization-processor`ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½¿ã£ã¦**BM25ã‚¹ã‚³ã‚¢ã¨kNNã‚¹ã‚³ã‚¢ã‚’æ­£è¦åŒ–ã—ã¦ã‹ã‚‰çµåˆ**ã—ã¾ã™ã€‚

```json
{
  "description": "ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ç”¨æ­£è¦åŒ–ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³",
  "phase_results_processors": [
    {
      "normalization-processor": {
        "normalization": {
          "technique": "l2"
        },
        "combination": {
          "technique": "arithmetic_mean",
          "parameters": {
            "weights": [0.4, 0.6]
          }
        }
      }
    }
  ]
}
```

æ­£è¦åŒ–æ‰‹æ³•ã¨çµ„ã¿åˆã‚ã›æ–¹å¼ã«ã¯ä»¥ä¸‹ã®é¸æŠè‚¢ãŒã‚ã‚Šã¾ã™ã€‚

| æ­£è¦åŒ–æ‰‹æ³• | è¨ˆç®—å¼ | ç‰¹å¾´ |
|-----------|--------|------|
| **min_max** | $(s - s_{min}) / (s_{max} - s_{min})$ | ç›´æ„Ÿçš„ã ãŒå¤–ã‚Œå€¤ã«å¼±ã„ |
| **l2** | $s / \sqrt{\sum s_i^2}$ | å¤–ã‚Œå€¤ã«å¼·ãã€å¤šãã®ã‚±ãƒ¼ã‚¹ã§å®‰å®š |
| **z_score** | $(s - \mu) / \sigma$ | åˆ†å¸ƒã‚’è€ƒæ…®ã€OpenSearch 2.19+ã§å¯¾å¿œ |

| çµ„ã¿åˆã‚ã›æ–¹å¼ | è¨ˆç®—å¼ | ç”¨é€” |
|--------------|--------|------|
| **arithmetic_mean** | $(w_1 s_1 + w_2 s_2) / (w_1 + w_2)$ | æ±ç”¨çš„ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¨å¥¨ |
| **harmonic_mean** | $(w_1 + w_2) / (w_1/s_1 + w_2/s_2)$ | ä½ã‚¹ã‚³ã‚¢ã®æ’é™¤ã«æœ‰åŠ¹ |
| **geometric_mean** | $s_1^{w_1} \cdot s_2^{w_2}$ | ä¸¡æ–¹ã®æ¤œç´¢ã§é«˜ã‚¹ã‚³ã‚¢ã®æ–‡æ›¸ã‚’å„ªé‡ |

OpenSearchãƒãƒ¼ãƒ ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ï¼ˆBEIRãŠã‚ˆã³Amazon ESCIãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼‰ã§ã¯ã€**l2æ­£è¦åŒ– + arithmetic_meanã®çµ„ã¿åˆã‚ã›ãŒå¤šãã®ã‚±ãƒ¼ã‚¹ã§æœ€é©**ã¨å ±å‘Šã•ã‚Œã¦ã„ã¾ã™ï¼ˆ[OpenSearch Blog: Hybrid Search Optimization](https://opensearch.org/blog/hybrid-search-optimization/)ï¼‰ã€‚

### Elasticsearch: Weighted RRF vs Linear Retriever

Elasticsearch 8.18+/9.0+ã§ã¯ã€RRFã«åŠ ãˆã¦**Linear Retriever**ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚

```json
{
  "retriever": {
    "linear": {
      "retrievers": [
        {
          "retriever": {
            "knn": {
              "field": "embedding",
              "query_vector": [0.1, 0.2, 0.3],
              "k": 50
            }
          },
          "weight": 5
        },
        {
          "retriever": {
            "standard": {
              "query": {
                "match": {"content": "ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°"}
              }
            }
          },
          "weight": 1.5,
          "normalizer": "minmax"
        }
      ]
    }
  }
}
```

| ç‰¹æ€§ | RRF | Weighted RRF | Linear Retriever |
|------|-----|-------------|-----------------|
| ã‚¹ã‚³ã‚¢è€ƒæ…® | é †ä½ã®ã¿ | é †ä½ï¼‹é‡ã¿ | **å®Ÿã‚¹ã‚³ã‚¢ï¼‹é‡ã¿** |
| æ­£è¦åŒ– | ä¸è¦ | ä¸è¦ | MinMaxå¿…è¦ |
| ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚° | kå€¤ã®ã¿ | kå€¤ï¼‹é‡ã¿ | **é‡ã¿ï¼‹æ­£è¦åŒ–** |
| é©ç”¨å ´é¢ | æ±ç”¨ | é‡ã¿å·®ãŒå¿…è¦ | ç²¾å¯†ãªã‚¹ã‚³ã‚¢åˆ¶å¾¡ |
| åˆ©ç”¨å¯èƒ½ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | 8.x+ | 8.x+ | **8.18+/9.0+** |

**ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆ**: Linear Retrieverã‚’ä½¿ã†å ´åˆã€**BM25ã®ã‚¹ã‚³ã‚¢ã¯ä¸Šé™ãªã—ï¼ˆ0ã€œæ•°ç™¾ï¼‰** ãªã®ã«å¯¾ã—ã€kNNã®ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ã¯**0ã€œ1ã®ç¯„å›²**ã§ã™ã€‚`normalizer: "minmax"`ã‚’æŒ‡å®šã—ãªã„ã¨ã€BM25ã‚¹ã‚³ã‚¢ãŒæ”¯é…çš„ã«ãªã‚Šãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®çµæœãŒã»ã¼ç„¡è¦–ã•ã‚Œã¾ã™ã€‚

## Learned Sparse Retrievalã§BM25ã‚’è¶…ãˆã‚‹

å¾“æ¥ã®BM25ã¯èªå½™ã®å®Œå…¨ä¸€è‡´ã«ä¾å­˜ã™ã‚‹ãŸã‚ã€ã€Œæ©Ÿæ¢°å­¦ç¿’ã€ã¨ã€ŒMLã€ã®ã‚ˆã†ãªç•¥èªã‚„è¨€ã„æ›ãˆã«å¯¾å¿œã§ãã¾ã›ã‚“ã€‚**Learned Sparse Retrieval**ã¯ã€ã“ã®é™ç•Œã‚’å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã§å…‹æœã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã™ã€‚

### BGE-M3: Dense + Sparse + Multi-vectorã®çµ±åˆãƒ¢ãƒ‡ãƒ«

[BGE-M3](https://huggingface.co/BAAI/bge-m3)ï¼ˆBAAI, 2024ï¼‰ã¯1ã¤ã®ãƒ¢ãƒ‡ãƒ«ã§3ç¨®é¡ã®åŸ‹ã‚è¾¼ã¿ã‚’åŒæ™‚ã«ç”Ÿæˆã§ãã‚‹ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«ãƒªãƒˆãƒªãƒ¼ãƒãƒ«ãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚

```python
# bge_m3_hybrid.py
"""BGE-M3ã§dense + sparseã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã‚’å®Ÿè£…ã™ã‚‹"""
from FlagEmbedding import BGEM3FlagModel

model = BGEM3FlagModel("BAAI/bge-m3", use_fp16=True)

# 3ç¨®é¡ã®åŸ‹ã‚è¾¼ã¿ã‚’åŒæ™‚ç”Ÿæˆ
output = model.encode(
    ["ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ‰‹æ³•"],
    return_dense=True,
    return_sparse=True,
    return_colbert_vecs=True,  # multi-vector (ColBERTå½¢å¼)
)

dense_embedding = output["dense_vecs"]       # shape: (1, 1024)
sparse_embedding = output["lexical_weights"]  # dict[str, float]
colbert_vecs = output["colbert_vecs"]         # shape: (1, seq_len, 1024)

print(f"Denseæ¬¡å…ƒæ•°: {dense_embedding.shape[1]}")
print(f"Sparseéã‚¼ãƒ­è¦ç´ æ•°: {len(sparse_embedding[0])}")
```

BGE-M3ã®sparse embeddingã¯ã€BM25ã®ã‚ˆã†ã«**èªå½™IDã¨é‡ã¿ã®ãƒšã‚¢**ã‚’å‡ºåŠ›ã—ã¾ã™ãŒã€å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ãŒæ–‡è„ˆã‚’è€ƒæ…®ã—ã¦**é‡ã¿ã‚’å‹•çš„ã«èª¿æ•´**ã—ã€**é–¢é€£èªã¸ã®å±•é–‹ï¼ˆterm expansionï¼‰** ã‚‚è¡Œã„ã¾ã™ã€‚

### ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœ

BGE-M3ã®è«–æ–‡ãŠã‚ˆã³Hugging Faceã®ãƒ¢ãƒ‡ãƒ«ã‚«ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ã¨ã€MIRACLãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ï¼ˆ18è¨€èªã®å¤šè¨€èªæ¤œç´¢ã‚¿ã‚¹ã‚¯ï¼‰ã§ä»¥ä¸‹ã®çµæœãŒå ±å‘Šã•ã‚Œã¦ã„ã¾ã™ã€‚

| æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ | MIRACL nDCG@10 |
|-----------|----------------|
| Dense ã®ã¿ | 65.4å‰å¾Œï¼ˆmE5ç›¸å½“ï¼‰ |
| Sparse ã®ã¿ | Dense ã‚’ä¸Šå›ã‚‹ |
| Dense + Sparse | ã•ã‚‰ã«å‘ä¸Š |
| **Dense + Sparse + Multi-vector** | **70.0** |

**MLDRãƒ†ã‚¹ãƒˆã‚»ãƒƒãƒˆ**ï¼ˆ13è¨€èªã®é•·æ–‡æ›¸æ¤œç´¢ï¼‰ã§ã¯ã€sparseæ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ãŒdenseãƒ¢ãƒ¼ãƒ‰ã‚’ç´„10ãƒã‚¤ãƒ³ãƒˆä¸Šå›ã‚Šã€ä¸¡è€…ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã§ã•ã‚‰ã«ç²¾åº¦ãŒå‘ä¸Šã—ãŸã¨å ±å‘Šã•ã‚Œã¦ã„ã¾ã™ï¼ˆ[BGE-M3 HuggingFace](https://huggingface.co/BAAI/bge-m3)ï¼‰ã€‚

**ãªãœBGE-M3ã®sparseãŒBM25ã‚’ä¸Šå›ã‚‹ã®ã‹:**
- BM25ã¯**èªå½™ã®å®Œå…¨ä¸€è‡´**ã®ã¿ã€‚BGE-M3ã®sparseã¯**å­¦ç¿’æ¸ˆã¿term expansion**ã§é–¢é€£èªã‚‚è£œå®Œ
- BM25ã¯TF-IDFçµ±è¨ˆã«åŸºã¥ãå›ºå®šé‡ã¿ã€‚BGE-M3ã¯**æ–‡è„ˆä¾å­˜ã®å‹•çš„ãªé‡ã¿ä»˜ã‘**
- BGE-M3ã¯100ä»¥ä¸Šã®è¨€èªã«å¯¾å¿œã—ã€**å¤šè¨€èªã‚¯ãƒ­ã‚¹ãƒªãƒ³ã‚¬ãƒ«æ¤œç´¢**ãŒå¯èƒ½

**åˆ¶ç´„æ¡ä»¶:**
> BGE-M3ã¯ãƒ¢ãƒ‡ãƒ«ã‚µã‚¤ã‚ºãŒç´„2.3GBï¼ˆFP16æ™‚ç´„1.2GBï¼‰ã§ã€æ¨è«–ã«GPUãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚BM25ã®CPUã®ã¿ãƒ»æ•°mså¿œç­”ã¨æ¯”è¼ƒã™ã‚‹ã¨ã€**ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã¨ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•**ãŒã‚ã‚Šã¾ã™ã€‚äº‹å‰ã«ãƒãƒƒãƒã§embeddingã‚’è¨ˆç®—ã—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«æ ¼ç´ã™ã‚‹é‹ç”¨ãŒä¸€èˆ¬çš„ã§ã™ã€‚

### Milvusã§ã®å®Ÿè£…ä¾‹

BGE-M3ã®dense + sparse embeddingã‚’Milvusã§ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã™ã‚‹æ§‹æˆã‚’ç¤ºã—ã¾ã™ã€‚

```python
# milvus_bge_m3_hybrid.py
"""Milvus 2.4+ã§BGE-M3ã®dense + sparseãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã‚’æ§‹ç¯‰ã™ã‚‹"""
from pymilvus import (
    AnnSearchRequest,
    Collection,
    RRFRanker,
    WeightedRanker,
    connections,
)

connections.connect(host="localhost", port="19530")
collection = Collection("documents")

# Denseæ¤œç´¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
dense_req = AnnSearchRequest(
    data=[dense_query_vec],     # BGE-M3ã®dense embedding
    anns_field="dense_vector",
    param={"metric_type": "IP", "params": {"nprobe": 16}},
    limit=100,
)

# Sparseæ¤œç´¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
sparse_req = AnnSearchRequest(
    data=[sparse_query_vec],    # BGE-M3ã®sparse embedding
    anns_field="sparse_vector",
    param={"metric_type": "IP"},
    limit=100,
)

# RRFã¾ãŸã¯Weighted Rankerã§çµ±åˆ
results = collection.hybrid_search(
    reqs=[dense_req, sparse_req],
    ranker=WeightedRanker(0.6, 0.4),  # dense:sparse = 6:4
    limit=10,
)
```

## PostgreSQLã ã‘ã§å®Œçµã™ã‚‹ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã‚’æ§‹ç¯‰ã™ã‚‹

å¤–éƒ¨ã®æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã‚’é‹ç”¨ã—ãŸããªã„ã‚±ãƒ¼ã‚¹ã§ã¯ã€**ParadeDB + pgvectorã«ã‚ˆã‚‹PostgreSQLãƒã‚¤ãƒ†ã‚£ãƒ–**ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ãŒé¸æŠè‚¢ã«ãªã‚Šã¾ã™ã€‚

### ParadeDBã®BM25 + pgvectorãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰

[ParadeDB](https://www.paradedb.com/blog/hybrid-search-in-postgresql-the-missing-manual)ã®pg_searchæ‹¡å¼µã¯ã€Tantivyï¼ˆRustè£½ã®æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ï¼‰ã‚’PostgreSQLå†…ã«çµ„ã¿è¾¼ã¿ã€BM25ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

```sql
-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
CREATE EXTENSION IF NOT EXISTS pg_search;
CREATE EXTENSION IF NOT EXISTS vector;

-- ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    title TEXT,
    content TEXT,
    embedding vector(1024)  -- BGE-M3ã®dense embedding
);

-- BM25ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE INDEX idx_bm25 ON documents
USING bm25 (
  id,
  title,
  content
)
WITH (key_field=id);

-- HNSWãƒ™ã‚¯ãƒˆãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE INDEX idx_vector ON documents
USING hnsw (embedding vector_cosine_ops);
```

### SQLã ã‘ã§æ›¸ãRRF

```sql
-- ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ï¼ˆRRF fusionï¼‰
WITH
fulltext AS (
    SELECT id, ROW_NUMBER() OVER (
        ORDER BY paradedb.score(id) DESC
    ) AS rank
    FROM documents
    WHERE title ||| 'ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢'
       OR content ||| 'ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢'
    LIMIT 50
),
semantic AS (
    SELECT id, ROW_NUMBER() OVER (
        ORDER BY embedding <=> $query_vector
    ) AS rank
    FROM documents
    ORDER BY embedding <=> $query_vector
    LIMIT 50
),
rrf AS (
    SELECT id, 1.0 / (60 + rank) AS score FROM fulltext
    UNION ALL
    SELECT id, 1.0 / (60 + rank) AS score FROM semantic
)
SELECT d.id, d.title, SUM(rrf.score) AS hybrid_score
FROM rrf
JOIN documents d USING (id)
GROUP BY d.id, d.title
ORDER BY hybrid_score DESC
LIMIT 10;
```

é‡ã¿ã‚’èª¿æ•´ã™ã‚‹å ´åˆã¯ã€å„ã‚µãƒ–ã‚¯ã‚¨ãƒªã®ã‚¹ã‚³ã‚¢ã«ä¿‚æ•°ã‚’æ›ã‘ã¾ã™ã€‚

```sql
-- é‡ã¿ä»˜ãRRFï¼ˆBM25é‡è¦–: 0.7ã€ãƒ™ã‚¯ãƒˆãƒ«: 0.3ï¼‰
rrf AS (
    SELECT id, 0.7 / (60 + rank) AS score FROM fulltext
    UNION ALL
    SELECT id, 0.3 / (60 + rank) AS score FROM semantic
)
```

**ãªãœParadeDBã‚’é¸ã¶ã®ã‹:**
- æ—¢å­˜ã®PostgreSQLã‚¤ãƒ³ãƒ•ãƒ©ã§**è¿½åŠ ã®æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ä¸è¦**
- ACIDãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¿è¨¼ã®ã‚‚ã¨ã§æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæ›´æ–°ã•ã‚Œã‚‹
- SQLã§å…¨ãƒ­ã‚¸ãƒƒã‚¯ãŒè¨˜è¿°ã§ãã‚‹ãŸã‚ã€**ãƒ‡ãƒãƒƒã‚°ãƒ»ç›£æŸ»ãŒå®¹æ˜“**

**åˆ¶ç´„æ¡ä»¶:**
> ParadeDBã®BM25ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ã€Elasticsearchã¨æ¯”è¼ƒã—ã¦**åˆ†æ•£ã‚·ãƒ£ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã›ã‚“**ï¼ˆCitusã¨ã®ä½µç”¨ã§å¯¾å¿œå¯èƒ½ï¼‰ã€‚æ•°ç™¾ä¸‡ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¦æ¨¡ã¾ã§ã¯PostgreSQLã®å˜ä¸€ãƒãƒ¼ãƒ‰ã§å¯¾å¿œå¯èƒ½ã§ã™ãŒã€ãã‚Œä»¥ä¸Šã®ã‚¹ã‚±ãƒ¼ãƒ«ã§ã¯å°‚ç”¨ã®æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ãŒå¿…è¦ã§ã™ã€‚

## ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

| å•é¡Œ | åŸå›  | è§£æ±ºæ–¹æ³• |
|------|------|----------|
| ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã§BM25å˜ä½“ã‚ˆã‚Šç²¾åº¦ãŒä¸‹ãŒã£ãŸ | ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®ãƒã‚¤ã‚ºãŒæ··å…¥ | ranxã§å„æ‰‹æ³•ã®NDCG@10ã‚’å€‹åˆ¥è¨ˆæ¸¬ã—ã€ç‰‡æ–¹ã‚’é™¤å¤–ã™ã¹ãã‹åˆ¤æ–­ |
| é‡ã¿ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãŒå®‰å®šã—ãªã„ | è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„ï¼ˆ<30ã‚¯ã‚¨ãƒªï¼‰ | æœ€ä½50ã‚¯ã‚¨ãƒªåˆ†ã®qrelsã‚’ç”¨æ„ã€ã‚¯ãƒ­ã‚¹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§å®‰å®šæ€§ç¢ºèª |
| æ—¥æœ¬èªBM25ã®ç²¾åº¦ãŒä½ã„ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãŒä¸é©åˆ‡ | Sudachi/MeCabã‚’é©ç”¨ã€OpenSearchã§ã¯analysis-kuromoji |
| Linear Retrieverã§ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ãŒç„¡è¦–ã•ã‚Œã‚‹ | BM25ã‚¹ã‚³ã‚¢ã®ã‚¹ã‚±ãƒ¼ãƒ«ãŒæ”¯é…çš„ | `normalizer: "minmax"` ã‚’å¿…ãšè¨­å®š |
| BGE-M3ã®æ¨è«–ãŒé…ã„ | GPUæœªä½¿ç”¨ or ãƒãƒƒãƒã‚µã‚¤ã‚ºãŒå°ã•ã„ | FP16 + ãƒãƒƒãƒã‚µã‚¤ã‚º32ä»¥ä¸Šã§æ¨è«–ã€äº‹å‰è¨ˆç®—ã—ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ ¼ç´ |
| RRFã® k å€¤ã‚’ã©ã†è¨­å®šã™ã¹ãã‹ã‚ã‹ã‚‰ãªã„ | k=60ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ãŒæœ€é©ã§ãªã„å ´åˆãŒã‚ã‚‹ | ranxã®`optimize_fusion`ã§kå€¤ã‚‚å«ã‚ã¦ã‚°ãƒªãƒƒãƒ‰ã‚µãƒ¼ãƒ |

## ã¾ã¨ã‚ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

**ã¾ã¨ã‚:**
- RRFã¯å®‰å®šã—ãŸãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã ãŒã€WANDSãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã§ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«**å¿…ãšã—ã‚‚æœ€é©è§£ã§ã¯ãªã„**ï¼ˆNDCG@10: RRF 0.707 vs multi-tier 0.750ï¼‰
- æ¤œç´¢ç²¾åº¦ã®æ”¹å–„ã«ã¯**NDCG@10/MRRã®å®šé‡è¨ˆæ¸¬ãŒå¿…é ˆ**ã€‚ranxãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§25ç¨®é¡ã®fusionæ‰‹æ³•ã‚’çµ±ä¸€APIã§æ¯”è¼ƒå¯èƒ½
- OpenSearchã§ã¯**l2æ­£è¦åŒ– + arithmetic_mean**ãŒå¤šãã®ã‚±ãƒ¼ã‚¹ã§å®‰å®šã€Elasticsearchã§ã¯8.18+ã®Linear RetrieverãŒã‚¹ã‚³ã‚¢å·®ã‚’ä¿æŒã—ãŸç²¾å¯†ãªåˆ¶å¾¡ã‚’æä¾›
- BGE-M3ã®Learned Sparse Retrievalã¯ã€MIRACL nDCG@10 = 70.0ã‚’é”æˆã—ã€**å¾“æ¥BM25ã‚’å…¨è¨€èªã§ä¸Šå›ã‚‹**
- ParadeDB + pgvectorã«ã‚ˆã‚Šã€**PostgreSQLã ã‘ã§å®Œçµã™ã‚‹**ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã‚‚å®Ÿç”¨æ®µéš

**æ¬¡ã«ã‚„ã‚‹ã¹ãã“ã¨:**
- è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã§50ã€œ100ã‚¯ã‚¨ãƒªåˆ†ã®relevance judgmentã‚’ä½œæˆã—ã€NDCG@10ã®ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚’è¨ˆæ¸¬ã™ã‚‹
- ranxã®`optimize_fusion`ã§æœ€é©ãªfusionæ‰‹æ³•ã¨é‡ã¿ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¢ç´¢ã™ã‚‹
- BGE-M3ã®sparse embeddingã‚’æ—¢å­˜ã®BM25ã¨æ¯”è¼ƒã—ã€ç²¾åº¦å‘ä¸ŠãŒè¦‹è¾¼ã‚ã‚‹ã‹æ¤œè¨¼ã™ã‚‹

**é–¢é€£è¨˜äº‹:**
- [BM25Ã—ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å®Ÿè£…ï¼šRRFã§æ¤œç´¢ç²¾åº¦ã‚’30%å‘ä¸Šã•ã›ã‚‹å®Ÿè·µã‚¬ã‚¤ãƒ‰](https://zenn.dev/0h_n0/articles/f3d8b80351ae7b)
- [RAGæ¤œç´¢ã®æœ¬ç•ªé‹ç”¨ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°](https://zenn.dev/0h_n0/articles/9a6d917f2ddad4)

## å‚è€ƒ

- [Elasticsearch Hybrid Search Recipes - Benchmarked](https://softwaredoug.com/blog/2025/03/13/elasticsearch-hybrid-search-strategies)
- [Elastic: Weighted Reciprocal Rank Fusion](https://www.elastic.co/search-labs/blog/weighted-reciprocal-rank-fusion-rrf)
- [Elastic: Linear Retriever for Hybrid Search](https://www.elastic.co/search-labs/blog/linear-retriever-hybrid-search)
- [OpenSearch: Optimizing Hybrid Search](https://opensearch.org/blog/hybrid-search-optimization/)
- [ParadeDB: Hybrid Search in PostgreSQL](https://www.paradedb.com/blog/hybrid-search-in-postgresql-the-missing-manual)
- [BGE-M3 - Hugging Face](https://huggingface.co/BAAI/bge-m3)
- [ranx: Ranking Evaluation and Fusion](https://github.com/AmenRa/ranx)
- [Optimizing RAG with Hybrid Search & Reranking - VectorHub](https://superlinked.com/vectorhub/articles/optimizing-rag-with-hybrid-search-reranking)

---

:::message
ã“ã®è¨˜äº‹ã¯AIï¼ˆClaude Codeï¼‰ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å†…å®¹ã®æ­£ç¢ºæ€§ã«ã¤ã„ã¦ã¯è¤‡æ•°ã®æƒ…å ±æºã§æ¤œè¨¼ã—ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã®åˆ©ç”¨æ™‚ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚ã”ç¢ºèªãã ã•ã„ã€‚
:::
