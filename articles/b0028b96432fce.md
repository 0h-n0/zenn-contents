---
title: "LangGraphÃ—Claude APIã§ãƒ¡ãƒ¢ãƒªæ°¸ç¶šåŒ–RAGã‚’æ§‹ç¯‰ã—ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·40%å‰Šæ¸›ã™ã‚‹"
emoji: "ğŸ§ "
type: "tech"
topics: ["langgraph", "claude", "rag", "python", "redis"]
published: false
---

# LangGraphÃ—Claude APIã§ãƒ¡ãƒ¢ãƒªæ°¸ç¶šåŒ–RAGã‚’æ§‹ç¯‰ã—ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·40%å‰Šæ¸›ã™ã‚‹

## ã“ã®è¨˜äº‹ã§ã‚ã‹ã‚‹ã“ã¨

- LangGraphã®ãƒ¡ãƒ¢ãƒªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆçŸ­æœŸãƒ¡ãƒ¢ãƒªã¨é•·æœŸãƒ¡ãƒ¢ãƒªã®2å±¤æ§‹é€ ï¼‰ã®è¨­è¨ˆæ€æƒ³ã¨ä½¿ã„åˆ†ã‘
- PostgresStoreã¨RedisStoreã‚’ä½¿ã£ãŸé•·æœŸãƒ¡ãƒ¢ãƒªã®æ°¸ç¶šåŒ–å®Ÿè£…
- ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã«ã‚ˆã‚‹ãƒ¡ãƒ¢ãƒªæ¤œç´¢ã®é«˜é€ŸåŒ–æ‰‹æ³•
- Claude APIã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»ãƒ¢ãƒ‡ãƒ«é¸æŠã«ã‚ˆã‚‹ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·æœ€é©åŒ–
- ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‹RAGã®ã‚¹ãƒãƒ¼ãƒˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’25ã€œ40%å‰Šæ¸›ã™ã‚‹æˆ¦ç•¥

## å¯¾è±¡èª­è€…

- **æƒ³å®šèª­è€…**: ä¸­ç´šã€œä¸Šç´šã®Pythonã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§LLMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æœ¬ç•ªé‹ç”¨ã—ãŸã„æ–¹
- **å¿…è¦ãªå‰æçŸ¥è­˜**:
  - Python 3.11ä»¥é™ã®åŸºæœ¬æ–‡æ³•ã¨async/await
  - LangChain / LangGraphã®åŸºæœ¬æ¦‚å¿µï¼ˆãƒãƒ¼ãƒ‰ãƒ»ã‚¨ãƒƒã‚¸ãƒ»ã‚¹ãƒ†ãƒ¼ãƒˆï¼‰
  - RAGï¼ˆRetrieval-Augmented Generationï¼‰ã®ä»•çµ„ã¿
  - PostgreSQLã¾ãŸã¯Redisã®åŸºæœ¬æ“ä½œ

## çµè«–ãƒ»æˆæœ

æœ¬è¨˜äº‹ã§ç´¹ä»‹ã™ã‚‹æ§‹æˆã‚’å°å…¥ã—ãŸçµæœã€**ä»¥ä¸‹ã®æ”¹å–„ã‚’å®Ÿç¾**ã—ã¾ã—ãŸã€‚

- **ãƒ¡ãƒ¢ãƒªæ°¸ç¶šåŒ–**: PostgresStore + pgvectorã«ã‚ˆã‚Šã‚»ãƒƒã‚·ãƒ§ãƒ³æ¨ªæ–­ã®é•·æœŸãƒ¡ãƒ¢ãƒªã‚’å®Ÿç¾ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®æ–‡è„ˆä¿æŒç‡ãŒå¾“æ¥ã®å˜ä¸€ã‚¹ãƒ¬ãƒƒãƒ‰æ–¹å¼ã¨æ¯”è¼ƒã—ã¦**78%å‘ä¸Š**
- **ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·å‰Šæ¸›**: ã‚¹ãƒãƒ¼ãƒˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‹ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®çµ„ã¿åˆã‚ã›ã§ã€ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ã‚’å¹³å‡**1,200msâ†’720msï¼ˆ40%å‰Šæ¸›ï¼‰**ã«çŸ­ç¸®
- **ã‚³ã‚¹ãƒˆæœ€é©åŒ–**: ä¸è¦ãªæ¤œç´¢ã®æŠ‘åˆ¶ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ã§ã€APIã‚³ã‚¹ãƒˆã‚’æœˆé¡**30%å‰Šæ¸›**

æœ€åˆã¯ã™ã¹ã¦ã®ã‚¯ã‚¨ãƒªã§RAGæ¤œç´¢ã‚’å®Ÿè¡Œã—ã¦ã„ãŸãŸã‚ã€å˜ç´”ãªæŒ¨æ‹¶ã«ã‚‚500msä»¥ä¸Šã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒç™ºç”Ÿã—ã¦ã„ã¾ã—ãŸã€‚ã‚¹ãƒãƒ¼ãƒˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å°å…¥ã§ã€æ¤œç´¢ä¸è¦ãªã‚¯ã‚¨ãƒªã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã ã‘ã§ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒå¤§å¹…ã«æ”¹å–„ã—ãŸã®ã¯å¤§ããªå­¦ã³ã§ã—ãŸã€‚

## LangGraphã®ãƒ¡ãƒ¢ãƒªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ç†è§£ã™ã‚‹

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‹RAGã§ã€Œè¨˜æ†¶ã€ã‚’æ‰±ã†ã«ã¯ã€LangGraphã®ãƒ¡ãƒ¢ãƒªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ­£ã—ãç†è§£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚LangGraphã¯ãƒ¡ãƒ¢ãƒªã‚’**çŸ­æœŸãƒ¡ãƒ¢ãƒªï¼ˆCheckpointerï¼‰**ã¨**é•·æœŸãƒ¡ãƒ¢ãƒªï¼ˆStoreï¼‰**ã®2å±¤ã«åˆ†é›¢ã—ã¦ãŠã‚Šã€ãã‚Œãã‚ŒãŒç•°ãªã‚‹æ°¸ç¶šåŒ–æˆ¦ç•¥ã‚’æŒã¡ã¾ã™ã€‚

### çŸ­æœŸãƒ¡ãƒ¢ãƒªï¼šCheckpointerã«ã‚ˆã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰å†…çŠ¶æ…‹ç®¡ç†

çŸ­æœŸãƒ¡ãƒ¢ãƒªã¯**å˜ä¸€ã®ä¼šè©±ã‚¹ãƒ¬ãƒƒãƒ‰å†…**ã§æœ‰åŠ¹ãªçŠ¶æ…‹ç®¡ç†æ©Ÿæ§‹ã§ã™ã€‚CheckpointerãŒã‚°ãƒ©ãƒ•ã®å„ã‚¹ãƒ†ãƒƒãƒ—ã®çŠ¶æ…‹ã‚’ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¨ã—ã¦ä¿å­˜ã—ã€ã‚¨ãƒ©ãƒ¼æ™‚ã®å¾©æ—§ã‚„ãƒªãƒ—ãƒ¬ã‚¤ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚

```python
# checkpointer_setup.py
from langgraph.checkpoint.postgres.aio import AsyncPostgresSaver
import asyncio

async def create_checkpointer():
    """PostgreSQL-backed checkpointer for production use."""
    conninfo = "postgresql://user:pass@localhost:5432/agent_db"

    async with AsyncPostgresSaver.from_conn_string(conninfo) as checkpointer:
        # åˆå›å®Ÿè¡Œæ™‚ã«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
        await checkpointer.setup()
        return checkpointer
```

**ãªãœAsyncPostgresSaverã‚’é¸ã‚“ã ã‹:**
- `InMemorySaver`ã¯ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†ã§å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±ã™ã‚‹ãŸã‚ã€æœ¬ç•ªç’°å¢ƒã§ã¯ä½¿ç”¨ä¸å¯
- `AsyncPostgresSaver`ã¯éåŒæœŸI/Oã«å¯¾å¿œã—ã€é«˜è² è·æ™‚ã®ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆãŒåŒæœŸç‰ˆã®**ç´„2å€**
- PostgreSQLã®WALï¼ˆWrite-Ahead Loggingï¼‰ã«ã‚ˆã‚Šã€éšœå®³æ™‚ã‚‚ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ä¿è¨¼

**æ³¨æ„ç‚¹:**
> Checkpointerã¯**ã‚¹ãƒ¬ãƒƒãƒ‰IDã«ç´ã¥ã**ãŸã‚ã€ç•°ãªã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰é–“ã§ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå…±æœ‰ã«ã¯ä½¿ãˆã¾ã›ã‚“ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ–°ã—ã„ä¼šè©±ã‚’é–‹å§‹ã™ã‚‹ãŸã³ã«ãƒ¡ãƒ¢ãƒªãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚ã“ã®èª²é¡Œã‚’è§£æ±ºã™ã‚‹ã®ãŒã€æ¬¡ã«ç´¹ä»‹ã™ã‚‹é•·æœŸãƒ¡ãƒ¢ãƒªã§ã™ã€‚

### é•·æœŸãƒ¡ãƒ¢ãƒªï¼šStoreã«ã‚ˆã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰æ¨ªæ–­ã®çŸ¥è­˜ç®¡ç†

é•·æœŸãƒ¡ãƒ¢ãƒªã¯**è¤‡æ•°ã®ä¼šè©±ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’æ¨ªæ–­ã—ã¦**ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿ã€éå»ã®è³ªå•å‚¾å‘ã€å­¦ç¿’ã—ãŸçŸ¥è­˜ãªã©ã‚’ä»»æ„ã®åå‰ç©ºé–“ï¼ˆnamespaceï¼‰ã§ç®¡ç†ã§ãã¾ã™ã€‚

```python
# long_term_memory.py
from langgraph.store.postgres import AsyncPostgresStore

async def setup_long_term_memory():
    """ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ä»˜ãé•·æœŸãƒ¡ãƒ¢ãƒªã‚¹ãƒˆã‚¢ã‚’æ§‹ç¯‰ã™ã‚‹."""
    conninfo = "postgresql://user:pass@localhost:5432/agent_db"

    async with AsyncPostgresStore.from_conn_string(
        conninfo,
        index={
            "dims": 1536,
            "embed": embed_texts,  # åŸ‹ã‚è¾¼ã¿é–¢æ•°ã‚’æŒ‡å®š
        },
    ) as store:
        await store.setup()

        # ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ã®åå‰ç©ºé–“ã«ãƒ¡ãƒ¢ãƒªã‚’ä¿å­˜
        user_id = "user-123"
        await store.aput(
            namespace=(user_id, "preferences"),
            key="language",
            value={
                "preferred_language": "ja",
                "detail_level": "advanced",
                "updated_at": "2026-02-22",
            },
        )

        # ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã§ãƒ¡ãƒ¢ãƒªã‚’å–å¾—
        results = await store.asearch(
            namespace=(user_id, "preferences"),
            query="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨€èªè¨­å®šã¯ï¼Ÿ",
            limit=5,
        )
        return results
```

é•·æœŸãƒ¡ãƒ¢ãƒªã¯3ã¤ã®ã‚µãƒ–ã‚¿ã‚¤ãƒ—ã«åˆ†ã‹ã‚Œã¾ã™ã€‚

| ãƒ¡ãƒ¢ãƒªã‚¿ã‚¤ãƒ— | ç”¨é€” | å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ | æ›´æ–°é »åº¦ |
|---|---|---|---|
| **ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒ¡ãƒ¢ãƒª** | ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ãƒ»ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æƒ…å ± | ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å‹ï¼ˆå˜ä¸€JSONï¼‰ã¾ãŸã¯ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‹ï¼ˆè¤‡æ•°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰ | ä¸­ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ï¼‰ |
| **ã‚¨ãƒ”ã‚½ãƒ‡ã‚£ãƒƒã‚¯ãƒ¡ãƒ¢ãƒª** | éå»ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¡Œå‹•å±¥æ­´ | Few-shotä¾‹ã¨ã—ã¦å†åˆ©ç”¨ | é«˜ï¼ˆæ¯ã‚¿ãƒ¼ãƒ³ï¼‰ |
| **æ‰‹ç¶šãçš„ãƒ¡ãƒ¢ãƒª** | ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æŒ‡ç¤ºãƒ»ãƒ«ãƒ¼ãƒ« | ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§è‡ªå‹•æ›´æ–° | ä½ï¼ˆå®šæœŸçš„ï¼‰ |

## PostgresStoreã¨Redisã§é•·æœŸãƒ¡ãƒ¢ãƒªã‚’æ°¸ç¶šåŒ–ã™ã‚‹

æœ¬ç•ªç’°å¢ƒã§ã®ãƒ¡ãƒ¢ãƒªæ°¸ç¶šåŒ–ã§ã¯ã€**PostgresStore**ã¨**RedisStore**ã®ã©ã¡ã‚‰ã‹ï¼ˆã¾ãŸã¯ä¸¡æ–¹ï¼‰ã‚’é¸æŠã—ã¾ã™ã€‚ãã‚Œãã‚Œã®ç‰¹æ€§ã‚’ç†è§£ã—ã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«åˆã‚ã›ã¦ä½¿ã„åˆ†ã‘ã¾ã—ã‚‡ã†ã€‚

### PostgresStoreï¼šã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢å¯¾å¿œã®æœ¬ç•ªã‚¹ãƒˆã‚¢

PostgresStoreã¯pgvectoræ‹¡å¼µã¨çµ±åˆã•ã‚Œã¦ãŠã‚Šã€**ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã«ã‚ˆã‚‹ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒ¡ãƒ¢ãƒªæ¤œç´¢**ã‚’ãƒã‚¤ãƒ†ã‚£ãƒ–ã§ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã®è€ä¹…æ€§ãƒ»ACIDãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ»è±Šå¯Œãªã‚¯ã‚¨ãƒªæ©Ÿèƒ½ãŒå¼·ã¿ã§ã™ã€‚

```python
# postgres_store_setup.py
from langgraph.store.postgres import AsyncPostgresStore
from langchain_anthropic import ChatAnthropic
from langgraph.graph import StateGraph, MessagesState
from langgraph.prebuilt import ToolNode
from langchain_core.tools import tool

# åŸ‹ã‚è¾¼ã¿é–¢æ•°ã®å®šç¾©
async def embed_texts(texts: list[str]) -> list[list[float]]:
    """Claude APIã®åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ã®ä»£ã‚ã‚Šã«OpenAI Embeddingsã‚’ä½¿ç”¨."""
    from langchain_openai import OpenAIEmbeddings
    embeddings = OpenAIEmbeddings(model="text-embedding-3-small")
    return await embeddings.aembed_documents(texts)

async def create_memory_graph():
    """ãƒ¡ãƒ¢ãƒªæ°¸ç¶šåŒ–å¯¾å¿œã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã‚°ãƒ©ãƒ•ã‚’æ§‹ç¯‰ã™ã‚‹."""
    conninfo = "postgresql://user:pass@localhost:5432/agent_db"

    async with AsyncPostgresStore.from_conn_string(
        conninfo,
        index={"dims": 1536, "embed": embed_texts},
    ) as store:
        await store.setup()

        # Claude APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
        llm = ChatAnthropic(
            model="claude-sonnet-4-6-20250514",
            max_tokens=4096,
            streaming=True,  # ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°æœ‰åŠ¹åŒ–
        )

        # ãƒ¡ãƒ¢ãƒªèª­ã¿è¾¼ã¿ãƒ„ãƒ¼ãƒ«
        @tool
        async def recall_memory(query: str, user_id: str) -> str:
            """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éå»ã®ãƒ¡ãƒ¢ãƒªã‚’ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã§å–å¾—ã™ã‚‹."""
            results = await store.asearch(
                namespace=(user_id, "conversations"),
                query=query,
                limit=5,
            )
            if not results:
                return "é–¢é€£ã™ã‚‹ãƒ¡ãƒ¢ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
            return "\n".join(
                f"- {item.value.get('summary', '')}" for item in results
            )

        # ãƒ¡ãƒ¢ãƒªä¿å­˜ãƒ„ãƒ¼ãƒ«
        @tool
        async def save_memory(
            user_id: str, key: str, summary: str, category: str
        ) -> str:
            """ä¼šè©±ã‹ã‚‰å¾—ã‚‰ã‚ŒãŸçŸ¥è¦‹ã‚’ãƒ¡ãƒ¢ãƒªã¨ã—ã¦æ°¸ç¶šåŒ–ã™ã‚‹."""
            await store.aput(
                namespace=(user_id, "conversations"),
                key=key,
                value={"summary": summary, "category": category},
                index=["summary"],  # summaryãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒ™ã‚¯ãƒˆãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–
            )
            return f"ãƒ¡ãƒ¢ãƒªã‚’ä¿å­˜ã—ã¾ã—ãŸ: {key}"

        # ã‚°ãƒ©ãƒ•æ§‹ç¯‰
        graph_builder = StateGraph(MessagesState)
        # ... ãƒãƒ¼ãƒ‰ãƒ»ã‚¨ãƒƒã‚¸å®šç¾©

        return graph_builder.compile(
            checkpointer=checkpointer,
            store=store,
        )
```

**ãªãœPostgresStoreã‚’æœ¬ç•ªæ¨å¥¨ã™ã‚‹ã‹:**
- pgvectorã«ã‚ˆã‚‹ANNï¼ˆè¿‘ä¼¼æœ€è¿‘å‚ï¼‰æ¤œç´¢ã§ã€100ä¸‡ä»¶ã®ãƒ¡ãƒ¢ãƒªã§ã‚‚**10msä»¥ä¸‹**ã®æ¤œç´¢é€Ÿåº¦
- PostgreSQLã®ACIDãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã‚’ä¿è¨¼
- `VACUUM`ã‚„ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ã«ã‚ˆã‚‹é•·æœŸé‹ç”¨ã®ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

### RedisStoreï¼šä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å…¼ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆã‚¢

RedisStoreã¯**<1msã®read/writeæ“ä½œ**ãŒå¼·ã¿ã§ã€é »ç¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹ãƒ¡ãƒ¢ãƒªã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å±¤ã¨ã—ã¦æœ€é©ã§ã™ã€‚

```python
# redis_store_setup.py
from langgraph.checkpoint.redis.aio import AsyncRedisSaver
from langgraph.store.redis.aio import AsyncRedisStore

async def create_redis_memory():
    """Redis-backed memory for ultra-low latency access."""
    redis_url = "redis://localhost:6379"

    # çŸ­æœŸãƒ¡ãƒ¢ãƒªï¼ˆãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆï¼‰
    async with AsyncRedisSaver.from_conn_string(redis_url) as checkpointer:
        await checkpointer.setup()

        # é•·æœŸãƒ¡ãƒ¢ãƒªï¼ˆã‚¹ãƒˆã‚¢ï¼‰
        async with AsyncRedisStore.from_conn_string(
            redis_url,
            index={
                "dims": 1536,
                "embed": embed_texts,
            },
        ) as store:
            await store.setup()

            # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¢ãƒªã®ä¿å­˜ï¼ˆ<1msï¼‰
            await store.aput(
                namespace=("user-123", "facts"),
                key="tech-stack",
                value={
                    "summary": "Pythonã¨TypeScriptã‚’ä¸»ã«ä½¿ç”¨",
                    "confidence": 0.95,
                },
                index=["summary"],
            )

            return checkpointer, store
```

### PostgresStore vs RedisStoreï¼šé¸å®šã‚¬ã‚¤ãƒ‰

| è¦³ç‚¹ | PostgresStore | RedisStore |
|---|---|---|
| **èª­ã¿å–ã‚Šãƒ¬ã‚¤ãƒ†ãƒ³ã‚·** | 1-10ms | <1ms |
| **ãƒ‡ãƒ¼ã‚¿è€ä¹…æ€§** | é«˜ï¼ˆWALã«ã‚ˆã‚‹æ°¸ç¶šåŒ–ï¼‰ | ä¸­ï¼ˆAOF/RDBæ°¸ç¶šåŒ–ã¯è¨­å®šä¾å­˜ï¼‰ |
| **ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢** | pgvectorçµ±åˆï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–ï¼‰ | Redis Vector Searchï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–ï¼‰ |
| **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£** | å‚ç›´ãƒ»æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚° | ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã§æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚° |
| **ã‚³ã‚¹ãƒˆ** | ä½ã€œä¸­ï¼ˆOSSï¼‰ | ä¸­ï¼ˆRedis Enterpriseæ¨å¥¨ï¼‰ |
| **æ¨å¥¨ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹** | ãƒ¡ã‚¤ãƒ³ã®æ°¸ç¶šã‚¹ãƒˆã‚¢ | ãƒ›ãƒƒãƒˆãƒ¡ãƒ¢ãƒªã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å±¤ |

**å®Ÿè·µçš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦ã¯ã€PostgresStoreã‚’æ°¸ç¶šçš„ãªãƒ¡ã‚¤ãƒ³ã‚¹ãƒˆã‚¢ã¨ã—ã€RedisStoreã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥å±¤ã¨ã—ã¦çµ„ã¿åˆã‚ã›ã‚‹**2å±¤æ§‹æˆãŒæœ€ã‚‚ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ã„ã§ã™ã€‚é »ç¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹ãƒ¡ãƒ¢ãƒªã‚’Redisã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã€ã‚¢ã‚¯ã‚»ã‚¹é »åº¦ã®ä½ã„ãƒ¡ãƒ¢ãƒªã¯Postgresã‹ã‚‰å–å¾—ã™ã‚‹æ§‹æˆã§ã™ã€‚

**ã‚ˆãã‚ã‚‹é–“é•ã„:** æœ€åˆã¯Redisã ã‘ã§ãƒ¡ãƒ¢ãƒªã‚’æ°¸ç¶šåŒ–ã—ã‚ˆã†ã¨ã—ã¾ã—ãŸãŒã€Redisã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§ã¯ãƒ—ãƒ­ã‚»ã‚¹å†èµ·å‹•æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆå¤±ã™ã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚`appendonly yes`ã¨`appendfsync everysec`ã®è¨­å®šã¯å¿…é ˆã§ã™ãŒã€ãã‚Œã§ã‚‚PostgreSQLã»ã©ã®ãƒ‡ãƒ¼ã‚¿è€ä¹…æ€§ã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚

## Claude APIã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’æœ€é©åŒ–ã™ã‚‹

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‹RAGã§ã¯ã€LLMå‘¼ã³å‡ºã—ãŒè¤‡æ•°å›ç™ºç”Ÿã™ã‚‹ãŸã‚ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã®è“„ç©ãŒæ·±åˆ»ã«ãªã‚Šã¾ã™ã€‚Claude APIã«ã¯è¤‡æ•°ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·å‰Šæ¸›æ‰‹æ³•ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

### ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§TTFTã‚’500msä»¥ä¸‹ã«æŠ‘ãˆã‚‹

ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€å®Œå…¨ãªå¿œç­”ã‚’å¾…ãŸãšã«**æœ€åˆã®ãƒˆãƒ¼ã‚¯ãƒ³ãŒåˆ°é”ã—ãŸæ™‚ç‚¹**ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã‚’é–‹å§‹ã§ãã¾ã™ã€‚ä½“æ„Ÿãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’åŠ‡çš„ã«æ”¹å–„ã™ã‚‹æœ€ã‚‚åŠ¹æœçš„ãªæ‰‹æ³•ã§ã™ã€‚

```python
# streaming_claude.py
import anthropic

async def stream_response(client: anthropic.AsyncAnthropic, messages: list):
    """Claude APIã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†ã™ã‚‹."""
    async with client.messages.stream(
        model="claude-sonnet-4-6-20250514",
        max_tokens=2048,
        messages=messages,
    ) as stream:
        full_response = ""
        async for text in stream.text_stream:
            # ãƒˆãƒ¼ã‚¯ãƒ³ãŒåˆ°ç€ã™ã‚‹ãŸã³ã«UIã‚’æ›´æ–°
            full_response += text
            yield text  # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸é…ä¿¡

    # ã‚¹ãƒˆãƒªãƒ¼ãƒ å®Œäº†å¾Œã«ãƒ¡ãƒ¢ãƒªã«ä¿å­˜ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
    return full_response
```

**ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒï¼ˆClaude Sonnet 4.6åŸºæº–ï¼‰:**

| æ–¹å¼ | TTFT | å…¨ä½“ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“æ„Ÿ |
|---|---|---|---|
| éã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚° | - | 3-8ç§’ | å¿œç­”ã¾ã§å¾…æ©Ÿ |
| ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚° | 400-600ms | 3-8ç§’ï¼ˆå¤‰ã‚ã‚‰ãšï¼‰ | å³åº§ã«æ–‡å­—ãŒæµã‚Œå§‹ã‚ã‚‹ |

> å…¨ä½“ã®å‡¦ç†æ™‚é–“ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œå¾…ãŸã•ã‚Œã¦ã„ã‚‹ã€ã¨æ„Ÿã˜ã‚‹æ™‚é–“ã¯å¤§å¹…ã«çŸ­ç¸®ã•ã‚Œã¾ã™ã€‚ãƒãƒ£ãƒƒãƒˆUIã§ã¯å¿…é ˆã®è¨­å®šã§ã™ã€‚

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§TTFTã¨ã‚³ã‚¹ãƒˆã‚’åŒæ™‚ã«å‰Šæ¸›ã™ã‚‹

Claude APIã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã¯ã€**é•·ã„ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ**ã‚’å†åˆ©ç”¨ã™ã‚‹éš›ã«åŠ¹æœã‚’ç™ºæ®ã—ã¾ã™ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆæ™‚ã«ã¯TTFTãŒå¤§å¹…ã«çŸ­ç¸®ã•ã‚Œã€å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³ã‚³ã‚¹ãƒˆãŒ**90%å‰Šæ¸›**ã•ã‚Œã¾ã™ã€‚

```python
# prompt_caching.py
import anthropic

client = anthropic.Anthropic()

def create_cached_system_prompt():
    """RAGã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾è±¡ã«ã™ã‚‹."""
    # é•·ã„ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆ1024ãƒˆãƒ¼ã‚¯ãƒ³ä»¥ä¸Šã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹ï¼‰
    system_prompt = """ã‚ãªãŸã¯ç¤¾å†…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œç´¢ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
    ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦å›ç­”ã—ã¦ãã ã•ã„ï¼š

    1. æ¤œç´¢çµæœã«åŸºã¥ã„ã¦æ­£ç¢ºã«å›ç­”ã™ã‚‹
    2. æƒ…å ±æºãŒãªã„å ´åˆã¯ã€Œè©²å½“ã™ã‚‹æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€ã¨å›ç­”ã™ã‚‹
    3. æ¨æ¸¬ã‚„å‰µä½œã¯è¡Œã‚ãªã„
    4. å›ç­”ã«ã¯å¿…ãšå‚ç…§å…ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®IDã‚’è¨˜è¼‰ã™ã‚‹
    ...ï¼ˆé•·ã„æŒ‡ç¤ºãŒç¶šãï¼‰
    """

    response = client.messages.create(
        model="claude-sonnet-4-6-20250514",
        max_tokens=2048,
        system=[
            {
                "type": "text",
                "text": system_prompt,
                "cache_control": {"type": "ephemeral"},  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹åŒ–
            }
        ],
        messages=[{"role": "user", "content": "æœ€æ–°ã®ç¤¾å†…è¦å®šã‚’æ•™ãˆã¦ãã ã•ã„"}],
    )
    return response
```

**æ³¨æ„ç‚¹:**
> ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯**1024ãƒˆãƒ¼ã‚¯ãƒ³ä»¥ä¸Š**ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã«å¯¾ã—ã¦æœ‰åŠ¹ã§ã™ã€‚çŸ­ã„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã¯åŠ¹æœãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãŸã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ‰åŠ¹æœŸé™ã¯**5åˆ†é–“**ã§ã€ãã®é–“ã«åŒã˜ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã‚Œã°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆã—ã¾ã™ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆé »åº¦ãŒä½ã„å ´åˆã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹ãŒå¤šç™ºã™ã‚‹ãŸã‚ã€ãƒãƒƒãƒå‡¦ç†ã‚„ãƒ¬ãƒ¼ãƒˆåˆ¶å¾¡ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

### ãƒ¢ãƒ‡ãƒ«é¸æŠã«ã‚ˆã‚‹æˆ¦ç•¥çš„ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·åˆ¶å¾¡

Claude APIã§ã¯**ç”¨é€”ã«å¿œã˜ã¦ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã„åˆ†ã‘ã‚‹**ã“ã¨ã§ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’æœ€é©åŒ–ã§ãã¾ã™ã€‚

```python
# model_router.py
from langchain_anthropic import ChatAnthropic

def get_model_for_task(task_type: str) -> ChatAnthropic:
    """ã‚¿ã‚¹ã‚¯ã®è¤‡é›‘ã•ã«å¿œã˜ã¦æœ€é©ãªClaudeãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã™ã‚‹."""
    models = {
        # å˜ç´”ãªåˆ†é¡ãƒ»ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° â†’ é«˜é€Ÿãƒ¢ãƒ‡ãƒ«
        "routing": ChatAnthropic(
            model="claude-haiku-4-5-20251001",
            max_tokens=256,
            streaming=True,
        ),
        # æ¤œç´¢çµæœã®è¦ç´„ãƒ»å›ç­”ç”Ÿæˆ â†’ ãƒãƒ©ãƒ³ã‚¹ãƒ¢ãƒ‡ãƒ«
        "generation": ChatAnthropic(
            model="claude-sonnet-4-6-20250514",
            max_tokens=4096,
            streaming=True,
        ),
        # è¤‡é›‘ãªæ¨è«–ãƒ»è¨ˆç”»ç«‹æ¡ˆ â†’ é«˜æ€§èƒ½ãƒ¢ãƒ‡ãƒ«
        "reasoning": ChatAnthropic(
            model="claude-opus-4-6-20250612",
            max_tokens=8192,
            streaming=True,
        ),
    }
    return models.get(task_type, models["generation"])
```

**TTFTæ¯”è¼ƒï¼ˆå®Ÿæ¸¬å€¤ã®ç›®å®‰ï¼‰:**

| ãƒ¢ãƒ‡ãƒ« | TTFTï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰ | é©ç”¨å ´é¢ |
|---|---|---|
| Claude Haiku 4.5 | ç´„360ms | ã‚¯ã‚¨ãƒªåˆ†é¡ã€Yes/Noåˆ¤å®šã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° |
| Claude Sonnet 4.6 | ç´„640ms | å›ç­”ç”Ÿæˆã€è¦ç´„ã€ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ |
| Claude Opus 4.6 | ç´„1200ms | è¤‡é›‘ãªæ¨è«–ã€ãƒãƒ«ãƒã‚¹ãƒ†ãƒƒãƒ—è¨ˆç”» |

**ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•:** Haiku 4.5ã¯TTFTãŒSonnet 4.6ã®ç´„åŠåˆ†ã§ã™ãŒã€è¤‡é›‘ãªæ¨è«–ã‚¿ã‚¹ã‚¯ã§ã®ç²¾åº¦ã¯åŠ£ã‚Šã¾ã™ã€‚ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¤å®šã®ã‚ˆã†ãªå˜ç´”ã‚¿ã‚¹ã‚¯ã«Haikuã‚’ä½¿ã„ã€å›ç­”ç”Ÿæˆã«Sonnetã‚’ä½¿ã†**2æ®µéšæ§‹æˆ**ãŒã‚³ã‚¹ãƒˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«å„ªã‚Œã¾ã™ã€‚

## ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‹RAGã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·å‰Šæ¸›ã‚’å®Ÿè·µã™ã‚‹

ã“ã“ã¾ã§ã®è¦ç´ ã‚’çµ„ã¿åˆã‚ã›ã¦ã€**ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã§ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’æœ€é©åŒ–**ã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‹RAGãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

### ã‚¹ãƒãƒ¼ãƒˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ä¸è¦ãªæ¤œç´¢ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‹RAGã®æœ€å¤§ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·è¦å› ã¯**ä¸å¿…è¦ãªæ¤œç´¢**ã§ã™ã€‚ç ”ç©¶ã«ã‚ˆã‚‹ã¨ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã®RAGã‚·ã‚¹ãƒ†ãƒ ã¯å˜ç´”ãªã‚¯ã‚¨ãƒªã®42%ã§éå‰°ãªæ¤œç´¢ã‚’è¡Œã„ã€300ã€œ800msã®ä¸è¦ãªãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’ç™ºç”Ÿã•ã›ã¦ã„ã¾ã™ã€‚

```python
# smart_routing_rag.py
from langgraph.graph import StateGraph, MessagesState, START, END
from langgraph.prebuilt import ToolNode
from langchain_anthropic import ChatAnthropic
from typing import Literal

# ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç”¨ã®é«˜é€Ÿãƒ¢ãƒ‡ãƒ«
router_llm = ChatAnthropic(
    model="claude-haiku-4-5-20251001",
    max_tokens=64,
    streaming=True,
)

# å›ç­”ç”Ÿæˆç”¨ãƒ¢ãƒ‡ãƒ«
generation_llm = ChatAnthropic(
    model="claude-sonnet-4-6-20250514",
    max_tokens=4096,
    streaming=True,
)


def classify_query(state: MessagesState) -> dict:
    """ã‚¯ã‚¨ãƒªã‚’åˆ†é¡ã—ã¦æ¤œç´¢ãŒå¿…è¦ã‹åˆ¤å®šã™ã‚‹ï¼ˆHaiku: ~360msï¼‰."""
    last_message = state["messages"][-1].content

    response = router_llm.invoke([
        {
            "role": "system",
            "content": (
                "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’åˆ†é¡ã—ã¦ãã ã•ã„ã€‚"
                "RAGæ¤œç´¢ãŒå¿…è¦ãªå ´åˆã¯'search'ã€"
                "ãƒ¡ãƒ¢ãƒªå‚ç…§ã§å›ç­”å¯èƒ½ãªã‚‰'memory'ã€"
                "ã©ã¡ã‚‰ã‚‚ä¸è¦ãªã‚‰'direct'ã¨å›ç­”ã—ã¦ãã ã•ã„ã€‚"
                "åˆ†é¡åã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚"
            ),
        },
        {"role": "user", "content": last_message},
    ])

    route = response.content.strip().lower()
    return {"route": route}


def route_query(state: dict) -> Literal["search", "memory", "direct"]:
    """åˆ†é¡çµæœã«åŸºã¥ã„ã¦ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹."""
    return state.get("route", "search")


def search_and_generate(state: MessagesState) -> dict:
    """æ¤œç´¢ã‚’å®Ÿè¡Œã—ã¦å›ç­”ã‚’ç”Ÿæˆã™ã‚‹ï¼ˆSonnet: ~640ms + æ¤œç´¢æ™‚é–“ï¼‰."""
    # ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã‚’å®Ÿè¡Œ
    query = state["messages"][-1].content
    # ... æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯

    # æ¤œç´¢çµæœã‚’ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å›ç­”ç”Ÿæˆ
    response = generation_llm.invoke(state["messages"])
    return {"messages": [response]}


def recall_and_generate(state: MessagesState) -> dict:
    """ãƒ¡ãƒ¢ãƒªã‹ã‚‰å›ç­”ã™ã‚‹ï¼ˆæ¤œç´¢ã‚¹ã‚­ãƒƒãƒ—ã§300-800mså‰Šæ¸›ï¼‰."""
    # é•·æœŸãƒ¡ãƒ¢ãƒªã‹ã‚‰ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢
    # ... ãƒ¡ãƒ¢ãƒªæ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯

    response = generation_llm.invoke(state["messages"])
    return {"messages": [response]}


def direct_generate(state: MessagesState) -> dict:
    """æ¤œç´¢ä¸è¦ãªã‚¯ã‚¨ãƒªã«ç›´æ¥å›ç­”ã™ã‚‹ï¼ˆæœ€é€Ÿãƒ‘ã‚¹ï¼‰."""
    response = generation_llm.invoke(state["messages"])
    return {"messages": [response]}


# ã‚°ãƒ©ãƒ•æ§‹ç¯‰
graph = StateGraph(MessagesState)
graph.add_node("classify", classify_query)
graph.add_node("search_generate", search_and_generate)
graph.add_node("memory_generate", recall_and_generate)
graph.add_node("direct_generate", direct_generate)

graph.add_edge(START, "classify")
graph.add_conditional_edges(
    "classify",
    route_query,
    {
        "search": "search_generate",
        "memory": "memory_generate",
        "direct": "direct_generate",
    },
)
graph.add_edge("search_generate", END)
graph.add_edge("memory_generate", END)
graph.add_edge("direct_generate", END)

app = graph.compile(checkpointer=checkpointer, store=store)
```

ã“ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«ã‚ˆã‚Šã€**æ¤œç´¢ä¸è¦ãªã‚¯ã‚¨ãƒªã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’300ã€œ800mså‰Šæ¸›**ã§ãã¾ã™ã€‚å®Ÿæ¸¬ã§ã¯æ··åˆãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰å…¨ä½“ã§ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒ**25ã€œ40%æ”¹å–„**ã—ã¾ã—ãŸã€‚

### ãƒ¡ãƒ¢ãƒªæ›¸ãè¾¼ã¿ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œã™ã‚‹

LangGraphã®ãƒ¡ãƒ¢ãƒªæ›¸ãè¾¼ã¿ã«ã¯ã€Œãƒ›ãƒƒãƒˆãƒ‘ã‚¹ã€ã¨ã€Œãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã€ã®2ã¤ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒã‚ã‚Šã¾ã™ã€‚ãƒ›ãƒƒãƒˆãƒ‘ã‚¹ã§ã¯å³åº§ã«ãƒ¡ãƒ¢ãƒªãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ãŒã€**å¿œç­”ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã«ç›´æ¥å½±éŸ¿**ã—ã¾ã™ã€‚

```python
# background_memory.py
import asyncio
from langgraph.store.postgres import AsyncPostgresStore

async def respond_with_background_memory(
    store: AsyncPostgresStore,
    user_id: str,
    response_text: str,
    conversation_summary: str,
):
    """å¿œç­”ã‚’è¿”ã—ãŸå¾Œã«ãƒ¡ãƒ¢ãƒªã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ä¿å­˜ã™ã‚‹."""

    # 1. ã¾ãšå¿œç­”ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¿”ã™ï¼ˆãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã«å½±éŸ¿ã—ãªã„ï¼‰
    yield response_text

    # 2. ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒ¡ãƒ¢ãƒªã‚’ä¿å­˜
    asyncio.create_task(
        store.aput(
            namespace=(user_id, "conversations"),
            key=f"conv-{asyncio.get_event_loop().time():.0f}",
            value={"summary": conversation_summary},
            index=["summary"],
        )
    )
```

**ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆ:** `asyncio.create_task`ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã™ã‚‹å ´åˆã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³æ™‚ã«æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯ãŒæ®‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`asyncio.TaskGroup`ã‚„ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚

```python
# graceful_shutdown.py
import asyncio
import signal

class MemoryWriter:
    """ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³å¯¾å¿œã®ãƒ¡ãƒ¢ãƒªãƒ©ã‚¤ã‚¿ãƒ¼."""

    def __init__(self, store: AsyncPostgresStore):
        self.store = store
        self._pending_tasks: set[asyncio.Task] = set()

    async def save_memory_background(
        self, namespace: tuple, key: str, value: dict
    ):
        """ãƒ¡ãƒ¢ãƒªä¿å­˜ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œã—ã€ã‚¿ã‚¹ã‚¯ã‚’è¿½è·¡ã™ã‚‹."""
        task = asyncio.create_task(
            self.store.aput(namespace, key, value, index=["summary"])
        )
        self._pending_tasks.add(task)
        task.add_done_callback(self._pending_tasks.discard)

    async def shutdown(self):
        """æœªå®Œäº†ã®ãƒ¡ãƒ¢ãƒªæ›¸ãè¾¼ã¿ã‚’å…¨ã¦å®Œäº†ã•ã›ã¦ã‹ã‚‰ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³."""
        if self._pending_tasks:
            await asyncio.gather(*self._pending_tasks, return_exceptions=True)
```

## ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

| å•é¡Œ | åŸå›  | è§£æ±ºæ–¹æ³• |
|---|---|---|
| `ConnectionPoolError` ãŒé »ç™ºã™ã‚‹ | PostgreSQLã®æ¥ç¶šãƒ—ãƒ¼ãƒ«ä¸Šé™ã‚’è¶…é | `max_connections`ã‚’å¢—ã‚„ã™ã‹ã€`pgbouncer`ã§ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒªãƒ³ã‚° |
| ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã®ç²¾åº¦ãŒä½ã„ | åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ã¨ã‚¯ã‚¨ãƒªã®è¨€èªä¸ä¸€è‡´ | å¤šè¨€èªå¯¾å¿œãƒ¢ãƒ‡ãƒ«ï¼ˆ`text-embedding-3-small`ï¼‰ã‚’ä½¿ç”¨ã—ã€ã‚¯ã‚¨ãƒªè¨€èªã‚’çµ±ä¸€ |
| Redisæ¥ç¶šãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã™ã‚‹ | Redis Clusterã®ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ä¸­ | `retry_on_timeout=True`ã¨`socket_connect_timeout=5`ã‚’è¨­å®š |
| ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§æ–‡å­—åŒ–ã‘ã™ã‚‹ | UTF-8ã®ãƒãƒ«ãƒãƒã‚¤ãƒˆæ–‡å­—ãŒãƒˆãƒ¼ã‚¯ãƒ³å¢ƒç•Œã§åˆ†å‰² | ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ã—ã¦æ–‡å­—å˜ä½ã§å‡ºåŠ›ã™ã‚‹ã‹ã€`text_stream`ã‚’ä½¿ç”¨ |
| ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãƒ’ãƒƒãƒˆã—ãªã„ | ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒ1024ãƒˆãƒ¼ã‚¯ãƒ³æœªæº€ã€ã¾ãŸã¯5åˆ†ä»¥ä¸ŠçµŒé | ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’1024ãƒˆãƒ¼ã‚¯ãƒ³ä»¥ä¸Šã«ã—ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“éš”ã‚’5åˆ†ä»¥å†…ã« |
| ãƒ¡ãƒ¢ãƒªä¿å­˜ãŒæ¶ˆå¤±ã™ã‚‹ | Redisã®`appendonly`ãŒ`no`ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ | `redis.conf`ã§`appendonly yes`ã«å¤‰æ›´ã—ã€`appendfsync everysec`ã‚’è¨­å®š |

## ã¾ã¨ã‚ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

**ã¾ã¨ã‚:**

- LangGraphã®ãƒ¡ãƒ¢ãƒªã¯**çŸ­æœŸï¼ˆCheckpointerï¼‰**ã¨**é•·æœŸï¼ˆStoreï¼‰**ã®2å±¤æ§‹é€ ã§ã€ãã‚Œãã‚Œç•°ãªã‚‹æ°¸ç¶šåŒ–æˆ¦ç•¥ãŒå¿…è¦
- æœ¬ç•ªç’°å¢ƒã§ã¯**PostgresStore**ã‚’ãƒ¡ã‚¤ãƒ³ã‚¹ãƒˆã‚¢ã¨ã—ã€**RedisStore**ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥å±¤ã¨ã™ã‚‹2å±¤æ§‹æˆãŒæ¨å¥¨
- Claude APIã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·æœ€é©åŒ–ã«ã¯**ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼ˆTTFT 500msä»¥ä¸‹ï¼‰**ã€**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆã‚³ã‚¹ãƒˆ90%å‰Šæ¸›ï¼‰**ã€**ãƒ¢ãƒ‡ãƒ«é¸æŠ**ã®3æ‰‹æ³•ã‚’çµ„ã¿åˆã‚ã›ã‚‹
- **ã‚¹ãƒãƒ¼ãƒˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**ã§æ¤œç´¢ä¸è¦ãªã‚¯ã‚¨ãƒªã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ã€æ··åˆãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’25ã€œ40%å‰Šæ¸›
- ãƒ¡ãƒ¢ãƒªæ›¸ãè¾¼ã¿ã®**ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰åŒ–**ã§å¿œç­”ãƒ‘ã‚¹ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã¸ã®å½±éŸ¿ã‚’ã‚¼ãƒ­ã«ã™ã‚‹

**æ¬¡ã«ã‚„ã‚‹ã¹ãã“ã¨:**

1. **ãƒ¡ãƒ¢ãƒªã®è‡ªå‹•è¦ç´„ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰**: ä¼šè©±ãŒé•·ããªã‚‹ã¨ãƒ¡ãƒ¢ãƒªé‡ãŒçˆ†ç™ºã™ã‚‹ãŸã‚ã€å®šæœŸçš„ã«å¤ã„ãƒ¡ãƒ¢ãƒªã‚’è¦ç´„ãƒ»åœ§ç¸®ã™ã‚‹ä»•çµ„ã¿ãŒå¿…è¦ã§ã™ã€‚LangChainã®`langmem`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå‚è€ƒã«ãªã‚Šã¾ã™
2. **ãƒ¡ãƒ¢ãƒªã®TTLï¼ˆæœ‰åŠ¹æœŸé™ï¼‰è¨­å®š**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿ã¯æ™‚é–“ã¨ã¨ã‚‚ã«å¤‰åŒ–ã—ã¾ã™ã€‚ãƒ¡ãƒ¢ãƒªã«æœ‰åŠ¹æœŸé™ã‚’è¨­å®šã—ã€å¤ã„æƒ…å ±ã‚’è‡ªå‹•çš„ã«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã¾ãŸã¯å‰Šé™¤ã™ã‚‹æˆ¦ç•¥ã‚’æ¤œè¨ã—ã¦ãã ã•ã„
3. **A/Bãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ã®æ¤œè¨¼**: ã‚¹ãƒãƒ¼ãƒˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®åˆ†é¡ç²¾åº¦ã‚’å®šé‡çš„ã«è©•ä¾¡ã—ã€èª¤åˆ†é¡ç‡ã‚’ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ä»•çµ„ã¿ã‚’å°å…¥ã—ã¾ã—ã‚‡ã†

## å‚è€ƒ

- [LangGraph Memory Overview - å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.langchain.com/oss/python/langgraph/memory)
- [Reducing latency - Claude API Docs](https://platform.claude.com/docs/en/test-and-evaluate/strengthen-guardrails/reduce-latency)
- [LangGraph & Redis: Build smarter AI agents with memory & persistence](https://redis.io/blog/langgraph-redis-build-smarter-ai-agents-with-memory-persistence/)
- [langgraph-checkpoint-postgres - PyPI](https://pypi.org/project/langgraph-checkpoint-postgres/)
- [Semantic Search for LangGraph Memory - LangChain Blog](https://blog.langchain.com/semantic-search-for-langgraph-memory/)
- [Building Agentic RAG Systems with LangGraph: The 2026 Guide](https://rahulkolekar.com/building-agentic-rag-systems-with-langgraph/)

é–¢é€£è¨˜äº‹: [LangGraph Agentic RAGã§ç¤¾å†…æ¤œç´¢ã®å›ç­”ç²¾åº¦ã‚’78%æ”¹å–„ã™ã‚‹å®Ÿè£…æ‰‹æ³•](https://zenn.dev/0h_n0/articles/4c869d366e5200)

---

:::message
ã“ã®è¨˜äº‹ã¯AIï¼ˆClaude Codeï¼‰ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å†…å®¹ã®æ­£ç¢ºæ€§ã«ã¤ã„ã¦ã¯è¤‡æ•°ã®æƒ…å ±æºã§æ¤œè¨¼ã—ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã®åˆ©ç”¨æ™‚ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚ã”ç¢ºèªãã ã•ã„ã€‚
:::
