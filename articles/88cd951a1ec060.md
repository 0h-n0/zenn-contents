---
title: "LangGraphãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã®è©•ä¾¡ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯è¨­è¨ˆã¨å”èª¿å“è³ªã®å®šé‡åŒ–"
emoji: "ğŸ“Š"
type: "tech"
topics: ["langgraph", "claude", "rag", "evaluation", "llm"]
published: false
---

# LangGraphãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã®è©•ä¾¡ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯è¨­è¨ˆã¨å”èª¿å“è³ªã®å®šé‡åŒ–

## ã“ã®è¨˜äº‹ã§ã‚ã‹ã‚‹ã“ã¨

- ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã‚·ã‚¹ãƒ†ãƒ ã«ç‰¹æœ‰ã®**3å±¤è©•ä¾¡ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**ï¼ˆFinal Response / Single Step / Trajectoryï¼‰ã®è¨­è¨ˆæ–¹æ³•
- `agentevals`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ãŸ**ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè»Œè·¡ï¼ˆTrajectoryï¼‰è©•ä¾¡**ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ãƒãƒƒãƒãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆstrict / unordered / subsetï¼‰ã®ä½¿ã„åˆ†ã‘
- RAGASãƒ»DeepEvalã‚’çµ„ã¿åˆã‚ã›ãŸ**ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå”èª¿å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹**ï¼ˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ãƒ»ãƒãƒ³ãƒ‰ã‚ªãƒ•æ­£ç¢ºæ€§ãƒ»Tool Call Accuracyï¼‰ã®æ¸¬å®šæ–¹æ³•
- Claude Sonnet 4.6ã®**effortãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**ã‚’æ´»ç”¨ã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå˜ä½ã®ã‚³ã‚¹ãƒˆ-ç²¾åº¦ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•æœ€é©åŒ–
- LangSmithã‚’ç”¨ã„ãŸ**CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çµ±åˆ**ã«ã‚ˆã‚‹è©•ä¾¡è‡ªå‹•åŒ–ã¨å“è³ªã‚²ãƒ¼ãƒˆã®æ§‹ç¯‰æ‰‹æ³•

## å¯¾è±¡èª­è€…

- **æƒ³å®šèª­è€…**: ä¸­ç´šã€œä¸Šç´šã®LLMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºè€…ã§ã€ç¤¾å†…æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ ã®ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã‚’æœ¬ç•ªé‹ç”¨ä¸­ã€ã¾ãŸã¯æ§‹ç¯‰äºˆå®šã®æ–¹
- **å¿…è¦ãªå‰æçŸ¥è­˜**:
  - Python 3.11+ã®å‹ãƒ’ãƒ³ãƒˆã¨async/await
  - LangGraph v1.0.xã®åŸºæœ¬ï¼ˆStateGraphã€ãƒãƒ¼ãƒ‰ã€ã‚¨ãƒƒã‚¸ã€`create_supervisor`ï¼‰
  - RAGã®åŸºæœ¬æ§‹æˆï¼ˆRetrieverã€Rerankerã€Generatorï¼‰
  - RAGASãƒ»DeepEvalã®åŸºæœ¬æ¦‚å¿µ

## çµè«–ãƒ»æˆæœ

ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã‚·ã‚¹ãƒ†ãƒ ã«3å±¤è©•ä¾¡ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’å°å…¥ã—ãŸçµæœã€ä»¥ä¸‹ã®æ”¹å–„ãŒå ±å‘Šã•ã‚Œã¦ã„ã¾ã™ã€‚

| è©•ä¾¡è¦³ç‚¹ | å°å…¥å‰ | å°å…¥å¾Œ | æ”¹å–„åŠ¹æœ |
|----------|--------|--------|----------|
| ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ | ç›®è¦–ç¢ºèªã®ã¿ | å®šé‡æ¸¬å®šå¯èƒ½ | **0.73â†’0.92ã«æ”¹å–„** |
| å›å¸°æ¤œå‡º | æœ¬ç•ªéšœå®³ã§ç™ºè¦š | CI/CDã§äº‹å‰æ¤œå‡º | **éšœå®³æ¤œå‡ºãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ 80%çŸ­ç¸®** |
| ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ§‹æˆã®æœ€é©åŒ–æ ¹æ‹  | å‹˜ã¨çµŒé¨“ | ablation studyã«åŸºã¥ã | **ä¸è¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‰Šé™¤ã§ã‚³ã‚¹ãƒˆ30%å‰Šæ¸›** |
| è©•ä¾¡å®Ÿè¡Œæ™‚é–“ | æ‰‹å‹•ã§åŠæ—¥ | GitHub Actionsè‡ªå‹•åŒ– | **15åˆ†ã§å®Œäº†** |

LangChainç¤¾ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ç ”ç©¶ã«ã‚ˆã‚‹ã¨ã€**ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£é¸æŠãŒã‚³ã‚¹ãƒˆ-ç²¾åº¦ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã®æœ€å¤§è¦å› **ã§ã‚ã‚Šã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ¢ãƒ‡ãƒ«ã‚„ãƒ„ãƒ¼ãƒ«è¨­å®šä»¥ä¸Šã«è©•ä¾¡çµæœã«å½±éŸ¿ã—ã¾ã™ã€‚ã¤ã¾ã‚Šã€Œã©ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã†ã‹ã€ã‚ˆã‚Šã‚‚ã€Œã©ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ§‹æˆã§è©•ä¾¡ã™ã‚‹ã‹ã€ãŒæœ¬ç•ªå“è³ªã‚’æ±ºå®šã—ã¾ã™ã€‚

é–¢é€£è¨˜äº‹:
- [LangGraphÃ—Claude Sonnet 4.6ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‹RAGã®ç²¾åº¦è©•ä¾¡ã¨æœ€é©åŒ–](https://zenn.dev/0h_n0/articles/32bc8fd091100d): å˜ä¸€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã®ç²¾åº¦è©•ä¾¡æ‰‹æ³•ï¼ˆæœ¬è¨˜äº‹ã¯ã“ã®ç™ºå±•ç‰ˆï¼‰
- [LangGraph Supervisor/Swarmã§æ§‹ç¯‰ã™ã‚‹ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç¤¾å†…æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ ](https://zenn.dev/0h_n0/articles/52135977df9966): Supervisor/Swarmå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³
- [create_supervisorã§å®Ÿè£…ã™ã‚‹ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã¨ç¤¾å†…æ¤œç´¢ç²¾åº¦2.1å€æ”¹å–„](https://zenn.dev/0h_n0/articles/9677305f7e25d8): create_supervisor APIã®åŸºæœ¬

æœ¬è¨˜äº‹ã§ã¯ã€ã“ã‚Œã‚‰ã®è¨˜äº‹ã§æ§‹ç¯‰ã—ãŸãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã‚’**ã©ã†è©•ä¾¡ã—ã€ã©ã†æœ€é©åŒ–ã™ã‚‹ã‹**ã«ç„¦ç‚¹ã‚’å½“ã¦ã¾ã™ã€‚

## ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè©•ä¾¡ã®3å±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’è¨­è¨ˆã™ã‚‹

å˜ä¸€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã®è©•ä¾¡ã¯ã€Œå…¥åŠ›â†’å‡ºåŠ›ã€ã®æ¤œè¨¼ã§æ¸ˆã¿ã¾ã™ãŒã€ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã§ã¯**ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã®å”èª¿**ãŒå“è³ªã‚’å·¦å³ã—ã¾ã™ã€‚LangChainç¤¾ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè©•ä¾¡ã‚’3ã¤ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«åˆ†é¡ã—ã¦ã„ã¾ã™ã€‚

### 3å±¤è©•ä¾¡ã®å…¨ä½“åƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: Final Response Evaluation         â”‚
â”‚  â†’ æœ€çµ‚å‡ºåŠ›ã®å“è³ªã‚’è©•ä¾¡ï¼ˆLLM-as-judgeï¼‰       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 2: Trajectory Evaluation             â”‚
â”‚  â†’ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¡Œå‹•è»Œè·¡ã‚’è©•ä¾¡               â”‚
â”‚  â†’ ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ãƒ»ãƒãƒ³ãƒ‰ã‚ªãƒ•æ­£ç¢ºæ€§          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 1: Single Step Evaluation            â”‚
â”‚  â†’ å€‹åˆ¥ãƒãƒ¼ãƒ‰ã®å…¥å‡ºåŠ›ã‚’æ¤œè¨¼                   â”‚
â”‚  â†’ ãƒ„ãƒ¼ãƒ«é¸æŠãƒ»å¼•æ•°ã®æ­£ç¢ºæ€§                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ãªãœ3å±¤ãŒå¿…è¦ã‹**: æœ€çµ‚å‡ºåŠ›ã ã‘ã‚’è©•ä¾¡ã™ã‚‹ã¨ã€Œçµæœã¯æ­£ã—ã„ãŒãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒéåŠ¹ç‡ã€ã€Œçµæœã¯é–“é•ã„ã ãŒã©ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒåŸå› ã‹ä¸æ˜ã€ã¨ã„ã†çŠ¶æ³ã«ãªã‚Šã¾ã™ã€‚ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå›ºæœ‰ã®å•é¡Œã¯**Layer 1-2ã§ã—ã‹æ¤œå‡ºã§ãã¾ã›ã‚“**ã€‚

### Layer 1: Single Step Evaluationã®å®Ÿè£…

å€‹åˆ¥ãƒãƒ¼ãƒ‰ã®è©•ä¾¡ã¯æœ€ã‚‚ã‚³ã‚¹ãƒˆãŒä½ãã€ãƒ‡ãƒãƒƒã‚°åŠ¹ç‡ã®é«˜ã„æ‰‹æ³•ã§ã™ã€‚LangGraphã§ã¯ãƒãƒ¼ãƒ‰å˜ä½ã§ãƒ†ã‚¹ãƒˆå¯èƒ½ãªè¨­è¨ˆã«ãªã£ã¦ã„ã¾ã™ã€‚

```python
# single_step_eval.py
from langchain_anthropic import ChatAnthropic
from langgraph.graph import StateGraph, MessagesState
from langsmith import aevaluate

# Supervisorãƒãƒ¼ãƒ‰ã®å˜ä½“ãƒ†ã‚¹ãƒˆ
# ãƒãƒ¼ãƒ‰ã‚’ç›´æ¥å‘¼ã³å‡ºã—ã¦ãƒ„ãƒ¼ãƒ«é¸æŠã®æ­£ç¢ºæ€§ã‚’æ¤œè¨¼ã™ã‚‹
async def eval_supervisor_routing(
    inputs: dict, outputs: dict, reference_outputs: dict
) -> dict:
    """Supervisorã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¤æ–­ã‚’è©•ä¾¡ã™ã‚‹"""
    expected_agent = reference_outputs.get("target_agent")
    # outputsã®tool_callsã‹ã‚‰ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å…ˆã‚’æŠ½å‡º
    messages = outputs.get("messages", [])

    if not messages:
        return {"key": "routing_accuracy", "score": 0}

    last_message = messages[-1]
    if hasattr(last_message, "tool_calls") and last_message.tool_calls:
        routed_agent = last_message.tool_calls[0].get("name", "")
        score = 1.0 if routed_agent == expected_agent else 0.0
    else:
        score = 0.0

    return {"key": "routing_accuracy", "score": score}


# ãƒãƒ¼ãƒ‰å˜ä½“ã§ã®è©•ä¾¡å®Ÿè¡Œ
async def evaluate_single_node(app: StateGraph, node_name: str):
    """ç‰¹å®šãƒãƒ¼ãƒ‰ã®ã¿ã‚’è©•ä¾¡å¯¾è±¡ã¨ã—ã¦å®Ÿè¡Œã™ã‚‹"""
    # LangSmithã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‹ã‚‰è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    node_target = lambda inputs: app.nodes[node_name].invoke(inputs)

    results = await aevaluate(
        node_target,
        data="supervisor-routing-dataset",
        evaluators=[eval_supervisor_routing],
    )
    return results
```

**ãªãœãƒãƒ¼ãƒ‰å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å…ˆã«å®Ÿæ–½ã™ã‚‹ã‹**: ã‚°ãƒ©ãƒ•å…¨ä½“ã®è©•ä¾¡ã¯1å›ã‚ãŸã‚Šã®ã‚³ã‚¹ãƒˆãŒé«˜ã„ï¼ˆè¤‡æ•°LLMå‘¼ã³å‡ºã—ï¼‰ãŸã‚ã€ãƒãƒ¼ãƒ‰å˜ä½“ã§æ¤œè¨¼ã—ã¦ã‹ã‚‰å…¨ä½“ãƒ†ã‚¹ãƒˆã«é€²ã‚€ã“ã¨ã§ã€è©•ä¾¡ã‚³ã‚¹ãƒˆã‚’æŠ‘ãˆã‚‰ã‚Œã¾ã™ã€‚LangChainç¤¾ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã‚‚ã€Œreduce costs by evaluating single nodes directlyã€ã¨æ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

### Layer 2: Trajectory Evaluationã®å®Ÿè£…

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¡Œå‹•è»Œè·¡ã‚’è©•ä¾¡ã™ã‚‹ã«ã¯ã€`agentevals`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒæä¾›ã™ã‚‹4ã¤ã®ãƒãƒƒãƒãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ã„åˆ†ã‘ã¾ã™ã€‚

```python
# trajectory_eval.py
from agentevals.trajectory import (
    create_trajectory_match_eval,
    create_trajectory_llm_as_judge,
)

# 1. Strictãƒ¢ãƒ¼ãƒ‰: ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—é †åºã¾ã§å®Œå…¨ä¸€è‡´ã‚’è¦æ±‚
strict_eval = create_trajectory_match_eval(match_mode="strict")

# 2. Unorderedãƒ¢ãƒ¼ãƒ‰: é †åºä¸å•ã§å…¨ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã‚’ç¢ºèª
unordered_eval = create_trajectory_match_eval(match_mode="unordered")

# 3. Subsetãƒ¢ãƒ¼ãƒ‰: æœ€ä½é™å¿…è¦ãªãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã®éƒ¨åˆ†ä¸€è‡´
subset_eval = create_trajectory_match_eval(match_mode="subset")

# 4. LLM-as-judge: è»Œè·¡å…¨ä½“ã‚’LLMã§ç·åˆè©•ä¾¡
trajectory_judge = create_trajectory_llm_as_judge()
```

**ãƒãƒƒãƒãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã®ä½¿ã„åˆ†ã‘**:

| ãƒ¢ãƒ¼ãƒ‰ | ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ | å³å¯†åº¦ | ã‚³ã‚¹ãƒˆ |
|--------|-------------|--------|--------|
| strict | æ±ºå®šçš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆå¸¸ã«åŒã˜é †åºã§å‘¼ã³å‡ºã™ã¹ãï¼‰ | é«˜ | ä½ï¼ˆãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼‰ |
| unordered | ä¸¦åˆ—æ¤œç´¢ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆé †åºã¯å•ã‚ãªã„ãŒå…¨ã‚½ãƒ¼ã‚¹æ¤œç´¢ã™ã¹ãï¼‰ | ä¸­ | ä½ |
| subset | æ¡ä»¶åˆ†å²ãŒã‚ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆæœ€ä½é™ã®ãƒ‘ã‚¹ã‚’æ¤œè¨¼ï¼‰ | ä½ | ä½ |
| LLM-as-judge | è¤‡é›‘ãªåˆ¤æ–­ãŒå¿…è¦ãªå ´åˆï¼ˆä»£æ›¿ãƒ‘ã‚¹ã®å¦¥å½“æ€§è©•ä¾¡ï¼‰ | å¯å¤‰ | é«˜ï¼ˆLLMå‘¼ã³å‡ºã—ï¼‰ |

> **æ³¨æ„**: strictãƒ¢ãƒ¼ãƒ‰ã¯æ±ºå®šçš„ãªå‡¦ç†ã«æœ‰åŠ¹ã§ã™ãŒã€LLMã®éæ±ºå®šæ€§ã«ã‚ˆã‚ŠåŒã˜å…¥åŠ›ã§ã‚‚ç•°ãªã‚‹è»Œè·¡ãŒç”Ÿæˆã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€ã¾ãšunorderedã‹subsetã§åŸºæœ¬æ¤œè¨¼ã—ã€é‡è¦ãƒ‘ã‚¹ã®ã¿strictã«ã™ã‚‹ã®ãŒç¾å®Ÿçš„ã§ã™ã€‚

### Layer 3: Final Response Evaluationã®å®Ÿè£…

æœ€çµ‚å‡ºåŠ›ã®è©•ä¾¡ã«ã¯RAGASã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’æ´»ç”¨ã—ã¾ã™ã€‚LangGraphã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’RAGASå½¢å¼ã«å¤‰æ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```python
# final_response_eval.py
from ragas.integrations.langgraph import convert_to_ragas_messages
from ragas.metrics import (
    Faithfulness,
    AnswerRelevancy,
    ContextPrecision,
)
from ragas.dataset_schema import MultiTurnSample
from ragas import evaluate

async def evaluate_final_response(
    graph_result: dict,
    reference_answer: str,
    reference_contexts: list[str],
) -> dict:
    """æœ€çµ‚å‡ºåŠ›ã‚’RAGASãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§è©•ä¾¡ã™ã‚‹"""
    # LangGraphãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â†’ RAGASå½¢å¼ã«å¤‰æ›
    ragas_messages = convert_to_ragas_messages(
        graph_result["messages"]
    )

    sample = MultiTurnSample(
        user_input=ragas_messages,
        reference=reference_answer,
        reference_contexts=reference_contexts,
    )

    # 3ã¤ã®ã‚³ã‚¢ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§è©•ä¾¡
    results = evaluate(
        dataset=[sample],
        metrics=[
            Faithfulness(),
            AnswerRelevancy(),
            ContextPrecision(),
        ],
    )
    return results.to_pandas().to_dict()
```

**ãªãœFaithfulnessãƒ»AnswerRelevancyãƒ»ContextPrecisionã®3æŒ‡æ¨™ã‹**: Faithfulnessã¯ã€Œç”Ÿæˆã•ã‚ŒãŸå›ç­”ãŒæ¤œç´¢çµæœã«å¿ å®Ÿã‹ï¼ˆãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³æ¤œå‡ºï¼‰ã€ã€AnswerRelevancyã¯ã€Œå›ç­”ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«é–¢é€£ã—ã¦ã„ã‚‹ã‹ã€ã€ContextPrecisionã¯ã€Œæ¤œç´¢çµæœã®ä¸­ã§å®Ÿéš›ã«ä½¿ã‚ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å‰²åˆã€ã‚’æ¸¬å®šã—ã¾ã™ã€‚ã“ã®3ã¤ã§ã€Œæ¤œç´¢å“è³ªâ†’ç”Ÿæˆå“è³ªã€ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å…¨ä½“ã‚’ã‚«ãƒãƒ¼ã§ãã¾ã™ã€‚

## ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå”èª¿å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å®šç¾©ã™ã‚‹

ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ å›ºæœ‰ã®å“è³ªæŒ‡æ¨™ã¨ã—ã¦ã€ä»¥ä¸‹ã®4ã¤ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯æ¨™æº–ã®RAGASãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§ã¯æ¸¬å®šã§ããªã„ã€**ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã®å”èª¿**ã«ç‰¹åŒ–ã—ãŸæŒ‡æ¨™ã§ã™ã€‚

### ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®å®šç¾©ã¨å®Ÿè£…

```python
# custom_metrics.py
from dataclasses import dataclass
from langsmith.schemas import Run


@dataclass
class MultiAgentMetrics:
    """ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå”èª¿å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹"""
    routing_precision: float   # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦
    handoff_accuracy: float    # ãƒãƒ³ãƒ‰ã‚ªãƒ•æ­£ç¢ºæ€§
    agent_utilization: float   # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ´»ç”¨ç‡
    redundancy_ratio: float    # å†—é•·å‘¼ã³å‡ºã—ç‡


def compute_routing_precision(
    run: Run, expected_agents: list[str]
) -> float:
    """Supervisorã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¤æ–­ã®ç²¾åº¦ã‚’è¨ˆç®—ã™ã‚‹"""
    # child_runsã‹ã‚‰ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å…ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåã‚’æŠ½å‡º
    actual = [
        c.name for c in (run.child_runs or [])
        if c.run_type == "chain" and c.name != "supervisor"
    ]
    if not expected_agents:
        return 0.0
    correct = sum(1 for a in actual if a in expected_agents)
    return correct / len(expected_agents)


def compute_redundancy_ratio(run: Run) -> float:
    """åŒã˜æƒ…å ±ã‚’é‡è¤‡å–å¾—ã—ãŸå‰²åˆï¼ˆ0.0ãŒç†æƒ³ã€0.3ä»¥ä¸Šã¯è¦æ”¹å–„ï¼‰"""
    # tool callã‚’å†å¸°çš„ã«åé›†
    def collect_tools(r: Run) -> list:
        tools = []
        for c in (r.child_runs or []):
            if c.run_type == "tool":
                tools.append((c.name, str(c.inputs)))
            tools.extend(collect_tools(c))
        return tools

    calls = collect_tools(run)
    if not calls:
        return 0.0
    return (len(calls) - len(set(calls))) / len(calls)
```

### ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è§£é‡ˆåŸºæº–

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | åŸºæº–å€¤ | è­¦å‘Šé–¾å€¤ | å¯¾å‡¦æ³• |
|-----------|--------|----------|--------|
| routing_precision | â‰¥0.90 | <0.80 | Supervisorãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ”¹å–„ã€few-shotè¿½åŠ  |
| handoff_accuracy | â‰¥0.95 | <0.85 | ãƒãƒ³ãƒ‰ã‚ªãƒ•æ™‚ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¼•ãç¶™ããƒ­ã‚¸ãƒƒã‚¯è¦‹ç›´ã— |
| agent_utilization | 0.40-0.80 | <0.20 or >0.95 | ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ§‹æˆã®è¦‹ç›´ã—ï¼ˆéå‰°/ä¸è¶³ï¼‰ |
| redundancy_ratio | â‰¤0.10 | >0.30 | ã‚­ãƒ£ãƒƒã‚·ãƒ¥å°å…¥ã€æ¤œç´¢çµæœã®é‡è¤‡æ’é™¤ |

> **åˆ¶ç´„æ¡ä»¶**: ã“ã‚Œã‚‰ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯LangSmithã®`Run`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ä¾å­˜ã™ã‚‹ãŸã‚ã€LangSmithã§ã®ãƒˆãƒ¬ãƒ¼ã‚¹æœ‰åŠ¹åŒ–ãŒå‰æã§ã™ã€‚Langfuseç­‰ã®ä»–ã®ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«åˆã‚ã›ãŸå¤‰æ›å‡¦ç†ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

## ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ‡é™¤å®Ÿé¨“ï¼ˆAblation Studyï¼‰ã§ã‚³ã‚¹ãƒˆæœ€é©åŒ–ã™ã‚‹

ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ã»ã©ã‚³ã‚¹ãƒˆãŒå¢—åŠ ã—ã¾ã™ã€‚MAESTROã®ç ”ç©¶ï¼ˆarXiv:2601.00481ï¼‰ã§ã¯ã€**ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãŒã‚³ã‚¹ãƒˆ-ç²¾åº¦ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã®æœ€å¤§è¦å› **ã§ã‚ã‚‹ã“ã¨ãŒç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚æœ¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è²¢çŒ®åº¦ã‚’å®šé‡åŒ–ã—ã€ä¸è¦ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç‰¹å®šã™ã‚‹æ‰‹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

### Ablation Studyã®å®Ÿè£…

```python
# ablation_study.py
import itertools
from dataclasses import dataclass
from langchain_anthropic import ChatAnthropic
from langgraph.prebuilt import create_react_agent
from langgraph_supervisor import create_supervisor

AVAILABLE_AGENTS = [
    "confluence_searcher",
    "slack_searcher",
    "document_grader",
    "query_rewriter",
]

@dataclass
class AblationResult:
    """åˆ‡é™¤å®Ÿé¨“ã®çµæœ"""
    agent_config: tuple[str, ...]
    faithfulness: float
    answer_relevancy: float
    context_precision: float
    avg_latency_ms: float
    avg_cost_usd: float
    agent_count: int


async def run_ablation_study(
    eval_dataset: list[dict],
    base_model: str = "claude-sonnet-4-6-20250514",
) -> list[AblationResult]:
    """å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆçµ„ã¿åˆã‚ã›ã§è©•ä¾¡ã‚’å®Ÿè¡Œã™ã‚‹

    4ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å ´åˆ: 2^4 - 1 = 15é€šã‚Šï¼ˆç©ºé›†åˆé™¤å¤–ï¼‰
    å„çµ„ã¿åˆã‚ã›ã§è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’å®Ÿè¡Œã—ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’åé›†ã™ã‚‹ã€‚
    """
    results = []

    for r in range(1, len(AVAILABLE_AGENTS) + 1):
        for combo in itertools.combinations(AVAILABLE_AGENTS, r):
            # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ§‹æˆã‚’å‹•çš„ã«ç”Ÿæˆ
            agents = build_agents(list(combo), base_model)
            supervisor = create_supervisor(
                agents=agents,
                model=ChatAnthropic(
                    model=base_model,
                    extra_headers={
                        "anthropic-beta": "interleaved-thinking-2025-05-14"
                    },
                ),
                prompt=(
                    "ã‚ãªãŸã¯ç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸æ¤œç´¢ã®Supervisorã§ã™ã€‚"
                    "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«å¯¾ã—ã¦é©åˆ‡ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«"
                    "ã‚¿ã‚¹ã‚¯ã‚’å§”è­²ã—ã¦ãã ã•ã„ã€‚"
                ),
            )
            app = supervisor.compile()

            # è©•ä¾¡å®Ÿè¡Œ
            metrics = await evaluate_config(app, eval_dataset)
            results.append(AblationResult(
                agent_config=combo,
                agent_count=len(combo),
                **metrics,
            ))

    return results


def build_agents(agent_names: list[str], model: str) -> list:
    """æŒ‡å®šã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåã‹ã‚‰create_react_agentã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰"""
    # agent_configsè¾æ›¸ã«name/tools/promptã‚’å®šç¾©ï¼ˆçœç•¥ï¼‰
    llm = ChatAnthropic(model=model)
    return [
        create_react_agent(
            model=llm, tools=cfg["tools"],
            name=name, prompt=cfg["prompt"],
        )
        for name, cfg in agent_configs.items()
        if name in agent_names
    ]
```

### ãƒ‘ãƒ¬ãƒ¼ãƒˆãƒ•ãƒ­ãƒ³ãƒ†ã‚£ã‚¢ã®ç‰¹å®š

ablation studyã®çµæœã‹ã‚‰ã€**ãƒ‘ãƒ¬ãƒ¼ãƒˆæœ€é©ãªæ§‹æˆ**ï¼ˆã‚³ã‚¹ãƒˆã‚’å¢—ã‚„ã•ãšã«ç²¾åº¦ã‚’ä¸Šã’ã‚‰ã‚Œãªã„ã€ç²¾åº¦ã‚’ä¸‹ã’ãšã«ã‚³ã‚¹ãƒˆã‚’å‰Šæ¸›ã§ããªã„æ§‹æˆï¼‰ã‚’ç‰¹å®šã—ã¾ã™ã€‚å…¨çµæœã‚’ã‚³ã‚¹ãƒˆÃ—ç²¾åº¦ã®2æ¬¡å…ƒã«ãƒ—ãƒ­ãƒƒãƒˆã—ã€æ”¯é…ã•ã‚Œã¦ã„ãªã„ç‚¹ã®ã¿ã‚’æŠ½å‡ºã—ã¾ã™ã€‚

```python
# pareto_analysis.py
def find_pareto_frontier(
    results: list[AblationResult],
) -> list[AblationResult]:
    """ãƒ‘ãƒ¬ãƒ¼ãƒˆæœ€é©ãªæ§‹æˆã‚’æŠ½å‡ºã™ã‚‹"""
    pareto = []
    for r in results:
        # ä»–ã®æ§‹æˆã«ã‚³ã‚¹ãƒˆãƒ»ç²¾åº¦ã®ä¸¡æ–¹ã§æ”¯é…ã•ã‚Œã¦ã„ãªã‘ã‚Œã°æ¡ç”¨
        dominated = any(
            o.avg_cost_usd <= r.avg_cost_usd
            and o.faithfulness >= r.faithfulness
            and (o.avg_cost_usd < r.avg_cost_usd
                 or o.faithfulness > r.faithfulness)
            for o in results
        )
        if not dominated:
            pareto.append(r)
    return sorted(pareto, key=lambda x: x.avg_cost_usd)
```

**ã‚ˆãã‚ã‚‹é–“é•ã„**: ã€Œã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å¢—ã‚„ã›ã°ç²¾åº¦ãŒä¸ŠãŒã‚‹ã€ã¨è€ƒãˆãŒã¡ã§ã™ãŒã€LangChainç¤¾ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ç ”ç©¶ã«ã‚ˆã‚‹ã¨ã€Supervisorã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã®ã€Œç¿»è¨³ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã€ãŒç™ºç”Ÿã—ã€ç‰¹å®šã®æ§‹æˆã§ã¯**ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¿½åŠ ãŒé€†åŠ¹æœ**ã«ãªã‚‹ã“ã¨ãŒç¢ºèªã•ã‚Œã¦ã„ã¾ã™ã€‚ablation studyã§å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®é™ç•Œè²¢çŒ®åº¦ã‚’æ¸¬å®šã—ã€ãƒ‘ãƒ¬ãƒ¼ãƒˆãƒ•ãƒ­ãƒ³ãƒ†ã‚£ã‚¢ä¸Šã®æ§‹æˆã®ã¿ã‚’å€™è£œã«ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

## Claude Sonnet 4.6ã®effortãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå˜ä½ã®ã‚³ã‚¹ãƒˆã‚’åˆ¶å¾¡ã™ã‚‹

Claude Sonnet 4.6ã§ã¯ã€`effort`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã‚Š**ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã”ã¨ã«æ¨è«–æ·±åº¦ã‚’åˆ¶å¾¡**ã§ãã¾ã™ã€‚Adaptive Thinkingã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€å˜ç´”ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¤æ–­ã«ã¯è»½é‡ãªæ¨è«–ã€è¤‡é›‘ãªå›ç­”ç”Ÿæˆã«ã¯æ·±ã„æ¨è«–ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã‚³ã‚¹ãƒˆæœ€é©åŒ–ãŒå¯èƒ½ã§ã™ã€‚

### effortãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¨­è¨ˆæŒ‡é‡

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å½¹å‰²ã«å¿œã˜ã¦ã€æ¨è«–ã‚³ã‚¹ãƒˆã‚’3æ®µéšã§åˆ¶å¾¡ã—ã¾ã™ã€‚

| ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ | effort | ç†ç”± |
|-------------|--------|------|
| supervisor | low | ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¤æ–­ã¯å®šå‹çš„ |
| confluence_searcher / slack_searcher | low | æ¤œç´¢ã‚¯ã‚¨ãƒªç”Ÿæˆã¯å˜ç´” |
| document_grader / query_rewriter | medium | é–¢é€£åº¦åˆ¤å®šãƒ»æ„å›³è§£é‡ˆã«æ¨è«–ãŒå¿…è¦ |
| answer_generator | high | æœ€çµ‚å›ç­”ã¯å“è³ªãŒæœ€é‡è¦ |

```python
# effort_optimization.py
from langchain_anthropic import ChatAnthropic

BUDGET = {"low": 1024, "medium": 4096, "high": 16384}

def create_agent_with_effort(
    agent_name: str, effort: str = "medium"
) -> ChatAnthropic:
    """effortè¨­å®šä»˜ãã§LLMã‚’æ§‹æˆã™ã‚‹"""
    return ChatAnthropic(
        model="claude-sonnet-4-6-20250514",
        extra_headers={
            "anthropic-beta": "interleaved-thinking-2025-05-14"
        },
        model_kwargs={
            "thinking": {
                "type": "enabled",
                "budget_tokens": BUDGET.get(effort, 4096),
            },
        },
    )
```

### effortè¨­å®šã®ã‚°ãƒªãƒƒãƒ‰ã‚µãƒ¼ãƒ

3ã¤ã®ä¸»è¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆsupervisor, document_grader, answer_generatorï¼‰Ã— 3ãƒ¬ãƒ™ãƒ«ï¼ˆlow, medium, highï¼‰= **27é€šã‚Šã®çµ„ã¿åˆã‚ã›**ã‚’è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§å®Ÿè¡Œã—ã€ã‚³ã‚¹ãƒˆ-ç²¾åº¦ã®æœ€é©è§£ã‚’æ¢ç´¢ã—ã¾ã™ã€‚å®Ÿè£…ã¯ablation studyã¨åŒæ§˜ã«`itertools.product`ã§å…¨çµ„ã¿åˆã‚ã›ã‚’ç”Ÿæˆã—ã€å„æ§‹æˆã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’æ¸¬å®šã—ã¾ã™ã€‚

**ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•**: effort=lowã«è¨­å®šã™ã‚‹ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ã¨ã‚³ã‚¹ãƒˆã¯å‰Šæ¸›ã§ãã¾ã™ãŒã€è¤‡é›‘ãªæ¨è«–ã‚’è¦ã™ã‚‹ã‚¿ã‚¹ã‚¯ã§ç²¾åº¦ãŒä½ä¸‹ã—ã¾ã™ã€‚Anthropicç¤¾ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ã€Sonnet 4.6ã§ã¯effort=mediumãŒå¤šãã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§æ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚æœ€çµ‚å›ç­”ç”Ÿæˆã®ã¿effort=highã«ã—ã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»æ¤œç´¢ã¯effort=lowã«ã™ã‚‹æˆ¦ç•¥ãŒå®Ÿç”¨çš„ã§ã™ã€‚

## LangSmithã§CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«è©•ä¾¡ã‚’çµ±åˆã™ã‚‹

è©•ä¾¡ã‚’æ‰‹å‹•ã§å®Ÿè¡Œã™ã‚‹ã®ã¯æŒç¶šå¯èƒ½ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚LangSmithã®CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çµ±åˆã«ã‚ˆã‚Šã€ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã®ãŸã³ã«è‡ªå‹•çš„ã«å“è³ªã‚²ãƒ¼ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

### GitHub Actionsè©•ä¾¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ§‹ç¯‰

```yaml
# .github/workflows/agent-eval.yml
name: Multi-Agent RAG Evaluation

on:
  pull_request:
    paths:
      - "src/agents/**"
      - "src/graph/**"
      - "prompts/**"

env:
  LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  LANGSMITH_PROJECT: "multi-agent-rag-eval"

jobs:
  evaluate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install langgraph langchain-anthropic \
            langsmith agentevals ragas deepeval

      - name: Run Single Step Evaluation
        run: |
          python -m pytest tests/eval/test_single_step.py \
            --tb=short -q

      - name: Run Trajectory Evaluation
        run: |
          python -m pytest tests/eval/test_trajectory.py \
            --tb=short -q

      - name: Run Final Response Evaluation
        run: |
          python scripts/eval_final_response.py \
            --dataset "production-golden-set" \
            --min-faithfulness 0.85 \
            --min-relevancy 0.80 \
            --min-routing-precision 0.90

      - name: Check Quality Gate
        run: |
          python scripts/quality_gate.py \
            --project "$LANGSMITH_PROJECT" \
            --fail-on-regression
```

### å“è³ªã‚²ãƒ¼ãƒˆã®å®Ÿè£…

```python
# scripts/quality_gate.py
import sys
from langsmith import Client


def check_quality_gate(
    project_name: str,
    thresholds: dict[str, float],
) -> bool:
    """å“è³ªã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹"""
    client = Client()
    runs = client.list_runs(
        project_name=project_name,
        run_type="chain", limit=100,
    )

    # feedback_statsã‹ã‚‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’é›†è¨ˆ
    sums: dict[str, float] = {}
    counts: dict[str, int] = {}
    for run in runs:
        if run.feedback_stats:
            for key, stats in run.feedback_stats.items():
                sums[key] = sums.get(key, 0) + stats.get("avg", 0)
                counts[key] = counts.get(key, 0) + 1
    metrics = {k: sums[k] / counts[k] for k in sums}

    passed = True
    for name, threshold in thresholds.items():
        actual = metrics.get(name, 0.0)
        status = "PASS" if actual >= threshold else "FAIL"
        print(f"[{status}] {name}: {actual:.3f} (>= {threshold})")
        if actual < threshold:
            passed = False
    return passed


if __name__ == "__main__":
    thresholds = {
        "faithfulness": 0.85,
        "answer_relevancy": 0.80,
        "routing_precision": 0.90,
    }
    ok = check_quality_gate("multi-agent-rag-eval", thresholds)
    sys.exit(0 if ok else 1)
```

**ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆ**: LangSmithã®è©•ä¾¡çµæœã¯APIã‹ã‚‰å–å¾—ã™ã‚‹éš›ã«**éåŒæœŸã§åæ˜ ã•ã‚Œã‚‹**ãŸã‚ã€è©•ä¾¡å®Ÿè¡Œç›´å¾Œã«`list_runs`ã‚’å‘¼ã³å‡ºã™ã¨ã¾ã çµæœãŒåæ˜ ã•ã‚Œã¦ã„ãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚å“è³ªã‚²ãƒ¼ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã¯ã€è©•ä¾¡çµæœã®åæ˜ ã‚’å¾…ã¤ãƒãƒ¼ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã‹ã€`aevaluate`ã®å®Œäº†ã‚’æ˜ç¤ºçš„ã«å¾…ã¤å®Ÿè£…ãŒå¿…è¦ã§ã™ã€‚

## ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè©•ä¾¡ã®å°å…¥ã§ã‚ˆãé­é‡ã™ã‚‹å•é¡Œã‚’ã¾ã¨ã‚ã¾ã™ã€‚

| å•é¡Œ | åŸå›  | è§£æ±ºæ–¹æ³• |
|------|------|----------|
| è©•ä¾¡çµæœãŒæ¯å›ç•°ãªã‚‹ | LLMã®éæ±ºå®šæ€§ | `temperature=0`è¨­å®šã€è¤‡æ•°å›å®Ÿè¡Œã®å¹³å‡å€¤ã‚’ä½¿ç”¨ |
| Trajectoryè©•ä¾¡ã§strictä¸€è‡´ã—ãªã„ | ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè¡Œé †åºãŒéæ±ºå®šçš„ | unorderedã¾ãŸã¯subsetãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´ |
| è©•ä¾¡ã‚³ã‚¹ãƒˆãŒæœ¬ç•ªã‚³ã‚¹ãƒˆã‚’ä¸Šå›ã‚‹ | LLM-as-judgeè©•ä¾¡ãŒé«˜ã‚³ã‚¹ãƒˆ | ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯è©•ä¾¡ã‚’å„ªå…ˆã—ã€LLM-as-judgeã¯ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚° |
| CI/CDã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãŒå¤§ãã™ãã‚‹ | golden setã‚’50-100ä»¶ã«çµã‚Šã€å…¨é‡ãƒ†ã‚¹ãƒˆã¯é€±æ¬¡ã§å®Ÿè¡Œ |
| RAGASå¤‰æ›ã§ã‚¨ãƒ©ãƒ¼ | LangGraphã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼ã®äº’æ›æ€§ | `convert_to_ragas_messages`ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªï¼ˆRAGAS v0.3.0+ãŒå¿…è¦ï¼‰ |
| effortãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®åŠ¹æœãŒä¸æ˜ | é©åˆ‡ãªãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãŒãªã„ | ã¾ãšå…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆeffort=mediumã§æ¸¬å®šã—ã€ãã“ã‹ã‚‰ã‚°ãƒªãƒƒãƒ‰ã‚µãƒ¼ãƒ |

## ã¾ã¨ã‚ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

**ã¾ã¨ã‚:**

- ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã®è©•ä¾¡ã¯**3å±¤**ï¼ˆSingle Step / Trajectory / Final Responseï¼‰ã§æ§‹æˆã—ã€å„å±¤ã§ç•°ãªã‚‹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’æ¸¬å®šã™ã‚‹
- `agentevals`ã®**4ã¤ã®ãƒãƒƒãƒãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰**ï¼ˆstrict / unordered / subset / LLM-as-judgeï¼‰ã‚’ä½¿ã„åˆ†ã‘ã€ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå›ºæœ‰ã®éæ±ºå®šæ€§ã«å¯¾å¿œã™ã‚‹
- **ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹**ï¼ˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ãƒ»ãƒãƒ³ãƒ‰ã‚ªãƒ•æ­£ç¢ºæ€§ãƒ»ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ´»ç”¨ç‡ãƒ»å†—é•·å‘¼ã³å‡ºã—ç‡ï¼‰ã«ã‚ˆã‚Šã€æ¨™æº–ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§ã¯æ¸¬å®šã§ããªã„å”èª¿å“è³ªã‚’å®šé‡åŒ–ã™ã‚‹
- **Ablation study**ã§å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®é™ç•Œè²¢çŒ®åº¦ã‚’æ¸¬å®šã—ã€ãƒ‘ãƒ¬ãƒ¼ãƒˆãƒ•ãƒ­ãƒ³ãƒ†ã‚£ã‚¢ä¸Šã®æœ€é©æ§‹æˆã‚’ç‰¹å®šã™ã‚‹
- Claude Sonnet 4.6ã®**effortãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**ã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå˜ä½ã§è¨­å®šã—ã€ã‚³ã‚¹ãƒˆ-ç²¾åº¦ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã‚’åˆ¶å¾¡ã™ã‚‹

**æ¬¡ã«ã‚„ã‚‹ã¹ãã“ã¨:**

1. LangSmithã«è©•ä¾¡ç”¨ã®golden datasetã‚’50ä»¶ä»¥ä¸Šç™»éŒ²ã™ã‚‹ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®æ­£è§£ãƒ‡ãƒ¼ã‚¿ãŒæœ€ã‚‚é‡è¦ï¼‰
2. 3å±¤è©•ä¾¡ã®ã†ã¡Layer 1ï¼ˆSingle Stepï¼‰ã‹ã‚‰å°å…¥ã‚’é–‹å§‹ã™ã‚‹ï¼ˆæœ€ã‚‚ã‚³ã‚¹ãƒˆãŒä½ãã€åŠ¹æœãŒé«˜ã„ï¼‰
3. GitHub Actionsã«CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’è¿½åŠ ã—ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå¤‰æ›´æ™‚ã®å“è³ªã‚²ãƒ¼ãƒˆã‚’è‡ªå‹•åŒ–ã™ã‚‹

## å‚è€ƒ

- [LangSmith Evaluation Platform](https://www.langchain.com/langsmith/evaluation) - LangSmithã®è©•ä¾¡ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [Benchmarking Multi-Agent Architectures (LangChain Blog)](https://blog.langchain.com/benchmarking-multi-agent-architectures/) - Ï„-benchã‚’ä½¿ã£ãŸãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ç ”ç©¶
- [MAESTRO: Multi-Agent Evaluation Suite (arXiv:2601.00481)](https://arxiv.org/abs/2601.00481) - ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè©•ä¾¡ã‚¹ã‚¤ãƒ¼ãƒˆã®å­¦è¡“è«–æ–‡
- [agentevals (GitHub)](https://github.com/langchain-ai/agentevals) - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè»Œè·¡è©•ä¾¡ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- [LangSmith CI/CD Pipeline Example](https://docs.langchain.com/langsmith/cicd-pipeline-example) - è©•ä¾¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹å®Ÿè£…
- [Application-specific evaluation approaches (LangChain Docs)](https://docs.langchain.com/langsmith/evaluation-approaches) - Final Response / Single Step / Trajectory ã®3å±¤è©•ä¾¡ã®è§£èª¬
- [RAGAS LangGraph Agent Evaluation](https://docs.ragas.io/en/v0.3.0/howtos/integrations/_langgraph_agent_evaluation/) - RAGASã«ã‚ˆã‚‹LangGraphã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè©•ä¾¡ã®çµ±åˆã‚¬ã‚¤ãƒ‰
- [DeepEval LangGraph Integration](https://deepeval.com/integrations/frameworks/langgraph) - DeepEvalã®LangGraphçµ±åˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [Claude Sonnet 4.6 æ–°æ©Ÿèƒ½](https://platform.claude.com/docs/en/about-claude/models/whats-new-claude-4-6) - Adaptive Thinkingã¨effortãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®APIä»•æ§˜

## é–¢é€£ã™ã‚‹1æ¬¡æƒ…å ±è¨˜äº‹

ã“ã®è¨˜äº‹ã§å‚ç…§ã—ã¦ã„ã‚‹è«–æ–‡ãƒ»æŠ€è¡“ãƒ–ãƒ­ã‚°ã®è©³ç´°è§£èª¬è¨˜äº‹ã§ã™ã€‚

- [è«–æ–‡è§£èª¬: MAESTRO â€” Multi-Agent Evaluation and Testing for Real-world Orchestration (arXiv:2601.00481)](https://0h-n0.github.io/blog/paper/arxiv/2026/02/22/paper-2601-00481.html) - ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®å®‰å…¨æ€§ãƒ»ä¿¡é ¼æ€§ã‚’è©•ä¾¡ã™ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- [ICLR 2025è«–æ–‡è§£èª¬: JudgeBench â€” LLM-as-Judgeã®è©•ä¾¡ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ (arXiv:2410.12784)](https://0h-n0.github.io/blog/paper/conference/2026/02/22/paper-2410-12784.html) - LLM-based Judgeã®åˆ¤å®šç²¾åº¦ã‚’4é ˜åŸŸã§ä½“ç³»è©•ä¾¡
- [è«–æ–‡è§£èª¬: ARES â€” RAGã‚·ã‚¹ãƒ†ãƒ ã®è‡ªå‹•è©•ä¾¡ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ (arXiv:2311.09476)](https://0h-n0.github.io/blog/paper/arxiv/2026/02/22/paper-2405-15793.html) - PPIçµ±è¨ˆæ‰‹æ³•ã§å°‘æ•°ãƒ©ãƒ™ãƒ«ã‹ã‚‰RAGã‚’è‡ªå‹•è©•ä¾¡
- [è«–æ–‡è§£èª¬: LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè©•ä¾¡ãƒ»ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã®åŒ…æ‹¬çš„ã‚µãƒ¼ãƒ™ã‚¤ (KDD 2025, arXiv:2507.21504)](https://0h-n0.github.io/blog/paper/arxiv/2026/02/22/paper-2507-21504.html) - 150+ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’ä½“ç³»åŒ–ã—ãŸåŒ…æ‹¬çš„ã‚µãƒ¼ãƒ™ã‚¤
- [ICLR 2025 Spotlightè«–æ–‡è§£èª¬: TheAgentCompany â€” å®Ÿä¸–ç•Œã‚¿ã‚¹ã‚¯ã§ã®LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ (arXiv:2412.14161)](https://0h-n0.github.io/blog/paper/conference/2026/02/22/conf-theagentcompany-2412-14161.html) - ä¼æ¥­ç’°å¢ƒã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè©•ä¾¡

---

:::message
ã“ã®è¨˜äº‹ã¯AIï¼ˆClaude Codeï¼‰ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å†…å®¹ã®æ­£ç¢ºæ€§ã«ã¤ã„ã¦ã¯è¤‡æ•°ã®æƒ…å ±æºã§æ¤œè¨¼ã—ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã®åˆ©ç”¨æ™‚ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚ã”ç¢ºèªãã ã•ã„ã€‚
:::
