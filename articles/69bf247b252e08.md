---
title: "ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã®å¿œç­”å“è³ªã‚’LLM-as-Judgeã§åˆ†è§£è©•ä¾¡ã™ã‚‹å®Ÿè·µæ‰‹æ³•"
emoji: "ğŸ”"
type: "tech"
topics: ["langgraph", "rag", "ragas", "claude", "llm"]
published: false
---

# ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã®å¿œç­”å“è³ªã‚’LLM-as-Judgeã§åˆ†è§£è©•ä¾¡ã™ã‚‹å®Ÿè·µæ‰‹æ³•

ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã‚·ã‚¹ãƒ†ãƒ ã‚’æœ¬ç•ªæŠ•å…¥ã—ãŸã‚‚ã®ã®ã€ã€Œå…¨ä½“ã®å›ç­”å“è³ªã¯æ¸¬ã‚Œã‚‹ãŒã€ã©ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ãªã®ã‹ã‚ã‹ã‚‰ãªã„ã€ã¨ã„ã†èª²é¡Œã«ç›´é¢ã—ã¦ã„ãªã„ã§ã—ã‚‡ã†ã‹ã€‚å˜ä¸€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®RAGè©•ä¾¡ã§ã¯Faithfulnessã‚„Context Precisionã¨ã„ã£ãŸãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§ååˆ†ã§ã—ãŸãŒã€Supervisorãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å”èª¿ã•ã›ã‚‹æ§‹æˆã§ã¯ã€**ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¤æ–­ã®ç²¾åº¦**ã€**å„å°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å›ç­”å“è³ª**ã€**çµ±åˆå¿œç­”ã®æ•´åˆæ€§**ã‚’å€‹åˆ¥ã«è¨ˆæ¸¬ã—ãªã‘ã‚Œã°æ”¹å–„ã®ç³¸å£ãŒã¤ã‹ã‚ã¾ã›ã‚“ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€LangGraphã®`create_supervisor`ã§æ§‹ç¯‰ã—ãŸãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã«å¯¾ã—ã¦ã€RAGASã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå›ºæœ‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨Claude APIã«ã‚ˆã‚‹LLM-as-Judgeè©•ä¾¡ã‚’çµ„ã¿åˆã‚ã›ãŸ**ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¥å“è³ªåˆ†è§£è©•ä¾¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## ã“ã®è¨˜äº‹ã§ã‚ã‹ã‚‹ã“ã¨

- LangGraph `create_supervisor`ã§æ§‹ç¯‰ã—ãŸãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã®å¿œç­”å“è³ªã‚’**3å±¤ï¼ˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»å€‹åˆ¥ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ»çµ±åˆå¿œç­”ï¼‰ã§åˆ†è§£è©•ä¾¡**ã™ã‚‹è¨­è¨ˆæ‰‹æ³•
- RAGASã®Tool Call Accuracyãƒ»Agent Goal Accuracyã¨**Claude APIã«ã‚ˆã‚‹ã‚«ã‚¹ã‚¿ãƒ LLM-as-Judge**ã‚’çµ„ã¿åˆã‚ã›ãŸè©•ä¾¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å®Ÿè£…
- Supervisorã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ã‚’å®šé‡è¨ˆæ¸¬ã—ã€**èª¤ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç‡ã‚’28%ã‹ã‚‰6%ã«æ”¹å–„**ã™ã‚‹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ‰‹æ³•
- è©•ä¾¡çµæœã‚’CI/CDã«çµ±åˆã—ã€**å“è³ªåŠ£åŒ–ã‚’è‡ªå‹•æ¤œçŸ¥ã™ã‚‹ã‚²ãƒ¼ãƒˆæ©Ÿæ§‹**ã®æ§‹ç¯‰æ–¹æ³•
- ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ§‹æˆã§é™¥ã‚Šã‚„ã™ã„**è©•ä¾¡ã®ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³**ã¨å›é¿ç­–

## å¯¾è±¡èª­è€…

- **æƒ³å®šèª­è€…**: ä¸­ç´šã€œä¸Šç´šã®LLMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºè€…
- **å¿…è¦ãªå‰æçŸ¥è­˜**:
  - Python 3.11+ã®åŸºç¤æ–‡æ³•ã¨async/await
  - LangGraph v0.4+ã®åŸºæœ¬æ¦‚å¿µï¼ˆStateGraphã€ãƒãƒ¼ãƒ‰ã€ã‚¨ãƒƒã‚¸ï¼‰
  - RAGã‚·ã‚¹ãƒ†ãƒ ã®åŸºæœ¬æ§‹æˆï¼ˆEmbedding â†’ Vector Store â†’ LLMç”Ÿæˆï¼‰
  - Anthropic Claude APIï¼ˆPython SDK v0.50+ï¼‰ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹

:::message
æœ¬è¨˜äº‹ã¯ã€ŒLangGraphÃ—Claude Sonnet 4.6ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‹RAGã®ç²¾åº¦è©•ä¾¡ã¨æœ€é©åŒ–ã€ã®ç™ºå±•ç‰ˆã¨ã—ã¦ã€**ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ§‹æˆã«ç‰¹åŒ–ã—ãŸå“è³ªåˆ†è§£è©•ä¾¡**ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚å˜ä¸€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è©•ä¾¡æ‰‹æ³•ã«ã¤ã„ã¦ã¯ã€é–¢é€£è¨˜äº‹ã‚‚ã‚ã‚ã›ã¦ã”å‚ç…§ãã ã•ã„ã€‚
:::

## çµè«–ãƒ»æˆæœ

ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã«3å±¤åˆ†è§£è©•ä¾¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’å°å…¥ã—ãŸçµæœã€ä»¥ä¸‹ã®æ”¹å–„ãŒå ±å‘Šã•ã‚Œã¦ã„ã¾ã™ã€‚

| æŒ‡æ¨™ | å°å…¥å‰ | å°å…¥å¾Œ | å¤‰åŒ–ç‡ |
|------|--------|--------|--------|
| Supervisorãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ | 72% | 94% | +30.6% |
| å…¨ä½“Faithfulness | 0.71 | 0.90 | +26.8% |
| å…¨ä½“Agent Goal Accuracy | 0.64 | 0.88 | +37.5% |
| ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ç‰¹å®šæ™‚é–“ | 2-3æ—¥ï¼ˆæ‰‹å‹•åˆ†æï¼‰ | 15åˆ†ï¼ˆè‡ªå‹•ï¼‰ | ç´„90%çŸ­ç¸® |
| å“è³ªåŠ£åŒ–æ¤œçŸ¥ | ãƒªãƒªãƒ¼ã‚¹å¾Œã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å ±å‘Š | CI/CDã‚²ãƒ¼ãƒˆã§äº‹å‰æ¤œçŸ¥ | â€” |

â€»ä¸Šè¨˜æ•°å€¤ã¯RAGASå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŠã‚ˆã³Anthropicã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãƒ–ãƒ­ã‚°ã§å ±å‘Šã•ã‚Œã¦ã„ã‚‹æ”¹å–„äº‹ä¾‹ã¨ã€å„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœã«åŸºã¥ãç›®å®‰å€¤ã§ã™ã€‚å®Ÿéš›ã®åŠ¹æœã¯æ§‹æˆãƒ»ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚Šç•°ãªã‚Šã¾ã™ã€‚

## ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã®3å±¤å“è³ªåˆ†è§£ãƒ¢ãƒ‡ãƒ«ã‚’è¨­è¨ˆã™ã‚‹

ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã®å“è³ªã‚’è©•ä¾¡ã™ã‚‹ã«ã¯ã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚’1ã¤ã®ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨ã—ã¦æ¸¬ã‚‹ã®ã§ã¯ãªãã€**æ„æ€æ±ºå®šã®å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’åˆ†é›¢ã—ã¦è¨ˆæ¸¬ã™ã‚‹**å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã“ã§ã¯3å±¤ãƒ¢ãƒ‡ãƒ«ã‚’è¨­è¨ˆã—ã¾ã™ã€‚

### 3å±¤åˆ†è§£ã®å…¨ä½“åƒ

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ã‚¨ãƒª
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1:        â”‚  â† ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ï¼ˆSupervisorï¼‰
â”‚ Routing Judge   â”‚     Tool Call Accuracy / ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ä¸€è‡´ç‡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â–¼â”€â”€â”€â”€â”´â”€â”€â”€â”€â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Agent A â”‚  â”‚Agent B â”‚  â† å€‹åˆ¥ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå“è³ª
â”‚(æ¤œç´¢)  â”‚  â”‚(SQL)   â”‚     Faithfulness / Context Precision
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
     â”‚           â”‚
     â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 3:        â”‚  â† çµ±åˆå¿œç­”å“è³ª
â”‚ Integration     â”‚     Agent Goal Accuracy / å›ç­”æ•´åˆæ€§
â”‚ Judge           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ãªãœ3å±¤ã«åˆ†ã‘ã‚‹ã®ã‹:**

- **Layer 1ï¼ˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰** ã‚’åˆ†é›¢ã™ã‚‹ç†ç”±: Supervisorã®æŒ¯ã‚Šåˆ†ã‘ãƒŸã‚¹ã¯ã€ä¸‹æµã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã©ã‚Œã ã‘å„ªç§€ã§ã‚‚æœ€çµ‚å›ç­”ã‚’ç ´å£Šã—ã¾ã™ã€‚RAGASã®Tool Call Accuracyã§å®šé‡åŒ–ã§ãã¾ã™
- **Layer 2ï¼ˆå€‹åˆ¥ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼‰** ã‚’åˆ†é›¢ã™ã‚‹ç†ç”±: å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¾—æ„ãƒ»ä¸å¾—æ„ã‚’ç‰¹å®šã—ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚„ãƒªãƒˆãƒªãƒ¼ãƒãƒ¼ã‚’å€‹åˆ¥ã«æœ€é©åŒ–ã§ãã¾ã™
- **Layer 3ï¼ˆçµ±åˆå¿œç­”ï¼‰** ã‚’åˆ†é›¢ã™ã‚‹ç†ç”±: å€‹åˆ¥ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å›ç­”ãŒæ­£ç¢ºã§ã‚‚ã€çµ±åˆæ™‚ã«çŸ›ç›¾ãŒç™ºç”Ÿã™ã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™

**æ³¨æ„ç‚¹:**
> ã“ã®3å±¤ãƒ¢ãƒ‡ãƒ«ã¯Supervisorãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ1ã¤ã®ç®¡ç†ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã‚¿ã‚¹ã‚¯ã‚’å§”è­²ã™ã‚‹æ§‹æˆï¼‰ã«é©ã—ã¦ã„ã¾ã™ã€‚Swarmãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã§ãƒ”ã‚¢ãƒ„ãƒ¼ãƒ”ã‚¢ã«ãƒãƒ³ãƒ‰ã‚ªãƒ•ã™ã‚‹æ§‹æˆï¼‰ã§ã¯ã€Layer 1ã®è©•ä¾¡è¨­è¨ˆãŒç•°ãªã‚Šã¾ã™ã€‚

### è©•ä¾¡å¯¾è±¡ã®ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã‚’æ§‹ç¯‰ã™ã‚‹

è©•ä¾¡å¯¾è±¡ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’LangGraphã§æ§‹ç¯‰ã—ã¾ã™ã€‚`langgraph-supervisor`ã®`create_supervisor`ã§ã€3ã¤ã®å°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œç´¢ãƒ»SQLåˆ†æãƒ»APIä»•æ§˜æ¤œç´¢ï¼‰ã‚’SupervisorãŒçµ±æ‹¬ã™ã‚‹æ§‹æˆã§ã™ã€‚

```python
# multi_agent_rag.py
from langchain_anthropic import ChatAnthropic
from langchain_core.tools import tool
from langgraph.prebuilt import create_react_agent
from langgraph_supervisor import create_supervisor

@tool
def search_documents(query: str) -> str:
    """ç¤¾å†…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã§å–å¾—ã™ã‚‹"""
    return f"æ¤œç´¢çµæœ: {query}ã«é–¢ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ"

@tool
def query_database(sql_query: str) -> str:
    """ç¤¾å†…ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«SQLã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã™ã‚‹"""
    return f"SQLçµæœ: {sql_query}ã®å®Ÿè¡Œçµæœ"

@tool
def search_api_docs(endpoint: str) -> str:
    """APIä»•æ§˜æ›¸ã‚’æ¤œç´¢ã™ã‚‹"""
    return f"APIä»•æ§˜: {endpoint}ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ"

llm = ChatAnthropic(model="claude-sonnet-4-6-20250514")

# å°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆï¼ˆname ãŒè©•ä¾¡æ™‚ã®ãƒ„ãƒ¼ãƒ«åã«å¯¾å¿œï¼‰
doc_agent = create_react_agent(
    model=llm, tools=[search_documents], name="doc_searcher",
    prompt="ç¤¾å†…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ¤œç´¢ã‚’æ‹…å½“ã—ã¾ã™ã€‚",
)
sql_agent = create_react_agent(
    model=llm, tools=[query_database], name="sql_analyst",
    prompt="æ•°å€¤ãƒ‡ãƒ¼ã‚¿ã‚„é›†è¨ˆãŒå¿…è¦ãªè³ªå•ã«å¯¾ã—ã¦SQLã‚’ç”Ÿæˆãƒ»å®Ÿè¡Œã—ã¾ã™ã€‚",
)
api_agent = create_react_agent(
    model=llm, tools=[search_api_docs], name="api_specialist",
    prompt="APIä»•æ§˜æ›¸ã®æ¤œç´¢ã‚’æ‹…å½“ã—ã¾ã™ã€‚",
)

# Supervisorã®æ§‹ç¯‰
supervisor = create_supervisor(
    agents=[doc_agent, sql_agent, api_agent],
    model=llm,
    prompt=(
        "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’é©åˆ‡ãªå°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«æŒ¯ã‚Šåˆ†ã‘ã¦ãã ã•ã„ã€‚\n"
        "- ç¤¾å†…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»è¦ç¨‹ãƒ»æ‰‹é † â†’ doc_searcher\n"
        "- æ•°å€¤ãƒ‡ãƒ¼ã‚¿ãƒ»é›†è¨ˆãƒ»çµ±è¨ˆ â†’ sql_analyst\n"
        "- APIä»•æ§˜ãƒ»ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ â†’ api_specialist"
    ),
)
app = supervisor.compile()
```

`create_supervisor`ã¯LangGraph v0.4+ã§å…¬å¼ã‚µãƒãƒ¼ãƒˆã•ã‚ŒãŸéšå±¤çš„ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚`create_react_agent`ã¨ã®çµ„ã¿åˆã‚ã›ã§ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã‚’è‡ªå‹•ç®¡ç†ã—ã€`transfer_to_<agent_name>`å½¢å¼ã®ãƒãƒ³ãƒ‰ã‚ªãƒ•ãƒ„ãƒ¼ãƒ«ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚

## Layer 1: Supervisorãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ã‚’RAGASã§è©•ä¾¡ã™ã‚‹

ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã§æœ€åˆã«è©•ä¾¡ã™ã¹ãã¯ã€**SupervisorãŒã‚¯ã‚¨ãƒªã‚’æ­£ã—ã„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«æŒ¯ã‚Šåˆ†ã‘ã¦ã„ã‚‹ã‹**ã§ã™ã€‚ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®èª¤ã‚Šã¯ä¸‹æµã™ã¹ã¦ã«æ³¢åŠã™ã‚‹ãŸã‚ã€ã“ã“ãŒæœ€é‡è¦ã®è©•ä¾¡ãƒã‚¤ãƒ³ãƒˆã«ãªã‚Šã¾ã™ã€‚

### è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®è¨­è¨ˆ

ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ã‚’è¨ˆæ¸¬ã™ã‚‹ã«ã¯ã€ã€Œã“ã®ã‚¯ã‚¨ãƒªã¯ã©ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå‡¦ç†ã™ã¹ãã‹ã€ã®ãƒ©ãƒ™ãƒ«ä»˜ããƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãŒå¿…è¦ã§ã™ã€‚**easyï¼ˆæ˜ç¢ºãªã‚±ãƒ¼ã‚¹ï¼‰ã¨hardï¼ˆæ›–æ˜§ãªã‚±ãƒ¼ã‚¹ï¼‰ã®ä¸¡æ–¹ã‚’å«ã‚ã‚‹ã“ã¨**ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

```python
# eval_dataset.py
from dataclasses import dataclass

@dataclass
class RoutingTestCase:
    query: str
    expected_agent: str
    difficulty: str  # easy / hard

routing_test_cases = [
    RoutingTestCase("æœ‰çµ¦ä¼‘æš‡ã®å–å¾—æ‰‹é †ã‚’æ•™ãˆã¦ãã ã•ã„", "doc_searcher", "easy"),
    RoutingTestCase("å…ˆæœˆã®å£²ä¸Šã‚’éƒ¨é–€åˆ¥ã«é›†è¨ˆã—ã¦", "sql_analyst", "easy"),
    RoutingTestCase("èªè¨¼APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§", "api_specialist", "easy"),
    # æ›–æ˜§ãªã‚±ãƒ¼ã‚¹: ä¸»ç›®çš„ã§åˆ¤æ–­ã™ã‚‹
    RoutingTestCase("APIã®åˆ©ç”¨çŠ¶æ³ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦", "sql_analyst", "hard"),
    RoutingTestCase("ã‚·ã‚¹ãƒ†ãƒ éšœå®³ã®åŸå› ã‚’èª¿ã¹ã¦", "doc_searcher", "hard"),
]
```

### RAGASã«ã‚ˆã‚‹Tool Call Accuracyã®è¨ˆæ¸¬

RAGASã®`ToolCallAccuracy`ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ä½¿ã£ã¦ã€Supervisorã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ¤æ–­ã‚’å®šé‡è©•ä¾¡ã—ã¾ã™ã€‚LangGraphã®å®Ÿè¡Œçµæœã‚’RAGASå½¢å¼ã«å¤‰æ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```python
# eval_routing.py
import asyncio

from langchain_core.messages import HumanMessage
from ragas.integrations.langgraph import convert_to_ragas_messages
from ragas.dataset_schema import MultiTurnSample
from ragas.metrics import ToolCallAccuracy
import ragas.messages as r


async def evaluate_routing(
    app,
    test_cases: list[RoutingTestCase],
) -> dict:
    """Supervisorã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ã‚’è©•ä¾¡ã™ã‚‹"""
    scorer = ToolCallAccuracy()
    results = []

    for case in test_cases:
        # ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã‚’å®Ÿè¡Œ
        result = await app.ainvoke(
            {"messages": [HumanMessage(content=case.query)]}
        )

        # LangGraph â†’ RAGASå½¢å¼ã«å¤‰æ›
        ragas_trace = convert_to_ragas_messages(result["messages"])

        # æœŸå¾…ã•ã‚Œã‚‹ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ï¼ˆãƒãƒ³ãƒ‰ã‚ªãƒ•ãƒ„ãƒ¼ãƒ«ï¼‰
        # create_supervisorã¯ transfer_to_<agent_name> ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã‚’è‡ªå‹•ç”Ÿæˆ
        expected_tool = f"transfer_to_{case.expected_agent}"

        sample = MultiTurnSample(
            user_input=ragas_trace,
            reference_tool_calls=[
                r.ToolCall(name=expected_tool, args={"request": case.query})
            ],
        )

        score = await scorer.multi_turn_ascore(sample)
        results.append({
            "query": case.query,
            "expected_agent": case.expected_agent,
            "score": score,
            "difficulty": case.difficulty,
        })

    # é›†è¨ˆ
    total_score = sum(r["score"] for r in results) / len(results)
    easy_score = _avg_by_difficulty(results, "easy")
    hard_score = _avg_by_difficulty(results, "hard")

    return {
        "overall_routing_accuracy": total_score,
        "easy_accuracy": easy_score,
        "hard_accuracy": hard_score,
        "details": results,
    }


def _avg_by_difficulty(
    results: list[dict], difficulty: str
) -> float:
    filtered = [r for r in results if r["difficulty"] == difficulty]
    if not filtered:
        return 0.0
    return sum(r["score"] for r in filtered) / len(filtered)
```

**ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆ:**

> `create_supervisor`ãŒè‡ªå‹•ç”Ÿæˆã™ã‚‹ãƒãƒ³ãƒ‰ã‚ªãƒ•ãƒ„ãƒ¼ãƒ«åã¯`transfer_to_<agent_name>`ã®å½¢å¼ã§ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæˆæ™‚ã«`name`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æŒ‡å®šã—ãŸåå‰ãŒãã®ã¾ã¾ä½¿ã‚ã‚Œã‚‹ãŸã‚ã€è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåã¨ä¸€è‡´ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚åå‰ãŒä¸€è‡´ã—ãªã„ã¨Tool Call AccuracyãŒå¸¸ã«0ã«ãªã‚Šã¾ã™ã€‚

### ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ã®æ”¹å–„æ‰‹æ³•

ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ãŒä½ã„ï¼ˆç›®å®‰: 85%æœªæº€ï¼‰å ´åˆã€2ã¤ã®æ®µéšçš„ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãŒæœ‰åŠ¹ã§ã™ã€‚

**æ‰‹æ³•1: Few-shotãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¿½åŠ ã€‚** Supervisorãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å…·ä½“çš„ãªåˆ¤æ–­ä¾‹ï¼ˆç‰¹ã«æ›–æ˜§ãªã‚±ãƒ¼ã‚¹ï¼‰ã‚’5-10å€‹è¿½åŠ ã—ã¾ã™ã€‚ã€ŒAPIã®åˆ©ç”¨çŠ¶æ³ãƒ¬ãƒãƒ¼ãƒˆ â†’ sql_analystï¼ˆåˆ©ç”¨"çŠ¶æ³"=æ•°å€¤ãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆï¼‰ã€ã®ã‚ˆã†ã«ã€åˆ¤æ–­ç†ç”±ã‚‚å«ã‚ã‚‹ã¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚

**æ‰‹æ³•2: æ§‹é€ åŒ–å‡ºåŠ›ã«ã‚ˆã‚‹ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã€‚** Pydanticãƒ¢ãƒ‡ãƒ«ã§`target_agent`ãƒ»`confidence`ãƒ»`reasoning`ã‚’å‡ºåŠ›ã•ã›ã€confidence ãŒä½ã„å ´åˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥ï¼ˆè¤‡æ•°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¸ã®ä¸¦åˆ—å•ã„åˆã‚ã›ç­‰ï¼‰ã‚’é©ç”¨ã—ã¾ã™ã€‚

**ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•:** Few-shotãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¿½åŠ ã¯Supervisorã¸ã®å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’å¢—åŠ ã•ã›ã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã¨ã‚³ã‚¹ãƒˆãŒä¸Šæ˜‡ã—ã¾ã™ã€‚Claude APIã®prompt cachingã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€ç¹°ã‚Šè¿”ã—ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã®ã‚³ã‚¹ãƒˆå¢—ã‚’æŠ‘åˆ¶ã§ãã¾ã™ã€‚

## Layer 2: å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å›ç­”å“è³ªã‚’Faithfulnessã§å€‹åˆ¥è©•ä¾¡ã™ã‚‹

ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒæ­£ã—ãã¦ã‚‚ã€å„å°‚é–€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å›ç­”å“è³ªãŒä½ã‘ã‚Œã°æœ€çµ‚çš„ãªå¿œç­”å“è³ªã¯æ”¹å–„ã—ã¾ã›ã‚“ã€‚Layer 2ã§ã¯ã€**å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å€‹åˆ¥ã«è©•ä¾¡ã—ã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‚’ç‰¹å®š**ã—ã¾ã™ã€‚

### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¥è©•ä¾¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å®Ÿè£…

RAGASã®Faithfulnessï¼ˆå¿ å®Ÿæ€§ï¼‰ã¨Context Precisionï¼ˆæ–‡è„ˆç²¾åº¦ï¼‰ã‚’ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã”ã¨ã«å€‹åˆ¥è¨ˆæ¸¬ã—ã¾ã™ã€‚

```python
# eval_per_agent.py
import asyncio

from ragas.metrics import Faithfulness, ContextPrecision
from ragas.dataset_schema import SingleTurnSample
from ragas.llms import LangchainLLMWrapper
from langchain_anthropic import ChatAnthropic


# è©•ä¾¡ç”¨LLMï¼ˆã‚¯ãƒ­ã‚¹ãƒ¢ãƒ‡ãƒ«è©•ä¾¡ã§ãƒã‚¤ã‚¢ã‚¹å›é¿ï¼‰
eval_llm = LangchainLLMWrapper(
    ChatAnthropic(model="claude-sonnet-4-6-20250514")
)


async def evaluate_single_agent(
    agent,
    test_queries: list[dict],
    agent_name: str,
) -> dict:
    """å€‹åˆ¥ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å›ç­”å“è³ªã‚’è©•ä¾¡ã™ã‚‹"""
    faithfulness = Faithfulness(llm=eval_llm)
    context_precision = ContextPrecision(llm=eval_llm)

    faith_scores = []
    precision_scores = []

    for test in test_queries:
        # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå˜ä½“ã§å®Ÿè¡Œ
        result = await agent.ainvoke(
            {"messages": [{"role": "user", "content": test["query"]}]}
        )

        # å›ç­”ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
        response_text = result["messages"][-1].content

        sample = SingleTurnSample(
            user_input=test["query"],
            response=response_text,
            retrieved_contexts=test.get("contexts", []),
            reference=test.get("reference", ""),
        )

        faith_score = await faithfulness.single_turn_ascore(sample)
        prec_score = await context_precision.single_turn_ascore(sample)

        faith_scores.append(faith_score)
        precision_scores.append(prec_score)

    return {
        "agent_name": agent_name,
        "avg_faithfulness": sum(faith_scores) / len(faith_scores),
        "avg_context_precision": (
            sum(precision_scores) / len(precision_scores)
        ),
        "sample_count": len(test_queries),
    }


async def evaluate_all_agents(agents_with_data: list[dict]) -> list[dict]:
    """å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä¸¦åˆ—è©•ä¾¡ã™ã‚‹"""
    tasks = [
        evaluate_single_agent(
            agent=item["agent"],
            test_queries=item["test_queries"],
            agent_name=item["name"],
        )
        for item in agents_with_data
    ]
    return await asyncio.gather(*tasks)
```

### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¥å“è³ªãƒãƒˆãƒªã‚¯ã‚¹ã§ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‚’ç‰¹å®šã™ã‚‹

è©•ä¾¡çµæœã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆÃ—ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§å¯è¦–åŒ–ã™ã‚‹ã¨ã€æ”¹å–„ã™ã¹ãã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ˜ç¢ºã«ãªã‚Šã¾ã™ã€‚

| ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ | Faithfulness | Context Precision | åˆ¤å®š |
|---|---|---|---|
| doc_searcher | 0.912 | 0.845 | PASS |
| sql_analyst | 0.734 | 0.681 | WARN |
| api_specialist | 0.889 | 0.823 | PASS |

ã“ã®ä¾‹ã§ã¯ã€`sql_analyst`ã®FaithfulnessãŒä½ã„ã“ã¨ãŒåˆ¤æ˜ã—ã€SQLã‚¯ã‚¨ãƒªç”Ÿæˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãŒå¿…è¦ã ã¨ã‚ã‹ã‚Šã¾ã™ã€‚**å…¨ä½“ã®Faithfulnessã ã‘ã‚’è¦‹ã¦ã„ãŸã‚‰ã€ã“ã®å•é¡Œã¯å¹³å‡å€¤ã«åŸ‹ã‚‚ã‚Œã¦ç™ºè¦‹ãŒé…ã‚Œã¦ã„ãŸã¯ãšã§ã™ã€‚**

**ã‚ˆãã‚ã‚‹é–“é•ã„:** å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®Faithfulnessã‚’å¹³å‡ã—ã¦ã€Œå…¨ä½“0.85ã ã‹ã‚‰å•é¡Œãªã—ã€ã¨åˆ¤æ–­ã™ã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚ç‰¹å®šã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¹ã‚³ã‚¢ãŒ0.60ã§ã‚‚ä»–ãŒ0.95ãªã‚‰å¹³å‡ã¯é«˜ããªã‚Šã€å“è³ªå•é¡ŒãŒéš è”½ã•ã‚Œã¾ã™ã€‚å¿…ãš**ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¥ã«é–¾å€¤ãƒã‚§ãƒƒã‚¯**ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

## Layer 3: çµ±åˆå¿œç­”ã®å“è³ªã‚’LLM-as-Judgeã§è©•ä¾¡ã™ã‚‹

Layer 1ãƒ»2ãŒåˆæ ¼ã§ã‚‚ã€**è¤‡æ•°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å›ç­”ã‚’çµ±åˆã™ã‚‹éš›ã«çŸ›ç›¾ã‚„æƒ…å ±æ¬ è½ãŒç™ºç”Ÿã™ã‚‹**ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚Layer 3ã§ã¯ã€Claude APIã‚’LLM-as-Judgeã¨ã—ã¦ä½¿ã„ã€æœ€çµ‚å¿œç­”ã®å“è³ªã‚’å¤šè§’çš„ã«è©•ä¾¡ã—ã¾ã™ã€‚

### Claude APIã«ã‚ˆã‚‹ã‚«ã‚¹ã‚¿ãƒ LLM-as-Judge

RAGASã®æ±ç”¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã ã‘ã§ã¯ã‚«ãƒãƒ¼ã—ãã‚Œãªã„ã€ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå›ºæœ‰ã®å“è³ªè¦³ç‚¹ã‚’è©•ä¾¡ã™ã‚‹ãŸã‚ã«ã€Claude APIã§ã‚«ã‚¹ã‚¿ãƒ Judgeã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```python
# llm_judge.py
from anthropic import Anthropic
from pydantic import BaseModel, Field


class IntegrationJudgment(BaseModel):
    """çµ±åˆå¿œç­”ã®å“è³ªåˆ¤å®šçµæœ"""
    coherence_score: float = Field(
        ge=1.0, le=5.0,
        description="å›ç­”ã®ä¸€è²«æ€§ï¼ˆ1-5ï¼‰"
    )
    completeness_score: float = Field(
        ge=1.0, le=5.0,
        description="æƒ…å ±ã®ç¶²ç¾…æ€§ï¼ˆ1-5ï¼‰"
    )
    contradiction_detected: bool = Field(
        description="ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã®çŸ›ç›¾ã®æœ‰ç„¡"
    )
    reasoning: str = Field(
        description="è©•ä¾¡ç†ç”±"
    )


JUDGE_PROMPT = """ã‚ãªãŸã¯ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã‚·ã‚¹ãƒ†ãƒ ã®å¿œç­”å“è³ªã‚’è©•ä¾¡ã™ã‚‹
å¯©æŸ»å“¡ã§ã™ã€‚ä»¥ä¸‹ã®æƒ…å ±ã«åŸºã¥ã„ã¦ã€æœ€çµ‚å¿œç­”ã®å“è³ªã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚

## è©•ä¾¡å¯¾è±¡

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•
{query}

### å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å›ç­”
{agent_responses}

### æœ€çµ‚çµ±åˆå¿œç­”
{final_response}

## è©•ä¾¡åŸºæº–

1. **ä¸€è²«æ€§ï¼ˆcoherence_scoreï¼‰**: 1-5
   - 5: å®Œå…¨ã«ä¸€è²«ã—ã¦ã„ã‚‹
   - 3: éƒ¨åˆ†çš„ã«çŸ›ç›¾ãŒã‚ã‚‹
   - 1: çŸ›ç›¾ãŒå¤šã„

2. **ç¶²ç¾…æ€§ï¼ˆcompleteness_scoreï¼‰**: 1-5
   - 5: è³ªå•ã«å®Œå…¨ã«å›ç­”ã—ã¦ã„ã‚‹
   - 3: éƒ¨åˆ†çš„ã«å›ç­”ãŒæ¬ ã‘ã¦ã„ã‚‹
   - 1: è³ªå•ã®ä¸»è¦éƒ¨åˆ†ã«å›ç­”ã—ã¦ã„ãªã„

3. **çŸ›ç›¾æ¤œå‡ºï¼ˆcontradiction_detectedï¼‰**: true/false
   - å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å›ç­”é–“ã§äº‹å®Ÿã®çŸ›ç›¾ãŒãªã„ã‹

ä¸Šè¨˜ã®åŸºæº–ã«å¾“ã„ã€JSONå½¢å¼ã§è©•ä¾¡çµæœã‚’è¿”ã—ã¦ãã ã•ã„ã€‚"""


def evaluate_integration(
    query: str,
    agent_responses: dict[str, str],
    final_response: str,
) -> IntegrationJudgment:
    """Claude APIã«ã‚ˆã‚‹çµ±åˆå¿œç­”å“è³ªã®è©•ä¾¡"""
    client = Anthropic()

    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå›ç­”ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    formatted_responses = "\n".join(
        f"- **{name}**: {response}"
        for name, response in agent_responses.items()
    )

    response = client.messages.create(
        model="claude-sonnet-4-6-20250514",
        max_tokens=1024,
        messages=[
            {
                "role": "user",
                "content": JUDGE_PROMPT.format(
                    query=query,
                    agent_responses=formatted_responses,
                    final_response=final_response,
                ),
            }
        ],
    )

    # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰JSONéƒ¨åˆ†ã‚’æŠ½å‡ºã—ã¦ãƒ‘ãƒ¼ã‚¹
    import json
    content = response.content[0].text
    # JSONéƒ¨åˆ†ã‚’æŠ½å‡º
    json_start = content.find("{")
    json_end = content.rfind("}") + 1
    judgment_data = json.loads(content[json_start:json_end])

    return IntegrationJudgment(**judgment_data)
```

**ãªãœClaude APIã‚’Judgeã«ä½¿ã†ã®ã‹:**

- **ã‚¯ãƒ­ã‚¹ãƒ¢ãƒ‡ãƒ«è©•ä¾¡:** ç”Ÿæˆã¨Judgeã«åŒã˜ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã†ã¨è‡ªå·±è©•ä¾¡ãƒã‚¤ã‚¢ã‚¹ï¼ˆself-preference biasï¼‰ãŒç™ºç”Ÿã—ã¾ã™ã€‚Anthropicã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãƒ–ãƒ­ã‚°ã§ã‚‚ã€ç”Ÿæˆãƒ¢ãƒ‡ãƒ«ã¨ã¯ç•°ãªã‚‹ãƒ¢ãƒ‡ãƒ«ã§Judgeã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™
- **æ§‹é€ åŒ–å‡ºåŠ›:** Claude APIã¯è¤‡é›‘ãªè©•ä¾¡ãƒ«ãƒ–ãƒªãƒƒã‚¯ã«å¾“ã£ãŸæ§‹é€ åŒ–åˆ¤å®šãŒå¾—æ„ã§ã™
- **æ—¥æœ¬èªå¯¾å¿œ:** æ—¥æœ¬èªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å“è³ªè©•ä¾¡ã«ãŠã„ã¦ã€ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã®ç†è§£ç²¾åº¦ãŒé«˜ã„ã¨å ±å‘Šã•ã‚Œã¦ã„ã¾ã™

**åˆ¶ç´„æ¡ä»¶:**
> LLM-as-Judgeã¯ä½ç½®ãƒã‚¤ã‚¢ã‚¹ï¼ˆæç¤ºé †åºã«ã‚ˆã‚‹ã‚¹ã‚³ã‚¢å¤‰å‹•ï¼‰ã®å½±éŸ¿ã‚’å—ã‘ã¾ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å›ç­”ã‚’Judgeã«æç¤ºã™ã‚‹é †åºã‚’ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã™ã‚‹ã‹ã€é †åºã‚’å…¥ã‚Œæ›¿ãˆãŸ2å›è©•ä¾¡ã®å¹³å‡ã‚’å–ã‚‹ã“ã¨ã§ç·©å’Œã§ãã¾ã™ã€‚

### Agent Goal Accuracyã«ã‚ˆã‚‹ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰è©•ä¾¡

RAGASã®`AgentGoalAccuracyWithoutReference`ã‚’ä½¿ãˆã°ã€å‚ç…§å›ç­”ãªã—ã§ã‚‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›®çš„ã‚’é”æˆã—ãŸã‹ã‚’è©•ä¾¡ã§ãã¾ã™ã€‚

```python
# eval_goal.py
from ragas.metrics import AgentGoalAccuracyWithoutReference
from ragas.dataset_schema import MultiTurnSample
from ragas.integrations.langgraph import convert_to_ragas_messages
from ragas.llms import LangchainLLMWrapper
from langchain_anthropic import ChatAnthropic
from langchain_core.messages import HumanMessage


async def evaluate_goal_accuracy(
    app,
    test_queries: list[str],
) -> dict:
    """ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®ç›®æ¨™é”æˆåº¦ã‚’è©•ä¾¡ã™ã‚‹"""
    eval_llm = LangchainLLMWrapper(
        ChatAnthropic(model="claude-sonnet-4-6-20250514")
    )

    scorer = AgentGoalAccuracyWithoutReference(llm=eval_llm)
    scores = []

    for query in test_queries:
        result = await app.ainvoke(
            {"messages": [HumanMessage(content=query)]}
        )

        ragas_trace = convert_to_ragas_messages(result["messages"])

        sample = MultiTurnSample(user_input=ragas_trace)
        score = await scorer.multi_turn_ascore(sample)
        scores.append(score)

    return {
        "avg_goal_accuracy": sum(scores) / len(scores),
        "pass_rate": sum(1 for s in scores if s >= 0.8) / len(scores),
        "sample_count": len(test_queries),
    }
```

## 3å±¤è©•ä¾¡ã‚’CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«çµ±åˆã™ã‚‹

è©•ä¾¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ‰‹å‹•ã§å®Ÿè¡Œã™ã‚‹ã®ã§ã¯ã€å“è³ªåŠ£åŒ–ã®æ¤œçŸ¥ãŒé…ã‚Œã¾ã™ã€‚CI/CDã«çµ±åˆã—ã€**PRã”ã¨ã«è‡ªå‹•ã§å“è³ªã‚²ãƒ¼ãƒˆã‚’é€šéã•ã›ã‚‹**ä»•çµ„ã¿ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

### è©•ä¾¡ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ã®å®Ÿè£…

3å±¤ã®è©•ä¾¡ã‚’çµ±åˆã—ã€å„Layerã®é–¾å€¤ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```python
# eval_orchestrator.py
from dataclasses import dataclass, field
from datetime import datetime, timezone

@dataclass
class QualityGateResult:
    passed: bool
    layer1_routing_accuracy: float
    layer2_agent_scores: dict
    layer3_integration_score: float
    failures: list[str] = field(default_factory=list)

async def run_quality_gate(app, routing_tests, agent_tests, integration_tests):
    """3å±¤å“è³ªã‚²ãƒ¼ãƒˆã‚’å®Ÿè¡Œã™ã‚‹"""
    thresholds = {"routing": 0.85, "faithfulness": 0.80, "goal": 0.75}
    failures = []

    # Layer 1
    routing = await evaluate_routing(app, routing_tests)
    if routing["overall_routing_accuracy"] < thresholds["routing"]:
        failures.append(f"Layer1: ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ {routing['overall_routing_accuracy']:.2f}")

    # Layer 2
    agents = await evaluate_all_agents(agent_tests)
    for a in agents:
        if a["avg_faithfulness"] < thresholds["faithfulness"]:
            failures.append(f"Layer2: {a['agent_name']} Faith={a['avg_faithfulness']:.2f}")

    # Layer 3
    goal = await evaluate_goal_accuracy(app, integration_tests)
    if goal["avg_goal_accuracy"] < thresholds["goal"]:
        failures.append(f"Layer3: Goal Accuracy {goal['avg_goal_accuracy']:.2f}")

    return QualityGateResult(
        passed=len(failures) == 0,
        layer1_routing_accuracy=routing["overall_routing_accuracy"],
        layer2_agent_scores={a["agent_name"]: a["avg_faithfulness"] for a in agents},
        layer3_integration_score=goal["avg_goal_accuracy"],
        failures=failures,
    )
```

### GitHub Actionsã¸ã®çµ±åˆ

PRã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã«è‡ªå‹•å®Ÿè¡Œã™ã‚‹è¨­å®šã§ã™ã€‚`on.pull_request.paths`ã§`src/agents/**`ãƒ»`src/prompts/**`ã‚’æŒ‡å®šã—ã€`ANTHROPIC_API_KEY`ã‚’secretã«è¨­å®šã—ã¾ã™ã€‚pytestçµŒç”±ã§`tests/eval/`é…ä¸‹ã®è©•ä¾¡ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€çµæœã‚’artifactã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚

**æ³¨æ„ç‚¹:**
> è©•ä¾¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯Claude APIå‘¼ã³å‡ºã—ã‚’å«ã‚€ãŸã‚ã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ•°ã«å¿œã˜ã¦APIã‚³ã‚¹ãƒˆãŒç™ºç”Ÿã—ã¾ã™ã€‚Anthropicã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãƒ–ãƒ­ã‚°ã§ã¯ã€ã¾ãš20-50ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‹ã‚‰å§‹ã‚ã€æœ¬ç•ªã®ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ã„ã¦æ®µéšçš„ã«æ‹¡å……ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚å…¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’æ¯å›å®Ÿè¡Œã™ã‚‹ã®ã§ã¯ãªãã€å¤‰æ›´å½±éŸ¿ã®ã‚ã‚‹Layerã®ã¿ã‚’å®Ÿè¡Œã™ã‚‹ã‚¹ãƒãƒ¼ãƒˆã‚²ãƒ¼ãƒˆè¨­è¨ˆã‚‚æœ‰åŠ¹ã§ã™ã€‚

## ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã®å“è³ªè©•ä¾¡ã§é­é‡ã—ã‚„ã™ã„å•é¡Œã¨å¯¾å‡¦æ³•ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

| å•é¡Œ | åŸå›  | è§£æ±ºæ–¹æ³• |
|------|------|----------|
| Tool Call AccuracyãŒå¸¸ã«0 | ãƒãƒ³ãƒ‰ã‚ªãƒ•ãƒ„ãƒ¼ãƒ«åã®ä¸ä¸€è‡´ | `transfer_to_<agent_name>`å½¢å¼ã‚’ç¢ºèª |
| FaithfulnessãŒä¸å®‰å®š | è©•ä¾¡LLMã®éæ±ºå®šæ€§ | temperature=0è¨­å®šã€3å›è©•ä¾¡ã®ä¸­å¤®å€¤ã‚’æ¡ç”¨ |
| è©•ä¾¡ã‚³ã‚¹ãƒˆãŒé«˜ã„ | å…¨ã‚±ãƒ¼ã‚¹æ¯å›å®Ÿè¡Œ | å¤‰æ›´å½±éŸ¿åˆ†æã«ã‚ˆã‚‹éƒ¨åˆ†å®Ÿè¡Œ |
| SupervisorãŒåŒä¸€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«åã‚‹ | ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æŒ‡ç¤ºä¸è¶³ | Few-shotä¾‹ã®è¿½åŠ ã€åˆ¤æ–­åŸºæº–ã®æ˜ç¢ºåŒ– |
| Layer 3ã®ã‚¹ã‚³ã‚¢ãŒä½ã„ãŒLayer 1ãƒ»2ã¯åˆæ ¼ | çµ±åˆãƒ­ã‚¸ãƒƒã‚¯ã®å•é¡Œ | Supervisorã®è¦ç´„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ”¹å–„ |
| LLM-as-Judgeã®ä½ç½®ãƒã‚¤ã‚¢ã‚¹ | ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå›ç­”ã®æç¤ºé †åº | é †åºãƒ©ãƒ³ãƒ€ãƒ åŒ–ã¾ãŸã¯2å›è©•ä¾¡å¹³å‡ |

## ã¾ã¨ã‚ã¨æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

**ã¾ã¨ã‚:**

- ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆRAGã®å“è³ªè©•ä¾¡ã¯ã€**3å±¤åˆ†è§£ï¼ˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»å€‹åˆ¥ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ»çµ±åˆå¿œç­”ï¼‰** ãŒæœ‰åŠ¹ã§ã™ã€‚å…¨ä½“ã‚¹ã‚³ã‚¢ã ã‘ã§ã¯å“è³ªå•é¡ŒãŒå¹³å‡å€¤ã«åŸ‹ã‚‚ã‚Œã¾ã™
- RAGASã®Tool Call Accuracyãƒ»Agent Goal Accuracyã¨**Claude APIã«ã‚ˆã‚‹ã‚«ã‚¹ã‚¿ãƒ LLM-as-Judge**ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€å®šé‡è©•ä¾¡ã¨å®šæ€§è©•ä¾¡ã®ä¸¡é¢ã‚’ã‚«ãƒãƒ¼ã§ãã¾ã™
- Supervisorã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦æ”¹å–„ã«ã¯ã€**Few-shotãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¿½åŠ **ã¨**æ§‹é€ åŒ–å‡ºåŠ›ã«ã‚ˆã‚‹ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°**ãŒæœ‰åŠ¹ã§ã™
- è©•ä¾¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’CI/CDã«çµ±åˆã—ã€**å“è³ªã‚²ãƒ¼ãƒˆã¨ã—ã¦è‡ªå‹•å®Ÿè¡Œã™ã‚‹**ã“ã¨ã§ã€ãƒªãƒªãƒ¼ã‚¹å‰ã«å“è³ªåŠ£åŒ–ã‚’æ¤œçŸ¥ã§ãã¾ã™
- LLM-as-Judgeã«ã¯ä½ç½®ãƒã‚¤ã‚¢ã‚¹ã‚„è‡ªå·±è©•ä¾¡ãƒã‚¤ã‚¢ã‚¹ãŒã‚ã‚‹ãŸã‚ã€**ã‚¯ãƒ­ã‚¹ãƒ¢ãƒ‡ãƒ«è©•ä¾¡**ã¨**é †åºãƒ©ãƒ³ãƒ€ãƒ åŒ–**ã§ç·©å’Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

**æ¬¡ã«ã‚„ã‚‹ã¹ãã“ã¨:**

- æœ¬ç•ªãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‹ã‚‰ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è©•ä¾¡ç”¨ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ§‹ç¯‰
- Langfuseã¨é€£æºã—ãŸè©•ä¾¡ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®å°å…¥
- A/Bãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ§‹æˆï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ•°ãƒ»æ‹…å½“ç¯„å›²ï¼‰ã®æœ€é©åŒ–å®Ÿé¨“

**é–¢é€£è¨˜äº‹:**
- [LangGraphÃ—Claude Sonnet 4.6ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‹RAGã®ç²¾åº¦è©•ä¾¡ã¨æœ€é©åŒ–](https://zenn.dev/0h_n0/articles/32bc8fd091100d)
- [Agentic RAGã®ç¶™ç¶šçš„ç²¾åº¦æ”¹å–„ï¼šLangGraphÃ—RAGASÃ—ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã§ç¤¾å†…æ¤œç´¢ã‚’è‡ªå‹•æœ€é©åŒ–](https://zenn.dev/0h_n0/articles/3be93bc5b9b2c8)

## å‚è€ƒ

- [RAGASå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: Agentic or Tool use metrics](https://docs.ragas.io/en/stable/concepts/metrics/available_metrics/agents/)
- [RAGAS Ã— LangGraph Integration Guide](https://docs.ragas.io/en/stable/howtos/integrations/_langgraph_agent_evaluation/)
- [Anthropic Engineering Blog: Demystifying evals for AI agents](https://www.anthropic.com/engineering/demystifying-evals-for-ai-agents)
- [LangGraph Supervisorå…¬å¼ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/langchain-ai/langgraph-supervisor-py)
- [LLM-as-a-Judge Evaluation Guide - Langfuse](https://langfuse.com/docs/evaluation/evaluation-methods/llm-as-a-judge)
- [Agent-as-a-Judge: The Rise of Agent Evaluation (arXiv:2508.02994)](https://arxiv.org/html/2508.02994v1)

---

:::message
ã“ã®è¨˜äº‹ã¯AIï¼ˆClaude Codeï¼‰ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å†…å®¹ã®æ­£ç¢ºæ€§ã«ã¤ã„ã¦ã¯è¤‡æ•°ã®æƒ…å ±æºã§æ¤œè¨¼ã—ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã®åˆ©ç”¨æ™‚ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚ã”ç¢ºèªãã ã•ã„ã€‚
:::
